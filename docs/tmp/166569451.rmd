---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
  pdf_document: default
params:
  examnumber: "B168655"
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(pander)
library(broom)
library(psych)
library(sjPlot)
library(dplyr)
library(lessR)
library(car)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 

# Rename all autunm to autumn

couchto5k[ ,7]

couchto5k[15,7] <- "autumn"

couchto5k[56,7] <- "autumn"

couchto5k[73,7] <- "autumn"

couchto5k[97,7] <- "autumn"

couchto5k[115,7] <- "autumn"

# Identify impossible values 

# The age variable 

hist(couchto5k$age) 
summary(couchto5k$age)

# The histogram shows that there are people around 150 years old, which is clearly not possible, nobody has ever lived that long. Descriptive statistics also shows that there is a max value of 151.

# The accountability variable 

hist(couchto5k$accountability)
summary(couchto5k$accountability)

# The possible values for accountability range between 5 and 35. A histogram and descriptive statistics shows that the values are within this range. 

# The self-motivation variable 

hist(couchto5k$selfmot)
summary(couchto5k$selfmot)

# The self-motivation scores can range from 5 to 35. Impossible values can be seen from the histogram and descriptive statistics (-99). 

# The health variable

hist(couchto5k$health)
summary(couchto5k$health)

# The health scores range from 0-100. The histogram looks good. Descriptive statistics shows that the health scores have a minimum of 32, a mean of 57, and a max of 82.

# Add standard deviation

# The happiness variable

hist(couchto5k$happiness)
summary(couchto5k$happiness)

# The happiness scores ranges from 0-100. The happiness scores look good, minimum is 0, mean is 46.1 and max is 100. 

# The season variable

summary(couchto5k$season)

# The seasons of the year can either be spring, summer, autumn or winter. 

# The city variable

summary(couchto5k$city)

# The city parcitipant was recruited in, either Glasgow or Edinburgh. 

# The week stopped variable 

hist(couchto5k$week_stopped)
summary(couchto5k$week_stopped)

# Week participant stopped, can range from 0-9 (where 9 is completion). The histogram shows that there are impossible values here. The descriptives also show that the maxis 14, which is beyond the completion of the program at week 9. 

# Delete impossible values 


# 1. Make NA out of impossible values from the age variable 

couchto5k <- 
  couchto5k %>%
  mutate(
    age = ifelse(age>100, NA, age)
  )


# 2. Make NA out of impossible values from the self-motivation variable 

couchto5k <- 
  couchto5k %>%
  mutate(
    selfmot = ifelse(selfmot<5, NA, selfmot)
  )

# 3. Make NA out of impossible variables from the week_stopped variable 
    
    couchto5k <- 
  couchto5k %>%
  mutate(
    week_stopped = ifelse(week_stopped>9, NA, week_stopped)
  )



# remove missing data 
    

couchto5k <- drop_na(couchto5k)


# Check for outliers in remaining data 

outliers <- function(obs, x = 3){
  abs(obs - mean(obs, na.rm=TRUE)) > (x * sd(obs, na.rm=TRUE))
}

outliers(obs = couchto5k$accountability)


outliers(obs = couchto5k$selfmot)

outliers(obs = couchto5k$health)

outliers(obs = couchto5k$happiness)


# In-line R code objects for normality tests 


ShapiroAGE <- shapiro.test(couchto5k$age)

ShapiroACC <- shapiro.test (couchto5k$accountability)

ShapiroSELFMOT <- shapiro.test (couchto5k$selfmot)

ShapiroHealth <- shapiro.test (couchto5k$health)

ShapiroHapp <- shapiro.test(couchto5k$happiness)

ShapiroWS <- shapiro.test (couchto5k$week_stopped)


# Some correlation checks not used in the report 



ggplot(data = couchto5k, aes(x = season, y = health))+
  geom_boxplot()+
  theme_bw()

ggplot(data = couchto5k, aes(x = season, y = week_stopped))+
  geom_boxplot()+
  theme_bw()



ggplot(data = couchto5k, aes(x = city, y = happiness))+
  geom_boxplot()+
  theme_bw()


ggplot(data = couchto5k, aes(x = city, y = week_stopped))+
  geom_boxplot()+
  theme_bw()



```

## Descriptives 

Data was obtained from https://uoepsy.github.io/data/usmr_2122_data.R, a dataset containing information on 138 participants health and happiness after the 9 week fitness program Couch to 5k. The data was used to answer the questions of what psychological factors make people continue on the program, as well as its effect on health and happiness. Happiness was measured with the simple self report happiness scale and health with the physiological multi-test health measure, both scales ranging from 0-100. The dataset also contains information on participants accountability and self-motivation, with scales ranging from 1-7. Data on participants age, the season they were interviewed in, the city the were recruited in and the week they stopped the program is also contained in the dataset.   

Impossible values were identified and removed from the participant data, resulting in `r nrow(couchto5k)` observations for the analysis. The remaining data was checked for outliers, defined as values 3 standard deviations away from the mean of each variable. No outliers were found. Descriptive statistics were derived for the numerical variables (see Table 1). A Shapiro Wilk's normality test was run on all numerical variables. The Shapiro Wilk's test for age (*W* = `r round(ShapiroAGE$statistic,2)`, *p* = `r round(ShapiroAGE$p,3)`), happiness (*W* = `r round(ShapiroHapp$statistic,2)`, *p* = `r round(ShapiroHapp$p,3)`) and the week_stopped variable (*W* = `r round(ShapiroWS$statistic,2)`, *p* = `r round(ShapiroWS$p,3)`) were significant, indicating that the variables were not normally distributed. Accountability, (*W* = `r round(ShapiroACC$statistic,2)`, *p* = `r round(ShapiroACC$p,3)`)  Self-motivation, (*W* = `r round(ShapiroSELFMOT$statistic,2)`, *p* = `r round(ShapiroSELFMOT$p,3)`)  and health, (*W* = `r round(ShapiroHealth$statistic,2)`, *p* = `r round(ShapiroHealth$p,3)`) were all normally distributed. Pearson's correlations between numeric variables where then established in a correlation matrix (see Figure X). The frequencies for the season and the city categorical variable are shown in a pie chart (see Figure X and Y). Relationships between categorical variables and outcome variables of interest (health, happiness and week stopped) were derived. Of notice was the discernible difference in happiness levels between participants from Edinburgh and Glasgow, and participants interviewed during different seasons(see Boxplot X and Y).  



```{r descriptives, include=FALSE}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 


# Descriptives for numerical variables 


OnlyNumericVariables <- couchto5k [c(2,3,4,5,6,9)]

describe(OnlyNumericVariables)

pander(describe(OnlyNumericVariables))

# Correlations for numerical variables 

cor(OnlyNumericVariables)

pander(cor(OnlyNumericVariables))


# Shapiro wilks test for numerical variable

ShapiroAGE <- shapiro.test(couchto5k$age)

ShapiroACC <- shapiro.test (couchto5k$accountability)

ShapiroSELFMOT <- shapiro.test (couchto5k$selfmot)

ShapiroHealth <- shapiro.test (couchto5k$health)

ShapiroHapp <- shapiro.test(couchto5k$happiness)

ShapiroWS <- shapiro.test (couchto5k$week_stopped)



# Frequencies for categorical variables

count(couchto5k, season)

PieChart(season, data = couchto5k)

count(couchto5k, city) 

PieChart(city, data = couchto5k)


# Relationship between categorical variables and outcome variables of interest 

ggplot(data = couchto5k, aes(x = season, y = happiness))+
  geom_boxplot()+
  theme_bw()

ggplot(data = couchto5k, aes(x = city, y = happiness))+
  geom_boxplot()+
  theme_bw()








```

```{r descriptivesshown}

pander(describe(OnlyNumericVariables))

pander(cor(OnlyNumericVariables))

PieChart(season, data = couchto5k)

PieChart(city, data = couchto5k)

ggplot(data = couchto5k, aes(x = season, y = happiness))+
  geom_boxplot()+
  theme_bw()

ggplot(data = couchto5k, aes(x = city, y = happiness))+
  geom_boxplot()+
  theme_bw()


```


# Question 1 



```{r q1a}


# Use ifelse function to create the 3 categories. 
  
  couchto5k$Cat_week_stopped <- as.factor(ifelse(couchto5k$week_stopped < 5, "Stopped before week 5", ifelse(couchto5k$week_stopped == 9, "Completed", "Stopped after week 5")))
  
  
# Do goodness of fit chisq.test 

CSGF <- chisq.test(table(couchto5k$Cat_week_stopped), p = c(0.45, 0.10, 0.45))



```

## Question 1a

A Chi-square Goodness-of-fit test was performed to determine if the data on programme abandonment was in line with data from earlier surveys, where 45% of participants abandoned the programme before week 5, and 10% gave up before the end of the programme. Table X shows % rates of completion for the participants in the current study. The chi-square goodness-of-fit test showed that there was a significant difference between the earlier survey and the current survey χ² (2, *N* = 133) = `r round(CSGF$statistic, 2)`, *p* = `r round(CSGF$p.value,3)`. Thus, significantly more participants continued longer on the current program. 

```{r}

# The table showing percentages

pander(prop.table(table(couchto5k$Cat_week_stopped))*100)


```



```{r q1b}

# Do a Chi Square Test of independence 

table(couchto5k$Cat_week_stopped,couchto5k$city)

CSI <- chisq.test(table(couchto5k$Cat_week_stopped,couchto5k$city))
```

## Question 1b

A Chi-square test of Independence was then performed to examine the relation between the city participants were recruited in and the time at which they stopped the programme. The relation between the variables were not significant, χ² (2, N=133) = `r round(CSI$statistic, 2)`, *p* = `r round(CSI$p.value,3)`. Participants from Edinburgh were thus as likely to complete the programme as participants from Glasgow. 



```{r q1c}

# T-test 

ttest1c <- t.test(couchto5k$age ~ couchto5k$city, mu = 0, alternative = "two.sided", conf = 0.95, var.eq = FALSE, paired = F)


# Assumptions 

shapiro.test(couchto5k$age)



```
## Question 1c

An independent sample's, two-sided, t-test was used to test the hypothesis that the average age of the participants commencing the program differed by city. The t-test (*t*(75) = `r round(ttest1c$statistic, 2)`, *p* = `r round(ttest1c$p.value,3)`) indicated that participants from Edinburgh (*M* = 39.8) were not significantly older than participants from Glasgow  (*M* = 37.2). However, the result may be biased since the age variable is not normally distributed (*W* = `r round(ShapiroAGE$statistic,2)`) 



```{r}



```


# Question 2

Linear and multiple regression analysis were then conducted to find a suitable baseline model to use when investigating the research questions. 

## Question 2a

Firstly,a linear regression analysis was used to test if participants' happiness ratings were affected by the season they were interviewed in (see Table X). Plots showing residual vs fitted values, the normal distribution of residuals and Cook's distances did not reveal significant bias in the model. Season was found to explain a significant amount of variance in happiness ratings, *F*(3,129)= 5.01, *p* = 0.003, *R*²=0.10.The regression coefficients indicated that happiness levels were significantly different during autumn(*B*= 24.67, *t*(129) = 2.73, *p* = 0.007) spring , *B* = 21.68, *t*(129) = 2.23, *p* = 0.028) and summer (*B* = 33.59, *t*(129) = 3.21, *p* = 0.002). As Figure X shows, participants were happiest during the summer. 



```{r q2a}

# The linear model 

SeasonOnHappiness <- lm(happiness ~ season, data = couchto5k)

summary(SeasonOnHappiness)

tab_model(SeasonOnHappiness)

# Assumptions

plot(SeasonOnHappiness)

# Create a plot  

ForGraph <- couchto5k %>% group_by(season) %>%
  summarise(mean_se(happiness))

ForGraph %>% ggplot(aes(x=season,y=y,
                  ymin=ymin,ymax=ymax)) +
  geom_bar(stat="identity") +
  geom_errorbar(width=.2) +
  ylab("Happiness")+
  theme_minimal()





```



## Question 2b

Next, a multiple linear regression was run to test if happiness was affected by age when controlling for season. Plots showing residual vs fitted values, the normal distribution of residuals and Cook's distances did not reveal significant bias in the model. Age was, however, not found to be a significant predictor of happiness when controlling for season (*B* = 0.32, *t*(128) = 1.47, *p* = 0.143). Therefore, age will not be included as a predictor in the baseline model. 


```{r q2b}

# Model 

SeasonAndAgeOnHappiness <- lm(happiness ~ season + age, data = couchto5k)

# Assumptions 

plot(SeasonAndAgeOnHappiness)

# Statistic

summary(SeasonAndAgeOnHappiness)



```

## Question 2c

Finally, including the city participants were recruited in was found to explain a significant amount of variance in happiness scores when controlling for season, *B* = -12.17, *t*(128)= -2.07, *p* = 0.04, *R*² = 0.13. The coefficient estimate revealed that participants interviewed in Glasgow were significantly less happy than participants in Edinburgh (see Figure X). The model including only season was thus compared with a model including season and city using an anova, and the additional inclusion of city was found to predict happiness over and beyond season , *F*(1, 128) = 4.3, *p* = 0.04. Plots showing residual vs fitted values, the normal distribution of residuals and Cook's distances did not reveal any discernible bias in the model.Therefore, city was also included in the baseline model.


```{r q2c}


# Run the model 

seasoncityonhappiness <- lm(happiness ~ season + city, data = couchto5k)

summary(seasoncityonhappiness)

anova(SeasonOnHappiness, seasoncityonhappiness)

# Assumptions 

plot(seasoncityonhappiness)

# Table 
tab_model(seasoncityonhappiness)

```

# Question 3

## Question 3a

Building from the baseline model, a multiple regression analysis that included season, city and completion of program was conducted to test if participants happiness ratings were affected by whether or not they completed the program. Plots showing residual vs fitted values, the normal distribution of residuals and Cook's distances did not reveal discernible bias in the model. When controlling for season and city, participants happiness ratings were not significantly affected by whether or not they completed the program, *B* = 10.49, *t*(127)= 1.51, *p* = 0.132. Completion of the program was therefore not included in the final model. 

```{r q3a}

# Create an additional variable for completed the program (yes or no)

couchto5k$completed <- ifelse(couchto5k$Cat_week_stopped == "Completed", "YES", "NO")

# Add variable to model

SeasonAndCityAndCompletedOnHappiness <- lm(happiness ~ season + city + completed, data = couchto5k)

# Assumptions 

plot(SeasonAndCityAndCompletedOnHappiness)

# Summary of model 

summary(SeasonAndCityAndCompletedOnHappiness)



```

## Question 3b

Next, a multiple regression analysis including season, city and health as predictors was conducted to test if happiness was additionally affected by the health metric. Plots showing residual vs fitted values, the normal distribution of residuals and Cook's distances did not reveal discernible bias in the model.The analysis found that health was not a significant predictor of happiness when controlling for season and city, *B* = -0.15, *t*(127) = -0.49, *p* = 0.628. 

```{r q3b}

# Model 

SeasonAndCityAndHealthOnHappiness <- lm(happiness ~ season + city + health, data = couchto5k)

# Assumptions 

plot(SeasonAndCityAndCompletedOnHappiness)

# Summary 

summary(SeasonAndCityAndHealthOnHappiness)



```

## Question 3c

It was hypothesized, however, that the effects of good health were amplified by the feeling of acting healthy, so that the happiness of the participants who continued longer on the program were more affected by the health metric than those who stopped the program earlier. The interaction between health and completion of the program was therefore included in the model as a predictor of happiness. A plot of the residuals versus the fitted values in the model indicated that the model met the assumptions of linearity (See Figure X). The model also met the assumption of  equal variances, (Breaush Pagan test, χ²(1) = 0.07,  *p* = 0.8), the independence of errors, (Durbin-Watson = 2.03, *p* = 0.846). However, the errors were not found to be normally distributed in a Shapiro Wilk's: *W* =1, *p* = 0.09. The VIF values indicated multicollinearity (values > 5) only amongst the interaction terms, which should not be a problem. A plot of Cook's distances indicated that no values were overly influential in the model. Although the errors were not normally distributed, the model was thus a relatively good fit. The F-test for model utility was significant (*F* (7, 125) = 4.93 *p* = < 0.001), and the model explained 21.6 % of the variance in happiness scores (See Table X). The interaction effect can be seen in plot X. 

```{r q3c}

# Run the model 

SeasonAndCityAndCompletedHealthOnHappiness <- lm(happiness ~ season + city + health + completed + health:completed, data = couchto5k)

summary(SeasonAndCityAndCompletedHealthOnHappiness)


# Linearity 

tibble(
  residuals = resid(SeasonAndCityAndCompletedHealthOnHappiness), 
  fitted = fitted(SeasonAndCityAndCompletedHealthOnHappiness)
) %>%
  ggplot(aes(x=fitted, y = residuals)) +
  geom_point()+
  geom_smooth(method = "loess", se = FALSE) +
  theme_minimal() +
  labs(title = "Residuals vs Fitted", y = "Model residuals", x = "Model fitted values")


# Homoskedasticity 

residualPlots(SeasonAndCityAndCompletedHealthOnHappiness)

ncvTest(SeasonAndCityAndCompletedHealthOnHappiness)

plot(SeasonAndCityAndCompletedHealthOnHappiness, whcih =1)

# Independence

dwt(SeasonAndCityAndCompletedHealthOnHappiness)


# Normality of errors

plot(SeasonAndCityAndCompletedHealthOnHappiness, which =2)

shapiro.test(residuals(SeasonAndCityAndCompletedHealthOnHappiness))


# Multicollinearity 

vif (SeasonAndCityAndCompletedHealthOnHappiness)


# Individual Case Diagnostics - Cook's 

plot(SeasonAndCityAndCompletedHealthOnHappiness, which = 4)


# Show model 

tab_model(SeasonAndCityAndCompletedHealthOnHappiness)

# Plot 

plot_model(SeasonAndCityAndCompletedHealthOnHappiness, type = "int")


```

## Question 3d

The results indicated that the relationship between health and happiness depends on whether or not the participants completed the program. The relationship between health and happiness was positive for those who completed the program, but negative for those who did not complete the program. Albeit small, the effect was significant when controlling for the season the participants were interviewed in and the city they were recruited in. Together, the effect of season, city and the interaction between health and happiness accounted for 21% of the variance in happiness scores. While season and city are strongly related to happiness, participants who completed the program appear to have gotten more healthy and thus a little more happy. However, the analysis performed does not establish causality, and it may be participants’ inherent happiness-proneness that influences both health and completion of the program. 


# Question 4

Figure X shows the happiness ratings of completers, grouped by Season and City. 

```{r q4}

# Create subset 

ParticipantsCompleted <- couchto5k[couchto5k$completed == "YES", ]

# Reorder seasons 

# Create plot

ggplot(data = ParticipantsCompleted, aes(x = season, y = happiness, fill = city)) +
  geom_bar(stat = "identity", position="dodge")+
  labs(title = "Happiness of Completers", x = "Season", y = "Happiness") + 
  theme_minimal()

 



```


# Question 5

   

## Question 5a

Lastly, it was hypothesized that accountability and self-motivation would decrease the likelihood of dropping out of the program. Relationships established between the variables of interest showed week correlations, however (See Plot X and Y). Furthermore, generalized linear models indicated that there was no significant effect of either self-motivation (*p* = 0.61) or accountability (*p* = 0.25) on the tendency to drop out of the program. No other significant predictors of the tendency to drop out was found in the data. 



```{r q5a}

# Create drop- out variable

couchto5k$Dropout <- ifelse(couchto5k$completed == "YES", 0, 1)

# Correlate with variables of interest

ggplot(data=couchto5k, aes(x= selfmot, y = Dropout))+
       geom_jitter()+
  theme_minimal()


ggplot(data=couchto5k, aes(x= accountability, y = Dropout))+
       geom_jitter()+
  theme_minimal()


# Use the general linear model for selfmotivation  


SelfMotonDropOut <- glm(Dropout ~ selfmot,
             family = binomial, 
             data=couchto5k)

summary(SelfMotonDropOut)


exp(coef(SelfMotonDropOut))


# Use the general linear model for accountability 

AccountabilityonDroput <-glm(Dropout ~ accountability,
             family = binomial, 
             data=couchto5k)

summary(AccountabilityonDroput)

exp(coef(AccountabilityonDroput))


# Self-motivation and accontability 

SelfMotandAccountabilityonDroput <-glm(Dropout ~ selfmot + accountability,
             family = binomial, 
             data=couchto5k)

summary(SelfMotandAccountabilityonDroput)

exp(coef(SelfMotandAccountabilityonDroput))


# Try other variables 

glm(Dropout ~ happiness,
             family = binomial, 
             data=couchto5k)


summary(glm(Dropout ~ happiness,
             family = binomial, 
             data=couchto5k))


glm(Dropout ~ health,
             family = binomial, 
             data=couchto5k)


summary(glm(Dropout ~ health,
             family = binomial, 
             data=couchto5k))


summary(glm(Dropout ~ health,
             family = binomial, 
             data=couchto5k))


glm(Dropout ~ age,
             family = binomial, 
             data=couchto5k)


summary(glm(Dropout ~ age,
             family = binomial, 
             data=couchto5k))







```

## Question 5b

No predictors of the tendency to drop out of the program were found in the data. The tendency to drop out was not significantly influenced by accountability, self-motivation or any of the other variables in the study.

```{r q5b}



```

## Question 5c

Figure X shows how the probability of quitting could be represented as a function of how self- motivated participants were.  In this study, the relationship between self-motivation and the likelihood of dropping out was however not found to be statistically significant. 

```{r q5c}

# Create the graph 

summary(SelfMotonDropOut)

predict(SelfMotonDropOut, type = "link")

predict(SelfMotonDropOut, type = "response")


selfmotivation100 <- tibble(selfmot=1:100)

selfmotivation100


predict(SelfMotonDropOut, newdata = selfmotivation100, type = "response")


selfmotivation100 <- 
  selfmotivation100 %>%
  mutate(
    predprobs = predict(SelfMotonDropOut, newdata = selfmotivation100, type = "response")
  )


ggplot(data = selfmotivation100, aes (x = selfmot, y = predprobs))+
  geom_line()+
  labs(title = "Selfmotivation and quitting", y = "Predicted probability of dropping out")+
  theme_minimal()

















```










