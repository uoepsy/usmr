---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  word_document: default
  pdf_document: default
  html_document: default
params:
  examnumber: "B170902"
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(patchwork)
library(pander)
library(broom)
library(extraoperators)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
couchto5k$missing <- NA
couchto5k$missing [couchto5k$age > 100] <- "impossible age"
couchto5k$missing [couchto5k$selfmot == -99] <- "impossible mot"
couchto5k$missing [couchto5k$week_stopped == 13] <- "beyond end"

# mtab is table for missing variables
mtab <- table(couchto5k$missing)

# now we remove the missing values

couchto5k <- couchto5k %>% filter(is.na(missing))
total <- count(couchto5k)
```
The data were inspected and while there were no missing values found, unlikely values were removed. `r total` observations remained and were used for analysis. Table 1 provides a summary of the removed data.

```{r table, results='asis'}
mtab %>% pander(caption= "Table 1: Summary of removed values")

# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 


```
```{r seasons}
miscoded <- sum(couchto5k$season == 'autunm')
#5 values are misspelt (autunm instead of autumn). Fix this.

couchto5k$season[couchto5k$season == "autunm"] <- 'autumn'
couchto5k$season <- as.factor(couchto5k$season)

couchto5k$city[couchto5k$city == "Edinburgh"] <- 'Edinburgh'

couchto5k$city[couchto5k$city == "Glasgow"] <- 'Glasgow'
```
`r miscoded` season entries included a misspelling of "autumn" as "autunm". These were re-coded to the correct spelling.

# Question 1 

## Question 1a

```{r q1a}
couchto5k <- couchto5k %>% mutate (beforewk5 = week_stopped < 5)
couchto5k <- couchto5k %>% mutate(afterwk5 = week_stopped >= 5 & week_stopped < 9)
couchto5k <- couchto5k %>% mutate(complete = week_stopped == 9)

# 45% abandoned halfway point in week5?

shapiro.test(couchto5k$week_stopped)

mean1a <- mean(couchto5k$beforewk5)
res1a <- t.test(couchto5k$beforewk5, mu= .45)

```
```{r}
#Apparently 10% gave up before the end of the program
res1a2<- t.test(couchto5k$afterwk5, mu= .10)
```

A Shapiro Wilk test indicated a violation of normality (W= 0.7, p < .05). However, to answer the question in 1a, t-tests were used to compare rates of attrition between the present data and the previous survey, since they are largely robust against normality.

Two one-sided sample t-tests were conducted. The previous surveyâ€™s attrition rate before the fifth week was 45%, which was not significantly different from the rate of attrition before the fifth week (M = `r mean (couchto5k$beforewk5) %>% round(2)`, SD =`r sd (couchto5k$beforewk5) %>% round(2)`) in the present data (t (`r nrow(couchto5k)-1`) = `r res1a$statistic %>% round(2)`, p > .05, one-tailed). 

Attrition rates after the fifth week in the present data (M = `r mean (couchto5k$afterwk5) %>% round(2)`, SD = `r sd (couchto5k$afterwk5) %>% round(2)`) also did not differ significantly from the 10% attrition demonstrated by the previous survey (t (`r nrow(couchto5k)-1`)= `r res1a2$statistic %>% round(2)`, p > .05, one-tailed).


## Question 1b


```{r q1b}

#data normally distributed?

shapiro.test(couchto5k$week_stopped)


```
```{r}

#t.test to see difference between cities for attrition before week 5

test_bwk5 <- t.test(with(couchto5k, beforewk5, city), mu= 0.37)

#t.test to see difference between cities for attrition after week 5

test_awk5 <- t.test(with(couchto5k, afterwk5, city), mu= 0.109)


#t.test to see difference between cities between completion

test_cmplt <- t.test(with(couchto5k, complete, city), mu= 0.521)

```
We know from the previous question that the data violates assumptions of normality (W= 0.7, p < .05), however we ran one-sided sample t-tests since they are robust to violations of normality.

One-sided sample t-tests were run for all three categories to examine differences in rates of attrition by city. There was no differences in rates of attrition between Edinburgh and Glasgow before the fifth week (t (`r nrow(couchto5k)-1`) = `r test_bwk5$statistic %>% round(2)`, p > .05, one-tailed) and after the fifth week (t (`r nrow(couchto5k)-1`) = `r test_awk5$statistic %>% round(2)`, p > .05, one-tailed). 

There was also no difference in rates of completion between the two cities (t(`r nrow(couchto5k)-1`) = `r test_cmplt$statistic %>% round(2)`, p > .05, one-tailed).



## Question 1c

```{r q1c}
#does mean age of participants who started the program differ by city
age_cit <- t.test(with (couchto5k, age, city), mu= 38.8)

```
We compared the mean age of participants using a one-sided sample t-test. Mean age (M = `r mean(couchto5k$age)`) did not differ significantly by city (t(`r nrow(couchto5k)-1`) = `r age_cit$statistic %>% round(2)`, p > .05, one-tailed).

# Question 2

## Question 2a

```{r q2a}
plot_seas_hap <- ggplot(couchto5k, aes(x = season, y = happiness, fill = season)) + geom_boxplot() + labs(x = "Season", y = "Happiness Score")

# seasonal happiness
seasonal_happiness <- lm (happiness ~ 1 + season, data = couchto5k)

# Null model for happiness
null_hap <- lm (happiness ~ 1, data = couchto5k)

# Comparison of models
anova(null_hap, seasonal_happiness)

```

There was no relationship between seasons and the variance in happiness scores, F (3,115) = 0.51, p > .05.

## Question 2b

```{r q2b}
#Plot to explore visually the relationship between happiness and age in this sample
Happiness_Ageplot <- ggplot(data = couchto5k, aes(x = age, y = happiness)) +    geom_point(alpha = 0.5) + labs(x = "Age of participants", y = "Happiness score", caption = "Figure 1. Happiness scores by age")

#Happiness Age Season model - multiple linear model
hap_agemodel <- lm(happiness ~ 1 + age, data= couchto5k)


```
Participants' age and happiness scores were plotted in Plot 1 below. There appears to be no relationship between happiness and age.

A t-test was conducted against the null hypothesis that age is not significant predictor of happiness. Results demonstrate that 40% of the variability in happiness is not explained by age (t (117) = 4.08, p >.001). An F-test demonstrates the significance of the regression, F(1,117) = .75, p > .001, indicating that age is not an effective predictor of happiness.

```{r}
Happiness_Ageplot
```


## Question 2c
```{r q2c}

##Multiple linear model - Happiness Age Season model. Can use this as age adds some effect

hap_agemodel <- lm(happiness ~ 1 + age, season, data= couchto5k)
```

The chosen baseline model is: lm(happiness ~ 1 + finprogram, data = couchto5k)

# Question 3

## Question 3a

```{r q3a}


#Finished exercise program - categorical variable with 'yes' 'no'
couchto5k <- couchto5k %>% mutate (finprogram = ifelse(week_stopped > 8, "Yes", "No"))

#plot happiness with finishing program
finplot <- ggplot(couchto5k, 
       aes(x = finprogram, y = happiness, fill=finprogram)) + geom_boxplot() + labs(x = "Completed programme", y = "Happiness score", caption = "Figure 2. Happiness scores and completion of programme")

#simple linear model - happiness and finishing the program
finprog_hap <- lm(happiness ~ 1 + finprogram, data = couchto5k)

```

A t-test was conducted against the null hypothesis that finishing the program had no effect on happiness scores (see Figure 2). Results demonstrate that the 47% variability in happiness is not explained by whether they complete the program (t (117) = 10.8, p > .001). An F-test F (1,117) = .05, p > .001, indicates that completing the program was not a predictor of happiness.

```{r}
finplot
```


## Question 3b

```{r q3b}
#multiple linear model - with health, finishing the program and happiness
finprog_Hap_Health <- lm(happiness ~ 1 + finprogram + health, 
                            data = couchto5k)
```

Building on the model used in 3a, health was added as an additional predictor. A one-sample t-test demonstrated that the health metric had no effect on happiness (t (116) = -1.52, p > .05). 


## Question 3c

```{r q3c}
#null model: no change in happiness caused by health; previously defined
null_hap

#multiple linear model: happiness increases as you go further towards the end of the program and this increases health metric. 

#model: happiness ~ 1 + week_stopped + health
Prog_Hap_Health <- lm(happiness ~ 1 + week_stopped + health, data = couchto5k)

#compare models
anova(null_hap,Prog_Hap_Health)

```
The model in 3b was altered to include all weeks that participants stopped. 
The health metric was not found to explain the variance in happiness over time participating in the program, F (2,116) = 1.23, p > .05, allowing us to accept the null hypothesis.


# Question 4

```{r q4}
#from q3a
couchto5k <- couchto5k %>% mutate (finprogram = ifelse(week_stopped > 8, "Yes", "No"))

#subset of data
completed_program <- couchto5k %>% filter(finprogram == "Yes") %>% select(city, happiness, season)

#plot
plothap_season_city <- ggplot(completed_program, aes( x = season, y = happiness, fill= season)) + geom_boxplot() + labs(x = "Season", y = "Happiness score", caption = "Figure 3. Average happiness ratings per season") + facet_wrap(vars(city)) 

#plots for happiness by season, of both cities
plothap_season_city
```
Plots on average happiness ratings by season for both Edinburgh and Glasgow are in Figure 3.

```{r}
plothap_season_city
```


# Question 5

## Question 5a

```{r q5a}

couchto5k <- couchto5k %>% mutate(dropout = ifelse(week_stopped<9, "dropout","completed"))

# factors
couchto5k$dropout <- as.factor(couchto5k$dropout)
levels(couchto5k$dropout)

#model
dropout_mod <- glm(dropout ~ 1, data= couchto5k, family = "binomial")

summary(dropout_mod)

#then anova

anova(dropout_mod, test = "Chisq")

logLik(dropout_mod)

#predict dropout
predict(dropout_mod, type = "response")

#coef
coef(dropout_mod)

```
The log-odds of dropping out of the exercise program are not significantly different from chance.

## Question 5b

```{r q5b}

```
The model predicts a 48% chance of dropping out.

## Question 5c

```{r q5c}
#lm

mot_drop <- lm(dropout ~ selfmot, data = couchto5k)

#plot dropping out with self motivation

motdrop_plot <- ggplot(couchto5k, aes(x= selfmot , y= dropout)) + geom_point() + geom_smooth(method= lm) + labs(x = "Self-motivation scores", y= "Dropped out", caption = "Figure 4. Plotted regression of self-motivation on dropping out")

motdrop_plot
```









