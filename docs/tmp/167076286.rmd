---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
  pdf_document: default
params:
  examnumber: "B193364"
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(psych) # good for descriptive stats
library(car) # for assumption tests
library(sjPlot) # for plotting models
library(pander)
library(broom)

# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")

options(digits=2)

```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->

```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
couchto5k$missing <- NA
couchto5k$missing[couchto5k$age>100] <- "crazy age"
couchto5k$missing[couchto5k$selfmot<5] <- "crazy selfmot"
couchto5k$missing[couchto5k$week_stopped>9] <- "week_stopped>9"
mtab <- table(couchto5k$missing)

couchto5k<- couchto5k %>% filter(is.na(missing))
total <- count(couchto5k)

```

```{r season,include = FALSE}
miscoded <- sum(couchto5k$season=='autunm')
couchto5k$season[couchto5k$season=="autunm"] <- 'autumn'
couchto5k$season <- as.factor(couchto5k$season)

```


Our data of 129 participants is collected from "Couch to 5k" dataset. Couch to 5k is a fitness programme from NHS and participants need to run half a hour per day lasting 9 weeks.The data has been included participants from two cities, namely, Edingurgh and Glasgow.At the beginning of the programme (week 0),researchers measured participants' accountability and self-motivation by using a questionnaire.Both of them have 5 questions (each scored 1-7). Furthermore, whether participants complete the programme, they completed a questionaire which measure self-reported happiness (0-100 scale) and health metric(0-100 scale). The data include participantID(pptID),age,season,city,week_stopped(week9 means completion). The data were inspected and missing or unlikely values were removed, resulting in `r total` observations for analysis.  Table 1 gives a summary of removed data. Moreover,`r miscoded` time of season entries were initially misentered as "autunm".  Hence, we changed them as right spelling "autumn". Table 2 shows a summary of descriptive statistics and we can find that among all participant data was completed (no missing value).


```{r table3, results="asis"}
mtab %>% pander(caption="Table 1: Summary of missing values")
```

```{r descriptives,include = FALSE }
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 
couchto5k_descriptives <- couchto5k %>% summarise(
  variable = c("age","accountability","selfmot","health","happiness"),
  n = c(n(),n(),n(),n(),n()),
  mean = c(mean(age),mean(accountability),mean(selfmot),mean(health),mean(happiness)),
  sd = c(sd(age),sd(accountability),sd(selfmot),sd(health),sd(happiness)),
  min = c(min(age),min(accountability),min(selfmot),min(health),min(happiness)),
  max = c(max(age),max(accountability),max(selfmot),max(health),max(happiness))
  ) %>%
  tibble()


```


```{r table2, results="asis"}
couchto5k_descriptives %>% pander(caption = "Table 2. Descriptive statistics for age, acountability, self-motivation, health, happiness" )
```
According to bivariate scatter plots (see Figure 1), we find that a very weak positive relationship between happiness and age; a week negative relationships between happiness and season; a very weak positive relationships between happiness and stopped week and a weak negative relationship between happiness and health.

```{r figure1, fig.asp = 0.6, fig.cap = "Figure 1: Bivariate scatter plots (below diagonal), histograms (diagonal), and Pearson correlation coefficient (above diagonal) of variables", message = FALSE}
couchto5k %>% select(happiness,age,season,week_stopped,health,accountability,selfmot,city) %>%
  psych::pairs.panels(jiggle = TRUE, factor = 0.5, ellipses = FALSE, cex.cor = 1, cex = 0.5, bg = c("red","blue"))
```



# Question 1 

## Question 1a
To explore whether our data in the sample is consistent with data from earlier surveys, we test the week_stopped by using the χ2 goodness of fit. We also check the observations and found no cell is less than 5 and our samples size is greater than 40, so we can use the χ2 goodness of fit. 

H0: Our data in the sample is consistent with the data from the earlier survey.
H1: Our data in the sample is not consistent with the data from the earlier survey.

```{r q1a,include = FALSE}


chi_table<-couchto5k%>%group_by(week_stopped)%>%summarise(freq=n())##an initial idea of how things are looking

ov_table<-tibble(week1234=sum(chi_table$freq[1:4]),week5678=sum(chi_table$freq[5:8]),week9=chi_table$freq[9])##observations 

q1achisq<-chisq.test(ov_table,p=c(0.45,0.1,0.45))

q1achisq

total <- count(couchto5k)

```
The results are shown in Table 3, we do not have enough evidence to reject the null hypothesis and can assert that our data in the sample is consistent with previous surveys, χ2(`r q1achisq$parameter`, N = `r total`) = `r q1achisq$statistic`, p > .05.
```{r, results='asis'}
q1achisq %>% pander(caption = "Table 3. χ2 Goodness of Fit Test result")
```


## Question 1b

To explore whether or not the patterns of attribution rates differ between Edinburgh and Glasgow, we compare the patterns of attribution rates of Edinburgh and Glasgow by using χ2 test of independence. We firstly divided participants into three groups: participants in group 1 who stopped the programme before week 5; participants in group2 who stopped after week 5 but did not complete the programme; participants in group 3 who finished the programme.

```{r q1b,include = FALSE}
couchto5k<-
  couchto5k%>%
  mutate(
    stopped_time=ifelse(week_stopped<5,"group1",ifelse(week_stopped>=5&week_stopped<9,"group2","group3"))
  )

table(couchto5k$stopped_time,couchto5k$city)

tableq1b<-plot(table(couchto5k$stopped_time,couchto5k$city))

t<-couchto5k %>%
  select(stopped_time,city) %>% table()


q1bchisq<-chisq.test(table(couchto5k$stopped_time, couchto5k$city))

```

Secondly, we consider the hypothesis of the question.
H0: There has no difference in the patterns of attribution rates in the two cities.
H1: There has a difference in the patterns of attribution rates in the two cities.

The results are shown in Table 5, we do not have enough confidence to reject the null hypothesis and will conclude that the patterns of attribution rates are not differ by city, χ2(`r q1bchisq$parameter`, N = `r total`) = `r q1bchisq$statistic`, p > .05.
```{r, results='asis'}
q1bchisq %>% pander(caption = "Table 3. χ2 test of independence result")
```


## Question 1c
```{r q1c,include = FALSE}

shapiro.test(couchto5k$age[couchto5k$city=="Edinburgh"])
shapiro.test(couchto5k$age[couchto5k$city=="Glasgow"])
with(couchto5k, var.test(age ~ city))
q1ctest<-with(couchto5k, t.test(age ~ city, alternative = "greater"))
```

```{r,include = FALSE}
tableq1c <- couchto5k %>% 
  select(city, age) %>%
  group_by(city) %>%
  mutate(row = row_number()) %>%
  pivot_wider(names_from = city, values_from = age) %>%
  select(-row)
tableq1c
summary(tableq1c)
```
To test whether the average ages of participants who commenced the programme differ by Edinburgh and Glasgow, we can use independent samples t-test.  Firstly, we check the normal distribution of age in two cities by using Shapiro-Wilk test. Age in Edingurgh is not normality (W = `r shapiro.test(tableq1c$Edinburgh)$statistic`, p = `r shapiro.test(tableq1c$Edinburgh)$p.value`). Age in Glasgow is also not normality (W = `r shapiro.test(tableq1c$Glasgow)$statistic`, p = `r shapiro.test(tableq1c$Glasgow)$p.value`). Therefore, we try to make the density plots to observe distribution of age in two cities (see Figure 2 & 3). Honestly, the two plots shows there are no normal distribution of age in two cities and cannot meet the assumptions of t-test. It might result from our sample size which is limited and sometimes Shapiro-Wilk test is just a reference. Therefore, we supposed that there can use independent samples t-test.
H0: The average ages of participants who started the programme are not differ by city.
H1: The average ages of participants who started the programme differ by city.

```{r,fig.asp = 0.6, fig.cap = "Figure 3: The density plot of ages in Edinburgh", message = FALSE, include=TRUE}
ggplot(tableq1c, aes(x = Edinburgh)) + 
  geom_density() +
  labs(x = "Age in Edinburgh", y = "Probability") +
  scale_x_continuous(limits = c(0,80)) +
  theme_bw()
```

```{r,fig.asp = 0.6, fig.cap = "Figure 4: The density plot of ages in Glasgow", message = FALSE, include=TRUE}
ggplot(tableq1c, aes(x =Glasgow)) + 
  geom_density() +
  labs(x = "Age in Glasgow", y = "Probability") +
  scale_x_continuous(limits = c(0,70)) +
  theme_bw()
```

Table 5 and Figure 4 shows the results of independent samples t-test. The average ages of participants in Edinburgh(M =41.39) is significant greater than from Glasgow(M =33.84), t(`r q1ctest$parameter`) = `r q1ctest$statistic`, p = `r q1ctest$p.value`. 

```{r, results='asis'}
q1ctest %>% pander(caption = "Table 5: Independent samples t-test results")
```

```{r figure5, fig.asp = 0.6, fig.cap = "Figure 5:Independent samples t-test results ", message = FALSE}
Figure1c=ggplot(couchto5k,aes(x=city,y=age))
figure1c<-Figure1c+
  stat_summary(fun= mean,
               geom = "bar",
               color="black",
               fill="white")+
  stat_summary(fun.data = mean_se,
               geom = "errorbar",
               width=.2)+
  ylim(0,60)+
  geom_segment(x=1,y=59,xend=2,yend=59)+
  geom_text(x=1.5,y=60,label="***",size=8)+
  theme_classic()+
  labs(x="City",y="Age")

figure1c
```



# Question 2
## Question 2a
To explore whether participants’ happiness rating was affected by their interview season, we generate a simple linear regression and take happiness as our outcome variable and season as our predictor. 
Happiness= b0 + b1 season + ϵ
Through making the model diagnostics by ploting the model, there is a hugely influential observation and then we remove it. Hence, the model fitted 123 observations. According to the assumptions of linear models, we firstly test the relationship of linearity (see Figure 3) and found a reasonably straight red line. It indicates that the mean of the residuals is close to 0 across the fitted values. We also test the normality of residuals (see Figure 3), the Q-Q plot shows that the residuals are close to the dotted line which indicates they follow close to a normal distribution. Therefore, we can use a simple linear model to investigate our question.We consider the hypothesis of the question:
H0: The coefficient of the season is zero.
H1: The coefficient of the season is not zero.

```{r q2a,include = FALSE}

couchto5k<-couchto5k[-104,]
ggplot(data = couchto5k, aes(x = happiness)) +
  geom_density() +
  geom_boxplot(width = 1/100) +
  labs(x = "happiness", 
      y = "Probability density")

couchto5k$season <- factor(couchto5k$season, levels = c("spring", "summer","autumn","winter"))
levels(couchto5k$season)

model1 <- lm(happiness ~ 1+season, data = couchto5k)

summary(model1)

tidy(anova(model1))
q2a<-tidy(anova(model1))


ncvTest(model1)
dwt(model1)
shapiro.test(residuals(model1))

plot(model1)

```

```{r, fig.asp = 0.6, fig.cap = "Figure 3: Residues vs fitted plot and Q-Q plot of residuals", message = FALSE}
q2a_f1<-plot(model1, which = 1)
q2a_f2<-plot(model1, which = 2)

```

```{r q2amodsum,results='asis'}
pander(model1)

q2amod<-tidy(model1)

```

The model can explian about `r summary(model1)$adj.r.squared[1]` of variability for scaled happiness scores.The F-ratio is significant (F(1,`r q2a$df[2]`)=`r q2a$statistic[1]`,p=`r q2a$p.value[1]`<.05. Furthermore, there is a significant association between autumn and happiness rating (b=`r q2amod$estimate[3]`, SE= `r q2amod$Std.Error[3]`, p<.05). It is means that if people interview in autumn, there will be a decrease of `r q2amod$estimate[3]` happiness rating for them.

We can conclude that season affect the participants' happiness rate. If we focus on a specificy season, the participants' happiness rate was affected if they join the programme at autumn.



## Question 2b
```{r q2b,include = FALSE}
model2 <- lm(happiness ~ 1 + season + age, data = couchto5k)
summary(model2)

q2b<-tidy(anova(model2))
tidy(anova(model2))

ncvTest(model2)
dwt(model2)
shapiro.test(residuals(model2))

plot(model2)
```


```{r, fig.asp = 0.6, fig.cap = "Figure 3: Residues vs fitted plot and Q-Q plot of residuals", message = FALSE}
q2b_f1<-plot(model1, which = 1)
q2b_f2<-plot(model1, which = 2)
```


```{r q2bmodsum,results='asis'}
pander(model2)

tidy(model2)
     
q2bmod<-tidy(model2)

```
we can find that knowing about age cannot improve over a model which simply includes season F(1,`r q2b$df[3]`)=`r q2b$statistic[2]`,p=`r q2b$p.value[2]`>0.05.

## Question 2c
##Incremental F-test/week8/model comparsion
```{r q2c,include = FALSE}
null_model <- lm(happiness ~ 1, data = couchto5k)
model1 <- lm(happiness ~ 1 + season, data = couchto5k)
model2 <- lm(happiness ~ 1 + season + age, data = couchto5k)

anova(null_model,model1)
anova(null_model,model2)

summary(model1)$adj.r.sq
summary(model2)$adj.r.sq

anova(model1, model2)
```


# Question 3

## Question 3a

```{r q3a,include = FALSE}
couchto5k<-
  couchto5k%>%
  mutate(
    completion=ifelse(week_stopped<9,"0","1")
  ) ##0 means not complete; 1 means finished


model3<-lm(happiness ~ 1+season+completion, data = couchto5k)
summary(model3)

tidy(anova(model3))
q3a<-tidy(anova(model3))

ncvTest(model3)
dwt(model3)
shapiro.test(residuals(model3))

plot(model3)

```

```{r q3amodsum,results='asis'}
pander(model3)

q3amod<-tidy(model3)

```

```{r, fig.asp = 0.6, fig.cap = "Figure 3: Residues vs fitted plot and Q-Q plot of residuals", message = FALSE}
q3a_f1<-plot(model3, which = 1)
q3a_f2<-plot(model3, which = 2)

```



## Question 3b

```{r q3b,include = FALSE}
model4 <- lm(happiness ~ 1+season+completion+health, data = couchto5k)
summary(model4)
coefficients(model4)
tidy(anova(model4))
    

ncvTest(model4)
dwt(model4)
shapiro.test(residuals(model4))

plot(model4)
```

```{r, fig.asp = 0.6, fig.cap = "Figure 3: Residues vs fitted plot and Q-Q plot of residuals", message = FALSE}
q3b_f1<-plot(model3, which = 1)
q3b_f2<-plot(model3, which = 2)
```

```{r q3bmodsum,results='asis'}
pander(model4)

q3bmod<-tidy(model4)


```



## Question 3c
week9/numeric*categorical
```{r q3c,include = FALSE}
model5 <- lm(happiness ~ 1+season+health+week_stopped+health:week_stopped, data = couchto5k)
coefficients(model5)
summary(model5)

ncvTest(model5)
shapiro.test(residuals(model5))
dwt(model5)

```

```{r, fig.asp = 0.6, fig.cap = "Figure 3: Residues vs fitted plot", message = FALSE}
q3b_f1<-plot(model3, which = 1)
```

```{r q3cmodsum,results='asis'}
pander(model5)

q3cmod<-tidy(model5)

```

```{r q3c figure,fig.asp=.6,fig.cap="Figure q3b: Stopped week moderating the effect of health on happiness",message=F}

library(sjPlot)

plot_model(model5,type="int")

```

## Question 3d



# Question 4

```{r q4,include = FALSE}

table_q4_completion <-couchto5k %>% 
  filter(week_stopped=="9")

```

```{r,fig.asp=.6,fig.cap="Figure. The average happiness ratings grouped by season and city", message=F}
table_q4_season <-couchto5k %>%
  filter(week_stopped=="9")%>%
  group_by(season)%>%
  summarise(mean_se(happiness))

q4_1 <- ggplot(table_q4_season, aes(x=season,y=y,ymin=ymin,ymax=ymax,fill=season))+
  geom_bar(stat="identity")+
  geom_errorbar(width=.2)+
  labs(x="Season",y="Happiness")+
  theme_bw()

table_q4_city <-couchto5k %>%
  filter(week_stopped=="9")%>%
  group_by(city)%>%
  summarise(mean_se(happiness))

q4_2 <- ggplot(table_q4_city, aes(x=city,y=y,ymin=ymin,ymax=ymax,fill=city))+
  geom_bar(stat="identity")+
  geom_errorbar(width=.2)+
  labs(x="City",y="Happiness")+
  theme_bw()


library(patchwork) #used to arrange plots

q4_1|q4_2

```



# Question 5

## Question 5a

```{r q5a,include = FALSE}

  couchto5k<-
  couchto5k%>%
  mutate(
    drop_out=ifelse(week_stopped<9,"1","0")
  ) 

couchto5k$drop_out <- as.numeric(couchto5k$drop_out)

model6<-glm(drop_out~ accountability + selfmot, data=couchto5k, family = "binomial")

summary(model6)

```


## Question 5b

## Question 5c
```{r q5c,include = FALSE}
model7<-glm(drop_out ~ selfmot, data=couchto5k, family = "binomial")
summary(model7)

```

```{r,fig.asp = 0.6, fig.cap = "Figure 11. The probability of quiting as a function of how self motivated participants were", message = FALSE}
ggplot(couchto5k, aes(x = selfmot, y = drop_out)) +
  geom_jitter(size=3, height = 0.1, width = .05, alpha = 0.5) +
  geom_smooth(method = "glm",method.args = list(family = binomial)) +
  scale_y_continuous(breaks = seq(0,1,by=.2)) +
  scale_x_continuous(breaks = seq(5,35,by=5)) +
  labs(y = "The probability of quitting", x = "Self-motivation scores")
```

