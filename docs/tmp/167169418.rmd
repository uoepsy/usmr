---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
  pdf_document: default
params:
  examnumber: B198726
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(pander)
library(broom)
library(patchwork)
library(psych)
library(sjPlot)
library(ggpubr)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
summary(couchto5k)
couchto5k$missing <- NA
couchto5k$missing[couchto5k$age>100] <- "age > 100"
couchto5k$missing[couchto5k$selfmot<5] <- "selfmot < 5"
couchto5k$missing[couchto5k$week_stopped>9] <- "week stopped > 9"


missing_tab <- table(couchto5k$missing)
couchto5k <- couchto5k %>% filter(is.na(missing))
total_obvs <- count(couchto5k)
```

The data used in this report was obtained from https://uoepsy.github.io/data/usmr_2122_data.R: a dataset containing information on 124 participants involved in the couch to 5k running program. The data contained information regarding each participants age, along with the individuals self-assessed psychometric factors of accountability and self-motivation, both recorded as the sum of 5 questions, each scored 1-7. In addition to this, there were further measures for both health and happiness of the participant (based on a scale of 0-100), along with the season the participant was interviewed in, the city in which they participated and finally the week in which the participant stopped the programme. By finishing in week 9, the participant had finished the programme.

The data were inspected in order to identify any missing or unlikely values which were then subsequently removed. This gave a remaining `r total_obvs` observations for analysis. Table 1 shows a summary of the data that were removed. These unlikely values were removed if either the age seemed extremely higher for a runner (over 100), if their psychometric measures were below the minimum of 5, or if the week in which the participant stopped in was higher than the length of the program.

```{r table, results="asis"}
missing_tab %>% pander(caption="Table 1: Summary of values removed from dataset.")
```


```{r season}
miscoded_season <- sum(couchto5k$season=="autunm")
couchto5k$season[couchto5k$season=="autunm"] <- "autumn"
couchto5k$season <- as.factor(couchto5k$season)
```

`r miscoded_season` season entries were initially misentered as "autunm". These were then recoded with the correct spelling of "autumn". There were no misentries for city.

```{r re-factoring}
couchto5k$city <- as.factor(couchto5k$city)
couchto5k$week_stopped <- as.factor(couchto5k$week_stopped)
```

Following this, the variables of city and week_stopped were then converted into factors.

```{r descriptives categorical figure, fig.asp=.6, fig.cap="Figure 1: barplots to illustrate frequencies of participants for city and season"}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 
season_barplot <- ggplot(data = couchto5k, aes(x = season)) + geom_bar() + labs(x = "Season", y = "Count", title = "Season frequencies") + theme_bw()
city_barplot <- ggplot(data = couchto5k, aes(x = city)) + geom_bar() + labs(x = "City", y = "Count", title = "City frequencies") + theme_bw()
week_barplot <- ggplot(data=couchto5k, aes(x=week_stopped)) + geom_bar() + labs(x="Week of programme participant stopped in", y="Count", title="Stopping week frequencies") + theme_bw()

ggarrange(season_barplot, city_barplot, week_barplot, ncol=2, nrow=2)

```

The graphs above in figure 1 illustrate the count of participants for each categorical variable.

```{r table for normal numerical, results="asis"}
#ggplot(data=couchto5k, aes(x=accountability)) + geom_histogram(binwidth=3)
#shapiro.test(couchto5k$accountability)
#ggplot(data=couchto5k, aes(x=selfmot)) + geom_histogram(binwidth=3)
#shapiro.test(couchto5k$selfmot)
#ggplot(data=couchto5k, aes(x=health)) + geom_histogram(binwidth=3)
#shapiro.test(couchto5k$health)

mean_table <- couchto5k %>% summarise(mean_accountability = mean(accountability), mean_selfmot=mean(selfmot), mean_health=mean(health)) %>% pander(caption="Table 2: Table of means for normally distributed numerical variables")

sd_table <- couchto5k %>% summarise(sd_accountability = sd(accountability), sd_selfmot=sd(selfmot), sd_health=sd(health)) %>% pander(caption="Table 3: Table of standard deviations for normally distributed numerical variables")

mean_table
sd_table
```


Tables 2 and 3 above are then used to display the mean and standard deviation of the continuous numerical variables that were normally distributed.
```{r descriptives numerical figure, fig.asp=.6, fig.cap="Figure 2: Plots for numerical variables that are not normally distributed"}
age_density <- ggplot(data = couchto5k, aes(x=age)) + geom_density() + xlim(0, 100) + labs(x="Age", y="Density", caption="Figure 2a: Density plot for age of participants") + theme_bw()
happiness_hist <- ggplot(data=couchto5k, aes(x=happiness)) + geom_histogram(binwidth=7) + labs(x="Happiness", y="Count", caption="Figure 2b: Histogram to illustrate the count of happiness ratings for participants in program") + theme_bw()

ggarrange(age_density, happiness_hist, ncol=1, nrow=2)
```
 
Figure 2a illustrates that it is a bimodal distribution for the age of participants and figure 2b then shows the multimodal distribution of happiness ratings for the participants, with especially high counts for participants with a happiness rating of either 0 or 100.

# Question 1 

## Question 1a

```{r q1a}
before5 <- length(couchto5k$week_stopped[couchto5k$week_stopped==1 | couchto5k$week_stopped==2 | couchto5k$week_stopped==3 | couchto5k$week_stopped==4])
after5 <- length(couchto5k$week_stopped[couchto5k$week_stopped==5 | couchto5k$week_stopped==6 | couchto5k$week_stopped==7 | couchto5k$week_stopped==8])
complete9 <- length(couchto5k$week_stopped[couchto5k$week_stopped==9])
sample_vec <- c(before5, after5, complete9)

chi_1a <- chisq.test(sample_vec, p=c(.45, .1, .45))

```

A chi-squared goodness of fit test was applied to the proportion of participants that gave up either before week 5, after week 5 or completed the program. The null hypothesis asserted that for each of these completion points in the program, the population proportions would be 45%, 10% and 45% respectively as there is no significant difference between the previous years survey and this sample. The outcome of this test (p=`r chi_1a$p.value`) has shown that there is insufficient evidence to reject the null hypothesis, therefore it can be determined that the data in this sample is in line with the data from the earlier survey.

## Question 1b

```{r q1b figure, fig.asp=.6, fig.cap="Figure 3: Proportional barchart for attrition rates across cities"}
couchto5k <- couchto5k %>%
  mutate(end_point = case_when(
    week_stopped==1 | week_stopped==2 | week_stopped==3 | week_stopped==4 ~ "before_5",
    week_stopped==5 | week_stopped==6 | week_stopped==7 | week_stopped==8 ~ "after_5",
    week_stopped==9 ~ "completed"
  ))


city_attrition <- ggplot(couchto5k, aes(x=city, fill=end_point)) + geom_bar(position="fill") + labs(x="City", y="Count") + scale_x_discrete(limits=c("Edinburgh", "Glasgow")) + guides(fill=guide_legend(title="End point in programme")) + theme_bw()
city_attrition
```
Figure 3 illustrates the rates of attrition across Edinburgh and Glasgow. It can be seen that the attrition rates across the two cities are very similar, with similar proportions of participants completing the program and dropping out before week 5 in both cities. A slightly higher proportion of participants in Glasgow drop out after week 5 than in Edinburgh.

## Question 1c

```{r q1c}
mean_edin <- couchto5k %>% filter(city == "Edinburgh") %>% summarise(mean_edin = mean(age))
mean_glasg <- couchto5k %>% filter(city == "Glasgow") %>% summarise(mean_glasg = mean(age))
```
The average ages of participants who commenced the programme do differ by city. The mean age for Edinburgh is `r mean_edin` whereas the mean age for Glasgow is `r mean_glasg`.

# Question 2

## Question 2a

```{r q2a}
#plot(model2a, which=1:4)
couchto5k <- couchto5k[-c(29, 42, 96),]
model2a <- lm(happiness ~ 1 + season, data=couchto5k)
av_hs <- tidy(anova(model2a))

```

Three influential data points were removed from the data following initial inspection of the model.
The data was then checked to see if the assumptions for a linear model were met. The residuals were fairly normally distributed, and were approximately zero across estimate y therefore indicating that there may be a linear relationship between the two variables. The sizes of the residuals across all the fitted values were also approximately even and as there was only the one predictor, there was no independence of variables to be checked.
Following the decision that the assumptions for a linear model were sufficiently met, the relationship between happiness levels across season was displayed graphically below.

```{r figure, fig.asp=.6, fig.cap="Figure 4: raw data for happiness levels for each season"}
season_happy_box <- ggplot(couchto5k, aes(x=season, y=happiness)) + geom_boxplot() + theme_bw()
season_happy_jit <- ggplot(couchto5k, aes(x=season, y=happiness)) + geom_jitter(height=0, width=.05) + theme_bw()
season_happy_box + season_happy_jit

av2a <- tidy(anova(model2a))
```


Using ANOVA a value of p<1 was obtained for the model using season as a predictor for happiness levels, therefore determining that there is not a significant relationship between season and happiness (F(1,`r av2a$df[2]`)=`r av2a$statistic[1]`, p<1).

## Question 2b

In order to determine whether happiness is affected by age, accounting for any effects discovered in (2a) above, the assumptions required for a linear model were first checked.

```{r q2b figure, fig.asp=.6, fig.cap="Figure 5: scatterplot to show relationship for raw data between age and happiness"}
#plot(model2b, which=1:4)
age_hap <- ggplot(data=couchto5k, aes(x=age, y=happiness)) + geom_point(alpha=.5) + labs(x="Age", y="Happiness") + theme_bw()
age_hap
cor_age_hap <- cor(x=couchto5k$age, y=couchto5k$happiness)

model2b <- lm(happiness ~ 1 + season + age, data=couchto5k)
av2b <- tidy(anova(model2b))
```


Figure 5 above shows that it is unlikely there is a relationship between age and happiness for participants. This is further illustrated by the low correlation value of `r cor_age_hap` between these two variables. This value being close to 0 suggests that it is unlikely there is a linear association between these two variables and higher/lower values of age do not tend to occur with higher/lower values of happiness, therefore the first assumption for a linear model is not met. 

The residuals in the model using both season and age as predictors for happiness are also relatively non-linear, but all other residual assumptions were met. Adding age as a predictor did not improve the model further over one which only included season, (F(1,`r av2b$df[3]`)=`r av2b$statistic[2]`, p<1). It was also determined by regression analysis that there was not a statistically significant relationship between age and happiness.


## Question 2c

```{r q2c}
anova(model2a, model2b) %>% pander(caption="Table 4. Table of analysis of variance for model 2a and model 2b")
adjr_2a <- summary(model2a)$adj.r.sq
adjr_2b <- summary(model2b)$adj.r.sq
```

On carrying out an anova test between the model using only season as a predictor and the model using both season and age as predictors, it can be determined that adding age as a predictor does not significantly improve the model (p>1). In addition to this, the adjusted R-squared value for the model using only season as a predictor illustrates that this model accounts for `r adjr_2a*100`% of the variance, and this then decreases to `r adjr_2b*100`% when adding age to the model. 

Therefore, the baseline model selected to use for question 3 is the model in (2a), using only the one variable of season as a predictor. Although neither of the models hold statistically significant relationships for happiness levels, adding the second predictor does not improve the model. A further justification for using model (2a) is that two of the levels within season held statistically significant relationships with happiness (autumn and summmer).
The model used (2a) is shown in the table below.

```{r table of model}
tidy(model2a) %>% pander(caption="Table 5. Table for baseline model selected")
```

# Question 3

## Question 3a

After initial inspection of the model, no data points were removed. The week in which participants stopped met the assumptions for residuals of a linear model of linearity, normality and homogeneity of variance. Due to the small sample size, the independence of season and week_stopped variables was not calculated as the chi-squared test is typically does not perform as well and is not as accurate on small sample sizes, and some of the counts within this data are relatively small.

```{r q3a}
#plot(model3a, which=1:4)
model3a <- lm(happiness ~ 1 + season + week_stopped, data=couchto5k)
pval_model3a <- glance(model3a)$p.value[1]
adjr_3a <- summary(model3a)$adj.r.sq
av3a <- tidy(anova(model3a))
```

Regression analysis was carried out in order to determine whether the week in which a participant stopped influences happiness outcomes, and gave a result of p<1 (F(1,`r av3a$df[3]`)=`r av2a$statistic[2]`, therefore indicating that there is no significant relationship between these two variables.

An ANOVA test was then used to compare this model to the baseline selected in question 2, and it was found that the more complex model did not statistically improve how the data were captured. In addition to this, the adjusted r-squared value for this model 3a shows that it accounts for  `r adjr_3a*100`% of the variance. This has decreased relative to the baseline model (`r adjr_2a*100`)%, therefore indicating that the additional predictor of week stopped is not of value for the model.

## Question 3b

```{r q3b}
#plot(model3b, which=1:4)
model3b <- lm(happiness ~ 1 + season + week_stopped + health, data=couchto5k)
pval_model3b <- glance(model3b)$p.value[1]
adjr_3b <- summary(model3b)$adj.r.sq
av3b <- tidy(model3b)
av3a3b <- anova(model3a, model3b)
```

Following initial inspection of the model, no data points were removed. It was determined that all assumptions required for a linear model were met. Again, the independence of predictor variables was not calculated due to the small sample size.

An ANOVA test was then used in order to determine if happiness was additionally affected by the health metric. On interpreting the regression analysis,  value of p<1 was obtained for the relationship between happiness and health, therefore concluding that it was not a statistically significant relationship (F(1,`r av3b$df[4]`)=`r av2b$statistic[3]`, p<1). In addition to this, by adding health as a predictor for the model, the amount of variance explained by the model had decreased to `r adjr_3b*100`%, therefore indicating that this predictor was not adding further value, and the p-value obtained using ANOVA for the two models was p<1 therefore illustrating the the complex model was not statistically better at capturing the data than the simpler model.


## Question 3c
In order to determine whether there was an interaction between the variables good health and the degree to which the participants completed the programme, the variable of week_dropped out was split into a binary yes/no for those who dropped out in weeks 1-5 vs those those who dropped out in weeks 6-9. This was what was used to then determine if there was a greater interaction between health and those who stopped in the later group rather than the earlier group.
```{r q3c, fig.asp=.6, fig.cap="Figure 6: Scatterplot to show relationship between raw data for happiness and health, for participants who stopped in the programme before week 5 vs those who stopped after week 5", message=FALSE}
model3c <- lm(happiness ~ 1 + season + week_stopped*health, data = couchto5k)
#summary(model3c)

couchto5k <- couchto5k %>%
  mutate(
    early_dropout = ifelse((week_stopped==1 | week_stopped==2 | week_stopped==3 | week_stopped==4 | week_stopped==5), "Yes", "No")
  )
tidy_3c <- tidy(model3c)
plot3c1 <- ggplot(data=couchto5k, aes(x=health, y=happiness, colour=season)) + geom_point() + geom_smooth(method="lm") + facet_wrap(~early_dropout) + theme_bw()
plot3c1
```
The facet plot above illustrates the relationship between health and happiness for those participants that dropped out of the programme. "No" is for the participants who dropped out later in weeks 6-9 and yes is for those that dropped out earlier in weeks 1-5.
Initially it appears that the general trend for those that dropped out later is a positive linear one, and for those that dropped out earlier is a negative linear one. On looking at the data though, it appears that this may also be due to the season in which participants were interviewed in, as nearly all of those who were interviewed in spring were those that dropped out early.

## Question 3d
It can be concluded that the most influential predictor for happiness is most likely season, as it gives the highest adjusted r-squared value and in addition to this, there is a statistically significant relationship between two of the levels and happiness.
It can also be concluded that health, week stopped and age both do not seem to be statistically significant predictors for happiness as when added to a model as a variable, there was no improvement in accounting for the variance of the model.

# Question 4

```{r q4, fig.asp=.6, fig.cap="Figure 7: Clustered bar chart of mean happiness level of participants, grouped by city and season"}
completed_ppl <- couchto5k %>% filter(week_stopped==9)
avg_spring_ed <- mean(completed_ppl$happiness[completed_ppl$city=="Edinburgh" & completed_ppl$season=="spring"])
avg_sum_ed <- mean(completed_ppl$happiness[completed_ppl$city=="Edinburgh" & completed_ppl$season=="summer"])
avg_aut_ed <- mean(completed_ppl$happiness[completed_ppl$city=="Edinburgh" & completed_ppl$season=="autumn"])
avg_wint_ed <- mean(completed_ppl$happiness[completed_ppl$city=="Edinburgh" & completed_ppl$season=="winter"])

avg_spring_gl <- mean(completed_ppl$happiness[completed_ppl$city=="Glasgow" & completed_ppl$season=="spring"])
avg_sum_gl <-mean(completed_ppl$happiness[completed_ppl$city=="Glasgow" & completed_ppl$season=="summer"])
avg_aut_gl <- mean(completed_ppl$happiness[completed_ppl$city=="Glasgow" & completed_ppl$season=="autumn"])
avg_wint_gl <- mean(completed_ppl$happiness[completed_ppl$city=="Glasgow" & completed_ppl$season=="winter"])

season <- c(rep("spring", 2), rep("summer", 2), rep("autumn", 2), rep("winter", 2))
city <- rep(c("Edinburgh", "Glasgow"), 4)
value <- c(avg_spring_ed, avg_spring_gl, avg_sum_ed, avg_sum_gl, avg_aut_ed, avg_aut_gl, avg_wint_ed, avg_wint_gl)

avg_data <- data.frame(season, city, value)

avg_city_season <- ggplot(avg_data, aes(fill=city, x=season, y=value)) + geom_bar(position="dodge", stat="identity") + theme_bw()
avg_city_season
```


# Question 5

## Question 5a

In order to build a model to predict the likelihood of dropping out at all, the variables used in the generalised linear model had to be selected. This was done by creating an initial model using all possible predictor variables, and then selecting those that were shown to have a statistically significant effect on whether a participant drops out.
The variables that met this criteria were age, selfmot and health.
A generalized linear model was then created using these predictors, as shown below.

```{r q5a}
couchto5k <- couchto5k %>%
  mutate(
    is_droppedout = ifelse(week_stopped==9, 0, 1)
  )

#mod <- glm(is_droppedout ~ age + accountability + selfmot + health + happiness + season + city, data=couchto5k, family="binomial")
model5a <- glm(is_droppedout ~ age + selfmot + health, data=couchto5k, family="binomial")

tidy(model5a) %>% pander(caption="Table 6 for coefficients from raw data for participants dropping out")

```

## Question 5b

```{r q5b}
exp(coef(model5a)) %>% pander(caption="Table 7 of exponetiated coefficients from model (5a)")
```
Table 7 above shows that for every year older someone is, the odds of dropping out decreases by 0.88, and for every point more self-motivated someone is, the odds of dropping out decreases by 0.747. It also shows that for every point healthier someone considers themselves to be, the odds of dropping out decreases by 0.9295.

## Question 5c

```{r q5c figure, fig.asp=.6, fig.cap="Figure 8: Graph to represent the probability of quitting as a function of how self motivated participants were"}
model5c <- glm(is_droppedout ~ selfmot, data=couchto5k, family="binomial")
selfmot100 <- tibble(selfmot = 1:100)

selfmot100 <-
  selfmot100 %>% 
  mutate(
    pred_probs = predict(model5c, newdata=selfmot100, type="response")
  )

prob_mod <- ggplot(data=selfmot100, aes(x=selfmot, y=pred_probs)) + geom_line() + labs(x="self motivation", y="predicted probability of dropping out") + theme_bw()
prob_mod
```







