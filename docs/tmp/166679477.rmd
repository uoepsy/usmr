---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
  pdf_document: default
params:
  examnumber: "B179773"
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0 - Have a look at the data. Check for impossible values and deal with these in an appropriate manner. Describe the data, either in words or using suitable graphs (or a combination). Remember to detail the decisions you have made.
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 

summary(couchto5k)

#Age
ggplot(data = couchto5k, aes(age)) + geom_boxplot()
# Two outliers identified age 133 and 134
couchto5k <- 
  couchto5k %>%
  mutate(age = ifelse(age>132,NA, age))

#Accountability
ggplot(data = couchto5k, aes(accountability)) + geom_boxplot()
# One outlier was identified; ID49 with a score however the score of 6 is still a possible value as the range of possible scores on accountability is 5-35 and therefore this score is plausible and there is not enough reasoning to remove it from the dataset.

#Selfmot
ggplot(data = couchto5k, aes(selfmot)) + geom_boxplot()
#Two impossible values detected - a score of -99 reported for 2 participants however the range of scores on the selfmot scale is from 5-35 and therefore these values must be removed.
couchto5k <- 
  couchto5k %>%
  mutate(selfmot = ifelse(selfmot< -98,NA, selfmot))

#Health
ggplot(data = couchto5k, aes(health)) + geom_boxplot()
#The boxplot did not show any clear outliers and upon inspecting the data, no impossible values were observed.

#Happiness
ggplot(data = couchto5k, aes(happiness)) + geom_boxplot()
#No outliers or impossible values.

#Week stopped
ggplot(data = couchto5k, aes(happiness)) + geom_boxplot()
#One impossible value identified, value of 13 in a 9 week programme
couchto5k <- 
  couchto5k %>%
  mutate(week_stopped = ifelse(week_stopped >9,NA, week_stopped))

#Seasons
#Autumn spelled wrong 
couchto5k$season<- as.factor(couchto5k$season)
levels(couchto5k$season)
couchto5k <-  
  couchto5k %>% 
  mutate(season = (gsub("autunm","autumn",season)))

```

```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 
summary(couchto5k)

Age_Distr <- ggplot(data = couchto5k, aes(age)) + geom_density()
Acc_Distr <- ggplot(data = couchto5k, aes(accountability)) + geom_density()
Selfmot_Distr <- ggplot(data = couchto5k, aes(selfmot)) + geom_density()
Health_Ditr <- ggplot(data = couchto5k, aes(health)) + geom_density()
Happ_Disrt <- ggplot(data = couchto5k, aes(happiness)) + geom_density()
WS_Distr <- ggplot(data = couchto5k, aes(week_stopped)) + geom_density()



library(patchwork)
Age_Distr | Acc_Distr | Selfmot_Distr
Health_Ditr | Happ_Disrt | WS_Distr

shapiro.test(couchto5k$age)
shapiro.test(couchto5k$accountability)
shapiro.test(couchto5k$selfmot)
shapiro.test(couchto5k$health)
shapiro.test(couchto5k$happiness)
shapiro.test(couchto5k$week_stopped)

```

# Question 1 

## Question 1a - In an earlier nationwide survey, researchers found that 45% of participants abandoned the programme before the halfway point in week 5, and a further 10% gave up before the end of the programme. Is the data in the sample you have been given in line with data from the earlier survey? Once you have created a suitable variable to map to the information in the question, you should be able to answer this using a simple statistical test.


```{r q1a}
# Creating subsets of week stopped data to group into 3 categories based on when each finished/dropped out
week_stopped_data <- couchto5k %>%
  select(week_stopped) %>%
  mutate(week_stopped_group = case_when (
    week_stopped < 5 ~ "B5",
    week_stopped > 4 & week_stopped < 9 ~ "A5",
    week_stopped > 8 ~ "C"))

# Putting the subset into the main data as another column
couchto5k$WS <- week_stopped_data$week_stopped_group

#Chi Square Goodness of fit to compare to data in the Q
chisq.test(table(week_stopped_data$week_stopped_group), p = c(.1,.45,.45))
prop.table(table(week_stopped_data$week_stopped_group))*100

#Visualising the data
couchto5k$WS <- factor(couchto5k$WS, levels = c("B5","A5","C"))
ggplot(data = couchto5k, aes(x = WS, fill = WS, na.rm = TRUE)) +
    geom_bar(na.rm = TRUE) +
    labs(x = "- Week Stopped -")


```

## Question 1b - Using the same three categories (stopped before week 5, stopped after week 5, completed), examine whether the patterns of attrition rates differ by city.

```{r q1b}
chisq.test(couchto5k$WS, couchto5k$city)

#Visualising
plot(table(couchto5k$WS, couchto5k$city))
```

## Question 1c

```{r q1c}
t.test(couchto5k$age ~ couchto5k$city)

```

# Question 2

## Question 2a - Are participants’ happiness ratings affected by the season they were interviewed in? Describe the way in which season influences happiness outcomes.

```{r q2a}
# Make new data set with age N/A removed
modified_age <- 
  couchto5k[-c(10,42),]

#Run model for season happiness
Season_Happiness <- 
lm(happiness ~ 1 + season, data=modified_age)

#Cooks Distance
plot(Season_Happiness,which=4)

# Removing pps 65, 61 and 10
modified_age <- modified_age[-c(67),]
modified_age <- modified_age[-c(63),]
modified_age <- modified_age[-c(10),]

#Rerun Cooks Distance
Season_Happiness <- 
lm(happiness ~ 1 + season, data=modified_age)
plot(Season_Happiness,which=4)

# Removing pps 9
modified_age <- modified_age[-c(9),]

Season_Happiness <- 
lm(happiness ~ 1 + season, data=modified_age)
plot(Season_Happiness,which=4)

# Visualise model
plot(Season_Happiness)
ggplot(data=modified_age, aes(x=happiness,y=season, color=season)) + 
  geom_boxplot()

# Interpreting the data
coef(Season_Happiness)
summary(Season_Happiness)
sigma(Season_Happiness)


```

## Question 2b

```{r q2b}
# Multiple regression model
SeasonAge_Happiness <- lm(happiness ~ 1 + season + age, data=modified_age)

# Cooks Distance
plot(SeasonAge_Happiness,which=4)

# Visualise model
plot(SeasonAge_Happiness)

# Interpreting the model
coef(SeasonAge_Happiness)
summary(SeasonAge_Happiness)
sigma(SeasonAge_Happiness)

# Comparing models
anova(Season_Happiness, SeasonAge_Happiness)


```

## Question 2c - The models you have built above explore ‘baseline’ effects; that is, effects that are not of primary interest to the researchers but which might affect the outcome variable of happiness. For use in question 3, pick a specific baseline model and justify why you are using this.

```{r q2c}
Season_Happiness <- 
lm(happiness ~ 1 + season, data=modified_age)

SeasonAge_Happiness <- 
  lm(happiness ~ 1 + season + age, data=modified_age)

# Null model happiness
Null_Happiness <- 
  lm(happiness ~ 1, data = modified_age)

# Model comparison vs simple linear model 
anova(Null_Happiness, Season_Happiness)


# Model comparison vs multiple linear model
anova(Null_Happiness, SeasonAge_Happiness)

# Comparison of the two models 
anova(Season_Happiness, SeasonAge_Happiness)


# Visualising the models
plot(Season_Happiness)
plot(SeasonAge_Happiness)
```

# Question 3

## Question 3a - Building on your baseline model, are participants’ happiness ratings affected by whether or not they completed the programme? Describe the way in which programme completion influences happiness outcomes.

```{r q3a}
# Using seasons happiness model bc plot is more normally distributed
WK_Complete <- 
  modified_age %>%
  select(week_stopped) %>%
  mutate(WK_Complete = case_when(
    week_stopped < 9 ~ "No",
    week_stopped > 8 ~ "Yes"))
modified_age$WK_Complete <-
  WK_Complete$WK_Complete

# Make the model
Season_Happiness_WKC <- lm(happiness ~ 1 + season + WK_Complete, data = modified_age)

# Cooks Distance
plot(Season_Happiness_WKC,which=4)

# Removing pps 81 and 57
modified_age <- modified_age[-c(81),]
modified_age <- modified_age[-c(57),]
Season_Happiness_WKC <- lm(happiness ~ 1 + season + WK_Complete, data = modified_age)

# Rerunning Cooks Distance
plot(Season_Happiness_WKC,which=4)

# Plot the model
plot(Season_Happiness_WKC)

# Interpreting the model
coef(Season_Happiness_WKC)
summary(Season_Happiness_WKC)
```

## Question 3b

```{r q3b}
# Adding to the model
Season_Happiness_Health <- lm(happiness ~ 1 + season + health, data = modified_age)

# Running Cooks Distance
plot(Season_Happiness_Health, which = 4)
# Removing values continued to create more influencial values

#Interpreting the model
coef(Season_Happiness_Health)
summary(Season_Happiness_Health)
```

## Question 3c - It’s been hypothesised that the effects of good health are amplified by the feeling of acting healthily, such that the happiness of participants who got further along the programme might be more affected by the health metric than that of those who stopped earlier. Building on the model in (3b), can you test this hypothesis?

```{r q3c}
# Making the model
Q3c_model <- lm(happiness ~ 1 + season + health:week_stopped, data = modified_age)

# Running Cook's Distance
plot(Q3c_model, which = 4)

# Removing pps 76
modified_age <- modified_age[-c(76),]

Q3c_model <- lm(happiness ~ 1 + season + health:week_stopped, data = modified_age)
plot(Q3c_model, which = 4)

#Analyse the model
coef(Q3c_model)
summary(Q3c_model)

# Removing value to make data frames same size
modified_age <- modified_age[-c(42),]

# Rerunning all models to take out N/A value and have the same data frame size
Q3c_nullmodel <- lm(happiness ~ 1 + season + week_stopped, data = modified_age)
Q3c_BaselineModel <- lm(happiness ~ 1 + season, data = modified_age)
Q3c_HealthModel <- lm(happiness ~ 1 + season + health, data = modified_age)

# ANOVAS
anova(Q3c_BaselineModel, Q3c_nullmodel)
anova(Q3c_BaselineModel, Q3c_HealthModel)

# Plotting the model
coef(Q3c_nullmodel)
summary(Q3c_nullmodel)

plot(x = couchto5k$happiness, y = couchto5k$week_stopped, pch = 20, col = "lightblue")
plot(x = couchto5k$happiness, y = couchto5k$health, pch = 20, col = "lightpink")

```

## Question 3d - What can we conclude about the various causes of happiness in our data? Write a brief description of the effects in the model, such as you might find in an academic paper.


# Question 4 - Create a subset of the data, including only those participants who completed the programme. Create a plot of the average happiness ratings grouped by season and city, that can be used in a presentation to the funders of the project.

```{r q4}
#Creating the subset
Q4_subset <- subset(couchto5k, WS == "C")

# Making the plot
ggplot(data=Q4_subset, aes(happiness, city, fill=season)) + 
    geom_boxplot(alpha=0.3) +
    facet_wrap(~season) +
    scale_fill_brewer(palette="Dark2")
```


# Question 5

## Question 5a - Build a model that predicts the likelihood of dropping out (at all).

```{r q5a}
# Creating a separate column for drop out
Dropout <- couchto5k %>%
  select(week_stopped) %>%
  mutate(week_stopped_group = case_when (
    week_stopped < 9 ~ "Dropout",
    week_stopped > 8 ~ "Complete" ))

couchto5k$DO_Rate <- Dropout$week_stopped_group

# Making the variable numeric
DO_Rate <- couchto5k$DO_Rate %>% factor(c("Dropout","Complete"))
couchto5k$DO_Rate %>% factor(c("Dropout","Complete"))
couchto5k$DO_Rate<- as.factor(couchto5k$DO_Rate)
couchto5k$DO_Rate <- as.factor(DO_Rate)

# Pairs panel to establish correlation
library(psych)
pairs.panels(couchto5k)


# Running individual models to determine which ones are significant
DO_Seasons <- glm(DO_Rate ~ 1 + season, data = couchto5k, family = "binomial")
coef(DO_Seasons)
summary(DO_Seasons)

DO_Selfmot <- glm(DO_Rate ~ 1 + selfmot, data = couchto5k, family = "binomial")
coef(DO_Selfmot)
summary(DO_Selfmot)

# Creating the model
DO_model <- glm(DO_Rate ~ 1 + season + selfmot, data = couchto5k, family = "binomial")

# Cooks Distance
plot(DO_model, which = 4)

# Removing influencers
couchto5k <- couchto5k[-c(9),]
couchto5k <- couchto5k[-c(25),]
couchto5k <- couchto5k[-c(87),]

# Rerunning Cooks Distance & model
DO_model <- glm(DO_Rate ~ 1 + season + selfmot, data = couchto5k, family = "binomial")
plot(DO_model, which = 4)
# More influencers created so no more removed

```

## Question 5b - Briefly describe the effects in your model as you would in an academic paper.

```{r q5b}
summary(DO_model)
coef(DO_model)

anova(DO_model, test = "Chisq")

```

## Question 5c - Draw a graph representing the probability of quitting as a function of how self motivated participants were.

```{r q5c}

couchto5k <- couchto5k %>%
  mutate(Q5DO = ifelse(DO_Rate == "Dropout", 0, 1))

ggplot(data = couchto5k, aes(x = selfmot, y = Q5DO, color = Q5DO)) +
  labs(x = "Self Motivation", y = "Probability of Dropout") +
  geom_jitter(size = 3, width = 0, height = .2, alpha = .2) +
  scale_y_discrete(breaks = seq(0, 1, by=.2)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"))

```










