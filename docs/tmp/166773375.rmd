---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
  word_document: default
params:
  examnumber: "B198891"
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(pander)
library(broom)
library(psych)
library(sjPlot)
library(readxl)
library(lsr)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->

Cleaning & Describing

   This dataset contains information on 138 participants, including age, season of the year participants were interviewed in, city of participants was recruited in, and the week of program participant stopped. Participants were required to complete a questionnaire measuring the psychometric factors of accountability and self-motivation. These two factors both include 5 questions, each scored 1-7 and only total scored are available, giving minimum and maximum possible scores of 5 and 35 respectively. Participants also completed a questionnaire which include a measure of their self-reported happiness, and a “health” measure, which both take values from 0-100.
```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
couchto5k$missing <- NA
couchto5k$missing[couchto5k$age>100] <- "crazy age"
couchto5k$missing[couchto5k$selfmot<0]<- "selfmot<0"
couchto5k$missing[couchto5k$week_stopped>9] <- "Over 9 weeks"
mtab <-table(couchto5k$missing)

couchto5k <- couchto5k %>% filter(is.na(missing))
total <- count(couchto5k)

```

  
```{r season}
miscoded <- sum(couchto5k$season=='autunm')
couchto5k$season[couchto5k$season == "autunm"] <- 'autumn'
couchto5k$season<-as.factor(couchto5k$season)

```
   The data were inspected and unlikely values were removed, resulting in `r total` observations for analysis. Table 1 gives a summary of removed data. `r miscoded` of season entries were initially misentered as "autunm". These were recoded as "autumn".
  
```{r table, results='asis'}

mtab %>% pander(caption="Table 1: Summary of removed values.")

```




All participants data was complete (no missing values), with values on the age, accountability, self-motivation, health and happiness (See Table 2).
   
```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 
t2<-describe(couchto5k %>% select(age, accountability,selfmot,health,happiness)) [,c(2:4,8:9)]
t2 %>% pander(caption="Table2: Descriptive statistics of variables.")

```

# Question 1 

## Question 1a
```{r q1a}
couchto5k$persistence <- 2
couchto5k$persistence[couchto5k$week_stopped>8] <- 3
couchto5k$persistence[couchto5k$week_stopped<5] <- 1

expected_n <-c(133*0.45, 133*0.1, 133*0.45)
observed<-table(couchto5k$persistence)
ka<-chisq.test(tibble(observed,expected_n))
```

I created a variable called "persistence" which has 3 levels. "1" is for participants who abandoned the programme at week 1, 2, 3, 4. "2" is for participants who abandoned the programme at week 5, 6, 7, 8. And "3" is for participants who stopped the programme at week 9. I conducted χ2-test and the results showed that there was no difference between the data in the sample and in the earlier survey, χ2(2) = `r ka$statistic %>% round(2)`, p > .05.


## Question 1b

```{r q1b}
tablecity<-table(couchto5k$persistence,couchto5k$city)
kaa<-chisq.test(table(couchto5k$persistence,couchto5k$city))

```
There was no significant difference of patterns of attrition rates between Edinburgh and Glasgow, χ2(2) = `r kaa$statistic %>% round(2)`,p > .05.

## Question 1c

```{r q1c}
test1<-t.test(x=couchto5k$age[couchto5k$city == "Edinburgh"], y=couchto5k$age[couchto5k$city == "Glasgow"])
```

  An independent sample t-test was conducted in order to determine if the average age of participants in Edinburgh and Glasgow was significantly different ( $\alpha = .05$).There was no difference of average of participants who commenced the programme between Edinburgh (Mean=`r mean(couchto5k$age[couchto5k$city == "Edinburgh"]) %>% round(2)`, SD=`r sd(couchto5k$age[couchto5k$city == "Edinburgh"])%>% round(2)`) and Glasgow(Mean=`r mean(couchto5k$age[couchto5k$city == "Glasgow"])%>% round(2)`, SD=`r sd(couchto5k$age[couchto5k$city == "Glasgow"])%>% round(2)`), t(78) = `r test1$statistic %>% round(2)`, p > .05.

# Question 2

## Question 2a

```{r q2a}
boxplot(happiness ~ season, data = couchto5k, main = "Happiness data", border = c("red","blue","black","green"),col=c("white","white","white"))

```


To investigate whether participants' happiness ratings are affected by the season they were interviewed, I created a linear model where we predict happiness from season. The results showed that participants' happiness were affected by season, F(3,129)=2.75, p < .05.


```{r}
s1<-lm(happiness~season, data=couchto5k)
tab_model(s1)

```



## Question 2b

```{r q2b}
ggplot(data=couchto5k,aes(x=age, y=happiness))+
  geom_point()

```


To investigate whether, when controlling for season, participants' happiness  were affected by age, ratings on participants' happiness were modelled using multiple linear regression. The model including season and age is summarsied below. We performed an F-test for the overall significance of the regression, F(4,128) = 2.23, p > .05, indicating that participants' happiness  were not affected by age, after controlling season.


```{r}
a1<-lm(happiness~age+season, data=couchto5k)
tab_model(a1)

```



## Question 2c
Model 2a showed that participants' happiness ratings were predicted by season, while model 2b showed that age did not predict participants' happiness ratings, when controlling for the effect of season. So, I pick season model as the baseline model.
```{r q2c}

```

# Question 3

## Question 3a

I create new variable "victory" to identify whether participants completed the programme. “1”means completed, and "0" means not completed. Based on the baseline model, I  created a mutiple linear model. 

$$
\text{Happiness} = \beta_0 + \beta_1 \text{S} + \beta_2 \text{V} +  \epsilon  \\
\begin{align}
\text{Where} \\
& \text{S = Season} \\
& \text{V = Victory} \\
\end{align}
$$

The results showed participants' happiness ratings were not affected by  whether or not they completed the programme.

```{r q3a}
couchto5k<-couchto5k%>%
  mutate(
    victory = ifelse(week_stopped == 9, 1,0)
  )
modv<-lm(happiness~season+victory, data=couchto5k)
tab_model(modv)

```

## Question 3b
Based on the analysis in 3a, there is the multiple linear model.

$$
\text{Happiness} = \beta_0 + \beta_1 \text{S} + \beta_2 \text{V} + \beta_3 \text{H} + \epsilon  \\
\begin{align}
\text{Where} \\
& \text{S = Season} \\
& \text{V = Victory} \\
& \text{H = Health Metric} \\
\end{align}
$$

The results showed participants' happiness ratings were not additionally affected by the "health metric".

```{r q3b}
modhealth<- lm(happiness~season+victory+health, data=couchto5k)
tab_model(modhealth)

```

## Question 3c
Based on the hypothesis, I created a model to test it.

$$
\text{Happiness} = \beta_0 + \beta_1 \text{S} + \beta_2 \text{V} + \beta_3 \text{H} +\beta_4 \text{WH} \epsilon  \\
\begin{align}
\text{Where} \\
& \text{S = Season} \\
& \text{V = Victory} \\
& \text{H = Health Metric} \\
& \text{VH = Victory*Health Metric} \\
\end{align}
$$

It was confirm that that the effects of good health are amplified by the feeling of acting healthily.

```{r q3c}
modvh<-lm(happiness~season+victory+health+victory*health, data=couchto5k)
tab_model(modvh)

stanB<-standardCoefs(modvh)
```


## Question 3d
As shown in the table above, after controlling for season, the length of  project involvement (b= -1.99, SE= 33.37, p < .001 )and health (b= -0.44 , SE= 0.43, p = .001) were negatively associated with participants' happiness ratings. Furthermore, the results showed that health moderated the association between the length of project involvement and happiness (b= 1.99 , SE= 0.56, p < .001).


# Question 4

```{r}
SWdata<-read_xlsx(path ="SWdata.xlsx")

SWdata$Season<-factor(SWdata$Season, levels=c("Spring","Summer","Autumn","Winter"))
q1<-ggplot(SWdata, aes(x=Season, y=Happiness, fill=City))+
  geom_bar(stat="identity",position = position_dodge(0.9))+
  coord_cartesian(ylim=c(0,100))+ #设置y 范围
  theme_classic()+
  labs(title = "Seasonal happiness ratings for Edinburgh and Glasgow", x="Season", y="Average happiness ratings")+
  theme(plot.title = element_text(hjust = 0.5))
 
q1

```

# Question 5

## Question 5a

The likelihood of participants dropping out the project is modelled using a simple linear regression, with self-motivation (measured from 1-35).

$$
\text{Quitting} = \beta_0 +\beta_1 \text{M} + \epsilon  \\
\begin{align}
\text{Where} \\
& \text{M = Self-motivation} \\
\end{align}
$$



```{r q5a}
couchto5k<-
  couchto5k%>%
  mutate(
    Quitting = -week_stopped
  )

```

```{r}
m1<-lm(Quitting~1+selfmot, data=couchto5k)

```



## Question 5b

```{r q5b}
stanm1<-standardCoefs(m1)
```
Self-motivation (b= -0.33, SE= 0.09, p < .001 ) was negatively associated with the likelihood of dropping out the project.

## Question 5c
```{r q5c}
couchto5k%>%ggplot(aes(x=selfmot, y=Quitting))+
  geom_point()+
  geom_smooth(method = "lm",formula = 'y ~ x')+
  theme_bw()
```








```{r}

```

```{r}

```

