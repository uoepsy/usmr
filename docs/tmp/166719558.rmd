---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
  pdf_document: default
params:
  examnumber: "B191013"
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(pander)
library(broom)
library(knitr)
library(patchwork)
library(papaja)
library(ggplot2)
library(ggpubr)
library(car)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}

# Neither output nor code from this chunk will be shown in the compiled document. 

#####DID MY OWN CLEANING AND NOT THE ONE THAT PROF.MARTIN SUGGESTED CAUSE I HAD AN UNEXPECTED ERROR ONLY IF I RAN IT THE SECOND TIME

#SUMMARY SHOWS A negative Minimum value FOR SELFMOT
#SUBSTITUTING VALUE WITH AN 'NA' FOR THAT VALUE CAUSE OTHER DATAPOINT ARE ALRIGHT FOR THAT PARTICULAR SUBJECT
couchto5k <- 
  couchto5k %>% 
  mutate(selfmot = ifelse(selfmot< -1, NA, selfmot)
        )

#NEXT IN WEEK STOPPED WE WILL REMOVE THE ENTIRE ROW THAT HAS BEEN CODED IN WITH WEEK 14, BECAUSE DATA BEYOND 9 WEEKS IS NOT RELEVANT, AND IS OF NO USE TO US, SO WE CAN'T LET THAT IMPACT OUT RESULTS IN ANYWAY. 
couchto5k <- couchto5k [!(couchto5k$week_stopped== 14),]

#THEN THERE IS AN AGES OF 149, WE WILL REMOVE ANY AGE ABOVE 100 CAUSE THAT LOOKS UNLIKELY - PUT THEM AS NA
couchto5k <- 
  couchto5k%>% mutate(age = ifelse(age > 100, NA, age)) 

#CHANGING A FEW AUTUNM TO AUTUMN FOR CLEANING 
couchto5k <- 
  couchto5k %>% 
  mutate(season = ifelse(season == "autunm", "autumn", season))

#NEXT WAT TO CHANGE SEASON and CITY TO FACTOR CAUSE R HAS TAKEN THEM AS CHARACTER - STRINGS
couchto5k$season <- as.factor(couchto5k$season)
couchto5k$city <- as.factor(couchto5k$city)

#check data frame again with SUMMARY
summary(couchto5k)

```

#First, the data was looked at by the help of the head function. Then the summary was generated through the summary function - in order to view the basic descriptive statistics, and visually inspect data concerning any potential impossible values and/or outliers that may need to be dealt with.

#Impossible values were observed for age and self motivation. Wherein there were two values above hundred for age and two values -99 for self-motivation. These values were replaced with NA.
#Furhermore, an outlier was detected in the variable for weeks. Hence, the entire row for the week of 14 was removed as the program and other variables are supposed to be related to week 9 and below. We could not be sure if the week was originally suppsed to be entered as 1 or 4, so as per our descretion, we decided to remove data obtained from that participant, as our research project was focusing on subjects within the bandwidth of 1 - 9 weeks. 

#Additonally, in the variable seasons: two values were mis-entered as autunm, so they were changed to autumn. 

#After taking care of missing values and outliers, our resulting data frame consisted of 127 observations from the original 128 for final analysis.


```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 


#LETS CREATE A TIBBLE TO SEE IF WE GOT IT RIGHT NOW [CREATING A SUMMARY TIBBLE FOR EYE BALLING DATA - THIS SHOULD BE "DESCRIPTION OF DATA" ENOUGH]
datadescrip <- couchto5k %>% 
  summarize(
    mean_age = mean(age, na.rm = T), 
    sd_age = sd(age, na.rm = T),
    mean_account = mean(accountability),
    sd_account = sd(accountability),
    mean_selfmot = mean(selfmot, na.rm = T),
    sd_selfmot = sd(selfmot, na.rm = T),
    mean_health = mean(health),
    sd_health = sd(health),
    mean_happ = mean(happiness),
    sd_happ = sd(happiness)
    )

#CREATING A DESCRIPTIVE TABLE

datadescrip %>% pander(caption = "Table 1.0: Descriptive statistics across the 5 variables of interest in the coucht to 5 K program")

```
###ANALYSIS BEGINS

# Question 1 

## Question 1a

```{r q1a, message=F}

#GOING TO CREATE THREE COLUMNS FOR QUITTING BEFORE WEEK 5, AFTER WEEK 5 AND COMPLETEING PROGRAM ON WEEK 9

couchto5k <- 
  couchto5k %>% 
  mutate(
    before_week5 = week_stopped < 5,
    after_week5 = week_stopped >= 5 & week_stopped < 9,
    on_week9 = week_stopped == 9
  )

 #CALCULATING MEAN OF HOW MANY QUIT BEFOREW WEEK 5 (bw5)
mean(couchto5k$before_week5, na.rm = T) #proportion that gave up before week 5 = 0.394 

#NOW A T-TEST WITH OLD MEAN TO SEE IF THERE IS A MEANINGFUL DIFFERENCE?
#bw5 <- t.test(couchto5k$before_week5, mu = .45, alternative = "two.sided")
bw5 <- prop.test(x = 50, n = 127, p = 0.45, correct = FALSE)

bw5%>% pander(caption = "Table 1.1 Proportion test result for participant attrition of subjects in the current sample for before week 5 compared to previous years cohort")

#############

#PROP TEST FOR ON OR AFTER WEEK 5 
mean(couchto5k$after_week5, na.rm = T) #proportion that gave up before week 9 = 0.575

#aw5 <- t.test(couchto5k$after_week5, mu = .10, alternative = "two.sided")
aw5 <- prop.test(x = 14, n = 127, p = 0.10, correct = FALSE)

aw5 %>% pander(caption = "Table 1.2 Proportion test results for participant attrition of subjects in the current sample for after week 5 compared to previous years cohort")
```
#A two-sided one-sample z - test was conducted to test if the participant attrition before week 5 for the current sample was statistically different from that of the previous years subject cohort. X2(1) = 1.626, p = 0.20, [95% CI = 0.31, 0.48], M = 0.394.
#The participant attrition rate for after week 5 is not statistically different from previous years subject cohort either. X2(1) = 0.14, p = 0.70, M = 0.11.
#A propotion test was used for this given question, as the analysis was proceeded by converting the estimate of drop-out into logical variables, which converted our values to proportion data - and proportions are not exactly fit for the t distribution. 


## Question 1b

```{r q1b}

#NOW WE WILL CACLULATE IF THERE IS STATISTICALLY SIGNIFICATN DIFFERENCE IN THEIR MEANS ACROSS THESE THREE CONDITIONS
#ED VS GLAS

#bw5mod <- with(couchto5k, t.test(before_week5 ~ city, alternative = "two.sided"))
bw5mod <- prop.test(x = c(37, 13), n = c(91, 36), alternative = "two.side", correct = F)

#aw5mod <- with(couchto5k, t.test(after_week5 ~ city, alternative = "two.sided"))
aw5mod <- fisher.test(matrix(c(12, 91-12, 2, 36-2), ncol=2))


#complmod <- with(couchto5k, t.test(on_week9 ~ city, alternative = "two.sided"))
complmod <- prop.test(x = c(42, 21), n = c(91, 36), alternative = "two.side", correct = F)


panderOptions("table.split.table", 105)
bw5mod %>% pander(caption = " Table 1.3 Proportion-test results for drop-out rate difference across the two cities for before week 5")
aw5mod %>% pander(caption = "Table 1.4 Fisher test results for drop-out rate difference across the two cities for after week 5 ")
complmod %>% pander(caption = "Table 1.5 Proportion-test results for completion rate difference across the two cities")


```
#T-TEST : The drop-out rate is not statistically different across the two cities of Edinburgh and Glasgow for before and after week 5. Neither is the completion rate different across cities as seen in Table 1.3, 1.4 & 1.5. The two-sample proportion test was conducted for the following question. Fishers exact test was used for after week 5, as the number of successes was less than 5 (<5) for Glasgow.

## Question 1c

```{r q1c, Message = F}
#DOES THEIR AGE DIFFER BY CITY?
#Normality check 
#shapiro.test(couchto5k$age) # WAS DONE IN CONSOLE 


ggplot(data = couchto5k, aes(x = age)) + 
  geom_histogram(bins=10)+labs(title = "Histogram for normality check of variable age")

#The test itself
TAgeMod <- with(couchto5k, t.test(age ~ city, alternative = "two.sided"))

#panderOptions("table.split.table", 105)
#TAgeMod %>% pander(caption = "Table 1.6 Results for differnce in ages across the two cities")
```
#The group means of age between the two cities are not statistically different t(59) = -0.04, P-VALUE = 0.97. Med = 39.3, Mglas = 39.4. There dsitribution of age is non-normal, but with sufficient observations in our dataset, the t-test is robust aginst violations of normaility. Hence, we continued with our t-test for the same.


# Question 2

## Question 2a

```{r q2a}

#VISUALISE to check if happiness meets assumptions 
happass <- ggplot(data = couchto5k, aes(x=happiness))+
  geom_density()+ geom_boxplot(width = 1/500)
 
#RELATIONSHIP BETWEEN SEASON AND HAPPINESS
seashapass <- ggplot(data = couchto5k, aes(x = season, y = happiness)) +
  geom_point(alpha = 0.5)+
  labs( x= "season", y = "happiness")

#Patchwork to join them together
happass | seashapass

#TEST TO SEE IF SEASON AFFECTS HAPPINESS IN SAMPLE 
weathap <- lm(happiness ~ 1 + season, data = couchto5k)

#panderOptions("table.split.table", 105)
#summary(weathap) %>% pander(caption = "Table 1.7 Baseline model: If seasons influence happiness ratings")

#DIAGNOSTICS
par(mfrow=c(2,2))
plot(weathap)
```
#A simple linear regression was conducted to test if seasons affect happiness rating in participants. Our results showed that seasons do not explain a statistically significant amount of variance in happiness ratings, F(3, 123) = 2.49, P = 0.06, R2 = 0.057 R2 adjusted = 0.034. Also, the diagnostic plots did not show any signiicanr deviations.


## Question 2b

```{r q2b, message = F}

#VISUALISE AGE TO SEE IF IT MEETS ASSUMPTIONS
ggplot(data = couchto5k, aes(x=age))+geom_density()+geom_boxplot(width = 1/500)

#ACCOUNT FOR SEASON DOES AGE AFFECTS HAPPINESS
weathapage <- lm(happiness ~ 1 + season + age, data = couchto5k)

#DIAGNOSTICS
par(mfrow=c(2,2)) #TO HAVE THEM NOT TAKE UP TOO MUCH SPACE IN MY WORD DOC
plot(weathapage)

#Table
summary(weathapage) %>% pander(Caption = "Table 1.8 Baseline model 2.0: If age, while controlling for seasons influences happiness ratings")
```
#Age, too, does not explain a statistically significant amount of variance in happiness rating amongst participant, while accounting for seasons. F(4,120) = 2.21, p = 0.082, R2 = 0.066, R2 adjusted = 0.034

## Question 2c

```{r q2c}

#The variable season is selected as a baseline model, as the addition of age did not improve the model. Furthermore, the reason for its selection is due to the amount of literature present in the domain that suggests happiness is affected by seasons. Hence, the variable is retained and age is removed from the model.

```

# Question 3

## Question 3a

```{r q3a}

#VISUALISE RELATIONSHIP BETWEEN NUMBER OF WEEKS IN AND HAPPINESS
ggplot(data = couchto5k, aes(x = week_stopped, y = happiness)) +
  geom_point(alpha = 0.5)+
  labs( x= "Program follow through", y = "happiness")

#REAL MODEL OF WEEK STOPPED WITH HAPPINES WHILE CONTROLING FOR BASELINE EFFECTS OF AGE AND SEASON
realmod <- lm(happiness ~ 1 + on_week9 + season , data =couchto5k)

#Diagnostics
par(mfrow=c(2,2))
plot(realmod)

#TABULATION
summary(realmod) %>% pander(caption = "Table 1.9 Happiness ratings on the basis of is participants completed the program or not, while controlling for season")
```

## Question 3b

```{r q3b}

#ADDING HEALTH
realmod1 <- lm(happiness ~ 1 + on_week9 + health + season , data = couchto5k)
summary(realmod1) %>% pander(caption = "Table 2.0 Model with the additions of the health metric")
 
#SEEING MODEL FIT
#anova(realmod, realmod1) # THIS WAS DONE IN CONSOLE CAUSE DID NOT WANT OUTPUT IN WORD DOC

#DIAGNOSTICS
par(mfrow=c(2,2))
plot(realmod1)
```


## Question 3c

```{r q3c}

#adding week_stopped to see for PROGRAM CONTINUITY
realmod2 <- lm(happiness ~ 1 + on_week9 + health + week_stopped + season + week_stopped:health, data = couchto5k)

#TABULATING RESULTS 
summary(realmod2) %>% pander(caption = "Table 2.1 Final model")

# MODEL diagnostics
par(mfrow=c(2,2))
plot(realmod2)
```

## Question 3d

#Program completion and seasons explained 5.7% of the variance (adjusted R2 =0.057, F(4,122)= 2.92, p = 0.02). The addition of the health metric did not improve the model fit and did not explain a significant amount of variance in happiness scores over and above completion of program [on_week9 in the model]. F(1,121) = 0.91, p = 0.34.

#However, the addition of program continuity explained a significant amount of variance in happiness ratings over and above program completion and the health metric. F(1,119) = 12.58, p < 0.01.
#Furthermore, the model shows that for every unit increase in the variable of health and program continuity there is 2.6 and 20.7 units of decrease in happiness, respectively. 

#Additionally, there was a statistically significant interaction between health and program continuity: that is, for every unit increase in health, the change in happiness ratings is associated with a week’s increase in continuity of program is adjusted by 0.39




# Question 4

```{r q4}

#CREATING A GRAPH FOR FUNDERS SHOWING HOW SHIT THEIR PROGRAM IS 
compcouch <- couchto5k %>% filter(week_stopped == 9)

#PLOTTING
ggplot(data= compcouch, aes(x = city, y = happiness,
group = season,
shape = season,
color = season)) + 
  geom_line() + 
  geom_point() +
  labs(title = "Happiness ratings across season and city") +
  facet_grid(.~season) + theme (axis.text.x = element_text( angle = 25, vjust=0.5,hjust = 1))

```
#The results across cities and seasons for differnce in happiness ratings were insignificant, but the graph above shows groupings by season for each city. It can be observed that, overall, the trend shows that Glasgow's happiness ratings dip in comparison to Edinburgh's across the three seasons, namely: autumn, summer, and winter. However, for spring the trend is the opposite.

# Question 5

## Question 5a

```{r q5a}
#PREDICTING THE DROP-OUT RATE OF PARTICPANTS ACCORDING TO THEIR ACCOUNTABILITY SCORES

couchto5k <- couchto5k %>% mutate(dropout = ifelse(week_stopped > 8, 1, 0)) #where 1 is for not dropping out and 0 is for dropping out

#JUST PLOTTING TO SHOW THE RELATION
ggplot(couchto5k, aes(x=accountability, y=dropout))+
  geom_point()+
  geom_smooth(method="lm")

#MODELLING
dropmod <- glm(dropout ~ accountability, family = "binomial", data = couchto5k)

#TABULATING THE MODEL FOR REFERNCE 
pander(dropmod)

```



## Question 5b

```{r q5b}
 
#For every unit decrease in accountability, the odds of dropping out rate increases by 1.105 (after converting the log-odds to odds).

exp(coef(dropmod)) %>% pander(caption = "Table 2.2 Log-odds transformed from log-odds to odds") 
#plotting for the odds converted from the log(odds) of the OG model TO MAKE THE INTERPRETATION MORE APPARENT 
```

## Question 5c

```{r q5c}
quitmod <- glm(dropout ~ selfmot, family = "binomial", data = couchto5k)

panderOptions("table.split.table", 105)
summary(quitmod) %>% pander (caption = "Quitting as a function of self-motivation in participants")

#ALL THE THINGS I NEED TO DO TO PREDICT 
SelfMot <- seq(5,35,.1)
newselfmot <- data.frame(selfmot=SelfMot)
predprob <- predict(quitmod,newselfmot,type="response")
 
#PLOTTING
ggplot(data = newselfmot, aes(x = selfmot, y = predprob)) +
 geom_line()+
   labs(x = "Self-Motivation (scale = 5 -35)",y = "Predicted Probability of Quitting", 
        title = "Quitting as a function of self-motivation")+
  papaja::theme_apa()

#CONVERSION OF LOG ODDS TO ODDS
exp(coef(quitmod)) %>% pander(caption = "Table 2.2 Log-odds transformed from log-odds to odds") 
```










