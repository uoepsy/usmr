---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
  pdf_document: default
params:
  examnumber: "B197183"
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(pander)
#library(cowplot) #conflict to sjPlot
library(patchwork)
library(gridExtra)
library(broom)
library(car)
library(sjPlot)
library(psych)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0: Cleaning & Describing
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->
    Have a look at the data. Check for impossible values and deal with these in an appropriate manner. Describe the data, either in words or using suitable graphs (or a combination). Remember to detail the decisions you have made.  
```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
couchto5k$missing <- NA
# It seems that few people age over 100 can run 5km.
couchto5k$missing[couchto5k$age > 100] <- "Impossible age"
# The lowest score of self mot is 5.
couchto5k$missing[couchto5k$selfmot < 5] <- "Invalid selfmot scores"
# The whole plan is only 9 weeks.
couchto5k$missing[couchto5k$week_stopped > 9] <- "More than total weeks"
mtab <- table(couchto5k$missing)
# Select the data excluding NA.
new_couchto5k <- couchto5k %>% filter(is.na(missing))
total_subs <- count(couchto5k)
subs <- count(new_couchto5k)
```

&emsp;&emsp;The confidence intervals in this article are all .05.

&emsp;&emsp;Firstly, we need to check what the data looks like, using descriptive statistics to summarize data and draw graphs to find the extremely unreasonable values, such as the total weeks over 9 is impossible. There are total `r total_subs` participants in the data. After removing the unlikely values, `r subs` observations remained for analysis. Table 1 gives a summary of the removed data.

```{r table, results='asis'}
mtab %>% pander(caption="Table 1. Summary of missing values.")
```

```{r season}
miscoded <- sum(new_couchto5k$season=="autunm")
new_couchto5k$season[new_couchto5k$season=="autunm"] <- "autumn"
new_couchto5k$season <- as.factor(new_couchto5k$season)
```

```{r city}
new_couchto5k$city <- as.factor(new_couchto5k$city)
```

&emsp;&emsp;In addition, in variables of season, `r miscoded` time of season entries were initially misentered as "autunm". These were be recoded as "autumn".

```{r descriptives by graph}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown.
plot_age <- ggplot(new_couchto5k, aes(x = age)) +
  geom_boxplot()
plot_account <- ggplot(new_couchto5k, aes(x = accountability)) +
  geom_histogram(bins = sqrt(nrow(new_couchto5k)))
plot_selfmot <- ggplot(new_couchto5k, aes(x = selfmot)) +
  geom_histogram(bins = sqrt(nrow(new_couchto5k)))
plot_health <- ggplot(new_couchto5k, aes(x = health)) +
  geom_histogram(bins = sqrt(nrow(new_couchto5k)))
plot_happiness <- ggplot(new_couchto5k, aes(x = happiness)) +
  geom_histogram(bins = sqrt(nrow(new_couchto5k)))
plot_season <- ggplot(new_couchto5k) +
  geom_bar(
    mapping = aes(x = season, fill = season),
    show.legend = FALSE,
    width = 1
  ) +
  coord_polar()   #add coordinate systems
plot_city <- ggplot(new_couchto5k) +
  geom_bar(
    mapping = aes(x = city, fill = city),
    show.legend = FALSE,
    width = 1
  ) +
  coord_polar()
plot_week <- ggplot(new_couchto5k, aes(x = week_stopped)) +
  geom_bar() +
  scale_x_continuous(breaks = 1:9) +
  theme(legend.position = "none")  #remove legend
plot_age + plot_account + plot_selfmot + plot_health +
     plot_happiness + plot_season + plot_city + plot_week +
     plot_annotation(tag_levels = c("a", "b", "c", "d", "e", "f", "g", "h"))
#plot_grid(plot_age, plot_account, plot_selfmot, plot_health,
#     plot_happiness, plot_season, plot_city, plot_week,
#     labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)", "(h)")
#)   #from cowplot

```

<center>Figure 1. Descriptive statistic. (a) participants in different ages; (b) numbers of participants in varied accountability; (c) numbers of participants in varied self-motivation; (d) numbers of participants in varied health conditions; (e) numbers of participants in varied happiness levels; (f) numbers of participants were interviewed in different seasons; (g) numbers of participants in two cities; (h) numbers of participants stopped at different weeks.<center\>

```{r descriptives by count}
new1_couchto5k <- new_couchto5k[,-c(1,10)]
describe(new1_couchto5k)
min_age <- min(new_couchto5k$age)
max_age <- max(new_couchto5k$age)
mean_age<- mean(new_couchto5k$age)
mean_account <- mean(new_couchto5k$accountability)
mean_selfmot <- mean(new_couchto5k$selfmot)
mean_health <- mean(new_couchto5k$health)
mean_happiness <- mean(new_couchto5k$happiness)
mul_city <- sum(new_couchto5k$city == "Edinburgh") / sum(new_couchto5k$city == "Glasgow")
total_week <- sum(new_couchto5k$week_stopped == 9)
pro_week <- total_week / subs

```
<center>Table 2. Descriptive statistic </center>

<p align = "left">&emsp;&emsp;Figure 1 and Table 2 shows us the descriptive statistic results. From Figure 1(a), we know that most of the participants in this data are aged 30-50 roughly. The youngest is `r min_age` years old, the oldest is `r max_age` years old, and the average age is `r mean_age`. Figure 1(b), (c), (d) shows us that participants' accountability, motivation and health condition present an intermediate set, missing at both ends but not precisely consistent with the normal distribution. Their means are `r mean_account`, `r mean_selfmot` and `r mean_health`, respectively. In terms of happiness, the participants were more scattered with scores, and the number of people with 75 or more points was significantly lower than the number of other scores. The mean of participants' happiness is `r mean_happiness`. Most of the interviewees were surveyed in the spring, the second largest population in the summer and much smaller in the other two seasons. Most of the participants were from Edinburgh, `r mul_city` times as many as Glasgow. There were a total of `r total_week` participants who eventually completed all tasks, the proportion is `r pro_week`. Last but not least, the box plots result show that no outliers have been found and so plot are not shown here.</p>

<p align = "left">&emsp;&emsp;From the results, we can speculate that middle-aged people are the main participants of this fitness programme. Most of them took part in the programme in spring or summer, which are the suitable seasons for outdoor activities. Nearly half of the participants completed the programme. This information may help adjust the programme to help more people get involved. The above is a preliminary analysis.</p>

# Question 1 General Checks
## Question 1a
    In an earlier nationwide survey, researchers found that 45% of participants abandoned the programme before the halfway point in week 5, and a further 10% gave up before the end of the programme. Is the data in the sample you have been given in line with data from the earlier survey? Once you have created a suitable variable to map to the information in the question, you should be able to answer this using a simple statistical test.
```{r q1a}
new_couchto5k$week_con <- NA
new_couchto5k$week_con[new_couchto5k$week_stopped == 9] <- "completed"
new_couchto5k$week_con[new_couchto5k$week_stopped <= 5] <- "non-completed"
new_couchto5k$week_con[new_couchto5k$week_stopped > 5 & new_couchto5k$week_stopped < 9] <- "almost-completed"
wtab <- table(new_couchto5k$week_con)
new_couchto5k <- new_couchto5k
test1a_1 <- binom.test(wtab['non-completed'], sum(wtab), .45, alternative = "two.sided")
test1a_2 <- binom.test(wtab['almost-completed'], sum(wtab), .10, alternative = "two.sided")
```

&emsp;&emsp;Firstly, we need to divide participants into three conditions. Participants who stopped at week 9 are marked as completed. Participants stopped before week 5 (including) are marked as non-completed while the others are almost completed. They are then using Binomial Test to test. The Binomial Test is suitable for testing a sample against a known population. The results show that `r test1a_1$statistic` participants stopped before week 5, which in line with the earlier survey (p = `r test1a_1$p.value` > .05 ). `r test1a_2$statistic` participants gave up before the end of the programme and completed at least 5 weeks, which also in line of the earlier data (p = `r test1a_2$p.value`). This sample repeats previous findings.

## Question 1b
    Using the same three categories (stopped before week 5, stopped after week 5, completed), examine whether the patterns of attrition rates differ by city.
```{r q1b}
q1b_plot <- ggplot(new_couchto5k) +
  theme_classic() +
  geom_bar(aes(x = week_con, fill = city), position = "fill") #draw a plot to describe
grid.arrange(q1b_plot, bottom = "Figure 2. Completion of programme in different city participants")  #from gridExtra
num_ed <- sum(new_couchto5k$city == "Edinburgh")
num_gl <- sum(new_couchto5k$city == "Glasgow")
q1b <- chisq.test(table(new_couchto5k$week_con, new_couchto5k$city))
```

&emsp;&emsp;Figure 2 shows the completion of the programme in different city participants. `r num_ed` are from Edinburgh and the remaining `r num_gl` are from Glasgow. They appeare to be no significant difference between the trials in different cities. Further $\chi$$^{2}$ tests prove it ($\chi$$^{2}$ (`r q1b$parameter`, n = `r subs`) = `r q1b$statistic`, p = `r q1b$p.value` > .05). The chi-square test is used here because both variables are categorical variables and the sample rate (composition ratio) of the two needs to be compared. The result indicates that the patterns of attrition rates have no different by city.    

## Question 1c
    Do the average ages of participants who commenced the programme differ by city?
```{r q1c}
q1c_plot <- ggplot(new_couchto5k, aes(x = age, y = city)) +
  geom_boxplot() +
  theme_classic()
grid.arrange(q1c_plot, bottom = "Figure 3. Age distribution of participants in different cities")
mean_ed <- mean(new_couchto5k$age[new_couchto5k$city == "Edinburgh"])
sd_ed <- sd(new_couchto5k$age[new_couchto5k$city == "Edinburgh"])
mean_gl <- mean(new_couchto5k$age[new_couchto5k$city == "Glasgow"])
sd_gl <- sd(new_couchto5k$age[new_couchto5k$city == "Glasgow"])
q1c_f <-with(new_couchto5k, var.test(age ~ city))
q1c_t <- with(new_couchto5k, t.test(age ~ city, alternative = "two.sided"))
```

&emsp;&emsp;Figure 3 presents a box plot about the age distribution of participants from Edinburgh or Glasgow. Whether there is a difference between two independent variables can be verified with an independent t-test. So an independent t-test is conducted to determine if the average ages of participants differ by city. The result indicates that the average age of participants from Edinburgh `r mean_ed` $\pm$ `r sd_ed` is older than those from Glasgow `r mean_gl` $\pm$ `r sd_gl`. F-test to compare whether the ages from these two cities are from normal populations indicates no evidence against the null hypothesis that the residuals are drawn from a normally distributed population (F(`r q1c_f$parameter`) = `r q1c_f$statistic`, p = `r q1c_f$p.value` > .05). However, t-test result points out that the different is not statistically significant (t(`r q1c_t$parameter`) = `r q1c_t$statistic`, p = `r q1c_t$p.value` > .05). The error may have come from a sampling error, and there is insufficient evidence that Edinburgh's participants were older.  

# Question 2
## Question 2a
    Are participants’ happiness ratings affected by the season they were interviewed in? Describe the way in which season influences happiness outcomes.
```{r q2a}
q2a.plot <- ggplot(new_couchto5k) +
  geom_boxplot(aes(x = season, y = happiness, fill = season)) +
  theme_classic() +
  theme(legend.position = "none") # remove legend
grid.arrange(q2a.plot, bottom = "Figure 4. Happiness scores of participants in different seasons")
q2a.mod <- lm(happiness ~ 1 + season, new_couchto5k)
q2a.a <- anova(q2a.mod)
q2a.s <- summary(q2a.mod)
q2a.t <- tidy(q2a.mod)  #from broom
```

&emsp;&emsp;To investigate whether the seasons have an effect on participants' happiness ratings, the data is modelled using simple linear regression (Anova can get the same result). And our null hypothesis test is: $H_{0}$: The effect of seasons on happiness is equal to zero. We performed an F-test for the overall significance of the regression, F(`r q2a.a$Df`) = `r q2a.a$'F value'`, p = `r q2a.a$'Pr(>F)'` < .05, indicating very strong evidence against the null hypothesis that the model is ineffective. In other words, the data provide strong evidence that seasons is an effective impact factor of happiness ratings. Approximately `r q2a.s$r.squared` of the total variability in happiness is explained by the linear association with season.
Figure 4 shows the distribution of happiness in different seasons. Spring (b = 30.9, SE = 10.3, p = .003 < .05) and summer (b = 38.7, SE = 10.8, p = .001 < .05) have significant effect on happiness. Participants who investigated in these two seasons are happier than the other.

## Question 2b
    Accounting for any effects you discovered in (2a), is happiness affected by age?
```{r q2b_1}
#q2b_plot <- ggplot(new_couchto5k, aes(x = age, y = happiness)) +
#  geom_point() +
#  aes(color = season)
#grid.arrange(q2b_plot, bottom = "Figure 5.  Participants distribution of happiness in different seasons and different ages")
q2b.mod <- lm(happiness ~ 1 + season + age, data = new_couchto5k)
q2b.s <- summary(q2b.mod)
q2b.st <- shapiro.test(residuals(q2b.mod))
q2b.nt <- ncvTest(q2b.mod)
q2b.w1 <- plot(q2b.mod, which = 1)
#q2b.w2 <- plot(q2b.mod, which = 2)
#q2b.w3 <- plot(q2b.mod, which = 3)
#q2b.w4 <- plot(q2b.mod, which = 5)
```
<center>Figure 5 Residuals vs Fitted plot demonstrating overall near constant mean and variance of error term across levels of the response<center\>

```{r q2b_2}
q2b.plot <- plot_model(q2b.mod, type ="pred", terms = c("age", "season"), show.data=TRUE) +
  theme_classic()
grid.arrange(q2b.plot, bottom = "Figure 6. Predicted values of happiness")
q2b.tab <- tab_model(q2b.mod, title = "Table 3. Regression table for Happiness model.")
```

<p align = "left">&emsp;&emsp;Based on the influence of season, we are interesting in estimate whether the age affect participants' happiness rating. The season which participants are interviewed in and the ages are included as predictors. And happiness as a dependent variable. For more than 2 predictors, we have to use multiple line regression, by fitting the following model:</p>
<center>Happiness = $b_{0}$ + $b_{1}$\*season + $b_{2}$\*age + $\epsilon$</center>

<p align = "left">&emsp;&emsp;And we consider the hypothesis test that $H_{0}$: The effect of seasons and age on happiness is equal to zero. The results are as follows. A Shapiro-Wilk test succeeds in rejecting the null hypothesis that the residuals were drawn from a normally distributed population(W = `r q2b.st$statistic`, p = `r q2b.st$p.value` <.05). According to the scatter plot, the distribution of the data is scattered, and the amount of data under some conditions is small, which does not conform to the normal distribution. We assume that the distribution of the population is normally distributed and perform the following analysis. Visual inspection of suggested little sign of non-constant variance, with the Breusch-Pagan test failing to reject the null that error variance does not change across the fitted values (χ2(`r q2b.nt$Df`) = `r q2b.nt$ChiSquare`, p = `r q2b.nt$p` > .05). Figure 5 demonstrates the model met assumptions of linearity.</p>
<center>`r q2b.tab`

<p align = "left">&emsp;&emsp;Figure 6 demonstrates a trend chart that predicts happiness by season and age, showing a slightly positive relationship. It means that as age grows, happiness slowly rises. There is no interaction between the different seasons, and it is close to parallel, indicating that the participants' happiness in different seasons changes with age. Table 3 give us the full detail of the regression results. The F-test for model utility is significant(F(`r q2b.s$df`) = 3.9, p = .005 < .5), and the model explained approximately `r q2b.s$r.squared` of the variability in happiness.</p>

<p align = "left">&emsp;&emsp;Results fail to show a significant conditional association between happiness and age (b = .14, SE = .21, p = .498 > .05)，showing that despite the trend, age does not affect the prediction of happiness. However, a significant conditional association  is evident between spring (b = 30.49, SE = 10.31, p = .004 < .05), summer season (b = 38.17, SE = 10.84, p = .001 < .05) and happiness, suggesting that for those participants of the same age, changing season to spring or summer will raise their happiness outcome. The results presented here indicate that the influence of the seasons is greater (as evidenced by Q2a), and the addition of age does not make the model more explanatory. Nor does it interact, and therefore does not further assume the interaction between factors. But we can see a slight trend in the graph, so a small sample may also be one of the reasons why the statistical significance is not significant. All in all, we can conclude with certainty that those who attended interviews in the spring and summer had a higher sense of happiness than those in the other two seasons.</p>

## Question 2c
    The models you have built above explore ‘baseline’ effects; that is, effects that are not of primary interest to the researchers but which might affect the outcome variable of happiness. For use in question 3, pick a specific baseline model and justify why you are using this.
```{r q2c}
q2c.mod1 <- lm(happiness ~ 1 + season + health, data = new_couchto5k)
q2c.mod2 <- lm(happiness ~ 1 + season + city, data = new_couchto5k)
q2c.tab1 <- tab_model(q2c.mod1, title = "Table 4. Regression table for Happiness model by season and health as predictors") 
q2c.tab2 <- tab_model(q2c.mod2, title = "Table 5. Regression table for Happiness model by season and city as predictors.")
q2c.st1 <- shapiro.test(residuals(q2c.mod1))
q2c.nt1 <- ncvTest(q2c.mod1)
#q2c.w11 <- plot(q2c.mod1, which = 1)
q2c.s1 <- summary(q2c.mod1)
q2c.st2 <- shapiro.test(residuals(q2c.mod2))
q2c.nt2 <- ncvTest(q2c.mod2)
#q2c.w12 <- plot(q2c.mod2, which = 1)
q2c.s2 <- summary(q2c.mod2)
q2c.plot1 <- plot_model(q2c.mod2, type ="pred", terms = c("season", "city"), show.data=TRUE) +
  theme_classic()
q2c.plot2 <- grid.arrange(q2c.plot1, bottom = "Figure 7. Predicted values of happiness by city and season")
q2c.med <- mean(new_couchto5k$happiness[new_couchto5k$city == 'Edinburgh'])
q2c.sded <- sd(new_couchto5k$happiness[new_couchto5k$city == 'Edinburgh'])
q2c.mgl <- mean(new_couchto5k$happiness[new_couchto5k$city == 'glasgow'])
q2c.sdgl <- sd(new_couchto5k$happiness[new_couchto5k$city == 'glasgow'])
```

&emsp;&emsp;The model from Questions 2a and 2b told us that season is a reliable factor to predict happiness, so we keep it in our new model as a part of the baseline. Based on this, we add another two factors, health and city, into the model, separately, because they are also not the primary interest to the researchers but may have an effect on happiness. The models are:
<center>Model1: Happiness = $b_{0}$ + $b_{1}$\*season + $b_{2}$\*health + $\epsilon$</center>
<center>Model2: Happiness = $b_{0}$ + $b_{1}$\*season + $b_{2}$\*city + $\epsilon$</center>

<p align = "left">&emsp;&emsp;Before using multiple line regression to fit the model, we check if the sample follows a normal distribution and if the error variance change across the fitted values. The Shapiro-Wilk test shows that both of the models succeeds in rejecting the null hypothesis that the residuals were drawn from a normally distributed population(W = `r q2c.st1$statistic`, p = `r q2c.st1$p.value` <.05) and (W = `r q2c.st2$statistic`, p = `r q2c.st2$p.value` <.05). The Breusch-Pagan test shows that both of the model failing to reject the null that error variance does not change across the fitted values (χ2(`r q2c.nt1$Df`) = `r q2c.nt1$ChiSquare`, p = `r q2c.nt1$p` > .05) and (χ2(`r q2c.nt2$Df`) = `r q2c.nt2$ChiSquare`, p = `r q2c.nt2$p` > .05). Figures of "residuals vs fitted" indicate the two models met assumptions of linearity.</p>
<center>`r q2c.tab1``r q2c.tab2`

<p align = "left">&emsp;&emsp;Full regression results including 95% Confidence Intervals are shown in Table 4 and Table 5. For model1, The F-test for model utility is significant(F(`r q2c.s1$df`) = 3.77, p = .006 < .5), and the model explained approximately `r q2c.s1$r.squared` of the variability in happiness. The season of spring (b = 30.96, SE = 10.35, p = .003 < .05), summer season (b = 38.71, SE = 10.84, p = .001 < .05) still present a significant conditional association to happiness, but the effect of health is not significant (b = -.02, SE = .27, p = .945 > .05). For model2, The F-test for model utility is significant(F(`r q2c.s2$df`) = 5.13, p = .001 < .5), and the model explained approximately `r q2c.s2$r.squared` of the variability in happiness. The season of autumn (b = 22.41, SE = 9.84, p = .025 < .05), spring (b = 28.75, SE = 10.16, p = .005 < .05) and summer (b = 37.24, SE = 10.65, p = .001 < .05) all shows a significant result. More importantly, The city, a binary variable, also shows a significant conditional association to happiness (b = -12.17, SE = 5.53, p = .03 < .05). Figure 7 demonstrates the predicted model by city and season. The result indicates that the participants from Edinburgh (`r q2c.med` $\pm$ `r q2c.sded`) were happier than those from Glasgow (`q2c.mgl` $\pm$ `r q2c.sdgl`), and in other words, for those who from Glasgow, scores on the happiness increase by -12.17 than those from Edinburgh. The model2 has stronger explanation of happiness.</p>

<p align = "left">&emsp;&emsp;Then we compare the Model2 to the model from Question 2a, using an incremental F-test. Model2 contains all the predictors of model from Question 2a. The hypothesis is:</p>

$H_{0}$: Coefficients for the added/ommitted variables are all zero. 

$H_{1}$: At least one of the added/ommitted variables has a coefficient that is not zero.
```{r q2c compare}
q2a.mod <- lm(happiness ~ 1 + season, new_couchto5k)
q2c.mod2 <- lm(happiness ~ 1 + season + city, data = new_couchto5k)
q2c.sum1 <- summary(q2a.mod)$adj.r.sq
q2c.sum2 <- summary(q2c.mod2)$adj.r.sq
q2c.com <- anova(q2a.mod, q2c.mod2)
```

<p align = "left">&emsp;&emsp;The model with season and city as predictors explains `r q2c.sum2` of the variance, and the model without city explains `r q2c.sum1`. City is found to explain a significant amount of variance in happiness over the season (F(1, 122) = 4.85, p = .030 < .05). As a result model with season and city are the best model, we test and will be used as the baseline model in the following part.</p>

# Question 3 Happiness and Health
## Question 3a
    Building on your baseline model, are participants’ happiness ratings affected by whether or not they completed the programme? Describe the way in which programme completion influences happiness outcomes.
```{r q3a_1}
new_couchto5k$week_con_bin <- "non-com"
new_couchto5k$week_con_bin[new_couchto5k$week_con == "completed"] <- "com"
new_couchto5k <- new_couchto5k
q3a.mod <- lm(happiness ~ 1 + season + city + week_con_bin, data = new_couchto5k)
q3a.s <- summary(q3a.mod)
q3a.st <- shapiro.test(residuals(q3a.mod))
q3a.nt <- ncvTest(q3a.mod)
#q3a.t <- tidy(q3a.mod)
#q3a.w1 <- plot(q3a.mod, which = 1)
#q3a.w2 <- plot(q3a.mod, which = 2)
#q3a.w3 <- plot(q3a.mod, which = 3)
#q3a.w4 <- plot(q3a.mod, which = 5)
#q3a.plot <- plot_model(q3a.mod, type ="pred", terms = c("city", "season"), show.data=TRUE)
#grid.arrange(q2b.plot, bottom = "Figure 8. Predicted values of happiness")
q3a.tab <- tab_model(q3a.mod, title = "Table 6. Regression table for Happiness model.")
```

<p align = "left">&emsp;&emsp;Based on the model we set up in Question 2c, we add another predictor "whether the programme is completed" into the model. We still use multiple line regression to fit it.</p>
<center>Happiness = $b_{0}$ + $b_{1}$\*season + $b_{2}$\*city + $b_{3}$\*week_con_bin + $\epsilon$</center>

* week_con_bin refers to programme completion

<p align = "left">&emsp;&emsp;The null hypothesis is $H_{0}$: The effect of seasons, city and programme completion on happiness is equal to zero. The Shapiro-Wilk test fails in rejecting the null hypothesis that the residuals were drawn from a normally distributed population(W = `r q3a.st$statistic`, p = `r q3a.st$p.value` >=.05). Visual inspection of suggested little sign of non-constant variance, with the Breusch-Pagan test failing to reject the null that error variance does not change across the fitted values (χ2(`r q3a.nt$Df`) = `r q3a.nt$ChiSquare`, p = `r q3a.nt$p` > .05).</p>
<center>`r q3a.tab`

<p align = "left">&emsp;&emsp;Table 6 give us the full detail of the regression results. The F-test for model utility is significant(F(`r q3a.s$df`) = 5.49, p = .001 < .5), and the model explained approximately `r q3a.s$r.squared` of the variability in happiness.</p>

<p align = "left">&emsp;&emsp;The results still show a significant conditional association between happiness and season. Additional, programme completion also play a significant role in predicting happiness (b = -14.27, SE = 5.78, p = .002 < .05), suggesting that those who had not completed the programme and scored the mean on the season and from a specific city, scores on the happiness decrease by 14.27 than those who completed the programme. That is to say, participants from the same city who were interviewed in the same season had a higher sense of happiness than participants who did not complete the task. The completion of the programme also represents the effectiveness of the programme to some extent. In other words, the results prove that the happiness of the participants after completing the programme is improved.</p>
```{r q3a compare}
q3a.mod2 <- lm(happiness ~ 1 + season + week_con_bin, data = new_couchto5k)
q3a.s2 <- summary(q3a.mod2)
q3a.st2 <- shapiro.test(residuals(q3a.mod2))
q3a.nt2 <- ncvTest(q3a.mod2)
q3a.sum1 <- summary(q3a.mod)$adj.r.sq
q3a.sum2 <- summary(q3a.mod2)$adj.r.sq
q3a.com <- anova(q3a.mod, q3a.mod2)
#q3a.tab2 <- tab_model(q3a.mod2, title = "Table 5. Regression table for Happiness model with predictors of season, city and programme completion")
```
<p align = "left">&emsp;&emsp;At the same time, we also noticed that the impact of cities was significant at .05, so we further removed the city factor and built a new model to compare.</p> 
<center>Happiness = $b_{0}$ + $b_{1}$\*season + $b_{3}$\*week_con_bin + $\epsilon$</center>

*week_con_bin refers to programme completion

<p align = "left">&emsp;&emsp;The model with season, city and programme completion as predictors explains `r q3a.sum1` of the variance, and the model without city explains `r q3a.sum2`. City is found to explain a significant amount of variance in happiness over the season (F(1, 122) = 4.85, p = .05 >= .05). The results fail to give stronger evidence that the new model has better explanatory power. So we still use the model with three predictors.</p>

## Question 3b
    Building on the analysis in (3a), is happiness additionally affected by the “health metric”?
```{r q3b}
q3b.mod <- lm(happiness ~ 1 + season + city + week_con_bin + health, data = new_couchto5k)
q3b.s <- summary(q3b.mod)
q3b.st <- shapiro.test(residuals(q3b.mod))
q3b.nt <- ncvTest(q3b.mod)
#q3a.t <- tidy(q3a.mod)
q3b.tab <- tab_model(q3b.mod, title = "Table 7. Regression table for Happiness model with predictors of season, city, programme completion and health")
```

<p align = "left">&emsp;&emsp;Based on the model in Question 3a, health metric is added into the model as a predictor. </p>
<center>Happiness = $b_{0}$ + $b_{1}$\*season + $b_{2}$\*city + $b_{3}$\*week_con_bin + $b_{4}$\*health + $\epsilon$</center>

*week_con_bin refers to programme completion

<p align = "left">&emsp;&emsp;The null hypothesis is $H_{0}$: The effect of seasons, city, programme completion  and health on happiness is equal to zero. We use multiple line regression to fit it. The Shapiro-Wilk test fails in rejecting the null hypothesis that the residuals were drawn from a normally distributed population(W = `r q3b.st$statistic`, p = `r q3b.st$p.value` >=.05). Visual inspection of suggested little sign of non-constant variance, with the Breusch-Pagan test failing to reject the null that error variance does not change across the fitted values (χ2(`r q3b.nt$Df`) = `r q3b.nt$ChiSquare`, p = `r q3b.nt$p` > .05).</p>
<center>`r q3b.tab`

<p align = "left">&emsp;&emsp;Table 7 give us the full detail of the regression results. The F-test for model utility is significant(F(`r q3b.s$df`) = 4.54, p = .001 < .5), and the model explained approximately `r q3b.s$r.squared` of the variability in happiness.</p>

<p align = "left">&emsp;&emsp;The results still show a significant conditional association between happiness and season, as well as happiness and programme completion. However, city become edge significant (b = -10.76, SE = 5.47, p = .051 > .05). In terms of health, it has had no significant effect on happiness (b = -.04, SE = .26, p = .888 > .05). That is to say, participants from the same city who were interviewed in the same season had a higher sense of happiness than participants who did not complete the task. The completion of the programme also represents the effectiveness of the programme to some extent. In other words, the results prove that the happiness of the participants after completing the programme is improved. Based on the model from 3a, health does not affect well-being. It doesn't seem to match common sense, and individuals with poor physical health often don't have a high sense of well-being. This result may be that the sample does not cover people with all health conditions. From the statistical results of the above description, we can see that the health status of the participants is relatively concentrated and moderate, and there are not many people with extreme health conditions. Secondly, from the programme's perspective, exceptionally healthy and particularly unhealthy people are less likely to need or be unable to participate in the programme.</p>

## Question 3c
    It’s been hypothesised that the effects of good health are amplified by the feeling of acting healthily, such that the happiness of participants who got further along the programme might be more affected by the health metric than that of those who stopped earlier. Building on the model in (3b), can you test this hypothesis?d
```{r q3c}
q3c.mod <- lm(happiness ~ 1 + season + city + week_stopped * health, data = new_couchto5k)
q3c.s <- summary(q3c.mod)
q3c.st <- shapiro.test(residuals(q3c.mod))
q3c.nt <- ncvTest(q3c.mod)
q3c.w1 <- plot(q3c.mod, which = 1)
#q3c.w2 <- plot(q3c.mod, which = 2)
#q3c.w3 <- plot(q3c.mod, which = 3)
#q3c.w4 <- plot(q3c.mod, which = 5)
q3c.tab <- tab_model(q3c.mod, title = "Table 8. Regression table for Happiness model with interaction")
```
<center>Figure 8 Residuals vs Fitted plot demonstrating overall near constant mean and variance of error term across levels of the response<center\>

<p align = "left">&emsp;&emsp;The previous model treated planned completions as binary variables, complete or incomplete. However, according to the assumption that participants' happiness with higher completion of the plan is more likely to be affected by health indicators, it is clear that there is a degree of incompleteness. Some participants gave up at the beginning, and some gave up before the end. The circumstance descripted by the former model is clearly not generalization. Therefore, the original model will be firstly modified to treat the programme completion as a continuous variable and measured using the "week stopped" metric, which refers to the week of programme participant stopped in. The model adjustment is as follows:</p>
<center>Happiness = $b_{0}$ + $b_{1}$\*season + $b_{2}$\*city + $b_{3}$\*week_stopped + $b_{4}$\*health + $\epsilon$</center>

<p align = "left">&emsp;&emsp;Furthermore, it is assumed that health metric has an impact on the extent to which programme completion affects happiness. The model will therefore further consider the interaction between the two factors.</p>
<center>Happiness = $b_{0}$ + $b_{1}$\*season + $b_{2}$\*city + $b_{3}$\*week_stopped + $b_{4}$\*health + $b_{5}$\*(week_stopped * health) + $\epsilon$</center>

<p align = "left">&emsp;&emsp;What we concern here is whether the interactions of programme stopped week and health equal to zero, also known as our null hypothesis, using multiple line regression to fit it. The model met assumptions of linearity (see plot of model residuals vs fitted values, Figure 8). The Shapiro-Wilk test indicated no evidence against the null hypothesis that the residuals were drawn from a normally distributed population(W = `r q3c.st$statistic`, p = `r q3c.st$p.value` >=.05). Visual inspection of suggested little sign of non-constant variance, with the Breusch-Pagan test failing to reject the null that error variance does not change across the fitted values (χ2(`r q3c.nt$Df`) = `r q3c.nt$ChiSquare`, p = `r q3c.nt$p` > .05).</p>

<center>`r q3c.tab`
<p align = "left">&emsp;&emsp;Table 8 give us the full detail of the regression results. The F-test for model utility is significant(F(`r q3c.s$df`) = 5.49, p = .001 < .5), and the model explained approximately `r q3c.s$r.squared` of the variability in happiness. Both the factors of programme completion (b = -13.19, SE = 5.16, p = .012 < .05) and health (b = -1.91, SE = .63, p = .003 < .05) that we care about here have an significant conditional association with happiness. These results indicate that in certain seasons and cities with the same health condition, those who score the happiness decrease by 13.19 for every 1 standard deviation increase in weeks participant stopped. Those who in certain seasons and cities and stop in the same week score the happiness decrease by 1.91 for every one standard deviation increase in weeks participant stopped. The results were shocking because they were the opposite of what we expected. After controlling for other conditions, the higher the degree of programme completion, the lower the sense of happiness of the participants, and the higher the degree of health, the lower the sense of happiness. It is also in conflict with the previous results. Figure 9 shows happiness changes with health, and different colored lines indicate trend lines at different standard deviations of program completion. The interaction between the two is significant, i.e., the association between health and happiness was found to be dependent upon the level the programme completion, with a great positive association between the two for those with high levels of programme completion.</p>

```{r q3c plot}
q3c.plot <- plot_model(q3c.mod, type = "pred", terms = c("health", "week_stopped [-1, 0, 1]")) +
  scale_x_continuous(breaks = 1:9) +
  theme_classic()
grid.arrange(q3c.plot, bottom = "Figure 9. Predicted values of happiness by health and week stopped")
```
<p align = "left">&emsp;&emsp;The results showed that happiness are negatively correlated with health and program completion, and we don't know what causes this. The interaction between the two is significant. When a health score of more than 47, program completion has a positive effect on happiness. For participants with the same health condition, the higher the degree of completion of the program, the higher the sense of happiness.</p>

## Question 3d
    What can we conclude about the various causes of happiness in our data? Write a brief description of the effects in the model, such as you might find in an academic paper.

&emsp;&emsp;First, in our data, seasons, cities, and whether or not to complete the programme predicts happiness. Age has nothing to do with happiness, and there is an interaction between completing the programme and health. Specifically, the happiness of the spring and summer is higher, the healthier the individual, the higher the happiness, and the happier the participants who completed the programme were higher than the participants who did not complete the programme. This is understandable because the weather in spring and summer is more pleasant. There are two explanations for the effect of whether the programme is complete or not on happiness, either maybe because planning improves happiness or perhaps because the sense of accomplishment of completing the programme increases happiness (Quinn & Duckworth, 2007). The available data cannot be further speculated. But we can't explain the impact of cities, and more data are still needed to explain the phenomenon further. In addition, multiple models show that the impact of cities is significant at the edge, so this can still be caused by sampling errors. Age does not predict happiness, possibly because happiness changes with age into a "U" curve, not a linear relationship (Beja, 2018). Health, which are not related to happiness, is somewhat inconsistent with previous research findings (Argyle, 1997). In general, the healthier the person, the happier they are. The reason may be that, as we mentioned in Question 3b, the data is too centralized to cover all people of healthy levels, and people who are particularly healthy or particularly unhealthy may not participate in this health improvement program.
&emsp;&emsp;In the model of interaction, anomalies arise, and the relationship between the completion of the plan and the sense of happiness turns negative. The change we made was to change the plan to stop in the first few weeks. We failed to find a specific reason. Combined with the above results, a reasonable reason may be that in addition to the participants who completed the task, the more weeks of completion, the more likely they are to develop regrets, which ultimately affects happiness. But the interaction is to some extent in line with our expectations. For people with the same health condition, the more weeks completed, the happier they are.    

# Question 4
    Create a subset of the data, including only those participants who completed the programme. Create a plot of the average happiness ratings grouped by season and city, that can be used in a presentation to the funders of the project.
```{r q4}
com_couchto5k <- new_couchto5k %>% filter(week_con_bin == "com")
E.Sp <- mean(com_couchto5k$happiness[com_couchto5k$city == "Edinburgh" & com_couchto5k$season == "spring"])
E.Su <- mean(com_couchto5k$happiness[com_couchto5k$city == "Edinburgh" & com_couchto5k$season == "summer"])
E.A <- mean(com_couchto5k$happiness[com_couchto5k$city == "Edinburgh" & com_couchto5k$season == "autumn"])
E.W <- mean(com_couchto5k$happiness[com_couchto5k$city == "Edinburgh" & com_couchto5k$season == "winter"])
G.Sp <- mean(com_couchto5k$happiness[com_couchto5k$city == "Glasgow" & com_couchto5k$season == "spring"])
G.Su <- mean(com_couchto5k$happiness[com_couchto5k$city == "Glasgow" & com_couchto5k$season == "summer"])
G.A <- mean(com_couchto5k$happiness[com_couchto5k$city == "Glasgow" & com_couchto5k$season == "autumn"])
G.W <- mean(com_couchto5k$happiness[com_couchto5k$city == "Glasgow" & com_couchto5k$season == "winter"])
C.C <- c(E.Sp, E.Su, E.A, E.W, G.Sp, G.Su, G.A, G.W)
rnames <- c("Edinburgh", "Glasgow")
cnames <- c("Spring", "Summer", "Autumn","Winter")
C.C.matrix <- matrix(C.C, nrow = 2, ncol = 4, byrow = TRUE, dimnames = list(rnames, cnames))
barplot(C.C.matrix, 
  col=colors()[c(23,89)] , 
  border="white",
  font.axis=1, 
  beside=F,
  legend=rnames,
  xlab="season",
  ylab="happiness",
  font.lab=2)
```
<center>Figure 10 The average happiness ratings grouped by season and city<center\>
<p align = "left">&emsp;&emsp;Figure 10 shows the average happiness under different seasons and cities. As the figure shown, in general, participants from Edinburgh had a higher sense of happiness, a phenomenon that only differs in the autumn. Spring and summer are happier, especially summer. Autumn has the lowest level of happiness. This tells us that season and city need to be consider when participants be recruited. For example, participants in Glasgow, may be more in need of improved happiness.</p>

# Question 5 Predictors of Drop-out
## Question 5a
    Build a model that predicts the likelihood of dropping out (at all).
```{r q5a}
new_couchto5k$dropping.out <- 1
new_couchto5k$dropping.out[new_couchto5k$week_con == "completed"] <- 0
new_couchto5k <- new_couchto5k
q5a.mod <- glm(dropping.out ~ accountability + selfmot + age + health, data = new_couchto5k, family = "binomial")
q5a.s <- summary(q5a.mod)
q5a.plot <- sjPlot::plot_model(q5a.mod) +
              geom_hline(yintercept=2) +
              scale_y_log10(limits = c(5e-01,1.2)) +
              theme_classic()
grid.arrange(q5a.plot, bottom = "Figure 11. GLM model predicted the factor of dropping out")
```

<p align = "left">&emsp;&emsp;The answer of whether the participants dropping out of the programme are either "Yes" or "not". Hence, it is a binary factor (have been marked as to whether the programme is completed in the previous analysis). A generalised linear model (specifically, logistic regression model) is suitable to predict the probability of this dichotomy variable occurring. The probability will be translated into "log-odds", which is both linear and unbounded so that we can model the likelihood of the event happening. In addition, we consider that accountability, self-motivation, age and health metric are the most likely factors to predict the likelihood of dropping out. The predictors are all continuous variables. Our model builds on this assumption.</p>
<center>ln(p/(1−p)) = $b_{0}$ + $b_{1}$\*accountability + $b_{2}$\*selfmot + $b_{3}$\*age + $b_{4}$\*health + $\epsilon$</center>
* p/(1−p) refers to the odds of the event happening.

<p align = "left">&emsp;&emsp;The analysis results shows that self-motivation (b = -0.295, SE = 0.078, p = .001 < .05) and age (b = -0.055, SE = 0.021, p = .010 < .05) are both significantly to predict dropping out. It means that for every 1 point drop in self-motivation, the log-odds of dropping out from the programme increases by 0.295. And for one year older, the log-odds of dropping out from the programme decreases by 0.055. Or exponentiate the coefficients from the model to translate them back from log-odds. The odds of dropping out from the programme for someone age 0，score 0 in accountability, self-motivation and health are 8033:1. For participants with higher (one score) self-motivation, the odds of dropping out from the programme decreases by 0.295. And for every year older someone is, the odds of dropping out decrease by 0.055. Figure 11 gives the visual result.</p>

## Question 5b
    Briefly describe the effects in your model as you would in an academic paper.
```{r q5b}
exp(confint(q5a.mod))
q5b <- cor(x = new_couchto5k$age, y = new_couchto5k$selfmot)
```
&emsp;&emsp;As we mentioned in Question 5a, the model showed that both age and self-motivation significantly predicted whether participants would quit their programme halfway through. The older the participants, the less likely they were to give up. The higher the self-motivation, the less likely participants were to give up. Here whether or not to quit the programme is a probability, indicating that the higher probability will choose to give up. Combined with the above 95% confidence intervals for the log-odds coefficients, the results are even more pronounced. People who are more self-motivated start with a plan to complete a goal. As for the older participants, we suspect that their self-motivation may also be stronger, but the Correlation Test (`r q5b`) does not prove this idea. As for health, we are not surprised that it does not have a significant predictive effect, but we are surprised that accountability has no significant effect. Perhaps because participants did not treat it as a liability, they did not consider it irresponsible to abandon the plan halfway through. The rest of the variables are not discussed further here because they have no significant effect on whether participants give up halfway through. 

## Question 5c
    Draw a graph representing the probability of quitting as a function of how self motivated participants were.
```{r q5c}
q5c.mod <- glm(dropping.out ~ selfmot, data = new_couchto5k, family = "binomial")
q5c.s <- summary(q5c.mod)
ggplot(new_couchto5k, aes(x = selfmot, y = dropping.out)) +
  geom_jitter(width = 0, height = .1) +
  geom_smooth(method = "glm", method.args = list(family = binomial)) +
  scale_color_binned()
```
<center>Figure 12. Predicted probability of quitting by self-motivation<center\>
<p align = "left">&emsp;&emsp;Build a new GLM model with only self-motivation as predictor. Figure 12 shows the trends of how the probability of quitting will affect by self-motivation.Overall, the likelihood of quitting the programme decreases as motivation increases.</p>

# Reference
Argyle, M. (1997). Is happiness a cause of health?. Psychology and Health, 12(6), 769-781.

Beja, E. L. (2018). The U-shaped relationship between happiness and age: evidence using world values survey data. Quality & Quantity, 52(4), 1817-1829.

Quinn, P. D., & Duckworth, A. L. (2007, May). Happiness and academic achievement: Evidence for reciprocal causality. In The annual meeting of the american psychological society (Vol. 24, No. 27.5, p. 2007).

Steptoe, A., Deaton, A., & Stone, A. A. (2015). Subjective wellbeing, health, and ageing. Lancet (London, England), 385(9968), 640–648.






