---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  word_document: default
  pdf_document: default
  html_document: default
params:
  examnumber: B192935
---

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 2 dp
options(digits=2)
# load any other packages that you require here:
library(tidyverse)
library(pander)
library(broom)
library(sjPlot)
library(car)
library(cowplot)
library(interactions)

# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")


```

# Question 0ï¼šCleaning & Describing

## Data Cleaning and describing 
```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 

# set up a new column containing the reason of removing the data
couchto5k$missing <-NA

# check for whether there is any missing value 
couchto5k$missing[is.na(couchto5k$age)] <- "no age given"
couchto5k$missing[is.na(couchto5k$accountability)] <- "no accountability recorded"
couchto5k$missing[is.na(couchto5k$selfmot)] <-"no selfmot recorded"
couchto5k$missing[is.na(couchto5k$health)] <-"no health recorded"
couchto5k$missing[is.na(couchto5k$happiness)] <-"no happiness recorded"
couchto5k$missing[is.na(couchto5k$week_stopped)] <- "no duration recorded" 

# check for any anomalies 
# after checking summary(couchto5k), only variable age, self-mot, week_stopped, and season have impossible values

# check crazy age (>100 years old)
couchto5k$missing[couchto5k$age>100] <- "Age (>100 years old)"
# check impossible values in self motivation (scale 1-7, 5 questions)
couchto5k$missing[couchto5k$selfmot>35|couchto5k$selfmot<0] <- "Self-motivation scores (>35)"
# check impossible values in week_stopped (>9 weeks)
couchto5k$missing[couchto5k$week_stopped>9] <- "Duration (>9 weeks)"

# table of missing values 
mtab <- table(couchto5k$missing)

# remove anomalies
couchto5k <- couchto5k %>% filter(is.na(missing))

# store total number of observations 
total <- count(couchto5k)
```

The data were collected, and five unlikely observations were removed from the analysis , resulting in `r total` observations. Table 1 shows the number of removed data and their corresponding reasons of for removal.   

```{r table, results="asis"}
mtab %>% pander(caption = "Table 1: Summary of five unlikely observations.") 
```
```{r season typo correction}
# there is a typo in the season (autunm) instead of autumn
# number of typos
ntypo <- sum(couchto5k$season == "autunm") 
# rewrite all "autunm" to "autumn"
couchto5k$season[couchto5k$season == "autunm"] <- "autumn"

```

Additionally, `r ntypo` entries in the season group were misspelled as "autunm". These were corrected and rewritten to "autumn."

## Data Description 

```{r descriptives}
# make season as a factor to visualize data
couchto5k$season<-as.factor(couchto5k$season)
# make city as a factor to visualize data
couchto5k$city <-as.factor(couchto5k$city)

# look at the data 
# age 
plot_age<-couchto5k %>% ggplot(aes(x=age)) +
  geom_density()+
  geom_boxplot(width=1/250)+
  labs(x="Age of Participants (Years)",y="Density")+
  theme(text=element_text(size=6))

# accountability
plot_acc<-couchto5k %>% ggplot(aes(x=accountability))+
  geom_density()+
  geom_boxplot(width=1/200)+
  labs(x="Accountability (Scale 5-35 points)",y="Density")+
  theme(text=element_text(size=6))

# selfmot
plot_sel<-couchto5k %>% ggplot(aes(x=selfmot))+
  geom_density()+
  geom_boxplot(width=1/200)+
  labs(x="Self Motivation (Scale 5-35 points)",y="Density")+
  theme(text=element_text(size=6))

# There was an outlier in the score of self motivation, but it was not removed because it was still in the range of score between 5 and 35 points. It was justified as possible score. 

# health
plot_h <- couchto5k %>% ggplot(aes(x=health))+
  geom_density()+
  geom_boxplot(width=1/200)+
  labs(x="Health Metric (Scale 0-100 points)",y="Density")+
  theme(text=element_text(size=6))

# There was an outlier in the score of health metric, but it was not removed because it was still in the range of score between 0 and 100 points. It was justified as possible score.

# happiness
plot_hp <- couchto5k %>% ggplot(aes(x=happiness))+
  geom_density()+
  geom_boxplot(width=1/200)+
  labs(x="Happiness (Scale 0-100 points)",y="Density")+
  theme(text=element_text(size=6))

# week_stopped
plot_ws<-couchto5k %>% ggplot(aes(x=week_stopped))+
  geom_density()+
  geom_boxplot(width=1/100)+
  labs(x="Week Quitted (Scale 1-9 weeks)",y="Density")+
  theme(text=element_text(size=6))

# season
plot_ss <- couchto5k %>% ggplot(aes(x=season))+
  geom_bar()+
  labs(x=" Four Seasons ",y="Frequency")+
  theme(text=element_text(size=6))

# city
plot_c<-couchto5k %>% ggplot(aes(x=city))+
  geom_bar()+
  labs(x="City",y="Frequency")+
  theme(text=element_text(size=6))

# combine all plots together
plot_summary <- plot_grid(plot_age,plot_acc,plot_sel,plot_h,plot_hp,plot_ws,plot_ss,plot_c)

```


```{r Figure1, fig.asp=.6,fig.cap="Figure 1: the figure shows the summary of data after cleaning. One hundred twenty-eight participants were remained with different (1) age (age range: 18-60 years, M= 38 years, SD= 12 years). The scores, using a 5-question questionnaire (each scored 1-7 points), of (2) accountability (range:5-35 points, M=20 points, SD = 5.7 points) and (3) self motivation(range:6-23 points, M= 14.9 points, SD=3.4 points), were used to represent the effects of the psychological factors. Moreover, the scores, measured by various psychological tests (scale: 0-100 points in total), of (4) health (range:26-85 points, M= 57 points, SD=10 points) were used to represent the health metric. The scores, measured by a self-reported questionnaire (scale: 0-100 points), of (5) happiness (range: 0-100 points, M=49 points, SD=32 points) were used to represent participants' wellbeing. Week quit (scale 1-9 weeks) represents the (6) week they quit (range: 1-9 weeks, M=6.5 weeks, median = 9 weeks, SD= 3.2 weeks) in this nine-week fitness programme. The data were collected from (7) four seasons and (8) two cities. Note. Although both (3) self-motivation and (4) health metric have shown outliers, they were not removed because their scores were not out of range of the tests (i.e., the questionaire and health-measure tests). They were judged as potentially viable scores, thus the sample including them was judged as a potentially viable representation of the population.", message=FALSE}
plot_summary

```

# Question 1: General checks 

## Question 1a: Comparing the current data to earlier data
To investigate whether the distribution of the current data was in line with distribution of the earlier data, a chi-square goodness-of-fit test was performed, and the alpha level was set as 0.05 to test the statistical significance. 

```{r q1a, include = FALSE}
# use chi-test
# set up a new variable dividing weeks spent in programme into three categories: before week5, stopped after week5 including week5, and completed
couchto5k$t_stop <- NA
couchto5k$t_stop[couchto5k$week_stopped<5]<- "before week 5"
couchto5k$t_stop[couchto5k$week_stopped>=5 & couchto5k$week_stopped<9]<- "stopped after week5"
couchto5k$t_stop[couchto5k$week_stopped==9]<- "completed"

# table of three categories
chiTab <-table(couchto5k$t_stop)

# chi-test comparing distribution of current data to the distribution of earlier data
result1a<-chisq.test(chiTab,p=c(0.45,0.1,0.45))
```
There was a significant difference between the distribution of the current data and the data in the earlier survey, X^2(`r result1a$parameter`, N=`r total`) = `r result1a$statistic`, p < 0.001. Thus, the current data in sample are highly unlikely to be in line with the data from the earlier survey. 

## Question 1b: Comparing the attribution rates in different cities
To test whether the attrition rates were different in two cities (Edinburgh and Glasgow), a chi-square test of independence was performed, and the alpha level was set as 0.05 to test the statistical significance.

```{r q1b, include=FALSE}
# look at the mosaic plot to visualize data
# set up table between two cities 
tab1 <- table(couchto5k$t_stop,couchto5k$city)

# plot mosaic plot to visualize data 
plot(tab1,main="Difference between Cities and Time Stopped",col="lightblue")

# test for independence between groups 
result1b <-chisq.test(table(couchto5k$t_stop,couchto5k$city),simulate.p.value = T)

```

The result showed that the probability of finding the difference in attrition rates between the two cities (Edinburgh and Glasgow) was not significant, X^2(2,N=`r total`)=`r result1b$statistic`, p=`r result1b$p.value`. This suggests that the pattern of attrition rates did not differ between Edinburgh and Glasgow. 

## Question 1c: Compare Average Ages of Participants between Two Cities
To investigate the difference of the mean ages of the participants between Edinburgh and Glasgow, an independent sample t-test was performed. The alpha level was set as 0.05 to test the statistical significance.

```{r q1c, include=FALSE}
# set up a new variable mean_age to store the mean age of the participants in different cities

# independent sample t-test 
# look at the data 
ggplot(data=couchto5k,aes(x=age, y=city)) +
  geom_boxplot()+
  labs(x="Mean Ages of Participants (Years)",y="City")

# Assumptions Check 
assum1cE <-shapiro.test(couchto5k$age[couchto5k$city=="Edinburgh"])
qqnorm(couchto5k$age[couchto5k$city =="Edinburgh"])

assum1cG <-shapiro.test(couchto5k$age[couchto5k$city=="Glasgow"])
qqnorm(couchto5k$age[couchto5k$city =="Glasgow"])

with(couchto5k,var.test(age ~ city))

# perform t-test 
tresult <- with(couchto5k, t.test(age~city))

# report results 
result1c <- couchto5k %>% summarise(
  mean_ageE = mean(age[city=="Edinburgh"]),
  sdE = sd(age[city=="Edinburgh"]),
  mean_ageG = mean(age[city=="Glasgow"]),
  sdG = sd(age[city=="Glasgow"])
)

```
The assumption of normality of the data in the sample was tested. The Shapiro-Wilk normality test showed that the assumption was violated in the data from Edinburgh (W=`r assum1cE$statistic`, p<0.01) but not violated in the data from Glasgow (W=`r assum1cG$statistic`, p=  `r assum1cG$p.value`). However, when the data were plotted using a Q-Q plot, the data still appeared to be normally distributed. Therefore, it was decided to continue using the independent sample t-test to test the difference in mean ages between the two cities. 

The result showed that the difference between the mean ages of participants in Edinburgh (M= `r result1c$mean_ageE` years, SD= `r result1c$sdE` years) and the mean ages of participants in Glasgow (M=`r result1c$mean_ageG` years, SD= `r result1c$sdG` years) was not significant, t(`r tresult$parameter %>% round(0)`) =`r tresult$statistic`, p= `r tresult$p.value`. This suggests that the mean ages of participants were not different between Edinburgh and Glasgow.  

# Question 2: Happiness

## Question 2a: The relationship between happiness rating and Season
To investigate whether happiness ratings were affected by the four seasons, a simple linear regression model was created to demonstrate how the changes in a categorical predictor (seasons) would predict the changes in happiness ratings. The alpha level was set as 0.05 to test the statistical significance.  

```{r q2a, include=FALSE}
# plot data to visualize the relationship between seasons and happiness ratings 
couchto5k %>% ggplot(aes(x=season, y= happiness))+ 
  geom_point() +
  labs(x="seasons", y="happiness ratings (scale 0-100 pts") 

contrasts(couchto5k$season)
# relevel spring to the reference level 
couchto5k <- couchto5k %>% 
  mutate(season=relevel(season, ref="spring"))

# create a model predicting the effects of changing seasons on the happiness rating 
mod2a <- lm(happiness ~ season,data=couchto5k)

# assumptions check 
# plotting
plot(mod2a, which=1:4)

# check normality of residuals 
assum2a <- shapiro.test(residuals(mod2a))

# check homogeneity of variance of residuals
ncvTest(mod2a)

# check independence of residuals 
durbinWatsonTest(mod2a)

# report results 
summary_mod2a <- tidy(mod2a)
result2a <-summary(mod2a)
```

```{r q2a table, results='asis'}
pander(mod2a, caption = "Table 2: this table shows the regression analysis of the effects of seasons on happiness ratings.")
```

The assumptions of the linear model were checked by using plotting, the Shapiro-Wilk normality test (for nomality of residuals), the Durbin-Watson test (for indenpendence of residuals ), and the Non-constant Variance Score test (for homogeneity of variance). Only the assumption of normality was violated by Shapiro-Wilk test (W=`r assum2a$statistic`, p<0.01). However, the Q-Q plot showed that the data were close to a normal distribution. Therefore, it was decided to continue using the linear model to investigate and represent the effects of the seasons on happiness ratings.

The linear model used spring as the reference level, i.e., the mean of happiness ratings in other seasons was compared with the average happiness ratings in spring. The results showed that the average happiness ratings in spring was `r mod2a$coefficients[1]`points (b=`r mod2a$coefficients[1]`, t(`r mod2a$df`)=`r summary_mod2a$statistic[1]`, p<0.001). Moreover, the average happiness ratings in summer was `r mod2a$coefficients[3]` points (b=`r mod2a$coefficient[3]`, t(`r mod2a$df`)=`r summary_mod2a$statistic[3]`, p<0.01) higher than the average happiness ratings in spring. However, there was no significant difference found in autumn or winter. Therefore, the results suggest that the happiness ratings were affected by seasons, particularly in the spring and summer. 

## Question 2b: The effect of age on happiness ratings
To investigate whether the participants' age would additionally affect the happiness ratings, a new multiple regression model was created containing both the season and age as predictors for changes in happiness ratings. The season was placed before the age in the sequence of predictors because it was considered to be more likely to influence the happiness ratings. The ANOVA was used to test whether including the age could improve the model of predicting happiness ratings. The alpha level was set as 0.05 to test the statistical significance. 

```{r q2b, include=FALSE}
# plot data to visualize the relationship between ages and happiness ratings in different seasons 
couchto5k %>% 
  ggplot(aes(x=age, y= happiness))+ 
  geom_point() +
  labs(x="age", y="happiness ratings (scale 0-100 pts") +
  facet_wrap(~season)

# build model including season and age
mod2b <- lm(happiness ~ season + age,data=couchto5k)

# assumptions check 
# plotting
plot(mod2b, which=1:4)

# check normality of residuals 
shapiro.test(residuals(mod2b))

# check homogeneity of variance of residuals
ncvTest(mod2b)

# check independence of residuals 
durbinWatsonTest(mod2b)

# whether age additionally affect the happiness ratings 
anova(mod2b)
av2b <- tidy(anova(mod2b))
```

```{r q2b table, results='asis'}
pander(anova(mod2b), caption = "Table 3: this table shows the ANOVA analysis on the improvements of the model by including age as a predictor.")
```

There was no significant difference found between the models when including the age to further predict the happiness ratings (F(`r av2b$df[1]`,`r av2b$df[3]`)) = `r av2b$statistic[2]`, p=`r av2b$p.value[2]`). This suggests that the age did not improve the model any more than the model that only included season. Therefore, happiness is highly unlikely to be affected by the age when accounting for the effects of the seasons. 

## Question 2c: Choose the baseline model

According to the findings in the previous questions, the happiness ratings were only significantly affected by the season. Moreover,the season can explain the `r  result2a$r.squared * 100`% of variance in the model (R^2=`r result2a$r.squared`, F(`r result2a$fstatistic[2]`, `r result2a$fstatistic[3]`)=`r result2a$fstatistic[1]`, p<0.01). Including the season will help avoid any variance that is explained by the season, which will then reduce the potential confounding effects caused by the season. Therefore, the model with influsion of the season is justified as as a suitable baseline model for the further data analyses. 

# Question 3: Happiness and health 

## Question 3a: The effects of programme completion on happiness ratings 

To investigate whether completing the programme would affect the happiness ratings, a multiple regression model, containing hte season and the completion of the programme, was created to predict the happiness ratings. If an effect was present, the happiness ratings would change along with whether the participants completeed the programme. The alpha level was set as 0.05to test the statistical significance. 

```{r q3a, include=FALSE}
# set up a new variable storing information of whether participants have completed the programme
couchto5k  <- couchto5k %>% mutate(
  is_complete = ifelse(week_stopped==9,"Yes","No")
)
couchto5k$is_complete <- as.factor(couchto5k$is_complete)

# plot data to visualize the relationship between the completion of programme and happiness ratings in different seasons 
couchto5k %>% 
  ggplot(aes(x=is_complete, y= happiness))+ 
  geom_point() +
  labs(x="Completion of Programme (Yes/No)", y="happiness ratings (scale 0-100 pts") +
  facet_wrap(~season)

# reset the reference level 
contrasts(couchto5k$is_complete)
couchto5k <- couchto5k %>% mutate(
is_complete = relevel(is_complete, ref="No")
)

# build the model 
mod3a <- lm(happiness ~ is_complete + season ,data=couchto5k)

# assumptions check 
# plotting
plot(mod3a, which=1:4)

# check normality of residuals 
assum3a <-shapiro.test(residuals(mod3a))

# check homogeneity of variance of residuals
ncvTest(mod3a)

# check independence of residuals 
durbinWatsonTest(mod3a)

# check if the new model is better at predicting happiness ratings 
anova(mod3a)
av3a <- tidy(anova(mod3a))
# the ANOVA test shows that adding the predictor of whether participants complete the programme or not does not improve the model. 

# table of the results 
pander(mod3a)

# report results 
summary_mod3a <- tidy(mod3a)
```

The assumptions were checked, and only the assumption of normality was violated by the Shapiro-Wilk test (W=`r assum3a$statistic`, p<0.01). However, the distribution of data was still close to a normal distribution in the Q-Q plot. Therefore, it was decide to continue using the linear model to test whether the happiness ratings were affected by the completion of programme (indicated by a yes-no outcome). Moreover, the completion of the programme was placed before the season in the sequence of predictors because it was considered to be more likely to affect the happiness ratings than the seasons. 

There was no significant difference found in the effect of programme completion on happiness ratings (b=`r mod3a$coefficients[2]`, t(`r mod3a$df`) = `r summary_mod3a$statistic[2]`, p=`r summary_mod3a$p.value[2]`). This suggests that, when holding the season constant, the average happiness rating upon completing the programme was not significantly different from the average happiness rating when the programme was not completed. Therefore, the participants' happiness ratings were highly unlikely to be affected by whether they completed the programme or not. 


## Question 3b: Effect of Participants' Health on Happiness
Since the previous analysis indicateed that happiness ratings were not significantly affected by the completion of the programme, it was removed from happiness prediction ratings. Therefore, to investigate whether the health metric was associated with happiness, a new multiple regression model containing only the health metric and season was created. The health metric was placed before the season in the sequence of predictors because it was considered to be more likely to affect the happiness rating. The alpha level was set as 0.05 to test the statistical significance. 

```{r q3b, include=FALSE}
# plot data to visualize the relationship between ages and happiness ratings in different seasons 
couchto5k %>% 
  ggplot(aes(x=health, y= happiness))+ 
  geom_point() +
  labs(x="Health (Scale 0-100 pts)", y="happiness ratings (scale 0-100 pts") +
  facet_wrap(~season)

# build the model 
mod3b <- lm(happiness ~ health + season ,data=couchto5k)

# assumptions check 
# plotting
plot(mod3b, which=1:4)

# check normality of residuals 
shapiro.test(residuals(mod3b))

# check homogeneity of variance of residuals
ncvTest(mod3b)

# check independence of residuals 
durbinWatsonTest(mod3b)

# whether health metric additionally affect the happiness ratings 
anova(mod3b)
av3b <- tidy(anova(mod3b))
```

There was no significant difference found between the models when including the health metric to further predict the happiness rating (F(`r av3b$df[1]`,`r av3b$df[3]`)) = `r av3b$statistic[1]`, p=`r av3b$p.value[1]`). This suggests that the happiness ratings were unlikely to be additionally affected by the participants' health.

## Question 3c: The interaction effects between the number of weeks spent in the programme and the health metric on happiness ratings. 

To investigate the hypothesis of whether the participants' happiness is more affected by the health metric if they stay longer in the programmer than stopped earlier, the interaction effects between the health metric and the number of weeks the participants spent in the programme on happiness ratings were tested using a multiple regression model. Alpha level was set as 0.05 to test the statistical significance. 

```{r q3c, include=FALSE}

# build the model 
mod3c <- lm(happiness ~ health + week_stopped + season + health:week_stopped, data=couchto5k)

# assumptions check 
# plotting
plot(mod3c, which=1:4)

# check normality of residuals 
shapiro.test(residuals(mod3c))

# check homogeneity of variance of residuals
ncvTest(mod3c)

# check independence of residuals 
durbinWatsonTest(mod3c)

# report results 
summary_mod3c <- tidy(mod3c)
amplitude <- (c(summary_mod3c$estimate[2]+(summary_mod3c$estimate[7]*1), summary_mod3c$estimate[2]+(summary_mod3c$estimate[7]*6.5),  summary_mod3c$estimate[2]+(summary_mod3c$estimate[7]*9)))
```


```{r q3c figure, fig.asp=.5,fig.cap="Figure 2: this figure shows the interaction effects between the number of weeks spent in the programme and the health metric (X axis) on happiness (Y axis).", message=FALSE}

# plot the interaction 
figure3c<-interact_plot(mod3c, pred=health, modx=week_stopped,modx.values = c(1,6.5,9),x.label = "Health Metric (Scores)", y.label = "Happiness Ratings (Scores)",modx.labels = c("1 week (minimum week spent)","6.5 weeks (mean week)","9 weeks (maximum week spent"),legend.main = "Weeks in Programme",main.title = "Interaction Effects on Happiness")

# Change type of font to Times 
figure3c <- figure3c + theme(axis.title = element_text(family = "serif"), legend.text = element_text(family = "serif"), legend.title = element_text(family = "serif"),strip.text = element_text(family = "serif"))

# display the figure 
figure3c

```


The assumptions were checked, and the results showed that, although the health metric can affect the happiness ratings(b1=`r mod3c$coefficients[2]`, t(`r mod3c$df`) = `r summary_mod3c$statistic[2]`, p <0.001), the effects of health on happiness differ depending on the number of weeks the participant spent in the programme(b4=`r mod3c$coefficients[7]`, t(`r mod3c$df`) = `r summary_mod3c$statistic[7]`, p <0.001). This suggests that there were interaction effects between the health metric and the number of weeks spent in programme on happiness. However, the hypothesis cannot be accepted because the health metric would have larger effects on the happiness ratings either when participants stopped earlier (towards 1 week) or stayed longer (towards 9 weeks) in the programme (as shown in figure 2). In other words, the amplitudes of the health metric effect, calculated by steepness of the slope of happiness over the health metric (|b1+b4*number of weeks spent|), are both larger when participants stopped earlier (`r abs(amplitude[1])` at week 1) and stopped later (`r abs(amplitude[3])` at week 9), compared to when they stopped at the mean number of weeks (`r abs(amplitude[2])` at the mean week). 

The only difference between stopping earlier and later is that the participants' happiness ratings would be more negatively affected by the health metric if they stopped earlier, i.e., the increase in health scores would lead to more decrease in happiness ratings. However, the participants' happiness ratings would be more positively affected by the health metric if participants stayed longer in programme, i.e., the increase in health scores would lead to more increase in happiness ratings. Nevertheless, when the number of weeks the participants spent in the programme approached the average (6.5 weeks), the happiness ratings seemd to be less affected by the health metric (as shown in figure 2). Therefore, the hypothesis that the happiness was more affected by the health metric if they stayed longer (towards 9 weeks) in the programme than stopped earlier (towards 1 week) cannot be accepted. 

## Question 3d: Interpret of the results 

This research was interested in the Couch-to-5k programme's effect on participants' health and wellbeing, which was indicated by happiness ratings. The analysis has addressed different factors that might affect participants' health and wellbeing, including season, age, completion of programme, health, and interaction effects between health and the number of weeks spent in the programme. Linear models, including simple and multiple regression model, and ANOVA were used to test these effects. 

Regarding the season, there was a significant difference found in the season when predicting the happiness, particularly in spring (b=`r mod2a$coefficients[1]`, t(`r mod2a$df`)=`r summary_mod2a$statistic[1]`, p<0.001) and in summer (b=`r mod2a$coefficient[3]`, t(`r mod2a$df`)=`r summary_mod2a$statistic[3]`, p<0.01). This suggests that the season during which the participants take part in the programme would likely predict their wellbeing (happiness). 

Moreover, there was a significant difference found in the interaction effects between participants' health and the number of weeks they spent in the programme on predicting participants' happiness (b=`r mod3c$coefficients[7]`, t(`r mod3c$df`) = `r summary_mod3c$statistic[7]`, p <0.001). This suggests that the number of weeks the participants spent in the programme would differ the strength of the health effects on happiness. Health metric will be more likely to predict the happiness ratings if the participants spent more weeks in the programme (towards 9 weeks) or less weeks in the programme (towards 1 week). However, health metric will have less impact on happiness ratings if the participants spent around average weeks (6.5 weeks) in the programme. 

However, there was no significant difference found in participants' age(F(`r av2b$df[1]`,`r av2b$df[3]`)) = `r av2b$statistic[2]`, p=`r av2b$p.value[2]`), whether they completed the programme(b=`r mod3a$coefficients[2]`, t(`r mod3a$df`) = `r summary_mod3a$statistic[2]`, p=`r summary_mod3a$p.value[2]`), and health metric(F(`r av3b$df[1]`,`r av3b$df[3]`)) = `r av3b$statistic[1]`, p=`r av3b$p.value[1]`). This suggests that wellbeing is highly unlikely to be affected by participants' age, whether they completed the programme, and their health metric (without accounting for the interaction effects).

Therefore, according to the data, taking the programme in the spring and summer would likely increase participants' wellbeing. Moreover, although the model with only health metric did not predict the changes in happiness ratings, the effects of the health metric would be strengthened depending on the number of weeks participants spent in the programme. As shown in the figure 2, for example, when participants continued on the programme over approximately the mean number of weeks (6.5 weeks) or beyond, the longer they continue on the programme, the increase in their health metric would lead to more increase in their happiness ratings (wellbeing). 

# Question 4: The average happiness in different seasons across cities

```{r q4 figure1, fig.asp=.6,fig.cap="Figure 3: this figure shows the average happiness (Y axis) of the participants after either completing or quitting the programme in different seasons (X axis) in different cities (Edinburgh and Glasgow).", message=FALSE}
# create a subset of data that includes the participants who have completed the programme
couchsub <- couchto5k[couchto5k$is_complete =="Yes",]

# g_info stores the mean, max, and min of the values in groups to be used later on the graph
g_info <- couchsub %>% group_by(season,city) %>% summarise(mean_se(happiness))

# plot the average happiness ratings grouped by season and city
g_info %>% 
  ggplot(aes(x=season, y=y, ymin=ymin, ymax=ymax, fill=y)) + 
  geom_bar(stat="identity")+
  scale_fill_gradient()+
  geom_errorbar(width=.2)+
  labs(title="Average Happiness in Different Seasons Across Cities",x="Four Seasons",y="Average Happiness (Scores)",fill="Happiness Extent")+
  theme(text=element_text(size=10),axis.text.x = element_text(angle=60, hjust=1))+
  scale_y_continuous(breaks=seq(0,100,by=10))+
  facet_wrap(~city)

```


# Question 5: The predictors of dropout

## Question 5a: Model of likelihood of dropping out

This question was interested in predicting the likelihood of participants dropping out of the programme. Since the dependent variable (whether they drop out or not) was a binomial variable with a yes-no outcome, a generalised linear model was created to study the factors that can predict the binary outcome of the dependent variable. Moreover, the research was interested in whether the psychological factors (self motivation and accountability) would affect whether participants would drop out of the programme or not . Therefore, self motivation and accountability were chosen as predictors of the generalised linear model to predict the likelihood of dropping out. 

```{r q5a, include=FALSE}
# visualise data 
couchto5k %>% ggplot(aes(x=accountability,y=is_complete))+
  geom_jitter()+
  facet_wrap(~is_complete)

couchto5k %>% ggplot(aes(x=selfmot,y=is_complete))+
  geom_jitter()+
  facet_wrap(~is_complete)

# build the generalised linear model
mod5a <- glm(is_complete ~ accountability + selfmot ,data = couchto5k,family="binomial")


```

## Question 5b: Interpretion of the results

```{r q5b}
# report the results 
summary_mod5b <- tidy(mod5a)
```


```{r q5b table, results='asis'}
pander(mod5a, caption = "Table 2: this table shows the regression analysis of the effects of psychological factors (self motivation and accountability) on the likelihood of dropping out")
```

The research was interested in how psychological factors would affect the participants' devision to continue on the Couch-to-5K programme. Two hypotheses could be derived from the research interests, and a generalised linear model was used to test the effects of psychological factors on the likelihood of participants' decision to continue on the programme. 

The first hypothesis was that the likelihood of continuing with the programme would be affected by the sense of accountability felt by participants. However, no significant difference was found (b=`r mod5a$coefficients[2]`, z(`r mod5a$df.null`) = `r summary_mod5b$statistic[2]`, p =`r summary_mod5b$p.value[2]`) . This suggests that knowing the accountability of the participants could not predict the likelihood of whether people would continue on the programme. In other words, participants' sense of accountability was highly unlikely to affect their decision to continue with the programme. Thus the first hypothesis was rejected. 

The second hypothesis was that the likelihood of continuing with the programme would be affected by the participants' self motivation. However, no significant difference was found (b=`r mod5a$coefficients[3]`, z(`r mod5a$df.null`) = `r summary_mod5b$statistic[3]`), p =`r summary_mod5b$p.value[3]`) . This suggets that knowing participants' self motivation in people could not predict the likelihood of whether they would continue with the programme. In other words, self motivation was highly unlikely to affect the participants' decision to continue with the programme. Thus the second hypothesis was rejected. 

In conclusion, according to the data, both psychological factors (accountability and self motivation) of the participants did not affect their decision to continue the Couch-to-5K programme. 

## Question 5c: Graph of Probability of Quitting

```{r q5c, fig.asp=0.5,fig.cap ="Figure 4: This figure shows the association between the participants' self motivation (X axis) and the probability of quitting the programme (Y axis). Note that there is no significant association between participants' self motivation and the probability of quitting."}

# build the generlised linear model 
mod5c <- glm(is_complete ~ selfmot,data = couchto5k, family = "binomial")

# set a new variable to test whether participants quitted the programme
couchto5k <- couchto5k %>% mutate(
 is_quit = ifelse(week_stopped<9,1,0))

# draw the graph 
couchto5k %>% ggplot(aes(x=selfmot, y=is_quit))+
  labs(title="Effects of Self Motivation on Probability of Dropping Out",x="Self Motivaion (Scores)",y="Probability of Quitting")+
  geom_jitter(size=3,width=0,height=0.2,alpha=0.1) +
  geom_smooth(formula = y~x, method="glm", method.args=list(family=binomial))+
  scale_y_continuous(breaks=seq(0,1,by=0.2))

```








