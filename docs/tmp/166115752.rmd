---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  word_document: default
  pdf_document: default
  html_document: default
params:
  examnumber: B203729
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(pander)
library(sjPlot)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->

```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
# preliminary look at data
summary(couchto5k)

# set up variable to record problematic data
couchto5k$problem <- NA

# age should be 0~100 (ideally)
couchto5k$age[couchto5k$age<0 | couchto5k$age>100] 
# 2 values over 100
# set them to NA and document in $problem 
couchto5k$problem[couchto5k$age>100] <- "impossible age"
couchto5k$age[couchto5k$age>100] <- NA

# accountability should be 5~35
couchto5k$accountability[couchto5k$accountability<5 | couchto5k$accountability>35]
# check passed 

# selfmot should be 5~35
couchto5k$selfmot[couchto5k$selfmot<5 | couchto5k$selfmot>35]
# 2 values less than 5
# using paste to avoid replacing previous "problem" value
couchto5k$problem[couchto5k$selfmot<5] <- "invalid selfmot score"
couchto5k$selfmot[couchto5k$selfmot<5] <- NA

# health should be 0~100
couchto5k$health[couchto5k$health<0 | couchto5k$health>100]
# check passed

# happiness should be 0~100
couchto5k$happiness[couchto5k$happiness<0 | couchto5k$happiness>100]
# check passed 

# season should be a factor and one of spring, summer, autumn, winter
table(couchto5k$season)
# correct 5 typos for autumn
couchto5k$season[couchto5k$season == "autunm"] <- "autumn"
couchto5k$season <- as.factor(couchto5k$season)

# city should be a factor and either Edinburgh or Glasgow
table(couchto5k$city)
# check passed 
couchto5k$city <- as.factor(couchto5k$city)

# week_stopped should be 0~9
couchto5k$week_stopped[couchto5k$week_stopped<0 | couchto5k$week_stopped>9]
# 1 value over 9
couchto5k$problem[couchto5k$week_stopped>9] <- "invalid week_stopped"
couchto5k$week_stopped[couchto5k$week_stopped>9] <- NA

total <- count(couchto5k)
```

There were a total of `r total` observations in the Couch to 5K dataset. After inspection, unlikely values (impossible ages, invalid scores, etc.) were replaced with 'NA'.

```{r}
spring_per <- round((sum(couchto5k$season == 'spring') / count(couchto5k))*100, digits = 2)
summer_per <- round((sum(couchto5k$season == 'summer') / count(couchto5k))*100, digits = 2)
autumn_per <- round((sum(couchto5k$season == 'autumn') / count(couchto5k))*100, digits = 2)
winter_per <- round((sum(couchto5k$season == 'winter') / count(couchto5k))*100, digits = 2)

edinburgh_per <- round((sum(couchto5k$city == 'Edinburgh') / count(couchto5k))*100, digits = 2)
glasgow_per <- round((sum(couchto5k$city == 'Glasgow') / count(couchto5k))*100, digits = 2)

finish_per <- round((sum(couchto5k$week_stopped == 9, na.rm=TRUE) / count(couchto5k))*100, digits = 2)
drop5_per <- round(sum(couchto5k$week_stopped < 5, na.rm=TRUE) / (count(couchto5k)-sum(couchto5k$week_stopped == 9, na.rm=TRUE))*100, digits = 2)
```

The dataset includes the following columns: age, accountability, self motivation, health, happiness, season, city, and week stopped. Below are descriptions and visualisations of each variable.

Age (Figure 1) is distributed between the minimum age of `r min(couchto5k$age, na.rm=TRUE)` and the maximum age of `r max(couchto5k$age, na.rm=TRUE)`. The mean is `r mean(couchto5k$age, na.rm=TRUE)` and the standard
deviation is `r sd(couchto5k$age, na.rm=TRUE)`.

Accountability and self motivation (Figures 2 & 3) are scored from 1-7 for 5 questions each, resulting in a score range of 5-35. The minimum, maximum, mean, 
and standard deviation for both are shown in Table 2. 

```{r table, results="asis"}
tab <- matrix(c(min(couchto5k$accountability), max(couchto5k$accountability), 
                mean(couchto5k$accountability), sd(couchto5k$accountability), 
                min(couchto5k$selfmot, na.rm=T), max(couchto5k$selfmot, na.rm=T),
                mean(couchto5k$selfmot, na.rm=T), sd(couchto5k$selfmot, na.rm=T)),
              ncol=4, byrow=TRUE)
colnames(tab) <- c('Minimum','Maximum','Mean', 'Standard Deviation')
rownames(tab) <- c('Accountability', 'Self Motivation')
tab <- as.table(tab)
tab %>% pander(caption="Table 2: Data description of accountability and self motivation.")
```

Health and happiness (Figures 4 & 5) are scored from 0-100. The minimum, maximum, mean, and standard deviation for both are shown in Table 3. 

```{r table3, results="asis"}
tab <- matrix(c(min(couchto5k$health), max(couchto5k$health), 
                mean(couchto5k$health), sd(couchto5k$health), 
                min(couchto5k$happiness), max(couchto5k$happiness),
                mean(couchto5k$happiness), sd(couchto5k$happiness)),
              ncol=4, byrow=TRUE)
colnames(tab) <- c('Minimum','Maximum','Mean', 'Standard Deviation')
rownames(tab) <- c('Health', 'Happiness')
tab <- as.table(tab)
tab %>% pander(caption="Table 3: Data description of health and happiness.")
```

Season (Figure 6) refers to the time of year when participants are interviewed. Spring is the most frequent season with `r spring_per`% of participants, while summer, autumn, and winter have `r summer_per`%, `r autumn_per`%, and `r winter_per`% respectively.

City (Figure 7) refers to the place where participants are recruited. `r edinburgh_per`% are from Edinburgh and `r glasgow_per`% Glasgow. 

Week stopped (Figure 8) refers to when the participant finished or dropped out of the program. A value of 9 means the participant had completed all 9 weeks. Over half of the participants (`r finish_per`%) finished the program. For those who dropped out, `r  drop5_per`% did so before week 5. 

```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 

# age 
ggplot(data = couchto5k, aes(x = age)) +
  geom_histogram(binwidth = 5, color='black', size = 0.2)+
  labs(x = "Age", y = "Count", title = "Age frequency")

# accountability
ggplot(data = couchto5k, aes(x = accountability)) +
  geom_density()+
  xlim(5,35)+
  labs(x = "Accountability Score", y = "Density", title = "Accountability score density")
# shapiro.test(couchto5k$accountability)

# selfmot
ggplot(data = couchto5k, aes(x = selfmot)) +
  geom_density()+
  xlim(5,35)+
  labs(x = "Self Motivation Score", y = "Density", title = "Self motivation score density")
# shapiro.test(couchto5k$selfmot)

# health
ggplot(data = couchto5k, aes(x = health)) +
  geom_density()+
  xlim(0,100)+
  labs(x = "Health Score", y = "Density", title = "Health score density")
# shapiro.test(couchto5k$health)

# happiness
ggplot(data = couchto5k, aes(x = happiness)) +
  geom_density()+
  xlim(0,100)+
  labs(x = "Happiness Score", y = "Density", title = "Happiness score density")
# shapiro.test(couchto5k$happiness)

# season
positions <- c("spring", "summer", "autumn", "winter")
ggplot(data = couchto5k, aes(x = season)) +
  geom_bar(width=0.5)+
  scale_x_discrete(limits = positions)+
  labs(x = "Season", y = "Count", title = "Season of interview frequency")

# city 
ggplot(data = couchto5k, aes(x = city)) +
  geom_bar(width=0.5)+
  labs(x = "City", y = "Count", title = "Participant recruitment city frequency")

# week_stopped
ggplot(data = couchto5k, aes(x = week_stopped)) +
  geom_bar() + 
  labs(x = "Week Stopped", y = "Count", title = "Frequency of weeks participants stopped in")+
  scale_x_continuous(breaks=0:9)
```

# Question 1 

## Question 1a

```{r q1a}
couchto5k$complete <- NA
couchto5k$complete[couchto5k$week_stopped==9] <- "completed"
couchto5k$complete[couchto5k$week_stopped<5] <- "stopped before week 5"
couchto5k$complete[couchto5k$week_stopped>=5 & couchto5k$week_stopped<9 ] <- "stopped after week 5"

complete_data = c(sum(couchto5k$complete == 'stopped before week 5', na.rm=T), sum(couchto5k$complete == 'stopped after week 5', na.rm=T), sum(couchto5k$complete == 'completed', na.rm=T))
survey = c(0.45, 0.10, 0.45)
complete_fit <- chisq.test(complete_data, p=survey)
```

To test if the data follows the general trend of the earlier survey, I conduct a 
chi-square goodness of fit test to see if the proportions of completion status 
are comparable, and set significance level alpha to 0.05. The p-value was >.05 
(p=`r complete_fit$p.value`), which means the proportion of our data is not 
significantly different from that of the survey.  

## Question 1b

```{r q1b}
city_table <- table(couchto5k$city, couchto5k$complete)
city_fit <- chisq.test(city_table[1, ], p=city_table[2, ]/rowSums(city_table[,c(1, 2, 3)])[2])

```

The frequencies of completeness between Edinburgh and Glasgow is shown in Figure 
9. Using a chi-square goodness of fit test, I conclude that the proportions of 
completeness between cities is significantly different (p=`r city_fit$p.value`). 

```{r}
ggplot(data = couchto5k, aes(fill = city, x = complete)) +
  geom_bar(width=0.5, position="dodge") + 
  scale_x_discrete(guide = guide_axis(n.dodge=6))+
  labs(x = "Completion Status", y = "Count", title = "Completion status by city")+
  scale_x_discrete(na.translate = FALSE)
```


## Question 1c

```{r q1c}

mean(couchto5k$age[couchto5k$city == 'Edinburgh'], na.rm=T)
mean(couchto5k$age[couchto5k$city == 'Glasgow'], na.rm=T)

city_t <- t.test(couchto5k$age[couchto5k$city == 'Edinburgh'], couchto5k$age[couchto5k$city == 'Glasgow'])

city_t$p.value
```

The average age of participants from Edinburgh is `r mean(couchto5k$age[couchto5k$city == 'Edinburgh'], na.rm=T)` and `r mean(couchto5k$age[couchto5k$city == 'Glasgow'], na.rm=T)` 
for Glasgow. To test if the average is statistically different, I conduct a t-test and set significance level alpha to 0.05. The p-value was <0.05 (p=`r city_t$p.value`), which indicates that the true difference in the averages are not equal to 0, therefore the average ages of participants differ by city. 

# Question 2

## Question 2a

```{r q2a}
couchto5k <- couchto5k %>% 
  mutate(season = season %>%
           fct_relevel("spring")
         )

season_model <- lm(happiness ~ 1 + season, data = couchto5k)
summary(season_model)$coef

season_table <- couchto5k %>% group_by(season) %>%
  summarise(mean_se(happiness))

season_table %>% ggplot(aes(x=season,y=y,ymin=ymin,ymax=ymax)) +
  geom_bar(stat="identity", width = 0.7) +
  geom_errorbar(width=0.2) +
  scale_x_discrete(limits = positions)+
  labs(x = "Season", y = "Happiness", title = "Happiness predicted by season")
```

To understand if and how season affects happiness rating, I fit a linear model (2a) and summarise the results in Table X. The model predicts that for spring participants, the estimated happiness rating is `r summary(season_model)$coef[1, 1]`. For summer, that rating decreases by `r -summary(season_model)$coef[3, 1]`, 
for autumn, the rating decreases by `r -summary(season_model)$coef[2, 1]`, and for winter, the rating decreases by `r -(summary(season_model)$coef[4, 1])`. However, the effect of season on happiness rating is not significant for summer (p=`r summary(season_model)$coef[3, 4]`) and winter (p=`r summary(season_model)$coef[4, 4]`). 

## Question 2b

```{r q2b}
seasonage_model <- lm(happiness ~ 1 + season + age, data = couchto5k)
summary(seasonage_model)$coef

```

I fit another model (2b) to understand if happiness is affected by age when accounting for effects discovered in the previous model (2a), which is the effect of season. The results are summarised in Table X. The model estimates a happiness score of `r summary(seasonage_model)$coef[1, 1]` for spring participants with an age of 0. The score decreases by `r -summary(seasonage_model)$coef[4, 1]` for summer participants, decreases by `r -summary(seasonage_model)$coef[3, 1]` for autumn participants, and decreases by `r -summary(seasonage_model)$coef[5, 1]` for winter participants. As age increases by 1 year, the happiness score is predicted to decrease by `r -summary(seasonage_model)$coef[2, 1]`. However, only the prediction of 0-year-old spring participants is significant with p < .05. All other coefficient p-values are above the set alpha value.  


## Question 2c

```{r q2c}
#summary(season_model)$adj.r.squared
#summary(seasonage_model)$adj.r.squared
```

I am basing my choice of baseline model on how well the model explains variance in the data. By comparing the adjusted r-sqaured value of model 2a (`r summary(season_model)$adj.r.squared`)and 2b (`r summary(seasonage_model)$adj.r.squared`), we can see that model 2a has better explanatory power.  

# Question 3

## Question 3a

```{r q3a}
# make new column for completion status 
couchto5k$complete_stat <- ifelse(couchto5k$complete=="completed", "completed", "incomplete")
couchto5k$complete_stat <- as.factor(couchto5k$complete_stat)

model3a <- lm(happiness ~ 1 + complete_stat + season, data = couchto5k)
summary(model3a)$coef
```

Results of the model (3a) are summarised in Table X. The model predicts that for a spring participant that completed the program, the predicted happiness rating is `r summary(model3a)$coef[1, 1]`. For summer participants, that rating drops by `r -summary(model3a)$coef[4, 1]`, for autumn participants, rating drops by `r -summary(model3a)$coef[3, 1]`, and for winter, rating drops by `r -summary(model3a)$coef[5, 1]`. If the participant did not complete the program, happiness rating would drop by `r -summary(model3a)$coef[2, 1]`. However, only the prediction of completed spring participants and autumn participants reach the level of significance. 

## Question 3b

```{r q3b}

model3b <- lm(happiness ~ 1 + health + complete_stat + season, data = couchto5k)
summary(model3b)$coef

```

This model (3b) adds the health metric as a predictor into the previous model (3a). It predicts that for each additional 1 point on the health metric, happiness rating would increase by `r summary(model3b)$coef[2, 1]`. However, this prediction did not pass the significance threshold (p=`r summary(model3b)$coef[2, 4]`). 

## Question 3c

```{r q3c}
model3c <- lm(happiness ~ 1 + complete_stat*health + season, data = couchto5k)
summary(model3c)$coef
```

This model (3c) explores the relationship between health rating and completion status within the previous model (3b). I add an interaction term to To investigate this relationship. Results are summarised in Table X. The interaction term between health rating and completion status is `r summary(model3c)$coef[7, 1]`, which is a negative number and reaches significance (p<.05, p=`r summary(model3c)$coef[7, 4]`). This means the model predicts that there is a significant negative change in the slope of best-fit line between the completed and incompleted groups (Figure X). Therefore, the effect of completion status on happiness decreases when health rating is higher, and the effect of health decreases when participants did not complete the program. In other words the effect of health is greater for those who did complete the program .


```{r}
plot_model(model3c, type = "pred", terms = c("health", "complete_stat"))
```

## Question 3d

Based on previous models, we can observe that although the baseline model(2a) uses season as a predictor, it does not have much explanatory power over the cause of happiness as the season coefficients often don't meet the significance level. Age is also not a significant predictor as can be seen in model 2b. Health rating and completion status as predictors on their own did not reach significance, but can explain differences in predicted happiness score when we define an interaction term between the two (models 3a, 3b, and 3c). 

# Question 4

```{r q4}
# create subset of participants who completed the program 
done <- couchto5k[couchto5k$complete_stat == "completed", ]

done_group <- done %>% 
        group_by(season, city) %>% 
        summarise(avg_happy = mean(happiness))

done_group <- drop_na(done_group)

ggplot(data = done_group, aes(x=season, y=avg_happy))+
  geom_bar(stat='identity')+
  facet_wrap(~city)+
  labs(x = "Season", y = "Mean happiness rating", title = "Mean happiness rating grouped by city and season")
  

```


# Question 5

## Question 5a

```{r q5a}
dropout <- glm(complete_stat ~ selfmot + happiness*health, data = couchto5k, family="binomial")
summary(dropout)$coef
```

I fit a general linear model using self motivation score, happiness, and health as predictors to the possibility of a participant dropping out of the program. I defined an interaction term in the model to account for possible relationships between happiness and health as suggested by previous models. The results are summarised in Table X.  

## Question 5b

```{r q5b}
```

Self motivation is a significant predictor (p=`r summary(dropout)$coef[2, 4]`) of drop-out probability. For each additional point of self motivation score, the log-odds of dropping out decreases by `r -summary(dropout)$coef[2, 1]`. Happiness is also significant (p=`r summary(dropout)$coef[3, 4]`). For each additional point of happiness rating, the log-odds of dropping out increases by `r -summary(dropout)$coef[3, 1]`.

Health rating did not reach significance level but the interaction term between happiness and health did (p=`r -summary(dropout)$coef[5, 4]`). However, the effect is small (`r summary(dropout)$coef[5, 1]`) and possibly negligible. 



## Question 5c

```{r q5c}
couchto5k$dropout <- ifelse(couchto5k$complete=="completed", 0, 1)
couchto5k$dropout <- as.numeric(couchto5k$dropout)

ggplot(data = couchto5k, aes(x=selfmot,y=dropout)) +
  geom_jitter(size=3,width=0,height=.2,alpha=.1) +
  geom_smooth(method="glm",method.args=list(family=binomial)) +
  scale_y_continuous(breaks=seq(0,1,by=.2))+
  labs(x = "Self motivation score", y = "p(dropped out)", title = "Probability of dropping out predicted by self motivation score")
```









