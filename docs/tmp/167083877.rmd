---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
  pdf_document: default
params:
  examnumber: B201467
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")

```

# Question 0

<!-- Cleaning data: 
cleaning data consists of two steps, cleaning all impossible values and cleaning all outliers. First, I plot all the variables in the data frame, with numeric data as histogram and categorical data as table, and comparing them to the description of data in the data dictionary, then delete the impossible values. To cleaning the outliers, I remove the data which are larger than 3 standard deviations away from the mean. -->

```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document.
#clean the impossible values
hist(couchto5k$age)
hist(couchto5k$accountability)
hist(couchto5k$selfmot)
hist(couchto5k$health)
hist(couchto5k$happiness)
hist(couchto5k$week_stopped)
table(couchto5k$season)
table(couchto5k$city)
couchto5k$season[couchto5k$season == "autunm"] <- "autumn"
couchto5k$week_stopped[couchto5k$week_stopped > 9] <- NA
couchto5k$selfmot[couchto5k$selfmot < 5] <- NA
couchto5k$selfmot[couchto5k$selfmot > 35] <- NA
couchto5k$accountability[couchto5k$accountability < 5] <- NA
couchto5k$accountability[couchto5k$accountability > 35] <- NA

# clean the outliers
df <- tibble(
  couchto5k$age,
  couchto5k$accountability,
  couchto5k$selfmot,
  couchto5k$health,
  couchto5k$happiness,
  couchto5k$week_stopped
)

outliers <- function(obs, x = 3){
  abs(obs - mean(obs, na.rm=TRUE)) > (x * sd(obs, na.rm=TRUE))
}

output <- vector("double", ncol(df))
for (i in seq_along(df)) {
  outliers(obs = df[[i]])
  couchto5k$age[outliers(df[[i]])]<- NA
}
```
<!--Data description: 
There are 8 variables in this data frame, where age, accountability, self-motivation, health, happiness are numerric data, and season and city are categorical data. 
The age of the participants ranges from 18 to 60, the mean age is 39.2.
The accountability score ranges from 5 to 35, the mean score is 19.6.
The self-motivation score ranges from 7 to 23, the mean score is 14.8.
The health score ranges from 22 to 79, the mean score is 47.
the happiness score ranges from 0 to 100, the mean score is 44.6.
Participants participated in at least one week of programme, and the most completed nine weeks. The average number of weeks they drop out is 6.2 weeks.
according to the density plot below, we can find that accountability score, self-motivation score and health score are roughly comform to a normal distribution, while age, happiness and the week of programme participants stopped in are not. The age of participants is concentrated between 25 and 50 years old；and their happiness scores were concentrated between 0 and 25. Almost 20% of participants completed the full programme. 
The most people start the programme in spring and summer of the four seasons, and there are also many more participants in Edinburgh than in Glasgow -->
```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 
ggplot(data = couchto5k, aes(x = age)) +
    geom_density() +
    labs(x = "- Age -")

ggplot(data = couchto5k, aes(x = accountability)) +
    geom_density() +
    labs(x = "- Accountability -")

ggplot(data = couchto5k, aes(x = selfmot)) +
    geom_density() +
    labs(x = "- Selfmot -")

ggplot(data = couchto5k, aes(x = happiness)) +
    geom_density() +
    labs(x = "- Happiness -")

ggplot(data = couchto5k, aes(x = health)) +
    geom_density() +
    labs(x = "- Health -")

ggplot(data = couchto5k, aes(x = week_stopped)) +
    geom_density() +
    labs(x = "- Week Stopped -")
summary(couchto5k)

ggplot(data = couchto5k, aes(x = season)) +
  geom_bar()
ggplot(data = couchto5k, aes(x = city)) +
  geom_bar()
```

# Question 1 

## Question 1a
<!--I have divided the number of weeks that participants stop the programme into three stages. Stage 1 participants stopped at or before week 5, Stage 2 participants lasted between 6 and 9 weeks, and Stage 3 participants completed the full programme. 
After looking at the observe counts, I conduct a chi-suqred test to compare this data set with the attrition rates of previous years. -->

```{r q1a}
couchto5k <- couchto5k %>% mutate(stage = 2)
couchto5k$stage[couchto5k$week_stopped == 9] <- 3
couchto5k$stage[couchto5k$week_stopped <= 5] <- 1

table(couchto5k$stage)
chisq.test(table(couchto5k$stage),p=c(.45,.1,.45))
```
<!--p value > 0,05, indicating that current year's attrition rate is in line with previous years and has not changed significantly-->
## Question 1b
<!-- Fisrtly I plot a percent stacked barchart to observe and compare attrition rates in Edinburgh and Glasgow, then conduct a chi-suqred test to test whether attrition rates vary by region. -->
```{r q1b}
city_attrition <- table(couchto5k$city, couchto5k$stage)
plot(city_attrition)
chisq.test(city_attrition)
```
<!-- According to the barchart and p value (p > 0.05), we can find that there is no significant difference in attrition rates between the two cities -->
## Question 1c
<!-- Firstly I plot a box plot with age on the x-axis and city on the y-axis to see if there is a significant difference in the age of participants in the two cities. Then shapiro test is used for confirm that the two sets of data are normally distributed or not. Then I use a t-test to determine whether the mean age of participants significantly vary by cities.-->
```{r q1c}
ggplot(data = couchto5k, aes(x = age, y = city)) +
  geom_boxplot()
shapiro.test(couchto5k$age[couchto5k$city=="Edinburgh"])
shapiro.test(couchto5k$age[couchto5k$city=="Glasgow"])
with(couchto5k, t.test(age ~ city, alternative = "two.sided"))
```
<!--The box plot shows that the average age of participants in Edinburgh and Glasgow is about the same, around 40 years old 
After conducting the shapiro test,the p value of both of the age of participants in two cities are smaller than 0.05(p-value = 0.006 in Edinburgh and p-value = 0.02 in Glasgow), so we can infer that both sets of data roughly conform to a normal distribution, and t-test can be used in this situation. 
The p valu of t-test is larger than 0,05 (p-value = 0,8), suggesting that the average ages of participants do not differ by city.
-->

# Question 2

## Question 2a
<!--Firstly, I will plot a box plot with season as the x aixs and happiness as the y aixs to observe is happiness different in different seasons.
Then I will try to fit a simple linear regression model as below use the lm() function
Hppiness = b0 + b1 season + ϵ
whereϵ∼N(0,σ) independently
-->
```{r q2a}
ggplot(data = couchto5k, aes(x = season, y = happiness)) +
  geom_boxplot()
mod.1 <- lm(happiness ~ factor(season), data=couchto5k)
summary(mod.1)

# the p-value is bigger than 0.05 (p-value = 0.07), showing that this linear model is not fit for the sample data. However, according to the box plot, I find that the average happiness score of summer and spring are larger than that of winter and autumn, so we can speculate that there is a difference between the happiness scores in the warmer seasons and the colder seasons. So I divided the four seasons into two categories, namely spring/summer and autumn/winter.
couchto5k <- couchto5k %>% 
  mutate(season_category = season)
couchto5k$season_category[couchto5k$season_category == "spring"] <- 1
couchto5k$season_category[couchto5k$season_category == "summer"] <- 1
couchto5k$season_category[couchto5k$season_category == "autumn"] <- 0
couchto5k$season_category[couchto5k$season_category == "winter"] <- 0

# Then I fit a simple linear regression model to the new category as below and use lm() function,
#Hppiness = b0 + b1 season_category + ϵ
#whereϵ∼N(0,σ) independently
mod.2 <- lm(happiness ~ factor(season_category), data=couchto5k)
summary(mod.2)
#p-value = 0.0136, samller than 0.05, showing that knowing about season category improves the model over a null model in which we know nothing other than what the happiness scores are. So,the sample data can be fitted into this linear model.
#The multiple R-squared is 0.0436, indicating that knowing about season category allow us to account for 4% of the variance that's in the model.  
coef(mod.2)
#The fitted line is:
#Hppiness = 29.6 + 18.1 season_category + ϵ
#The linear model indicates that the participants' happiness score increased by 18.1 when starting the programme at the warmer season.
ggplot(data = couchto5k, aes(x = season_category, y = happiness)) + 
  geom_boxplot()
# Then I plot a box plot to confirm again. The box plot shows that average happiness in spring and summer is higher than in autumn and winter.
```

## Question 2b
<!--Build on the effect I discover above, I add age as another predictor to build a multiple regression model:
Happiness = b0 + b1 age + b2 season_category + ϵ
whereϵ∼N(0,σ) independently

Then I plot a scattered plot to observe whether the multiple regression model is suitable for the sample data.
--> 
```{r q2b}
mod.3 <-lm(happiness ~ age + season_category, data=couchto5k)
summary(mod.3)
# According to the summary of the model we built, the p value of coefficient of age is larger than 0.05 (p value = 0.132), suggesting that the actual coefficient of age do not statistically differ from 0. So we can conclude that happiness do not additionally affected by age.
#Apart from that, the F-statistic of model 3 is smaller than that of model 2, indicating that this multiple regression model does not improve over the previous model. 
ggplot(data = couchto5k, aes(x = age, y = happiness)) + 
  geom_point() + 
  geom_smooth(method = 'lm') +
  facet_wrap(~season_category)
# the scattered plot also shows that the regression model do not fit in our data.
```
 
## Question 2c
<!-- I will build a multiple regression model as a baseline model for further analysis, adding the predictors I have already analyzed in above questions and the interaction between them, using anova test to see which predictor can improve the model over chance. Then I will reduce the predictor which are less likely to improve our model, and test if the new model is more suitble for our data set.  -->
```{r q2c}
mod.4 <- lm(happiness ~ health + week_stopped + season_category + age + health:week_stopped + week_stopped:season_category +age:season_category + age:health, data = couchto5k)
anova(mod.4)
# the result of anova test shows that the effect of week_stopped, age, the interaction between week_stopped and season_category, the interaction between season_category and age, and the interaction between health and age are not significant, all of their p value are bigger than 0.05, and F ratios are small. 
#Only the effect of season_category (p value = 0.0043) and the interaction between health and week_stopped (p value = 3.4e-05) are significant. 
mod.4reduced <- lm(happiness ~ health:week_stopped + season_category, data = couchto5k)
summary(mod.4reduced)
#After testing the improved model, we can see that 
```

# Question 3

## Question 3a
<!--I will create a new column and classify the completion status of participants, and name it "whether_complete". Those who participated in the nine-week project will be marked as 1, and those who have not completed will be marked as 0.
Then, based on the model I built in 2c, I will replace the predictor week_stopped with the new predictor whether_complete, and build a new multiple regression model. Then take an anova test to determine whether the completion status will have an effect on happiness score. 
-->
```{r q3a}

couchto5k <- couchto5k %>% 
  mutate(whether_complete = week_stopped)
couchto5k$whether_complete[couchto5k$whether_complete < 9] <- 0
couchto5k$whether_complete[couchto5k$whether_complete == 9] <- 1

mod.5 <- lm(happiness ~ whether_complete + season_category + whether_complete:health, data = couchto5k)
anova(mod.5)
#the result of anova test shows that the completion status does not improve the model(p value = 0.11). So,  programme completion cannot significantly influence happiness outcomes. To confirm this result, we plot another scatters plot.

ggplot(data = couchto5k, aes(x = whether_complete, y = happiness)) + 
  geom_point()
# We can find that regardless of whether it is completed or not, the value of happiness is evenly dispersed in the range of 0-100, which confirm the result we have. 
```

## Question 3b
<!--To test whether happiness scores additionally affected by the health condition, I will again, add health as a predictor to our model, and conduct the anova test. Then plot a scattered plot to check our result.-->
```{r q3b}
mod.6 <- lm(happiness ~ health + season_category + health:whether_complete, data = couchto5k)
anova(mod.6)
# The result of the anova test indicates that health cannot significantly affect happiness scores, because the p-value is larger than 0.05 (p value = 0.65). 
ggplot(data = couchto5k, aes(x = health, y = happiness)) + 
  geom_point()
# the plot confirms the result of the above test. We observe that regardless of the value of health, happiness may be distributed in the range of 0-100. Therefore, changes in health cannot significantly affect the changes in happiness
```

## Question 3c

```{r q3c}
#to test the hypothesis, building on the model in 3b, I will delete the predictor like season_category, which is not related to either health score or completion status; leaving the single predictor, namely the interaction between health and completion status.Through this model, we can  estimating the extent to which the effect of health on happiness is different across the values of completion status.  
#happiness = b0 + b1(health) + b2(whether_complete) + b3(health * whether_complete) + ϵ 
#whereϵ∼N(0,σ) independently
library(sjPlot)
mod.7 <- lm(happiness ~ 1 + health*whether_complete, data = couchto5k)
anova(mod.7)
#according to the result, the interaction between completion and health is significant (p value = 6.3e-06).
#in this case, we should talk about a conditional effect of health scores on happiness at a specific value of completion status. 
coefficients(mod.7)
plot_model(mod.7, type = "pred",  terms=c("health","whether_complete"), show.data=TRUE)
# according to the plot, if the participant complete the programme, the healthier he is, the higher happiness score he will get. If the participant does not complete the programme, the healthier he is, the lower happiness score he will get. In conclusion, the hypothesis can be proved.
```

## Question 3d

Happiness will be affected by the various of seasons and the interaction between health metric and the completion status. participants' happiness score increased by 18.1 when starting the programme at the warmer season; besides, when the participant complete the programme, the healthier the he is, the higher happiness score he will get. If the participant does not complete the programme, the healthier he is, the lower happiness score he will get.
# Question 4

```{r q4}
#To visualize the average happiness ratings grouped by season and city, I plot a box plot, with the two cities on the x axis and the happiness ratings on the y axis. For each city category, there are four different boxes in different colors indicating the four seasons. 
complete_data <- couchto5k %>%filter(couchto5k$whether_complete == 1)
complete_data %>% 
  ggplot(aes(x=city, y=happiness, fill=factor(season))) +
  geom_boxplot() 
```


# Question 5

## Question 5a

```{r q5a}
#I add a new column to record whether each participant dropped out. Contrary to the completion, people who drop out will be marked as 1, while those who have completed will be marked as 0.
library(car)
couchto5k <- couchto5k %>% 
  mutate(dropout = week_stopped)
couchto5k$dropout[couchto5k$dropout < 9] <- 1
couchto5k$dropout[couchto5k$dropout == 9] <- 0
# Then I build a generalized linear model as below to measure the likelihood of dropout ratings. The predictors are self-motivation, accountability, age, happiness and health.
model.8 <- glm(dropout ~ selfmot + accountability + age + happiness + health, data = couchto5k, family="binomial")
Anova(model.8, type = 3)
#after conducting the anova test, we can find that only age and self-motivation are significant, with p value smaller than 0.05. So I improve this model by eliminating the insignificant predictors, leaving only self-motivation and age.
model.8reduced <- glm(dropout ~ selfmot + age, data = couchto5k, family="binomial")
summary(model.8reduced)
#comparing the new model with the previous one, by doing the chi-squared test using the anova function
anova(model.8reduced, model.8, test="Chisq")
#the p value of chi-square is smaller than 0.05, showing that the new model for the two predictors fits as well as the model for the 5 complete predictors. So we can conclude that adding accountability, happiness and health variables will not significantly improve the prediction accuracy of the equation. So we can use the improved model. 
```

## Question 5b

```{r q5b}
exp(coef(model.8reduced))
```
The odds of dropping out for someone whose self-motivation score = 0 and age = 0 is 92.67:1.
For every point increase in self-motivation scores， the odds of dropping out decrease by 0.85
For every year older someone is, the odds of dropping out decrease by 0.95.

## Question 5c

```{r q5c}
# I draw a graph representing the probability of quitting as a function of how self motivated participants were
summary(glm(dropout ~ selfmot, data = couchto5k, family="binomial"))

couchto5k %>% ggplot(aes(x=selfmot,y=dropout)) +
  ylab("p(droupout)") +
  geom_jitter(size=3,width=0,height=.2,alpha=.1) +
  geom_smooth(method="glm",method.args=list(family=binomial)) +
  scale_y_continuous(breaks=seq(0,1,by=.2))

```










