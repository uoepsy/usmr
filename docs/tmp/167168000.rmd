---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
  pdf_document: default
params:
  examnumber: B194716
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(pander)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document.
total_rows <- nrow(couchto5k)

#Fix ages
incorrect_ages <- couchto5k %>% filter(couchto5k$age > 100) %>% nrow()
couchto5k <- couchto5k %>% filter(couchto5k$age < 101) #remove impossible ages. Assuming a max age of 100
age_hist <- hist(couchto5k$age, breaks=10)


#Fix self motivation
plot(couchto5k$selfmot,ylab="Self Motivation")
incorrect_self_mot <- couchto5k %>% filter(couchto5k$selfmot < 0) %>% nrow()
couchto5k <- couchto5k %>% filter(couchto5k$selfmot > 0)


#Fix Seasons
seasons <- unique(couchto5k$season)
incorrect_seasons <- sum(couchto5k$season == "autunm")
couchto5k$season[couchto5k$season=="autunm"] <- "autumn"
couchto5k$season <- as.factor(couchto5k$season) #Convert season to factor


#Fix city
couchto5k$city <- as.factor(couchto5k$city)


#Fix Week Stopped
finishing_weeks <- unique(couchto5k$week_stopped)
incorrect_finishing_weeks <- sum(couchto5k$week_stopped > 9)
couchto5k$week_stopped[couchto5k$week_stopped > 9] <- 9 #Assuming it was a mix-up in entry an the person, somehow, ended up doing it for 12 weeks instead.


#Add a new column which tells if the person finished successfully
couchto5k$FINISHED <- couchto5k$week_stopped==9
removed <- incorrect_ages+incorrect_self_mot
summary(couchto5k)
```

We started out with `r total_rows` rows of Data. Out of these, `r incorrect_ages` were removed due to incorrect ages (ages greater than 100) and `r incorrect_self_mot` were removed due to impossible values of self-motivation metric (<0). We ended up removing `r removed` rows in total, ending with a dataset consisting of `r total_rows - removed` rows.

There were misspellings in the column "season", and it was then converted into a factor. The city was also converted into a factor. We assumed that incorrect week values were really true values incorrectly written (a person can continue with the couch to 5k for more than 9 weeks) and all values greater than 9 were converted to 9 for simplicity.

```{r}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown.
label_color = "blue"
label_font = 3
plot(age_hist,xlab="Age",ylab="Count",main="",font.lab=label_font,col.lab=label_color)
```

The age seems to be largely uniformly distributed in the dataset.

```{r}
plot(density(couchto5k$selfmot), xlab="Self motivation",ylab="Density",main="",font.lab=label_font,col.lab=label_color)
```

The motivation seems to have a normal distribution instead.

```{r}
barplot(table(couchto5k$season),xlab="Season",ylab="Count",main="",font.lab=label_font,col.lab=label_color)
```
The distribution of Seasons is not as clear and is best visualized as the bar chart shown.

# Question 1 

## Question 1a

We have a theorized distribution of when our participants failed. We can use the chi squared goodness of fit test to check.

```{r q1a}

couchto5k$stopping_time <- "Temp"
couchto5k$stopping_time[couchto5k$week_stopped==9] <- "Completed"
couchto5k$stopping_time[couchto5k$week_stopped<9] <- "Post 5 Weeks"
couchto5k$stopping_time[couchto5k$week_stopped<5] <- "Pre 5 Weeks"
chisq.test(table(couchto5k$stopping_time), p = c(.45,.1,.45))

```

As we get a p-value of less than 0.05, we can reject the null and say that the sample we have been given is NOT in line with data from the earlier survey.

## Question 1b

```{r q1b}
res <- chisq.test(table(couchto5k$stopping_time[couchto5k$city=="Edinburgh"]),table(couchto5k$stopping_time[couchto5k$city=="Glasgow"]))
chisq.test(table(couchto5k$stopping_time[couchto5k$city=="Edinburgh"]),table(couchto5k$stopping_time[couchto5k$city=="Glasgow"]))
p_value <- res[3]$p.value
```

We get a p-value of `r p_value`, meaning that the attrition patterns do NOT differ by city.

## Question 1c

```{r q1c}
ggplot(data = couchto5k, aes(x = age, y = city)) +
  geom_boxplot()
shapiro.test(couchto5k$age[couchto5k$city=="Edinburgh"])
shapiro.test(couchto5k$age[couchto5k$city=="Glasgow"])

```

As expected, we fail the shapiro wilks test for normality for the age distribution (we saw its distribution being uniform rather than normal earlier).

```{r qic_continued}
a <- ks.test(couchto5k$age[couchto5k$city=="Edinburgh"], couchto5k$age[couchto5k$city=="Glasgow"], alternative = "two.sided")
ks.test(couchto5k$age[couchto5k$city=="Edinburgh"], couchto5k$age[couchto5k$city=="Glasgow"], alternative = "two.sided")
```

We ended up using the Kolmogorov-Smirnov test instead. As the p-value (`r a[2]$p.value`) is less than 0.05, we reject the null, and state that average ages of participants who commenced the programme differ by city. 

# Question 2

## Question 2a

```{r q2a}
library(sjPlot)
mod_season <- lm(happiness~1+season, data=couchto5k)
anova(mod_season) #We see a value of 0.07 for season, but in the means we see a visible improvement in the summer and spring
plot(mod_season,main="",font.lab=label_font,col.lab=label_color) #Plotting these we see a few troublesome datapoints
```

Plotting the normal QQ-Plot, we see 3 (120, 49 and 74) troublesome points which need to be removed.

```{r q2 fixed}
couchto5k <- couchto5k[-c(120,49,74),]
mod_season <- lm(happiness~1+season, data=couchto5k)
anova(mod_season) #Now, we can clearly say that the season affects the happiness.
a <- anova(mod_season)
```

We see an F-value of `r a[5]$'Pr(>F)'[1]` in the model. As this is less than the 0.05 threshold, we can say that season indeed has an effect on happiness.

``` {r q2a_plot}
plot_model(mod_season, type = "pred")
```

We can see in the plot that there is a higher happiness associated with the spring and summer months. Season also manages to explain a variance of `r summary(mod_season)$r.sq`.

```{r q2a_model_tests}
library(car)
ncvTest(mod_season)
plot(mod_season, which=4,main="",font.lab=label_font,col.lab=label_color)
```
None of the other plots give us cause for concern either.

## Question 2b

```{r q2b_requisite}
mod_season_age <- lm(happiness~1+season+age, data=couchto5k)
plot(mod_season_age,main="",font.lab=label_font,col.lab=label_color)
```
The requisite plots seem fine.

``` {r q2b_inference}
anova(mod_season,mod_season_age) #As we can see, adding in the age also affects the happiness


plot_model(mod_season_age, type="pred")[2]
coef(summary(mod_season_age))
```

Happiness is definitely affected by age, with age explaining `r 100*summary(mod_season_age)$r.sq` percent of the variance. We can also see this in the graph, and the slope of `r coef(summary(mod_season_age))[5]` for age points to the same fact. 

## Question 2c

```{r q2c_requisite}
mod_happiness <- lm(happiness ~ 1+age+season+city, data=couchto5k)
plot(mod_happiness,main="",font.lab=label_font,col.lab=label_color)
anova(mod_happiness)
```

We initialize a baseline model with purely objective predictors. Subjective predictors such as Self Motivation are not added. The Analysis of Variance Table lets us know that city is not a very useful predictor and so we remove it from our baseline model.

```{r q2c}
mod_happiness <- lm(happiness ~ 1+age+season, data=couchto5k) 
summary(mod_happiness)
anova(mod_happiness)
```

# Question 3

## Question 3a

```{r q3a}
couchto5k$FINISHED_FACTOR <- as.factor(couchto5k$FINISHED) #Need this conversion for sjPlot
mod_program_completion <- lm(happiness ~ 1+age+season+FINISHED_FACTOR, data=couchto5k)
anova(mod_happiness, mod_program_completion)
```

As again we can see in the Analysis of Variance table, happiness ratings seem unaffected by whether or not they completed the program.

```{r q3a_plot}
plot_model(mod_program_completion, type = "pred")[3]
```

The plot above however, does show a higher happiness rating on average for those who finished the programme.

## Question 3b

```{r q3b}
mod_pc_hm <- lm(happiness ~ age+season+FINISHED_FACTOR+health, data=couchto5k)
anova(mod_program_completion, mod_pc_hm)
summary(mod_pc_hm)
plot_model(mod_pc_hm,type="pred")[4]
```

The analysis of variance table gives us an Probability of getting a higher F Value of `r anova(mod_program_completion, mod_pc_hm)[6]$'Pr(>F)'[2]`. This allows us to infer that health further improves our model. However, we get a negative slope of `r coef(summary(mod_pc_hm))[7]` for health in our model. This seems counter intuitive but the figure above also shows the same story.

## Question 3c

```{r q3c}
mod_pc_hm <- lm(happiness ~ age+season+FINISHED_FACTOR+health*week_stopped, data=couchto5k)
summary(mod_pc_hm)
```
In this summary, we see something quite interesting. Though the estimates of coefficients (slopes) for health and week_stopped individually are negative, their interaction term has a high positive slope. This does seem to agree with the statement in the question "the happiness of participants who got further along the programme might be more affected by the health metric than that of those who stopped earlier".

This is also accompanied with and increase in the `Pr(>|t|)` for health as compared to our previous model without the interaction term. Implying that their interaction term is a strong predictor of happiness.

## Question 3d
We have seen that the binary column FINISHED is not a very good indicator of happiness but week_stopped is. This implies that the information contained within the order of week_stopped, that is how long the person lasted in the program is an important indicator of happiness. We also see an improvement in the model when we add the interaction term, lending further credence to the fact that health and week_stopped "together" are good indicators of happiness.

Other columns such as age, season are all straightforward indicators of happiness and provide decent sources of information for the same.

# Question 4

```{r q4}
couchto5k_successful <- couchto5k %>% filter(couchto5k$FINISHED)
couchto5k_successful <- couchto5k_successful %>% group_by(season,city) %>% summarise(average=mean(happiness))
ggplot(couchto5k_successful, aes(fill=city,y=average,x=season))+
  geom_bar(aes(fill=city),position = "dodge", stat="identity")+
  geom_text(aes(label = round(average,1)),
            position = position_dodge(1.0),
            color="black",vjust = -0.5,hjust = 0.5)+
  ylim(0,80)+
  xlab("Season")+ylab("Happiness")+scale_fill_discrete(name = "City")
```


# Question 5

## Question 5a

```{r q5a}
library(boot)
model1 <- glm(FINISHED_FACTOR ~ season, 
              data = couchto5k, family="binomial")
model2 <- glm(FINISHED_FACTOR ~ season+selfmot, 
              data = couchto5k, family="binomial")
model3 <- glm(FINISHED_FACTOR ~ season+selfmot+age, 
              data = couchto5k, family="binomial")
model4 <- glm(FINISHED_FACTOR ~ season+selfmot+age+health, 
              data = couchto5k, family="binomial")
model5 <- glm(FINISHED_FACTOR ~ season+selfmot+age+health+accountability, 
              data = couchto5k, family="binomial")
anova(model5)
cvr1 <- cv.glm(couchto5k, model1, K=5)
a <- c(cvr1$delta[2])

cvr2 <- cv.glm(couchto5k, model2, K=5)
a <- append(a,c(cvr2$delta[2]))

cvr3 <- cv.glm(couchto5k, model3, K=5)
a <- append(a,c(cvr3$delta[2]))

cvr4 <- cv.glm(couchto5k, model4, K=5)
a <- append(a,c(cvr4$delta[2]))

cvr5 <- cv.glm(couchto5k, model5, K=5)
a <- append(a,c(cvr5$delta[2])) #I got 0.15429999 0.14421034 0.15241910 0.14774398 0.14133606. This will keep changing but i'll use model 5

couchto5k <-
  couchto5k %>%
  mutate(
    predprobs = predict(model5, type="response"),
    predclass = ifelse(predprobs > 0.5, "TRUE", "FALSE")
  )

couchto5k %>%
  select(FINISHED, predclass) %>%
  table()

pander(couchto5k)

```

## Question 5b

```{r q5b}
tab_model(model5)
```

## Question 5c

```{r q5c}
plot_model(model5,type="pred")[2]
```




