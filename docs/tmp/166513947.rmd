---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  word_document: default
  html_document: default
params:
  examnumber: B203168
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->

The dataset contains 9 variables and 123 observations. During the basic descriptive statistics analysis, I found some outlier values for three variables: age, selfmot, season and week_stopped. For these outlier and errors, I corrected and set them to missing respectively. For example, two of the data for age were greater than or equal to 100 years old, and these were replaced with missing data in view of the difficulty of completing the experiment with respondents of this age. In the same way, the value of -99 for selfmot was replaced with a missing value, and the misspelling of "autumn" in season was corrected. For week_stopped, the value 12 was replaced by NA.

The basic descriptive statistics for the nine variables are shown below and we can see that there are currently no more outliers in the data. city and season are the nominal variables out of the nine, so they are visualised using the bar plot. We can see that city mainly contains two Edinburgh and Glasgow, with Edinburgh having a higher proportion of respondents. Season mainly contains four levels, with spring having the highest frequency of values.



```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
couchto5k$selfmot<-ifelse(couchto5k$selfmot<0,NA,couchto5k$selfmot)
couchto5k$season<-ifelse(couchto5k$season=="autunm","autumn",couchto5k$season)
couchto5k$age<-ifelse(couchto5k$age>99,NA,couchto5k$age)
couchto5k$week_stopped<-ifelse(couchto5k$week_stopped==12,NA,couchto5k$week_stopped)

```

```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 


summary(couchto5k)

ggplot(data=couchto5k,aes(city,fill="red"))+geom_bar(color = "red", width = .7, position = 'dodge')

ggplot(data=couchto5k,aes(season))+geom_bar(color = "black", width = .7, position = 'dodge',fill="blue")

```

# Question 1 

## Question 1a

We can see that the data seems not agree with the above statement. The percentage of participants who stopped halfway through the race was 33%, and the percentage of participants who stopped in the second half of the race was as high as 16%. The participant who completed the experiment successfully was 50%.(week_stop=9)

Again, we used two simple binomial test to test whether the proportion of people who gave up halfway through is 0.45, and whether the proportion of people who gave up in the second half is 0.1. 

The results show that for the first hypothesis, we have enough evidence to reject it(p-value=0.006<0.05), i.e. that the proportion of people giving up before the halfway point is different from 45\%. For the second hypothesis, there is enough evidence to reject the original hypothesis too (p-value=0.003<0.05), i.e.  the proportion of people giving up in the second half of the experiment has significantly difference from 10\%.


```{r q1a}
couchto5k$stop<-if_else(couchto5k$week_stopped<5,"1",if_else(couchto5k$week_stopped<9,"2","3"))
couchto5k%>%group_by(stop)%>%summarise(n()/140,n())

binom.test(47,140,p=0.45)

binom.test(22,140,p=0.1)
```

## Question 1b
We constructed the STOP variable, which has three levels, 1 for giving up before WEEK 5, 2 for giving up in the second half of the race, and 3 for finishing the race. If we want to investigate whether there is a correlation between participation rate and CITY, we need to do this with the help of a chi-square test of independence, as both variables are NOMINAL.

We chose Fisher's exact test because the column table has frequencies less than 5. The p-value of the test is 0.4, which is much greater than 0.05. Therefore, based on the current data, we cannot reject the original hypothesis, which is a significant association between participation rate and city.

```{r q1b}
table(couchto5k$city,couchto5k$stop)
fisher.test(table(couchto5k$city,couchto5k$stop))
```

## Question 1c

We chose to test the difference in the mean age of participants in the two cities using a t-test with two independent samples. The p-value of the t-test was 0.09>0.05. Therefore, we have no reasons to reject the original hypothesis and consider that there is a significant difference in the mean age of participants in the two cities. Looking at the mean age in the two cities, the mean age in Edinburgh was greater at around 40 years.

```{r q1c}
#1c
t.test(couchto5k$age~couchto5k$city)
```

# Question 2

## Question 2a
A regression model was constructed to quantify the effect of season on happiness rating. Where happiness rating is the dependent variable and season is the explanatory variable. The results of the regression model show that the F-test is not significant, meaning that the whole regression model may be no meaningful. 

Looking at the regression coefficients for each season, we find that only the autumn is significant.

```{r q2a}
model1<-lm(happiness~season,data=couchto5k)
summary(model1)
```

## Question 2b
Continuing to include the age variable in the model that takes into account seasonal effects, we find that the F-test of the regression is also not significant, i.e. the model may be no meaningful. However, looking at the regression coefficients for the age variable. We found that the age variable was not significant, i.e. age did not have a significant effect on the level of happiness rating.

```{r q2b}
model2<-lm(happiness~season+age,data=couchto5k)
summary(model2)
```

## Question 2c

If a model needs to be chosen as a baseline model, I think the model in 2b is more appropriate. Firstly, comparing the R-squared of the two models, we find that the R-squared of the two models have no significant difference. Secondly, the age variable is insignificant and leaving it in the model does not have any practical significance, but rather increases the complexity of the model.

```{r q2c}

```

# Question 3

## Question 3a
We first construct a dummy variable called complete, if the week_stop==9, complete=1 and means the experiemnt has finished. We then incorporate this variable into our selected benchmark model. The results of the regression showed that the regression coefficient for the complete variable is not significant, i.e. whether or not the project was completed had no significant effect on the outcome of the happiness rating. The regression coefficient for this variable was 10.63, meaning that the mean happiness rating was 10.63 higher for subjects who completed the experiment compared to those who did not.

```{r q3a}
couchto5k$complete<-if_else(couchto5k$week_stopped==9,"1","0")
model3<-lm(happiness~season+complete,data=couchto5k)
summary(model3)
```

## Question 3b
The results of the regression showed that the regression coefficient for the health variable is not significant, i.e. the health metric had no significant effect on the outcome of the happiness rating. The regression coefficient for this variable was -0.340, meaning that the influence is negative. This is a little strange, maybe we should get more data.


```{r q3b}
model4<-lm(happiness~season+complete+health,data=couchto5k)
summary(model4)
```

## Question 3c

Yes. There is an interaction effect between the variable of whether or not the experiment is completed and the variable of health. We can see the interaction term complete0:health is highly significant, this suggest those who have complete the experiment will be more affected by the health metric.

```{r q3c}
model5<-lm(happiness~season+complete:health,data=couchto5k)
summary(model5)
```

## Question 3d

Through the above study we found that the respondents' happiness was related to the season in which they were interviewed. In general, respondents who were interviewed in the spring had a higher happiness rating than those interviewed in the autumn, and those who have complete the experiment will be more affected by the health metric..

# Question 4

```{r q4}
datanew<-couchto5k%>%filter(complete==1)

p <- datanew%>%group_by(season,city)%>%summarize(meanhapp=round(mean(happiness),digits = 2))%>%
  ggplot(aes(x = season,y = meanhapp,fill = city))+
  geom_bar(stat ="identity",width = 0.6,position ="stack")+     
  scale_fill_manual(values = c("pink","lightblue"))+              
  labs(x = "Season",y = "Average happiness rating", title = "The distribution of happiness rating Vs season and city")+    
  geom_text(aes(label = meanhapp),position=position_stack(vjust =0.5),size = 4)+ 
  guides(fill = guide_legend(reverse = F))+               
  theme(plot.title = element_text(size = 18,face = "bold", vjust = 0.5, hjust = 0.5),  
        legend.title = element_blank(),              
        legend.text = element_text(size = 18, face = "bold"),     
        legend.position = 'right',               
        legend.key.size=unit(0.8,'cm'))          

print(p)
```


# Question 5

## Question 5a

The model we build using all the other variables in the dataset is shown below.

```{r q5a}
couchto5k$complete<-as.factor(couchto5k$complete)
mlogit1 <- glm(complete ~ age+accountability+selfmot+health+happiness+season+city, data = couchto5k, family = "binomial")
summary(mlogit1)
```

## Question 5b
The intercept is -12.69 with standard error 3.62, which is the mean value of logit probability of complete when all the independent variables take value 0. It has no practical meaning in this question.

The estimated coefficient of age is 0.11 with standard error 0.03, which means when the age increase by 1 year , the average logit probability of complete will increase by 0.11. This estimate is significant, as p-value=0.00029<0.05.

The estimated coefficient of accountability is -0.11 with standard error 0.06, which means when the accountability increase by 1 unit , the average logit probability of complete will decrease by 0.11. This estimate is significant, as p-value=0.05=0.05.

The estimated coefficient of selfmot is 0.26 with standard error 0.102, which means when the selfmot increase by 1 unit , the average logit probability of complete will increase by 0.26. This estimate is significant, as p-value=0.01<<0.05.

The estimated coefficient of health is 0.14 with standard error 0.04, which means when the health increase by 1 unit , the average logit probability of complete will increase by 0.14. This estimate is not so significant, as p-value=0.0028<0.05.

The estimated coefficient of happiness is 0.002 with standard error 0.009, which means when the happiness increase by 1 unit , the average logit probability of complete will increase by 0.002. This estimate is not significant, as p-value=0.815>0.05.

The estimated coefficient of seasonspring is -4.04 with standard error 0.99, which means compared with autumn , the average logit probability of complete of spring is 4.04 lower. This estimate is significant, as p-value=4.4e-05<<0.05.

The estimated coefficient of seasonsummer is -0.32 with standard error 0.86, which means compared with autumn , the average logit probability of complete of summer is 0.32 lower. This estimate is not significant, as p-value=0.71>0.05.

The estimated coefficient of seasonwinter is 0.63 with standard error 1.09, which means compared with autumn , the average logit probability of complete of winter is 0.63 higher. This estimate is not significant, as p-value=0.56>0.05.

The estimated coefficient of cityGlasgow is -0.91 with standard error 0.58, which means compared with Edinburgh , the average logit probability of complete of Glasgow is 0.91 lower. This estimate is not significant, as p-value=0.12>0.05.

```{r q5b}

```

## Question 5c



```{r q5c}
pred<-predict(mlogit1,data=couchto5k,type="response")
selfmot<-couchto5k$selfmot[complete.cases(couchto5k)]

plot(pred~selfmot,xlab="selfmot",ylab="Predicted probability of quiting",pch=19,col="red")
```











