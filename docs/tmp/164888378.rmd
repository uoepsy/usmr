---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
  pdf_document: default
params:
  examnumber: B190978
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(psych)
options(scipen = 200)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->

  Data was obtained from https://uoepsy.github.io/data/usmr_2122_data.R. It contained information on 125 participants who joined Couch to 5k, which is an NHS-sponsored fitness programme which lasts 9 weeks, taking participants from a gentle start up to a half-hour run. All participants were either from Edinburgh or Glasgow. The dataset included participants' ID, age, city, the season of year they were interviewed in, and the number of weeks they completed. At Week 0, all participants completed a questionnaire measuring the psychometric factors of accountability and self-motivation, which were both sums of five questions, each scored from one to seven, meaning that scores could range from a possible 5 to 35. Upon either completing the programme (Week 9) or dropping out (< Week 9), participants completed a questionnaire which included a measure of their self-reported happiness (0 - 100), and a “health” measure (0 - 100) derived from a number of physiological tests.
```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
couchto5k <- couchto5k %>%
  mutate(
    age = ifelse(age < 18 | age > 75, NA, age),
    accountability = ifelse(accountability < 5 | accountability > 35, NA, accountability),
    selfmot = ifelse(selfmot < 5 | selfmot > 35, NA, selfmot),
    health = ifelse(health < 0 | health > 100, NA, health),
    happiness = ifelse(happiness < 0 | happiness > 100, NA, happiness),
    season = ifelse(season == "autunm", "autumn", season),
    city = ifelse(city == "Glasgow" | city == "Edinburgh", city, NA),
    week_stopped = ifelse(week_stopped < 1 | week_stopped > 9, NA, week_stopped)
  )
```
  Impossible values were turned into NAs, including two records of age, two scores of self-motivation, and a record of the number of week that a participant stopped at. From a preliminary data description, we could tell that only participants' health metric (W = `r shapiro.test(couchto5k$health)[2]`) and accountability scores (W = `r shapiro.test(couchto5k$accountability)[2]`) were normally distributed, participants' age, self-motivation score and happiness ratings did not have a normal distribution. Also, the number of participants from Edinburgh were more than doubled than that of from Glasgow . The season that most participants were interviewed in was spring. Only around half of the participants completed the programme.   
```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 
describe(couchto5k)

shapiro.test(couchto5k$age)
shapiro.test(couchto5k$accountability)
shapiro.test(couchto5k$selfmot)
shapiro.test(couchto5k$health)
shapiro.test(couchto5k$happiness)

couchto5k %>%
  ggplot(aes(x=season), xlab = "season") +
  geom_bar() +
  theme_bw()
couchto5k %>%
  ggplot(aes(x=city), xlab = "city") +
  geom_bar() +
  theme_bw()
couchto5k %>%
  ggplot(aes(x=week_stopped), xlab = "week_stopped") +
  geom_bar() +
  scale_x_continuous(breaks = 1:9) +
  theme_bw()
```

# Question 1 

## Question 1a
  After performing a chi-squared goodness of fit test, our dataset were found to be in line with a previous survey that 45% of participants abandoned the programme before the halfway point in week 5, and a further 10% gave up before the end of the programme. 
```{r q1a}
couchto5k <- couchto5k %>%
  mutate(quit_time = ifelse(week_stopped < 6, "before_5", "after_5"),
         quit_time = ifelse(week_stopped == 9, "complete", quit_time)
)

chisq.test(table(couchto5k$quit_time), p = c(.1,.45,.45))
```

## Question 1b
After performing a chi-squared independence test, the results showed that there was no difference between the patterns of attrition rates between the two cities. 
```{r q1b}
chisq.test(table(couchto5k$city, couchto5k$quit_time))
```

## Question 1c
After performing a simple t-test, the results showed that the average ages between participants from Edinburgh and Glasgow were significantly different, where participants from Edinburgh were older than those from Glasgow (t(`r with(couchto5k, t.test(age ~ city, alternative = "two.sided"))[2]` = `r with(couchto5k, t.test(age ~ city, alternative = "two.sided"))[1]`, p < .05). 
```{r q1c}
with(couchto5k, t.test(age ~ city, alternative = "two.sided"))
```

# Question 2

## Question 2a
```{r q2a}
season_happiness <- lm(happiness ~ 1 + season, data = couchto5k)
summary(season_happiness)
```
The results from the linear model showed that participants’ happiness ratings affected by the season they were interviewed in. Specifically, on average, participants' happiness ratings increased by `r season_happiness$coefficients["seasonspring"]` in spring than in autumn, which had the lowest happiness ratings on average. 

## Question 2b
Results from the new linear model after adding age as a variable showed that age did not account for the effects from the previous model, that is, age did not affect participants' happiness ratings over and above the season they wee interviewed in. 
```{r q2b}
age_happiness <- lm(happiness ~ 1 + season + age, data = couchto5k)
summary(age_happiness)
```

## Question 2c
The linear model that only included season as a variable was chosen as the baseline model because though it was not of primary interest to the current study, participants' happiness ratings were affected by the season they were interviewed in, while age was not an influencing factor.

# Question 3

## Question 3a
Participants' happiness ratings were not affected by whether or not they completed the programme over and above the season they wee interviewed in. 
```{r q3a}
couchto5k <- couchto5k %>%
  mutate(completion = ifelse(quit_time == "complete", "yes", "no"))
model_1 <- lm(happiness ~ 1 + season + completion, data = couchto5k)
summary(model_1)
```

## Question 3b
After adding health metric into the model, results showed that happiness was not affected by it on top of season. 
```{r q3b}
model_2 <- lm(happiness ~ 1 + season + health, data = couchto5k)
summary(model_2)
```

## Question 3c
```{r q3c}
model_3 <- lm(happiness ~ 1 + season + completion*health, data = couchto5k)
summary(model_3)
ggplot(couchto5k, aes(health, happiness, color = completion)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)
  theme_bw()
```
The interaction between completion time and health metric was significant (F(6, `r model_3$df.residual`) = 5.4, p < .001), and the model explained approximately 17.7% of the variability in happiness. We found aligned results to the hypothesis such that participants who completed the programme were more affected by the health metric than that of those who stopped earlier ((\beta = `r model_3$coefficients[7]`, se = 0.518, p < .001)). Specifically, participants who completed the programme rated themselves happier if they had higher health metric, while the opposite was true for those who stopped earlier. 

## Question 3d
Overall, we found that spring could improve people's happiness. People who completed the programme were more affected by the health metric than those who stopped earlier in terms of their feeling of happiness. To be more specific, those who had better health metric might feel worse if they stopped running early than those who had worse health metric while people who stopped running might feel happier if they had poorer health than those who were healthier. It was worth noting that age, health metric, or whether or not they complete a 5k running alone were not significant influencing factors on their perceived happiness.

# Question 4
Figure 5 showed the average happiness ratings grouped by season and city including only participants who completed the programme. 
```{r q4}
complete_5k <- subset(couchto5k, quit_time == "complete")
interim <- complete_5k %>%
  group_by(season, city) %>%
  summarise(happiness = mean(happiness))
ggplot(interim, aes(x=season,y=happiness)) +
  geom_col() +
  facet_wrap(~city) +
  theme_bw()
```


# Question 5

## Question 5a
```{r q5a}
completeness <- couchto5k %>%
  mutate(
    quit_time = ifelse(quit_time != "complete", 0, 1)
  )
'age_time <- glm(quit_time ~ 1 + age, data = completeness, family = "binomial")
summary(age_time)

acc_time <- glm(quit_time ~ 1 + accountability, data = completeness, family = "binomial")
summary(acc_time)

selfmot_time <- glm(quit_time ~ 1 + selfmot, data = completeness, family = "binomial")
summary(selfmot_time)'

drop_likelihood <- glm(quit_time ~ 1 + selfmot, data = completeness, family = "binomial")
summary(drop_likelihood)
```

## Question 5b
```{r q5b}
odd = exp(drop_likelihood$coefficients[1]+drop_likelihood$coefficients[2])
p = odd/(1+odd)
```
The model aimed to predict participants' likelihood of dropping out. Since the dependent variable was two level and non-convertible to be linear, as a result, binomial generalised linear model was chosen. After taking into account of participants' age, accountability and self-motivation, we found that only self-motivation was a significant independent variable (\beta = `r drop_likelihood$coefficients[2]`, SE = 0.073, p < .001), such that for every unit of self-motivation score, there was an increment of `r p*100`% of probability of dropping out.  

## Question 5c
Figure 6 showed the probability of quitting as a function of how self motivated participants were.
```{r q5c}
'pred <- predict(selfmot_time, type="response")
plot(pred)'

ggplot(completeness, aes(x = selfmot, y = quit_time)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) 
```










