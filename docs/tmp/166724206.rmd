---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
  pdf_document: default
params:
  examnumber: "B192090"
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->

Question 0:Cleaning & Describing

Have a look at the data. Check for impossible values and deal with these in an appropriate manner. Describe the data, either in words or using suitable graphs (or a combination). Remember to detail the decisions you have made.
```{r cleaning, include = TRUE}

# Ensure the data is cleared of any impossible values

couchto5k <- 
  couchto5k %>%
  mutate(age = ifelse(age>147,NA, age))


couchto5k <- 
  couchto5k %>%
  mutate(accountability = ifelse(accountability<5,NA, accountability))


couchto5k <- 
  couchto5k %>%
  mutate(accountability = ifelse(accountability>35,NA, accountability))

couchto5k <- 
  couchto5k %>%
  mutate(selfmot = ifelse(selfmot>35,NA, selfmot))

couchto5k <- 
  couchto5k %>%
  mutate(selfmot = ifelse(selfmot<5,NA, selfmot))
couchto5k <- 
  couchto5k %>%
  mutate(health = ifelse(health>100,NA, health))

couchto5k <- 
  couchto5k %>%
  mutate(health = ifelse(health<0,NA, health))

couchto5k <- 
  couchto5k %>%
  mutate(happiness = ifelse(happiness>100,NA, happiness))

 couchto5k <- 
  couchto5k %>%
  mutate(happiness = ifelse(happiness<0,NA, happiness))
 
couchto5k<- couchto5k %>% mutate(week_stopped=ifelse(week_stopped>12,NA, week_stopped))

# Create a boxplot for each of the data variables to check for outliers

ggplot(data = couchto5k, aes(age)) + geom_boxplot()
ggplot(data = couchto5k, aes(accountability)) + geom_boxplot()
ggplot(data = couchto5k, aes(selfmot)) + geom_boxplot()
ggplot(data = couchto5k, aes(health)) + geom_boxplot()
ggplot(data = couchto5k, aes(happiness)) + geom_boxplot()
ggplot(data = couchto5k, aes(week_stopped)) + geom_boxplot()

Age_DP <- ggplot(data = couchto5k, aes(age)) + geom_density()
Acc_DP <- ggplot(data = couchto5k, aes(accountability)) + geom_density()
Selfmot_DP <- ggplot(data = couchto5k, aes(selfmot)) + geom_density()
Health_DP <- ggplot(data = couchto5k, aes(health)) + geom_density()
Happiness_DP <- ggplot(data = couchto5k, aes(happiness)) + geom_density()
Week_DP <- ggplot(data = couchto5k, aes(week_stopped)) + geom_density()


library(patchwork)

Age_DP | Acc_DP | Selfmot_DP
Health_DP| Happiness_DP | Week_DP
  

shapiro.test(couchto5k$age)
shapiro.test(couchto5k$accountability)
shapiro.test(couchto5k$selfmot)
shapiro.test(couchto5k$health)
shapiro.test(couchto5k$happiness)
shapiro.test(couchto5k$week_stopped)





# Correct spelling mistakes which may interfere with analysis 

couchto5k$season<- as.factor(couchto5k$season)
class(couchto5k$season)
levels(couchto5k$season)
couchto5k <- couchto5k %>% 
  mutate(season = (gsub("autunm","autumn",season)))
levels(couchto5k$season)

```

```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 


```

# Question 1 

## Question 1a
Question 1: General Checks


1a. In an earlier nationwide survey, researchers found that 45% of participants abandoned the programme before the halfway point in week 5, and a further 10% gave up before the end of the programme. Is the data in the sample you have been given in line with data from the earlier survey? Once you have created a suitable variable to map to the information in the question, you should be able to answer this using a simple statistical test.


```{r q1a}

week_stopped_data <- couchto5k %>%
  select(week_stopped) %>%
  mutate(week_stopped_group = case_when(
    week_stopped < 5 ~ "B5",
    week_stopped > 4 & week_stopped < 9 ~ "A5",
    week_stopped > 8 ~ "C"
  ))

couchto5k$WSG <- week_stopped_data$week_stopped_group

table(week_stopped_data$week_stopped_group)

prop.table(table(week_stopped_data$week_stopped_group))*100

barplot(prop.table(table(week_stopped_data$week_stopped_group))*100)


chisq.test(table(week_stopped_data$week_stopped_group), p = c(.1,.45,.45))



couchto5k$WSG<- factor(couchto5k$WSG, levels = 
                                   c("B5", "A5", "C"))

ggplot(data = couchto5k, aes(x= WSG, fill = WSG, na.rm = TRUE))+
  geom_bar(na.rm = TRUE) + 
  labs(x = "Week Stopped")


```

## Question 1b

1b. Using the same three categories (stopped before week 5, stopped after week 5, completed), examine whether the patterns of attrition rates differ by city.

```{r q1b, warning=FALSE}

# Add the week stopped data to the couchto5k data set

couchto5k$WSG<- week_stopped_data$week_stopped_group

# Complete a chi-squared test

table(couchto5k$city,couchto5k$WSG)

city_group_tables <- table(couchto5k$city,couchto5k$WSG)

chisq.test(couchto5k$WSG, couchto5k$city)

# Create proportion tables for both cities to compare as a precaution


Glasgow_subset <- subset(couchto5k, city == "Glasgow")

table(Glasgow_subset$WSG)

prop.table(table(Glasgow_subset$WSG))*100

Edi_subset <- subset(couchto5k, city == "Edinburgh")

table(Edi_subset$WSG)

prop.table(table(Edi_subset$WSG))*100

```

## Question 1c

1c. Do the average ages of participants who commenced the programme differ by city?

```{r q1c}

t.test(couchto5k$age ~ couchto5k$city)

```

# Question 2

Question 2: Happiness

Are participants’ happiness ratings affected by the season they were interviewed in? Describe the way in which season influences happiness outcomes? 

## Question 2a

```{r q2a}

modified_age <- 
  couchto5k[-c(34, 80),]


seasonsmodel <- 
lm(happiness ~ 1 + season, data= modified_age)
coef(seasonsmodel)
summary(seasonsmodel)


plot(seasonsmodel,which=4)

ggplot(data= modified_age, aes(x=happiness, y=season, color=season)) +
  geom_boxplot()




```

## Question 2b

2b. Accounting for any effects you discovered in (2a), is happiness affected by age?

```{r q2b}

agemodel <- 
lm(happiness ~ 1 + season + age, data=modified_age)
coef(agemodel)
summary(agemodel)
sigma(agemodel)

# Cooks Distance
plot(agemodel,which=4)

# Visualise model
plot(agemodel)

# Interpreting the model
coef(agemodel)
summary(agemodel)
sigma(agemodel)


```

## Question 2c

2c. The models you have built above explore ‘baseline’ effects; that is, effects that are not of primary interest to the researchers but which might affect the outcome variable of happiness. For use in question 3, pick a specific baseline model and justify why you are using this.


```{r q2c}

seasonsmodel <- 
lm(happiness ~ 1 + season, data= modified_age)
coef(seasonsmodel)
summary(seasonsmodel)


agemodel <- 
lm(happiness ~ 1 + season + age, data=modified_age)
coef(agemodel)
summary(agemodel)
sigma(agemodel)


null_model_happiness <- 
  lm(happiness ~ 1, data = modified_age)

coef(null_model_happiness)
summary(null_model_happiness)

anova(null_model_happiness,seasonsmodel)


anova(null_model_happiness,agemodel)

anova(seasonsmodel, agemodel)

```



Question 3: Happiness and Health

3a. Building on your baseline model, are participants’ happiness ratings affected by whether or not they completed the programme? Describe the way in which programme completion influences happiness outcomes.

## Question 3a

```{r q3a, include = FALSE}

Wk_Complete <- 
  modified_age %>%
  select(week_stopped) %>%
  mutate(Wk_Complete = case_when(
    week_stopped < 9 ~ "No",
    week_stopped > 8 ~ "Yes"))
    
    modified_age$Wk_Complete <-
  Wk_Complete$Wk_Complete
  
  lm(happiness ~ 1 + Wk_Complete, data = modified_age)
  
  Happiness_WKC<- lm(happiness ~ 1 + Wk_Complete, data = modified_age)
  
  coef(Happiness_WKC)
summary(Happiness_WKC)

plot(Happiness_WKC,which=4)

Happiness_WKC<- lm(happiness ~ 1 + Wk_Complete, data = modified_age)

plot(Happiness_WKC,which=4)



```

## Question 3b

3b. Building on the analysis in (3a), is happiness additionally affected by the “health metric”?

```{r q3b}

Happiness_WKC_Health  <- lm(happiness ~ 1+ Wk_Complete + health, data = modified_age)

summary(Happiness_WKC_Health)



```

## Question 3c

3c. It’s been hypothesised that the effects of good health are amplified by the feeling of acting healthily, such that the happiness of participants who got further along the programme might be more affected by the health metric than that of those who stopped earlier. Building on the model in (3b), can you test this hypothesis?

```{r q3c}

Q3c_model <- lm(happiness ~ 1 + health:week_stopped, data = modified_age)

summary(Q3c_model)

library(sjPlot)

plot_model(Q3c_model, type = "pred")


ggplot(data = couchto5k, aes(x = health, y = happiness)) +
  geom_point(size = 3, col = "red") + 
  geom_smooth(method = "lm") +
  theme_bw() +
  labs(x = "Health (0-100)", y = "Happiness (0-100)") 


```

## Question 3d

3d. What can we conclude about the various causes of happiness in our data? Write a brief description of the effects in the model, such as you might find in an academic paper.


Question 4

Create a subset of the data, including only those participants who completed the programme. Create a plot of the average happiness ratings grouped by season and city, that can be used in a presentation to the funders of the project.


```{r q4}
Q4_subset <- subset(couchto5k, WSG == "C")

ggplot(data = Q4_subset, aes(happiness,city,fill=season)) +
  geom_boxplot() +
  facet_wrap(~season) +
   scale_fill_brewer(palette="BuPu") +
    labs(x = "Happiness (0-100)", y = "City") +
      legend_style(pos = "none")

```


Question 5: Predictors of Drop-out

## Question 5a
5a. Build a model that predicts the likelihood of dropping out (at all).

```{r q5a}


# Creating a separate column for drop out


Dropout <- couchto5k %>%
  select(week_stopped) %>%
  mutate(WSG = case_when (
    week_stopped < 9 ~ "Dropout",
    week_stopped > 8 ~ "No_Dropout" ))

couchto5k$DO_Rate <- Dropout$WSG



DO_Rate <- couchto5k$DO_Rate %>% factor(c("Dropout", "No_Dropout"))
couchto5k$DO_Rate %>% factor(c("Dropout", "No_Dropout"))
couchto5k$DO_Rate <- as.factor(couchto5k$DO_Rate)

couchto5k$DO_Rate <- as.factor(DO_Rate)


DO_model <- glm(DO_Rate ~ 1 + season + selfmot, data = couchto5k, family = "binomial")

levels(couchto5k$DO_Rate)

plot(DO_model, which = 4)
   


# Pairs panel to establish correlation

library(psych)

pairs.panels(couchto5k[2:9])

DO_Seasons <- glm(DO_Rate ~ 1 + season + selfmot + health, data = couchto5k, family = "binomial")

coef(DO_Seasons) 

summary(DO_Seasons)


DO_Selfmot <- glm(DO_Rate ~ 1 + season, data = couchto5k, family = "binomial")
coef(DO_Selfmot)
summary(DO_Selfmot)

# Creating the model

DO_model <- glm(DO_Rate ~ 1 + selfmot, data = couchto5k, family = "binomial")

summary(DO_model)

# Cooks Distance

plot(DO_model, which = 4)

#evaluating the model

anova(DO_model, test = "Chisq")

```

## Question 5b

5b. Briefly describe the effects in your model as you would in an academic paper.

```{r q5b}

```

## Question 5c

5c. Draw a graph representing the probability of quitting as a function of how self motivated participants were.

```{r q5c}

couchto5k <- couchto5k%>% 
  mutate(Dropout = ifelse(DO_Rate == "Dropout", 1, 0 ))


ggplot(data = couchto5k, aes(x = selfmot, y = Dropout, color = Dropout)) +
  labs(x = "Self Motivation", y = "Probability of Dropout") +
  geom_jitter(size = 3, width = 0, height = .2, alpha = .2) +
  scale_y_discrete(breaks = seq(0, 1, by=.2)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"))

```










