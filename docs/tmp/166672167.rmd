---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
  word_document: default
params:
  examnumber: B189396
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(broom)
library(pander)
library(ggplot2)
library(sjPlot)

install.packages("pastecs" ,repos = "https://github.com/phgrosjean/pastecs")
library(pastecs)


#two digits
options(digits = 2)

# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->

```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
couchto5k$impossible <- NA
couchto5k$impossible[couchto5k$accountability < 5] <- "lower than the possible lowest accountability score"
couchto5k$impossible[couchto5k$accountability > 35] <- "higher than the possible highest accountability score"
couchto5k$impossible[couchto5k$selfmot < 5 ] <-"lower than the possible lowest self motivation score"
couchto5k$impossible[couchto5k$selfmot > 35 ] <-"higher than the possible highest self motivation score"
couchto5k$impossible[couchto5k$health < 0] <-"lower than the possible lowest health score"
couchto5k$impossible[couchto5k$health > 100] <-"higher than the possible highest health score"
couchto5k$impossible[couchto5k$happiness < 0] <- "lower than the possible lowest happiness score"
couchto5k$impossible[couchto5k$happiness > 100] <- "higher than the possible highest happiness score"
couchto5k$impossible[couchto5k$week_stopped < 1] <- "earlier than the possible earliest dropping week"
couchto5k$impossible[couchto5k$week_stopped > 9] <- "programme ends at week 9"

#table of impossible values
tab_impossible <- table(couchto5k$impossible)

#remove impossible values
couchto5k <- couchto5k %>% filter(is.na(impossible))

#total observations after removing impossible values
total_obs <- count(couchto5k)
```

 
```{r typo, include=FALSE}
typo <- sum(couchto5k$season == "autunm")
couchto5k$season[couchto5k$season == "autunm"] <- "autumn"
couchto5k <- couchto5k %>% mutate(
  Attrition_Cat = NA,
  didComplete = NA
)
couchto5k$Attrition_Cat[couchto5k$week_stopped < 5] <- "Before Week 5"
couchto5k$Attrition_Cat[couchto5k$week_stopped == 9] <- "Completed"
couchto5k$Attrition_Cat[couchto5k$week_stopped >= 5 & couchto5k$week_stopped<9] <- "After Week 5"
couchto5k$didComplete [couchto5k$week_stopped <9] <- 0
couchto5k$didComplete [couchto5k$week_stopped == 9] <- 1

couchto5k$season <- factor(couchto5k$season, levels = c("winter", "spring", "summer", "autumn"))

as.factor(couchto5k$Attrition_Cat)
couchto5k$Attrition_Cat <- factor(couchto5k$Attrition_Cat, levels = c("Before Week 5", "After Week 5", "Completed"))

as.factor(couchto5k$didComplete)
couchto5k$didComplete <- factor(couchto5k$didComplete)

AttritionProp <- prop.table(table(couchto5k$Attrition_Cat))
```

The data were inspected and missing or impossible values were removed, resulting in a total of `r total_obs` observations for analysis. `r typo` season of the interview entries were mistyped as "autunm". These were recorded as "autumn".

```{r descriptives, comment="", tidy=TRUE}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown
desctab <- stat.desc(couchto5k[, 2:6], basic = F)
```

```{r}
desctab %>% pander(caption="Table 1 Summary of Descriptive Statistics")
```


Table 1 shows the summary of descriptive statistics of the sample data. 

# Question 1 

## Question 1a

```{r q1a, comment = ""}
#goodness of fit test
goodness_fitAtt <- chisq.test(table(couchto5k$Attrition_Cat), p = c(.45,.1, .45))
goodness_fitComp <- chisq.test(table(couchto5k$didComplete), p = c(.45, .55))
Attbarplot <- barplot(AttritionProp*100, main = "Attrition Rates by City", xlab = "Attrition Category",ylab = "Percentage of Participants", ylim = c(0,65))

Attbarplot
```
*Figure 1*: Attrition Rates Percentages


A Chi-square goodness of fit test was used to investigate whether present data were in line with data from an earlier survey. For three categories of attrition (Stopped Before Week 5, Stopped After Week 5, Completed) Chi-square test results were not significant, indicating present sample's completion rates were not in line with data of the nationwide survey. A second Chi-square goodness of fit test was conducted to investigate completion rates, regardless of week of programme participant stopped in, also was not significant.Figure 1 shows the distribution of attrition categories for the sample data. 


## Question 1b

```{r q1b, comment = "", tidy=TRUE}
#test of independence
independenceAtt <- chisq.test(table(couchto5k$Attrition_Cat, couchto5k$city))
independenceAtt
mosaicplot(~ city + Attrition_Cat, data = couchto5k, main = "Attrition Rates by City", shade = FALSE)

```
*Figure 2:* Attrition Rates by City

A Chi-square test of independence was used to test whether there were any differences in attrition rates depending on the city participant was from. Chi-square test results were not statistically significant, indicating that attrition rates do not differ by city. Figure 2 shows how attrition rates differ by city. 


## Question 1c

```{r q1c, comment = "", tidy=TRUE}
normalityAge <- shapiro.test(couchto5k$age)

age_test<- t.test(couchto5k$age ~ couchto5k$city, alternative = "two.sided")
age_test
```
A two-sample t-test was conducted to investigate mean age differences depending on the city of the participants. There was no statistical difference between cities regarding the age of participants, (t(93)= 0.2, p = 0.9).





# Question 2

## Question 2a

```{r q2a, comment = "", tidy=TRUE}
happiness_season_mod <- lm(happiness ~  1 + season, data = couchto5k)
couchto5k2 <- couchto5k[-c(95,107,126,65), ]

happiness_season_mod2 <-lm(happiness ~  1 + season, data = couchto5k2)
summary(happiness_season_mod2)
```
A model was created and simple regression was carried out to investigate the relationship between the interview season and the happiness scores of the participants. After the initial inspection, four influential outlier points were removed. There is a significant relationship between season of the interview and happiness scores only for winter (t(`r happiness_season_mod2$df.residual`) = 2.17, p < 0.05 ), spring ((t(`r happiness_season_mod2$df.residual`) = 2.87, p < 0.01 ) and summer (t(`r happiness_season_mod2$df.residual`) = 2.21, p < 0.05 ). Adjusted R-squared is 0.047, indicating this model explains 47% of the variation in happiness scores. 




## Question 2b

```{r q2b, comment = "", tidy=TRUE}
happiness_age_mod <- lm(happiness ~ 1+ season + age, data = couchto5k2)
summary(happiness_age_mod)
```
A second model was built using age of the participants as well as season of the interview. A multiple regression analysis showed that age does not have a statistically significant effect on happiness scores. Age does not predict happiness scores over season.  

## Question 2c

```{r q2c}

```
Out of age and season, only season of the interview can predict happiness scores significantly. That is why I only picked season of the interview for my baseline model for the upcoming questions regarding this sample. 



# Question 3

## Question 3a

```{r q3a, comment = "", tidy=TRUE}
hap_completion_mod <- lm(happiness ~ 1+ season + didComplete, data = couchto5k2)
summary(hap_completion_mod)
```
Happiness scores of participants were not affected by whether they completed the programme or not. Completion of the programme did not significantly predict happiness scores. 



## Question 3b

```{r q3b, comment = "", tidy=TRUE}
hap_health_mod <-lm(happiness ~ 1+ season + health, data = couchto5k2)
summary(hap_health_mod)
```
A multiple regression analysis was conducted to investigate whether happiness scores are affected by health metric. A new model was created, this time including health metric as a predictor, building on the baseline model. According to the analysis, health scores cannot predict happiness scores significantly. 


## Question 3c

```{r q3c, comment = "", tidy=TRUE}
q3c_mod<- lm(happiness ~ 1 + season + week_stopped * health, data = couchto5k2)
summary(q3c_mod)
coefficients(q3c_mod)

plot_model(q3c_mod, type = "int")
```
*Figure 3:* Plot showing the interaction of health metric and the week participated stopped in


A model investigating the interaction between the health metric and the week participants dropped the programme was built. The interaction between health and getting further in the programme was stastistically significant (t(15) = 3.95, p < 0.001). It can hypothesized that interaction of health metric and getting further on the programme, here measured by the completion week, has a significant effect on happiness scores of participants. Figure 3 shows how health metric and getting further in the programme interact, in terms of happiness scores

## Question 3d

A multiple regression analysis was conducted to investigate what affects happiness scores of participants, in a fitness programme context. F,rst, it was analyzed whether or not time of the year which the interview took place had an effect on happiness scores or not. Out of 4 seasons, winter (t(`r happiness_season_mod2$df.residual`) = 2.17, p < 0.05 ), spring  ((t(`r happiness_season_mod2$df.residual`) = 2.87, p < 0.01 ) and summer (t(`r happiness_season_mod2$df.residual`) = 2.21, p < 0.05 ) all had a significant effect on happiness scores, whereas autumn did not had any statistically significant effect. 

Age, health scores in general and week of programme participant stopped in, were not able to predict happiness scores significantly. However, the interaction of health metric and completion rate was statistically significant (t(15) = 3.95, p < 0.001). This indicates that there is a relationship between effects of good health and feeling of acting healthily. These two measurements interact with each other and affect happiness scores as well.


# Question 4

```{r q4}
couchto5k2_Comp <-couchto5k2 [couchto5k2$didComplete == 1, ]
ggplot(couchto5k2_Comp, aes(x = season, y = happiness))+
  geom_col(position = position_dodge())+
  facet_wrap(~city, strip.position = "bottom")+
  theme_classic()+
  theme(strip.placement = "outside")+
  labs(title = "Happiness Ratings by Season and City" ,x = "", y = "Happiness Scores")
```
*Figure 4:* Happiness Ratings by Season and City
Figure 4 shows the happiness ratings of participants who completed the programme at week 9 grouped by season and city


# Question 5

## Question 5a

```{r q5a}
dropping_mod <- glm(didComplete ~ selfmot + accountability+ age, data = couchto5k2, family = "binomial" )
dropping_mod2 <- glm(didComplete ~ selfmot, data = couchto5k2, family = "binomial" )
summary(dropping_mod)

```

## Question 5b

```{r q5b}
exp(coef(dropping_mod))
```
Probability of dropping out of the programme or not were modelled using logistic regression with accountability, self motivation and age as predictors. Self motivation, measured with a self reported questionnaire ,n this study, has a significant effect on probability of dropping out of the Couch to 5K programme(z(118) = 2.26, p < 0.01). For every point of increase in self motivation questionnaire, the probability of completing the programme increases by 1.2. 


## Question 5c

```{r q5c, include=FALSE}
selfmot100 <- tibble(selfmot = 1:100)

selfmot100 <- selfmot100 %>% mutate(
  prob_predic = predict(dropping_mod2, newdata = selfmot100, type = "response")
)

```

```{r}
ggplot(data = selfmot100, aes(x = selfmot, y = prob_predic)) +
  geom_line()+
  labs(y="Predicted Probability of Continuing the Programme")
```

*Figure 5:* Probability of Continuing to Couch to 5K Programme Predicted by Self Motivation Scores
