---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
  pdf_document: default
params:
  examnumber: B203109
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
cleaned_couch<- couchto5k %>% mutate(
 age = ifelse(age<100, age, NA),
 selfmot = ifelse((selfmot>=5 & selfmot<=35), selfmot, NA),
 season = ifelse(season == "autunm", "autumn", season),
week_stopped = ifelse(week_stopped>9, NA, week_stopped)
)
cleaned_couch<- na.omit(cleaned_couch)
cleaned_couch<-cleaned_couch %>% mutate(
  finished = ifelse(cleaned_couch$week_stopped==9, "yes", "no")
)
winners<-(cleaned_couch[cleaned_couch$finished=="yes",])
justasmuch<-(cleaned_couch[cleaned_couch$finished=="no",])

```
In this report, we will analyse the data from this year's edition of the Couch to 5k programme, by describing it and answering some research questions about it. This year's data has 9 variables: the participant's ID, the city and season they took the programme in, the week they stopped taking it at, and some personal information: their age, accountability, self-motivation, health, and happiness. 

The first thing we did was removing impossible values. We eliminated all the rows that contained ages above 100, stop weeks above 9 or, finally, self-motivation or accountability less than 5 or greater than 35. After applying those filters, we corrected any typos in season names, like "autunm" instead of "autumn". Finally, there were some participants whose happiness was either 0 or 100. This is suspicious, because there aren't people that are either not happy at all or completely happy. If we included these participants in our investigation, the average happiness of people who completed the programme and that of people who didn't would be very similar(`r mean(winners$happiness)` and `r mean(justasmuch$happiness)`), which makes no sense if we plot our data. The binary variable "finished" establishes whether a participant completed the programme or not:

```{r}
cleaned_couch %>% ggplot(aes(x=happiness, y=finished)) + geom_jitter(size=3, width=0, height=.2) + geom_smooth(method="glm", method.args=list(family=binomial))
cleaned_couch <- cleaned_couch %>% mutate (
  happiness = ifelse((happiness!=0 & happiness!=100), happiness, NA)
)
cleaned_couch<- na.omit(cleaned_couch)
winners<-(cleaned_couch[cleaned_couch$finished=="yes",])
justasmuch<-(cleaned_couch[cleaned_couch$finished=="no",])
```

Judging by this graph, we can tell that people who completed the challenge are happier than those who didn't. When we take this into account, it makes even less sense when we see that some finishers have 0 happiness and, reversing the situation, some nonfinishers have 100 happiness. If we remove rows whose happiness is 0 or 100, the average happiness of the former and the latter matches what we see in the plot: `r mean(winners$happiness)` and `r mean(justasmuch$happiness)`. Hence, we deleted them before conducting our analysis. Now, the plot looks like this:


```{r}
cleaned_couch %>% ggplot(aes(x=happiness, y=finished)) + geom_jitter(size=3, width=0, height=.2) + geom_smooth(method="glm", method.args=list(family=binomial))
```


After having cleaned our data, we show below a bar graph for each variable:

```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 
agehist<-hist(cleaned_couch$age, col="cornflowerblue", border="white", xlab="age", ylab="nº of participants", main="Participants by age")
acchist<-hist(cleaned_couch$accountability, col="cornflowerblue", border="white", xlab="accountability", ylab="nº of participants", main="Participants by accountability")
selfmothist<-hist(cleaned_couch$selfmot, col="cornflowerblue", border="white", xlab="self-motivation", ylab="nº of participants", main="Participants by self-motivation")
healthhist<-hist(cleaned_couch$health, col="cornflowerblue", border="white", xlab="health", ylab="nº of participants", main="Participants by health")
happyhist<-hist(cleaned_couch$happiness, col="cornflowerblue", border="white", xlab="happiness", ylab="nº of participants", main="Participants by happiness")
stopweekhist<- hist(cleaned_couch$week_stopped, col="cornflowerblue", border="white", xlab="Week the participant left", ylab="nº of participants", main="Participants by stop week")
seasonplot<-ggplot(data=cleaned_couch, aes(x=season)) + geom_bar(fill="cornflowerblue") + labs(x="season", y="nº of participants")
seasonplot + ggtitle("Participants by season") + theme(plot.title =element_text(hjust=0.5))
cityplot<-ggplot(data=cleaned_couch, aes(x=city)) + geom_bar(fill="cornflowerblue") + labs(x="city", y="nº of participants")
cityplot + ggtitle("Participants by city") + theme(plot.title =element_text(hjust=0.5))
```



Just by taking a look at these graphs, we can get a good image of what data we are working with. The majority of participants took the programme in spring and summer, and the most popular city to take it was Edinburgh. Ages range from under 20 (`r min(cleaned_couch$age)`, to be precise) to `r max(cleaned_couch$age)`. Accountability, self-motivation, happiness and health all present a normal distribution curve.  Furthermore, we can see that the curve of the "Participants by stop week" graph is the opposite of a bell curve: it's highest at the extremes and lowest at the middle. If we plot how many left the programme at week 9 and how many did so before, we can see that a slight majority of the participants completed it:

```{r}
finishedplot<-ggplot(data=cleaned_couch, aes(x=finished)) + geom_bar(fill="cornflowerblue") + labs(x="Completed the programme", y="nº of participants")
finishedplot + ggtitle("Programme completion") + theme(plot.title =element_text(hjust=0.5))

```

To finish this introduction off, below we show the dataframe we'll be working with, so the reader can replicate the results of this report anytime.
```{r}
options(tibble.width = Inf)
options(tibble.print_max = Inf)
print(tibble(cleaned_couch))
```



# Question 1

# Question 1a
```{r 1qa}
ngmi<-ifelse(cleaned_couch$week_stopped<=5, "Yes", cleaned_couch$week_stopped)
ngmi2<-ifelse(ngmi<9, "No", ngmi)
left_before_halfway_point<-table(ngmi2)
```
In an earlier survey conducted across the country, researchers found that 45% of participants abandoned the programme before halfway point in week 5 and 10 % did so before the final week. In this case, the first percentage has been `r (left_before_halfway_point["Yes"]/length(cleaned_couch$week_stopped))*100`% and the second one has been `r (left_before_halfway_point["No"]/length(cleaned_couch$week_stopped))*100`% , so our data shows similarity to the survey in this regard.    


## Question 1b

Are these data influenced by the city the participants take the programme in? In the following table, under the two columns which represent Edinburgh and Glasgow, we show the three variables: completed the programme, left it before week 5, left it after week five:
```{r q1b}
cleaned_couch<-cleaned_couch %>% mutate(
  lbhp = ifelse(cleaned_couch$week_stopped<=5, "yes", cleaned_couch$week_stopped))
cleaned_couch$lbhp<-ifelse(cleaned_couch$lbhp<9, "no", cleaned_couch$lbhp)
cleaned_couch$lbhp<-ifelse(cleaned_couch$lbhp==9, "completed", cleaned_couch$lbhp)
attrition<-table(cleaned_couch$lbhp, cleaned_couch$city)
attrition
chisq<-chisq.test(attrition)
```
We performed a chi-squared test on this table to check whether the attrition patterns differed by city, and we found that the p-value was `r chisq$p.value`, which makes us accept the null hypothesis: the difference in results from Edinburgh to Glasgow can be attributed to chance, rather than to one location's special effect. That is saying, the city you participate in doesn't affect your chances of completing the programme or leaving it before or after some point. Indeed, we can see that the expected counts don't differ much from those we've observed:
```{r}
chisq$expected
```


## Question 1c

```{r q1c}
agetest<-t.test(cleaned_couch$age~cleaned_couch$city)
```
We also asked ourselves whether the average age of runners differed by city. We conducted a t-test and found out that this was the case: the age mean in Edinburgh is `r agetest$estimate[1]`, while, in Glasgow, this number is reduced to `r agetest$estimate[2]`


# Question 2

## Question 2a
```{r q2a}
seasonlm<-lm(cleaned_couch$happiness ~ 1 + cleaned_couch$season)
fstat<-summary(seasonlm)$fstatistic[1]
df_1<-summary(seasonlm)$fstatistic[2]
df_2<-summary(seasonlm)$fstatistic[3]
seasonlmpvalue<-pf(fstat, df_1, df_2, lower.tail= FALSE)

```
Moreover, in order to know whether the season affected participants' happiness, we created a linear model in which the former predicted the latter. The intercept was the participants' happiness in autumn, `r seasonlm$coefficient[1]`. From that intercept, on average, happiness went up `r seasonlm$coefficient[2]` points in spring, `r seasonlm$coefficient[3]` points in summer and `r seasonlm$coefficient[4]` points in winter. Nevertheless, these four estimates are too variable: the standard error values for autumn, spring, summer and winter are `r summary(seasonlm)$coefficient[5]`, `r summary(seasonlm)$coefficient[6]`,`r summary(seasonlm)$coefficient[7]` and `r summary(seasonlm)$coefficient[8]`, respectively. We can also see that the p-value for this model is `r seasonlmpvalue`, that is, the probability that we had seen that same result by chance is very high. We need no more proofs to conclude season is not a good predictor for happiness. 


## Question 2b
```{r q2b}
seasonagelm<-lm(cleaned_couch$happiness ~ 1 + cleaned_couch$season + cleaned_couch$age)
sa_fstat<-summary(seasonagelm)$fstatistic[1]
sa_df_1<-summary(seasonagelm)$fstatistic[2]
sa_df_2<-summary(seasonagelm)$fstatistic[3]
seasonagelmpvalue<-pf(sa_fstat, sa_df_1, sa_df_2, lower.tail= FALSE)
agelm<-lm(cleaned_couch$happiness ~ 1 + cleaned_couch$age)

```
We also created a model that, after accounting for the season predictor, added the age predictor. According to said model, after having applied the effects of season on happiness, for every time age goes up 1 point, happiness goes up `r seasonagelm$coefficients[5]`. However, its standard error is `r summary(seasonagelm)$coefficients[10]`, so it could have been a very different number instead. Furthermore, the p-value of this multiple linear regression model is, `r seasonagelmpvalue` even higher than that of the model with just the season. If we create a linear model with just age, we can see it was not a good predictor from the start, with a p-value of `r summary(agelm)$coefficients[8]`.


## Question 2c
```{r q2c}
agerange<-((max(cleaned_couch$age) - min(cleaned_couch$age)))
agestep<-seasonagelm$coefficients[5]
agediff<-agerange*agestep
null_model<- lm(cleaned_couch$happiness ~ 1)
seasonageanova<-anova(null_model, seasonagelm)
seasonanova<-anova(null_model, seasonlm)
ageanova<-anova(null_model, agelm)
```
We have seen three linear models for predicting happiness so far: one with season, one with age and one with both. All of them have very high p-values and, when we compare them to a null model using a incremental F-test, the f-values are `r seasonanova$F[2]`, `r ageanova$F[2]` and `r seasonageanova$F[2]`, leaving a huge amount of variance unexplained. Hence, choosing a null model for the next section of our investigation seems the most sensible choice.


# Question 3

## Question 3a

```{r q3a}
finishedlm<-lm(happiness ~ 1 + finished, data=cleaned_couch)

```
At the beginning of this report, we took a glance at the connection between a participant's happiness and whether they completed Couch to 5k or not. To further investigate this relationship, we added the variable "finished" to our null model. Unlike the models we had seen before, this one has a p-value of just `r summary(finishedlm)$coefficients[8]`, meaning that it is highly unlikely for this to happen by chance and that, therefore, completion of the programme is a good predictor for how happy a participant is. According to this model, on average, a person who finished it is `r finishedlm$coefficients[2]` points happier than one who didn't, whose happiness is `r finishedlm$coefficients[1]`.


## Question 3b

```{r q3b}
finishedhealthlm<-lm(happiness ~ 1 + finished + health, data=cleaned_couch)
finishedhealthanova<-anova(finishedlm, finishedhealthlm)
finishedhealthanovapvalue<-finishedhealthanova[6][2,]
```
Building on the model we just created, we created a new one by adding the health predictor, to see how it affected happiness. We conducted an incremental F-test on them and saw that the p-value was `r finishedhealthanovapvalue`, which means health doesn't provide a better fit for our model. If we plot the happiness against the health of the participants, we can see that health was never a good predictor of happiness to begin with. The points are evenly distributed across the plane and they barely have a linear relationship. In fact, their correlation is just `r cor(cleaned_couch$happiness, cleaned_couch$age)`.
```{r}
ggplot(data=cleaned_couch, aes(x=happiness, y=health))+geom_point(color="black")+geom_smooth(method="lm")
```


## Question 3c

Nevertheless, experts have hypothesised that the effects of good health are amplified by the feeling of acting healthily, so we asked ourselves whether the happiness of participants who got further along the programme could have been more affected by the health metric than that of those who stopped earlier. To investigate this, we created a model that took into account the interaction between completion and health. We show it below:

```{r}
both<-lm(happiness ~ 1 + health * finished, data = cleaned_couch)
library(sjPlot)
plot_model(both, type="int")
both_fstat<-summary(both)$fstatistic[1]
both_df_1<-summary(both)$fstatistic[2]
both_df_2<-summary(both)$fstatistic[3]
bothpvalue<-pf(both_fstat, both_df_1, both_df_2, lower.tail= FALSE)
null_both<-lm(happiness ~ 1, data = cleaned_couch)
both_anova<-anova(null_both, both)
```


This model's p-value is `r bothpvalue`, so it allows us to reject the null hypothesis by far. Interestingly enough, for those who completed the programme, more health equals more happiness, and, for those who didn't, the situation is reversed: more health means less happiness. What this means is that the effect health has on participants' happiness depends on whether they finished 5k or not. Moreover, if we conduct an incremental f-test on a null model and this one, we can see that its f-value is `r both_anova$F[2]`, which means that there is a relatively big proportion of explained variance to unexplained variance.

We can show in more detail this interaction. Below, we display the relationship between health and happiness for each week. Week 7 won't be plotted because it's only one participant and, consequently, a line can't be created. We've removed the confidence interval's representation to add visibility:


```{r}

testing<- cleaned_couch
testing<- testing %>% mutate(
week_stopped = ifelse(week_stopped==1, "one", week_stopped),
week_stopped = ifelse(week_stopped==2, "two", week_stopped),
week_stopped = ifelse(week_stopped==3, "three", week_stopped),
week_stopped = ifelse(week_stopped==4, "four", week_stopped),
week_stopped = ifelse(week_stopped==5, "five", week_stopped),
week_stopped = ifelse(week_stopped==6, "six", week_stopped),
week_stopped = ifelse(week_stopped==7, "seven", week_stopped),
week_stopped = ifelse(week_stopped==8, "eight", week_stopped),
week_stopped = ifelse(week_stopped==9, "nine", week_stopped),
)
testing<- testing %>% mutate (
week_stopped = ifelse(week_stopped=="seven", NA, week_stopped))
testing<- na.omit(testing)
testing$week_stopped <-factor(testing$week_stopped, levels = c("one", "two", "three", "four", "five", "six", "eight", "nine"))
stoplm<-lm(happiness ~ 1 + health * week_stopped, data=testing)
allweeksplot<-ggplot(data=testing, aes(x=happiness, y=health, color=week_stopped)) + geom_point() + geom_smooth(method="lm", se=F)
allweeksplot + ggtitle("Effect of health on happiness by week (all weeks)") + theme(plot.title =element_text(hjust=0.5))
```


To make it easier to see, we'll split it in two:


```{r}
weeks123<-cleaned_couch
weeks123<- weeks123 %>% mutate (
 week_stopped = ifelse(week_stopped==1, "one", week_stopped),
week_stopped = ifelse(week_stopped==2, "two", week_stopped),
week_stopped = ifelse(week_stopped==3, "three", week_stopped),
week_stopped = ifelse(week_stopped==4, "four", week_stopped),
week_stopped = ifelse(week_stopped==5, "five", week_stopped),
week_stopped = ifelse(week_stopped==6, NA, week_stopped),
week_stopped = ifelse(week_stopped==7, NA, week_stopped),
week_stopped = ifelse(week_stopped==8, NA, week_stopped),
week_stopped = ifelse(week_stopped==9, NA, week_stopped),
) 
weeks123<-na.omit(weeks123)
weeks123$week_stopped <-factor(weeks123$week_stopped, levels = c("one", "two", "three", "four", "five"))
weeks69<-cleaned_couch
weeks69<- weeks69 %>% mutate (
 week_stopped = ifelse(week_stopped==1, NA, week_stopped),
week_stopped = ifelse(week_stopped==2, NA, week_stopped),
week_stopped = ifelse(week_stopped==3, NA, week_stopped),
week_stopped = ifelse(week_stopped==4, NA, week_stopped),
week_stopped = ifelse(week_stopped==5, NA, week_stopped),
week_stopped = ifelse(week_stopped==6, "six", week_stopped),
week_stopped = ifelse(week_stopped==7, NA, week_stopped),
week_stopped = ifelse(week_stopped==8, "eight", week_stopped),
week_stopped = ifelse(week_stopped==9, "nine", week_stopped),
) 
weeks69<-na.omit(weeks69)
weeks69$week_stopped <-factor(weeks69$week_stopped, levels = c("six", "eight", "nine"))
weeks15plot<-ggplot(data=weeks123, aes(x=happiness, y=health, color=week_stopped)) + geom_point() + geom_smooth(method="lm", se=F)
weeks69plot<-ggplot(data=weeks69, aes(x=happiness, y=health, color=week_stopped)) + geom_point() + geom_smooth(method="lm", se=F)
weeks15plot + ggtitle("Effect of health on happiness by week (weeks 1-5)") + theme(plot.title =element_text(hjust=0.5))
weeks69plot + ggtitle("Effect of health on happiness by week (weeks 6-9)") + theme(plot.title =element_text(hjust=0.5))

```


In these two graphs we see a clear pattern. In the first five weeks, a participant's health doesn't positively affect their happiness; in fact, it doesn't stop it from going down. In the last four weeks (excluding seven for the reason above), we see the opposite trend: the healthier people are, the happier they get. This further confirms the conclusion we extracted from our model.

## Question 3d
From the previous data exploring, we can arrive to a series of conclusions about what influences participants' happiness. In the first place, we know that finishing the programme has a significant impact on happiness: on average, someone who completed it is `r finishedlm$coefficients[2]` points happier than someone who did not.
In the second place, we have discovered there's an impact of health on happiness. When we tried analyzing its isolated effect on the outcome, we saw that it was negligible. However, we then found out that its effect depends on how far did the participant get in the challenge. For starters, health has a positive impact on finishers' happiness but does not on nonfinishers'. If we study more carefully the data, we realize even more: for the first half of the programme (until week five), more health doesn't stop the happiness score from going down, and for the second half, the healthier a participant is, the happier they get. 
This data is very positive and could be shown to future participants of the programme to encourage them.

# Question 4

```{r q4}
season_and_city<-cleaned_couch %>% 
group_by(city, season) %>%
summarise_at(vars(happiness), mean)
edinburgh<-cleaned_couch[cleaned_couch$city=="Edinburgh", ]
glasgow<-cleaned_couch[cleaned_couch$city=="Glasgow", ]
autumninglasgow<-glasgow[glasgow$season=="autumn", ]

```

Below, we show a plot of the average happiness ratings grouped by season and city, which is meant to be shown in a presentation to the funders of the project. All seasons' ratings look similar for both cities, except for autumn, which is very low in Glasgow; this is because there are only `r nrow(autumninglasgow)` runners whose happiness is really low (`r autumninglasgow$happiness[1]` and `r autumninglasgow$happiness[2]`). When someone is shown this data, they could get the impression that there is something wrong with autumn in Glasgow, which would be totally unfounded, since it's just two outliers in the data. This circumstance should be explained to the funders.

```{r}
sac_plot<-ggplot(season_and_city, aes(x=happiness, y=season, color=city))+geom_jitter(size=5)
sac_plot+ ggtitle("Average happiness by season and city") + theme(plot.title =element_text(hjust=0.5))
```


# Question 5

## Question 5a
In the final part of the investigation, we studied drop-out. First of all, we had to build a model that predicted the likelihood of quitting. It didn't seem sensible to create it with all possible predictors, since it would have been too complex. Therefore, in order to choose, we plotted each continuous predictor's relationship against the outcome (it wasn't possible to do so with the categorical variables):
```{r q5a}
cleaned_couch<- cleaned_couch %>% mutate(
  dropout = ifelse(finished=="no", 1, 0)
  )
ggplot(data=cleaned_couch, aes(x=age, y=dropout))+geom_point() + geom_smooth(method="lm")
ggplot(data=cleaned_couch, aes(x=accountability, y=dropout))+geom_point() + geom_smooth(method="lm")
ggplot(data=cleaned_couch, aes(x=selfmot, y=dropout))+geom_point() + geom_smooth(method="lm") + labs(x="self-motivation")
ggplot(data=cleaned_couch, aes(x=health, y=dropout))+geom_point() + geom_smooth(method="lm")
ggplot(data=cleaned_couch, aes(x=happiness, y=dropout))+geom_point() + geom_smooth(method="lm")

#ggplot(data=cleaned_couch, aes(x=dropout, y=happiness, color=city))+geom_jitter(size=2)+facet_wrap(~season)
```

It seems that, as age increases, the rate of dropout goes up as well, but it's an insignificant slope: the age barely makes the oldest participant (`r max(cleaned_couch$age)`) more likely to drop out than the youngest one.(`r min(cleaned_couch$age)`). Accountability, self-motivation, health and happiness do seem to have a relevant impact on how likely is someone to dropout, so we chose them as the predictors of our generalized model, which we show below:

```{r}
fiveaglm<-glm(dropout ~ 1 + accountability + selfmot + health + happiness,  data=cleaned_couch, family="binomial")
summary(fiveaglm)$coefficients
fiveaglmcoefs<-exp(coef(fiveaglm))
```



## Question 5b
Each time one of our predictors goes up one point, the log-odds of the participant dropping out decrease by the estimate of said predictor. For example, for each one point increase in accountability, the log-odds of dropping out go down by `r summary(fiveaglm)$coefficients[2]`.
However, since talking in terms of log-odds is not that intuitive, we translated those log-odds back into odds. After doing that conversion, we saw that the odds of dropping out start by being `r fiveaglmcoefs[1]` for a participant that has the minimum value in all predictors. For each accountability, self-motivation, health or happiness point, the odds of quitting go down by `r fiveaglmcoefs[2]`, `r fiveaglmcoefs[3]`, `r fiveaglmcoefs[4]`, `r fiveaglmcoefs[5]`. So we can conclude that, the higher those predictors are for a participant, the lower will be likelihood that they will abandon the challenge before finishing it.

## Question 5c
To finish the report, we show below a graph representing the probability of quitting as a function of how self-motivated a participant is. We can see that, the more self-motivated you are, the less likely you are to quit.

```{r q5c, include=FALSE}
selfmotglm<-glm(dropout ~ selfmot, data = cleaned_couch, family = "binomial")
selfmot35<- tibble(selfmot = 5:35)
predict(selfmotglm, newdata = selfmot35, type="response")
selfmot35<- selfmot35 %>%
 mutate(
   predicted = predict(selfmotglm, newdata = selfmot35, type = "response")
)
```
```{r q5c_part2}
final_plot<-ggplot(data= selfmot35, aes(x=selfmot, y=predicted)) + geom_line() + labs(x = "self-motivation", y = "Dropout probability")
final_plot + ggtitle("Probability of quitting as a function of self-motivation") + theme(plot.title =element_text(hjust=0.5))
```