---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
  pdf_document: default
params:
  examnumber: B203062
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(pander)
library(broom)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
couchto5k$missing <- NA
couchto5k$missing[couchto5k$age>100] <- "impossible age"
couchto5k$missing[couchto5k$selfmot<5] <- "impossible selfmot"
couchto5k$missing[couchto5k$week_stopped>9] <- "impossible week stopped"
mtab <- table(couchto5k$missing)

couchto5k <- couchto5k%>%filter(is.na(missing))
total <- count(couchto5k)
```

The data were inspected and unlikely values removed, result in `r total` observations for analysis. Table 1 gives a summary of removed data.

```{r table, results='asis'}
mtab %>% pander(caption="Table 1 : Summary of missing values.")
```

```{r season}
miscoded <- sum(couchto5k$season=='autunm')
couchto5k$season[couchto5k$season=="autunm"] <- 'autumn'
couchto5k$season <- as.factor(couchto5k$season)
```

`r miscoded` season entries were initially misentered as "autunm". These were recoded as "autumn".

```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 



sum_0 <- summary(couchto5k)
sum_0 %>% pander(caption = "Table 2: Summary of couchto5k")

```

## Initial Analysis

# Question 1 

## Question 1a
To investigate whether the data in the sample is in line with data from the earlier survey, we will use chi-square goodness-of-fit test to check two hypotheses.

H0: The data in the sample is in line with data from the earlier survey.
H1: The data in the sample is not in line with data from the earlier survey.

Chi-square test of goodness-of-fit is shown in Table 3.
The difference between data in the sample and data from the earlier survey was statistically significant (X-squared=131, df=2, p<.05,one-tailed). We reject H0, and accept H1.

```{r q1a}
couchto5k <- couchto5k %>%
     mutate(
         weekcate = ifelse(week_stopped<5,"before5",ifelse(week_stopped == 9,"completed","after5"))
     )
table(couchto5k$weekcate)
chisq.test(table(couchto5k$weekcate), p = c(.45,.1,.45))
chisq_1a <- chisq.test(table(couchto5k$weekcate), p = c(.45,.1,.45))
chisq_1a %>% pander(caption = "Table 3: chi-square test result")
```

## Question 1b
To investigate whether the patterns of attrition rates differ by city, we will use chi-square goodness-of-fit test to check two hypotheses.

H0: The patterns of attrition rates did not differ by city.
H1: The patterns of attrition rates differ by city.

Chi-square test of goodness-of-fit is shown in Table 5.
The patterns of attrition rates differ by city was statistically significant (X-squared=130.6, df=2, p<.05,one-tailed). We reject H0, and accept H1.
```{r q1b}
table_1b <- table(couchto5k$weekcate,couchto5k$city)
table_1b %>% pander(caption = "Table 4: three categories (stopped before week 5, stopped after week 5, completed)")

table_1b <- couchto5k %>% 
  group_by(week_stopped) %>%
  summarise(freq= n())
weekcate <- tibble(weekcate1_4 = sum(table_1b$freq[1:4]),
                   weekcate5_8 = sum(table_1b$freq[5:8]),
                   weekcate_9 = table_1b$freq[9]
                   )


table(couchto5k$weekcate,couchto5k$city)
plot(table(couchto5k$weekcate,couchto5k$city))
chisq_1b <- chisq.test(table(couchto5k$weekcate), p = c(.45,.1,.45))
chisq_1b %>% pander(caption = "Table 5: chi-square test result")
df_1b <- chisq_1b$parameter <- c(df=2)
```

## Question 1c
A one-sided one-sample t-test was conducted in order to determine if the average ages of participants who commenced the programme differ significantly by city(α = .05). 

Here are two hypotheses
H0: The average ages of participants who commenced the programme did not differ by city.
H1: The average ages of participants who commenced the programme differ by city.

T-test is shown in Table 5.
The average ages of participants who commenced the programme did not significantly differ by city(t = 0.6, df = 42, p-value = 0.3,one-tailed). We accept H0, and reject H1.
```{r q1c}
shapiro.test(couchto5k$age[couchto5k$city=="Edinburgh"])
shapiro.test(couchto5k$age[couchto5k$city=="Glasgow"])
with(couchto5k, var.test(age ~ city))
ttest_1c <- with(couchto5k, t.test(age ~ city, alternative = "greater"))
ttest_1c %>% pander(caption = "Table 6: T-test of age and city")
```

# Question 2

## Question 2a
To investigate whether participants’ happiness ratings affected by the season they were interviewed in, total data on happiness and season were modelled using simple linear regression. The data on happiness and season were included as predictors.
We will consider the hypothesis test that the participants’ happiness ratings affect by the season they were interviewed in is equal to zero, where:

H0: β1=0. The coefficient of season is equal to zero.
H1: β1≠0. The coefficient of season is not equal to zero.

Effects will be considered statistically significant at α=.05.

Full regression results are shown in Table 7. 

The model:
$$
Happiness = β0 + β1(season) + \epsilon
$$
```{r q2a}
model_2a <- lm(happiness ~ 1 + season, data = couchto5k)
plot(model_2a, which=1:4)
model_2a %>% pander(caption = "Table 7: T-test of age and city")

sum_2a <- summary(model_2a)
sum_2a %>% pander(caption = "Table 8: T-test of age and city")

av_2a <- tidy(anova(model_2a))
av_2a
```
Assumptions have been checked. No observation were excluded from the final analysis as it was not judged to be too influential on the model. 

Results showed a significant conditional association between happiness and season (F(3,118) = 4.03, Adjusted R-squared = 0.07, p <.01), and autumn(β=35.42, SE=7.37, p<.01) and summer(β=18.47, SE=9.02, p<.05) also showed significant differences, suggesting that participants’ happiness ratings significantly affected by the season they were interviewed in, and there were differences in the effects on happiness between seasons, with autumn and summer having a more significant effect. We reject H0, and accept H1.





## Question 2b
To investigate whether happiness was affected by age, total data on happiness, season and age were modelled using multiple linear regression. The data on happiness, season and age were included as predictors.
We will consider the hypothesis test that the coefficient of happiness and age is equal to zero, where:

H0: β2=0. The coefficient of age is equal to zero.
H1: β2≠0. The coefficient of age is not equal to zero.

Effects will be considered statistically significant at α=.05.

Full regression results are shown in Table 7. 

The model:
$$
Happiness = β0 + β1(season) + β2(age) + \epsilon
$$
```{r q2b}
model_2b <- lm(happiness ~ 1 + season + age, data = couchto5k)
plot(model_2b, which=1:4)
#couchto5k  ggplot

sum_2b <- summary(model_2b)
sum_2b %>% pander(caption = "Table 9: T-test of season and age")
```
Assumptions have been checked. No observation were excluded from the final analysis as it was not judged to be too influential on the model. 

Results showed a non-significant conditional association between happiness and age (β = -0.114,SE = 0.227, p >.05), suggesting that there was no significant effect of age on happiness. We accept H0, and reject H1.




## Question 2c
To investigate which effects that are not of primary interest to the researchers but which might affect the outcome variable of happiness, we will use ANOVA to test two models. 

Effects will be considered statistically significant at α=.05.

Full ANOVA results are shown in Table 9. 
```{r q2c}
av_2c <- anova(model_2a, model_2b)
av_2c %>% pander(caption = "Table 10: ANOVA of two linear models")
```
Results showed a non-significant conditional association between model_2a and model_2b(F(117)=0.2512, p >.05), with the results in q2b, model_2a can be selected as the baseline model.





# Question 3

## Question 3a
To investigate whether participants’ happiness ratings affected by they completed the programme or not , season and week_stopped_3a were modelled using multiple linear regression. The data on season and week_stopped_3a were included as predictors.
We will consider the hypothesis test that the coefficient of happiness and week_stopped_3a is equal to zero, where:

H0: β2=0. The coefficient of week_stopped_3a is equal to zero.
H1: β2≠0. The coefficient of week_stopped_3a is not equal to zero.

Effects will be considered statistically significant at α=.05.

Full regression results are shown in Table 10. 

The model:
$$
Happiness = β0 + β1(season) + β2(week_stopped_3a) + \epsilon
$$
```{r q3a}
couchto5k <- 
  couchto5k %>% 
  mutate(
    week_stopped_3a = ifelse(week_stopped == "9", "completed", "not completed")
  )

couchto5k$week_stopped_3a <- as.factor(couchto5k$week_stopped_3a)

model_3a <- lm(happiness ~ 1 + season + week_stopped_3a, data = couchto5k)
plot(model_3a, which=1:4)
summary(model_3a)
model_3a %>% pander(caption = "Table 11: Fitting linear model_3a: happiness ~ 1 + season + week_stopped_3a")
```
Assumptions have been checked. No observation were excluded from the final analysis as it was not judged to be too influential on the model. 

Results showed no significant conditional association between happiness and week_stopped_3a (β=-6.65, SE=8.886, p>.05), suggesting that there was no significant effect of week_stopped_3a on happiness. We accept H0, and reject H1.





## Question 3b
To investigate whether  happiness additionally affected by the “health metric”, season, week_stopped_3a and health were modelled using multiple linear regression. The data on season ,age week_stopped_3a and health were included as predictors.
We will consider the hypothesis test that the coefficient of happiness and health is equal to zero, where:

H0: β2=0. The coefficient of health is equal to zero.
H1: β2≠0. The coefficient of health is not equal to zero.

Effects will be considered statistically significant at α=.05.

Full regression results are shown in Table 11. 

The model:
$$
Happiness = β0 + β1(season) + β2(week_stopped_3a) + β3(health) + \epsilon
$$
```{r q3b}
model_3b <- lm(happiness ~ 1 + season + week_stopped_3a + health, data = couchto5k)
plot(model_3b, which=1:4)
summary(model_3b)
model_3b %>% pander(caption = "Table 11: Fitting linear model_3a: happiness ~ 1 + season + week_stopped_3a + health")
```
Assumptions have been checked. No observation were excluded from the final analysis as it was not judged to be too influential on the model. 

Results showed no significant conditional association between happiness and health (β=-0.05345, SE=.3, p>.05), suggesting that there was no significant effect of health on happiness. We accept H0, and reject H1.




## Question 3c
To investigate whether the effects of good health are amplified by the feeling of acting healthily, season, week_stopped_3a and health were modelled using multiple linear regression. The data on season, age week_stopped_3a and health were included as predictors.
We will consider the hypothesis test that the interaction between week_stopped_3a and health is equal to zero., where:

H0: β2=0. The interaction between week_stopped_3a and health is equal to zero.
H1: β2≠0. The interaction between week_stopped_3a and health is not equal to zero.

Effects will be considered statistically significant at α=.05.

Full regression results are shown in Table 12. 

The model:
$$
Happiness = β0 + β1(season) + β2(week_stopped_3a*health) + \epsilon
$$
```{r q3c}
model_3c <- lm(happiness ~ 1 + season + health * week_stopped_3a, data = couchto5k)
summary(model_3c)
plot(model_3c, which=1:4)
model_3c %>% pander(caption = "Table 12: Fitting linear model_3a: happiness ~ 1 + season + health * week_stopped_3a")

couchto5k %>%
  ggplot(aes(x = health, y = happiness, colour=week_stopped_3a)) + 
  geom_point() +
  geom_smooth(method="lm") +
  ggtitle("Figure 1: The interaction between week_stopped_3a and health on happiness") +
  theme_bw()
```
Assumptions have been checked. No observation were excluded from the final analysis as it was not judged to be too influential on the model. 

Results showed a significant conditional association between happiness and week_stopped_3a (β = 109.6, SE = 34.45, p<.01), suggesting that scores on the happiness increase by 109.6 for every 1 standard deviation increase in week_stopped_3a. And a significant conditional association between happiness and health (β = 1.007, SE=0.4189, p<.05), suggesting that scores on the happiness increase by 1.007 for every 1 standard deviation increase in health. 
Crucially, the association between health and happiness was found to be dependent upon the level of week_stopped_3a, with a greater negative association between the two for those with high levels of week_stopped_3a (β = -2.019, SE = 0.5787, p <.01). This interaction is visually presented in Figure 1. The results presented here indicate that the association between health and happiness may depend upon individuals’ levels of week_stopped_3a, the happiness of participants who got further along the programme might be more affected by the health metric than that of those who stopped earlier.

We reject H0, and accept H1.



## Question 3d
An analysis was conducted to investigate the various causes of happiness in our data. When week_stopped_3a was included as a predictor, results showed no significant conditional association between happiness and week_stopped_3a (β=-6.65, SE=8.886, p>.05), suggesting that there was no significant effect of week_stopped_3a on happiness. Same as use health as a predictor, results showed no significant conditional association between happiness and health (β=-.03267, SE=.3, p>.05), suggesting that there was no significant effect of health on happiness. 
However, when I use season, age week_stopped_3a and health as predictors, results showed a significant conditional association between happiness and week_stopped_3a (β = 109.6, SE = 34.45, p<.01), suggesting that scores on the happiness increase by 109.6 for every 1 standard deviation increase in week_stopped_3a. And a significant conditional association between happiness and health (β = 1.007, SE=0.4189, p<.05), suggesting that scores on the happiness increase by 1.007 for every 1 standard deviation increase in health. And the association between health and happiness was found to be dependent upon the level of week_stopped_3a, with a greater negative association between the two for those with high levels of week_stopped_3a (β = -2.019, SE = 0.5787, p <.01). The results presented here indicate that the association between health and happiness may depend upon individuals’ levels of week_stopped_3a, the happiness of participants who got further along the programme might be more affected by the health metric than that of those who stopped earlier.


# Question 4
```{r q4}
week_stopped_4 <- couchto5k %>% filter(week_stopped_3a == "completed")

week_stopped_4 %>%
  group_by(city, season) %>%
  summarise(average.happiness = mean(happiness)) %>%
  ggplot(aes(season, average.happiness, fill = city)) +
  geom_col(position = "dodge") +
  ggtitle("Figure 2: The average happiness ratings grouped by season and city") +
  theme_bw() +
  labs(y="Average happiness")
```



# Question 5

## Question 5a
To investigate the likelihood of dropping out, week_stopped_5a, accountability and selfmot were modelled using generalized linear regression. As psychological factors, accountability and selfmot were included as predictors. Effects will be considered statistically significant at α=.05.

Full regression results are shown in Table 12. 

```{r q5a}
couchto5k <- 
  couchto5k %>% 
  mutate(
    week_stopped_5a = ifelse(week_stopped_3a == "completed", 0, 1)
  )



model_5a <- glm(week_stopped_5a ~ 1 + selfmot + accountability, data = couchto5k, family="binomial")
plot(model_5a, which=1:4)
summary(model_5a)
model_5a %>% pander(caption = "Table 12: Fitting linear model_5a: week_stopped_5a ~ 1 + selfmot + accountability")
```
Assumptions have been checked. No observation were excluded from the final analysis as it was not judged to be too influential on the model. 






## Question 5b

```{r q5b}
summary(model_5a)
exp(coef(model_5a))
```
Results showed no significant conditional association between happiness and selfmot (β = -0.108, SE = 0.05978, p>.05), suggesting that scores on the happiness increase by -0.108 for every 1 standard deviation increase in selfmot. And a significant conditional association between happiness and accountability (β = 0.03184, SE=0.04058, p>.05), suggesting that scores on the happiness increase by 0.03184 for every 1 standard deviation increase in accountability. 






## Question 5c

```{r q5c}
model_5c <- glm(week_stopped_5a ~ selfmot, data = couchto5k, family="binomial")
plot(model_5c,which=1:4)
pander(model_5c)


couchto5k %>% ggplot(aes(x = selfmot, y = week_stopped_5a)) +
  ylab("p(quitting)") +
  geom_jitter(size = 3, width = 0, height =.2 , alpha = .1) +
  geom_smooth(method = "glm" , method.args = list(family = binomial)) +
  scale_y_continuous(breaks = seq( 0, 1, by =.2))
```










