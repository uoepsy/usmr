---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  word_document: default
  pdf_document: default
  html_document: default
params:
  examnumber: "B192976"
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
library(tidyverse)
head(couchto5k)
summary(couchto5k)

```
By using the head and summary function, we can found that the maximum of age and the minimum 
of selfmot are barely possible. To check the plausibility of these two values, I am gonna use 
the ggplot. 

```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 

ggplot(data = couchto5k, aes(x = age)) +
  geom_density() +
  geom_boxplot(width = 1/300) +
  labs(x = "age", 
       y = "density")

ggplot(data = couchto5k, aes(x = selfmot)) +
  geom_density() +
  geom_boxplot(width = 1/300) +
  labs(x = "age",  
       y = "density")

```
As is inspected in the boxplots below, both the age and the selfmot have been identified 
for an impossible value, therefore any values of the couchto5k variable which are > 3 standard 
deviations from the mean would be replaced with "NA".  

```{r}

outliers <- function(obs, x = 3){
  abs(obs - mean(obs, na.rm=TRUE)) > (x * sd(obs, na.rm=TRUE))}

couchto5k$age[outliers(couchto5k$age)]<- NA
couchto5k$selfmot[outliers(couchto5k$selfmot)]<- NA

summary(couchto5k)

ggplot(data = couchto5k, aes(x = age)) +
  geom_density() +
  geom_boxplot(width = 1/300) +
  labs(x = "age", 
       y = "density")

ggplot(data = couchto5k, aes(x = selfmot)) +
  geom_density() +
  geom_boxplot(width = 1/300) +
  labs(x = "selfmot", 
       y = "density")


couchto5k$season <- gsub("autunm", "autumn", couchto5k$season) 

couchto5k$season <- factor(couchto5k$season)

summary(couchto5k)


```

Now, as the new boxplots of variable have shown above, unlikely vaules were replaced, maintaining the 134 observations for analysis.  


# Question 1 

## Question 1a

To test whether the given data from the sample is in line with the data from the earlier survey, I am gonna to test whether the two sets of data coming from two group people who gave up the programme at different points? would be consistent with the data from the earlier survey respectively. 

```{r q1a}
# people who dropped the programme at the halfway
abandoned_participants <- couchto5k %>% filter(week_stopped < 5) 
count(abandoned_participants) 
length(couchto5k$week_stopped)

binom.test( 51 , 134 , p=0.45)

```

```{r}

# people who dropped the programme before the end of the programme
gave_up <- couchto5k %>% 
  filter(week_stopped < 9)
count(gave_up)
length(couchto5k$week_stopped)

binom.test(67,134,p=0.1+0.45)

```

The returned p-values are both greater than the critical value of 0.05, therefore
we are failed to reject the null hypothesis. So we can say the given data is indeed 
in line with the earlier survey. 


## Question 1b


```{r q1b}

week_stopped_groop <-cut( couchto5k$week_stopped,breaks=c(-Inf,5,8,Inf),
                          labels = c("before_week5","after_week5","completed"))
couchto5k<-cbind(couchto5k,week_stopped_groop)
summary(couchto5k)

couchto5k$week_stopped_groop <- factor(couchto5k$week_stopped_groop)

```

Table 1 shows the relationships between patterns of attrition rates and city.

```{r table, results='asis'}

library(pander)

table(couchto5k$week_stopped_groop, couchto5k$city)%>% 
  pander(caption="Table 1: The relationship between the pattern of attrition rates and city")

```


```{r}

t <- table(couchto5k$week_stopped_groop, couchto5k$city)
chisq.test(t)
fisher.test(t)

```
A chi-squared test was thus conducted in order to determine if the attrition rates of Edinburgh was not significantly different from (α=.05) than the attrition rates of Glasgow. The difference was not statistically significant (x-squared=3, p > .05). Therefore, the patterns of attrition rates did not differ by city. 



## Question 1c

```{r q1c}

t.test(age ~ city , couchto5k)

```
A two-sample t-test was conducted in order to determine if average age of participants who commenced the programmed in Edingurgh was significantly different (α=.05) from that in Glasgow. The results showed that there is a significant
difference between the average ages of pariticpants in Edinburgh and Glasgow (t(73)=4, p < .05, two-tailed), so the 
average ages of participants who commenced the programme do differ by city.




# Question 2

## Question 2a


```{r q2a}

library(car)
qqPlot(lm(happiness~ season ,data=couchto5k), simulate = TRUE, main = 'QQ Plot')

```

```{r}

bartlett.test(happiness~ season ,data=couchto5k)

mod_2a=aov(happiness~ season ,data=couchto5k)

summary(mod_2a)

```

```{r}

library(multcomp)
par(mar=c(5,4,6,2))
tuk <- glht(mod_2a, linfct=mcp(season="Tukey"))
plot(cld(tuk, level=.05),col="lightgrey")


```

In this code, the par statement increased the top margin to fit the letter array. The level option in the cld() function provides the significance level to use (0.05, or 95 percent confidence in this case).  Groups (represented by box plots) that have the same letter don’t have significantly different means. 

As visually presented, participants' happiness ratings in spring and summer are not significantly different
(as they both have the letter c) and the happiness outcomes in autumn and winter are not singinicantly different as well 
(as they also share the letter a). However, a difference can be noted in the happiness outcomes in autumn and spring (for which do not share any letter). Therefore, it's clearly presented that season does influence the happiness outcomes, in particular, participants in spring or summer would have a higher happiness rating thatn that in autumn and winter.



## Question 2b

```{r q2b}

mod_2b =lm(happiness~ age ,data=couchto5k)
summary(mod_2b)

```
The F-test for the linear relationship between happiness and age is not significant (F=2.44, p=0.12), so it failed to come to the conclusion that happiness is affected by age. 


## Question 2c

```{r q2c}

library(MASS)
library(sjPlot)

fit_2c <- lm(happiness ~ 1 +  week_stopped * health+
               accountability + selfmot,  
             data = couchto5k)

summary(fit_2c)

stepAIC(fit_2c , direction = "backward")

```
We have discussed the influences that season and age would have on happiness ratings. Despite the existing influence caused by season, we are going to set up a certain baseline model to test whether there would be any factor that would affect the outcome variable of happiness. By doing so, we are gonna to use the stepwise method. 

It worth noticing that week_stopped that we have already discussed may have an impact on health, of which the results would have affected the outcome of happiness. Therefore, we are going to introduce the a interaction between the two preidctor variables of week_stopped and health. To avoid the impact caused by the season, this time the variable season would not be included. 

We start with all four predictors in the model. For each step, the AIC (The Akaike Information Criterion) column provides the model AIC resulting from the deletion of the variable listed in that row. The AIC value for <none> is the model AIC if no variables are removed. In the first step, accountability is removed, decreasing the AIC from 875.75 to 873.87. Deleting any more variables would increase the AIC, so the process stops.

Therefore, the final baseline model would be:
happiness = 224.14 – 28.77 * week_stopped – 3.65 * health + 0.50 * week_stopped_fin * health+ 2.18 * selfmot



# Question 3

## Question 3a

```{r q3a}

week_stopped_fin <- ifelse( couchto5k$week_stopped >=9, "yes" ,"No")
couchto5k<-cbind(couchto5k,week_stopped_fin)
couchto5k$week_stopped_fin <- factor(couchto5k$week_stopped_fin)

fit3a <- lm(happiness ~ 1 +  week_stopped_fin * health + selfmot,  
           data = couchto5k)

```

Results showed a significant conditional association between programme completion and happiness (SE = 28, t = -5.89, p <.01), suggesting that for those at the mean level of participants, scores on happiness decrease by 165 for the increase in each completed week, which means that the relatonship between health and happiness varies by the completion level of the programme. 



## Question 3b

```{r q3b}

summary(fit3a)

```

From the previous model, the results have shown the difference between health (t=6.74, SE=0.54, p<0.05) and programme completion (t=6.71, SE=0.50, p<0.05) is statistically significant. Therefore, the health does affect the outcome of happiness rating. 


## Question 3c

```{r q3c}

summary(fit3a)

```
Based on the 3b's result, the result has shown that the interactions in programme completion (estimate=2.86, t=5.92, Pr<0.05) is significant. 


## Question 3d

In the couchto5k programme, the health and programme completion would togehter have an impact on the outcome of happiness ratings. Participants who have completed more parts of the programme through the weeks would be more likely to have a influences from the health compared to those who ended the programme earlier. The more healthier participants would more likely to complete the programme. Seasons obviously affects the participants' outcome of happiness ratings. In spring and summer, the happiness rates of participants would be much higher. Besides, despite the difference in the average age of participants from Edinburgh and Glasgow, it seems there is no correlation between the happiness rates and age. 


# Question 4

The figure below has visually presented the average happiness ratings grouped by season and city. 

```{r q4}

subset(couchto5k,week_stopped_groop == 'completed', select=c(city,season,happiness)) -> subset_data
subset_data

ggplot(subset_data, aes(x=season, y=happiness, color=city)) + 
  geom_boxplot() + geom_violin()+  
  labs( title = "Average Happiness Ratings", 
      y = "happiness")+
  theme(plot.title = element_text(hjust = 0.5))


```


# Question 5

## Question 5a

```{r q5a}

mod_5a = lm(week_stopped ~ selfmot ,data=couchto5k) 
summary(mod_5a)

```

The F-test for model is significant (F=9.88, t=3.14, p<.05).       

## Question 5b

```{r q5b}

summary(mod_5a)

```
In this study, data were obtained from 134 participants who live in Edinburgh and Glasgow. At Week 0, all participants completed a questionnaire measuring the psychometric factors of accountability and self-motivation. Upon either completing the programme (Week 9) or dropping out (< Week 9), participants completed a questionnaire which included the measure of their self-reported happiness, and a “health” measure derived from a number of physiological tests.     

The selfmot score ranged from 7 to 23. The relationship between programme completion (week_stopped) and self-motivation (selfmot) is studied: self-motivation score was the dependent variable that was to be estimated from the independent variable, week_stopped. On the basis of the data, the following regression line was determined: Y= 2.0 + 0.3 × X, where X is selfmot score and Y is week_stopped. 

The regression coefficient of 2 means that, in this model, a week_stopped increases by 2 week with each score added by selfmot. Figure  shows the regression line that represents the linear relationship between week_stopped and selfmot. 
The coefficient of determination, r2, is a measure of how well the regression model describes the observed data (Box 2). In univariable regression analysis, r2 is simply the square of Pearson’s correlation coefficient. In the case that is described above, the coefficient of determination for the relationship between height and weight is 0.1. This means that 10% of the variance in week_stopped is due to selfmot. F = 9.882 , p-value=0.002, that shows they are linearly related.




## Question 5c

```{r q5c }

library(tidyverse)
library(sjPlot)
ggplot(data = couchto5k,aes(x=selfmot,y=week_stopped)) +
  geom_point() +
  theme_bw()+
  labs( title = "The Predictive Model in likelihood of dropping out ")+
  theme(plot.title = element_text(hjust = 0.5))

```










