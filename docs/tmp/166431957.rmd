---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
  pdf_document: default
params:
  examnumber: B152648
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(broom)
library(dplyr)
library(ggplot2)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
Have a look at the data. Check for impossible values and deal with these in an appropriate manner. Describe the data, either in words or using suitable graphs (or a combination). Remember to detail the decisions you have made.
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->

```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 

couchto5k <-couchto5k[-c(21,52,83,106,109),]
total <- count(couchto5k)
couchto5k$city <-as.factor(couchto5k$city)
couchto5k$season <- as_factor(couchto5k$season)

couchto5k$season[couchto5k$season =="autunm"] <- "autumn"

```

The dataset was inspected and missing and unlikely values were removed resulting in `r total` observations for analysis. The data entries for seasons were initially entered incorrectly as "autunm" and were recoded as "autumn".

The marginal distributions and relationships between the data variables were plotted to give insight into the data prior to analysis. 

```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 

```

```{r fig.cap="Figure 1: Marginal Distribution of Happiness Scores"}

ggplot(data=couchto5k, aes(x=happiness)) +geom_density() + labs(title= "Marginal Distribution of Happiness Scores", 
x= "happiness", y= "probability density") + theme_classic()

```

```{r fig.cap="Figure 2: Marginal Distribution of Health Scores"}

ggplot(data=couchto5k, aes(x=health)) + geom_density() + scale_x_continuous() + labs(title = "Marginal Distribution of Health Scores", x= "health", y= "probability density") + theme_classic()
```


```{r fig.cap="Figure 3: Marginal Distribution of Self Motivation Scores"}
ggplot(data=couchto5k, aes(x=selfmot)) + geom_density() + labs(title = "Marginal Distribution of Self Motivation Scores", 
x= "self-motivation", y= "probability density")

```

```{r fig.cap="Figure 4: Marginal Distribution of Accountability Scores"}
ggplot(data=couchto5k, aes(x=accountability)) + geom_density() + labs(title = "Marginal Distribution of Accountability Scores", 
x= "accountability", y= "probability density")

```



**

Figure 1 shows that the marginal distribution of happiness scores is multi-modal with a mean of approximately 48.8. There is variation in the distribution of happiness scores (SD=33.7)

Figure 2 shows that the marginal distribution of health scores is unimodal with a mean of approximately 56.7. There is variation in health scores (SD=10.1).

Figure 3 shows that the marginal distribution of self motivation scores is unimodal with a mean of approximately 14.9. There is variation in self motivation scores (SD=3.07). 

Figure 4 shows that the marginal distribution of accountability scores is unimodal with a mean of approximately 20.3 .There is variation in accountability scores (SD=5.37).


# Question 1 

## Question 1a
In an earlier nationwide survey, researchers found that 45% of the participants abandoned the programme before the halfway point in week 5, and a further 10% gave up before the end of the programme. Is the data in the sample you have been given in line with data from the earlier survey? Once you have created a suitable variable to map to the information in the question, you should be able to answer this using a simple statistical test.

```{r q1a}
couchto5k <-
  couchto5k %>%
  mutate(slevel= week_stopped)

couchto5k$slevel[couchto5k$slevel == 1 | couchto5k$slevel == 2 | couchto5k$slevel == 3 |couchto5k$slevel == 4 |couchto5k$slevel == 5] = "stopped before week 5"
couchto5k$slevel[couchto5k$slevel == 5 | couchto5k$slevel == 6 | couchto5k$slevel == 7 | couchto5k$slevel == 8] = "stopped after week 5"
couchto5k$slevel[couchto5k$slevel == 9] = "completed"

couchto5k$slevel <- factor(couchto5k$slevel, levels = c("stopped before week 5", "stopped after week 5", "completed"))

table (couchto5k$slevel)
chi1a<-chisq.test(table(couchto5k$slevel), p = c(0.45, 0.10, 0.45))

```

A categorical variable was created to map 3 levels of participants: stopped before week 5, stopped after 5, and completed the program. A chi-square goodness of fit test was performed to assess whether the data sample conforms to the distribution of attrition proportions of the nation wide survey. All `r total` observations were included in the analysis. Effects will be considered statistically significant at $\alpha=0.05$.

The hypotheses that will be considered are: 

$H_0: \chi^2 = 0$. The attrition rates from the earlier nationwide survey and the data in the sample do not differ significantly.


$H_1: \chi^2 > 0$. The attrition rates from the earlier survey and the data in the sample do significantly differ. 

A $X^2$(`r chi1a$parameter`)= `r chi1a$statistic`, n = `r total`, *p* = `r chi1a$p.value` fails to reject the null hypothesis that the attrition rates from the earlier nationwide survey and the data sample do not differ significantly.

## Question 1b
Using the same three categories (stopped before week 5, stopped after week 5, completed), examine whether the patterns of attrition rates differ by city.

```{r q1b}

chi1b<-chisq.test(table(couchto5k$slevel, couchto5k$city))

chi1b

```
A chi-square of independence test was performed to assess whether the patterns of attrition differed by city. All `r total` observations were included in the analysis. Effects will be considered statistically significant at $\alpha=0.05$.

The hypotheses that will be considered are: 

$H_0: \chi^2 = 0$. The attrition rates do not differ significantly by city.


$H_1: \chi^2 > 0$. The attrition rates differ significantly by city.

A $X^2$(`r chi1b$parameter`)= `r chi1b$statistic`, n = `r total`, *p* = `r chi1b$p.value` fails to reject the null hypothesis that the patterns of attrition differ by city. 

## Question 1c
Do the average ages of participants who commenced the programme differ by city?

```{r q1c}

edinburghs<-shapiro.test(couchto5k$age[couchto5k$city== "Edinburgh"])

glasgows<-shapiro.test(couchto5k$age[couchto5k$city== "Glasgow"])

plot(density(couchto5k$age))
qqnorm(couchto5k$age)

var1c<-with(couchto5k,var.test(age ~city))

```


A Shapiro wilk test was performed to assess whether the average ages of participants in the program differed by city.  All `r total` observations were included in the analysis. Effects will be considered statistically significant at $\alpha>0.05$.

The Shapiro Wilk test did indicate a violation of normality for both Edinburgh  (W= `r edinburghs$statistic`, p = `r edinburghs$p.value`) and Glasgow (W= `r glasgows$statistic`, p = `r glasgows$p.value`)
However, the data was plotted using a qqnorm and density plot where the data looked roughly normally distributed, therefore assumptions of normality were met.
 
In addition, an F test to compare two variances was conducted to determine whether the two samples, Edinburgh and Glasgow have equal variance, p= `r var1c$p.value`
Thus, the two samples have equal variance. 

```{r}
ctest<-t.test(x=couchto5k$age[couchto5k$city== "Edinburgh"], y= couchto5k$age[couchto5k$city== "Glasgow"])

ggplot(data=couchto5k, aes(x=age, y=city)) + geom_boxplot()

```


A Welch Two Sample test was performed to assess whether the two populations have equal means. All `r total` observations were included in the analysis. Effects will be considered statistically significant at $\alpha>0.05$. 

$H_0: \mu E = \mu G$. The mean age between participants from Edinburgh and Glasgow sample do not differ significantly. 

$H_1: \mu E \neq \mu G$.The mean age between participants from Edinburgh and Glasgow sample do differ significantly. 

A Welch Two Sample t-test was conducted against the null hypothesis that there is no significant difference in mean ages between the participants from Edinburgh and Edinburgh. The Welch Two Sample test did indicate a difference between means ($\mu E$ = `r ctest$estimate[1]`, $\mu G$ = `r ctest$estimate[2]`, *p* = `r ctest$p.value`)

The data was plotted to evidence the difference in means between the two samples. The average age of participants from Edinburgh is approximately 40 years and the average age of participants from Glasgow is approximately 34 years. 

# Question 2

## Question 2a
Are participants’ happiness ratings affected by the season they were interviewed in? Describe the way in which season influences happiness outcomes.

```{r q2a}
model1 <- lm(happiness~1+ season,data=couchto5k)
plot(model1)
summary(model1)

plot(model1, which=4)

```


The linear regression model shows that there may be a relationship between season and happiness ratings. The relationship may be significant. The coefficients indicate the average happiness ratings per season, there is a substantial difference in average happiness ratings from summer and winter. 

Season explained 5.98% of the variance in happiness ratings (adjusted R squared=0.0598, F(3,122)=3.65, $p= 0.0145$)

Assumptions were conducted and they were met. 

The residual vs. fitted plot shows a roughly straight red line which indicates that the mean of the residuals is close to zero across the fitted values.

The QQ-plot of residuals shows that the residuals are fairly close to the dotted line indicating that they closely follow a normal distribution.

The scale location plot shows the square root of the absolute value of the standardized residuals and allows us to examine the extent to which the variance of the residuals changes across the fitted values. The line exemplified is wiggly indicating that there may be some discrepancies in constant variance, however, this does not warrant significant concern.

The residuals vs leverage plot shows the extent to which the data points that have higher residuals have the potential to influence the regression line. There are a few influential points however, the cook's distances values don't warrant significant concern. 

## Question 2b
Accounting for any effects you discovered in (2a), is happiness affected by age?

```{r q2b}
model2 <- lm(happiness~1+season+age, data=couchto5k) 
summary(model2) 
plot(model2)
```

The linear regression model was refitted to include the age variable. 

Assumptions were conducted and they were met. 

The residual vs. fitted plot shows a roughly straight red line which indicates that the mean of the residuals is close to zero across the fitted values.

The QQ-plot of residuals shows that the residuals are fairly close to the dotted line indicating that they closely follow a normal distribution.

The scale location plot shows the square root of the absolute value of the standardized residuals and allows us to examine the extent to which the variance of the residuals changes across the fitted values. The line exemplified is wiggly indicating that there may be some discrepancies in constant variance, however, this does not warrant significant concern.

The residuals vs leverage plot shows the extent to which the data points that have higher residuals have the potential to influence the regression line. There are a few influential points however, the cook's distances values don't warrant significant concern. 

This model shows that there may be a relationship between season, age and happiness ratings. The relationship may be significant. 

Age and season explained 5.35% of the variance in happiness ratings (adjusted R squared=0.0535, F(4,121)=2.77, $p= 0.0304$)

Although this model shows that happiness ratings are affected by both season and age, it may be contrasted against the earlier model of season which explained 5.98% of the variance in happiness ratings. 

## Question 2c
The models you have built above explore ‘baseline’ effects; that is, effects that are not of primary interest to the researchers but which might affect the outcome variable of happiness. For use in question 3, pick a specific baseline model and justify why you are using this.

```{r q2c}
anova(model1,model2)
```
I performed an analysis of variance test to evaluate the effects of model1 and model2 on happiness ratings. The analysis of variance test showed that the models are not significantly different $p-value=0.66$ 

Based on this value, I have chosen model1 as my baseline model as the age variable does not improve the model. Performing an analysis of variance test does run the risk of a Type 1 error, thus it is important to account for this when you run your test.

# Question 3

## Question 3a
Building on your baseline model, are participants’ happiness ratings affected by whether or not they completed the programme? Describe the way in which programme completion influences happiness outcomes.

```{r q3a}
couchto5k <- couchto5k%>% mutate(
  comp_program = ifelse(week_stopped == "9","yes","no")
)

model3 <- lm(happiness~ season + comp_program, data= couchto5k)
plot(model3)
summary(model3)

```
A new binary variable was created with yes and no values to evaluate whether participants' happiness ratings were affected by whether or not they completed the programme. 

$H_0:R-squared= 0$. Programme completion does not significantly explain variance in happiness ratings in addition to the season variable. 


$H_1:R-squared > 0$. Programme completion significantly explains variance in happiness ratings in addition to the season variable.

This binary variable was added into the baseline model and the data was plotted. The assumptions of the residuals were met.

The residual vs. fitted plot shows a roughly straight red line which indicates that the mean of the residuals is close to zero across the fitted values.

The QQ-plot of the residuals shows that the residuals are fairly close to the dotted line indicating that they closely follow a normal distribution.

The scale location plot shows the square root of the absolute value of the standardised residuals and allows us to examine the extent to which the variance of the residuals changes across the fitted values. The line exemplified is distorted indicating that there may be some discrepancies in constant variance, however, this does not warrant significant concern.

The residuals vs leverage plot shows the extent to which the data points that have higher residuals have the potential to influence the regression line. There are a few influential points however, the cook's distances values don't warrant significant concern. 

The new binary variable, programme completion influences happiness ratings significantly. Season and programme completion explained 6.45% of the variance in happiness ratings (Adjusted R-squared= 0.0645, F(4,121)= 3.15, $p-value=0.0166$)

## Question 3b
Building on the analysis in (3a), is happiness additionally affected by the “health metric”?

```{r q3b}
health_model <- lm(happiness ~ season + comp_program + health, data= couchto5k)

summary(health_model)
plot(health_model)
```

The health variable was added into the model from 3a to evaluate whether happiness ratings were improved.

$H_0: R-squared = 0$. Health does not significantly explain variance in happiness ratings in addition to the season and program completion variables. 


$H_1: R-squared> 0$. Health significantly explains variance in happiness ratings in addition to the season and program competition variables.

The assumptions of the residuals were met.

The residual vs. fitted plot shows a roughly straight red line which indicates that the mean of the residuals is close to zero across the fitted values.

The QQ-plot of residuals shows that the residuals are fairly close to the dotted line indicating that they closely follow a normal distribution.

The scale location plot shows the square root of the absolute value of the standardised residuals and allows us to examine the extent to which the variance of the residuals changes across the fitted values. The line exemplified is distorted indicating that there may be some discrepancies in constant variance, however, this does not warrant significant concern.

The residuals vs leverage plot shows the extent to which the data points that have higher residuals have the potential to influence the regression line. There are a few influential points however, the cook's distances values don't warrant significant concern. 

The health variable influences happiness outcomes. Season, programme completion and health explained 6.17% of the variance in happiness ratings (Adjusted R-squared= 0.0617, F(5,120)= 2.64, $p-value=0.0265$)

However, happiness ratings are not additionally explained by the health metric as this model only accounts 6.17% of the variance. 

## Question 3c
It’s been hypothesised that the effects of good health are amplified by the feeling of acting healthily, such that the happiness of participants who got further along the programme might be more affected by the health metric than that of those who stopped earlier. Building on the model in (3b), can you test this hypothesis?

```{r q3c}

gh_model<-lm(happiness ~ season + comp_program + health + health: comp_program, data= couchto5k) 

summary(gh_model)

plot(gh_model)

```

$H_0: R-squared = 0$. Health does not significantly affect happiness ratings for those who went further in the program


$H_1: R-squared> 0$. Health significantly affects happiness ratings for those who went further in the program

A hypothesis test was conducted to evaluate whether the effects of good health are amplified by the feeling of acting healthily such that the happiness of participants who got further along the programme might be more affected by the health metric than those who stopped earlier. A linear model which included an interaction between health and completed program was fitted. 

The data was plotted and the assumptions were met.

The residual vs. fitted plot shows a roughly straight red line which indicates that the mean of the residuals is close to zero across the fitted values.

The QQ-plot of residuals shows that the residuals are fairly close to the dotted line indicating that they closely follow a normal distribution.

The scale location plot shows the square root of the absolute value of the standardised residuals and allows us to examine the extent to which the variance of the residuals changes across the fitted values. The line exemplified is distorted indicating that there may be some discrepancies in constant variance, however, this does not warrant significant concern.

The residuals vs leverage plot shows the extent to which the data points that have higher residuals have the potential to influence the regression line. There are a few influential points however, the cook's distances values don't warrant significant concern. 

Health influences happiness ratings differently depending on program completion of participants $p-value=0.00033$, Adjusted R-squared= 0.151, F(6,119)= 4.71, $p-value=0.000244$) 

## Question 3d
What can we conclude about the various causes of happiness in our data? Write a brief description of the effects in the model, such as you might find in an academic paper.

The data set exemplifies that the happiness ratings of participants are influenced by multiple predictors. The model which included season and programme completion explained 6.45% of the variance in happiness ratings, however, the model which added in the health variable only explained 6.17% of the variance in happiness ratings. Thus health did not contribute to the improvement of the model. The interaction model explains 15.1% of the variance in happiness ratings, which is the greatest improvement to the model. 

# Question 4: 
Create a subset of the data, including only those participants who completed the programme. Create a plot of the average happiness ratings grouped by season and city, that can be used in a presentation to the funders of the project.

```{r fig.cap="Figure 5: Average Happiness Ratings grouped by season and city"}

completed_program<-filter(couchto5k, week_stopped==9)

completed_program

mean_happiness<- mean(completed_program$happiness)

ggplot(data = completed_program, aes(x=season, y= happiness, col= city)) + geom_boxplot() + facet_wrap(~city, scales = "free_x") + theme(legend.position = "none")

```

# Question 5

## Question 5a
Build a model that predicts the likelihood of dropping out(at all)

```{r q5a}
couchto5k <- couchto5k %>%
  mutate(
    dropout = ifelse(week_stopped == 9, "completed", "dropout")
  )

couchto5k$dropout <- factor(couchto5k$dropout, levels= c("completed", "dropout"))

predmodel <- dropout ~ age  + accountability + selfmot + health + happiness + season + city

fitmodel <- glm(dropout~ age + accountability + selfmot + health + happiness + season + city, data= couchto5k, family = "binomial")
                
summary(fitmodel) 

anova(fitmodel)

nullm <-  glm (dropout ~1, family=binomial, data=couchto5k) 
  

```

A new fitted model was created to predict the probability of dropping out. This model accounted for all of the predicted variables such as age, accountability, self motivation, health, happiness, season, city, in the data set. A new variable 'drop out' was created and factored to divide participants into those who dropped out before week 9 and those who completed the program. 

## Question 5b
Briefly describe the effects in your model as you would in an academic paper
```{r q5b}
anova(fitmodel)
summary(fitmodel)

```

An analysis of deviance was conducted which compares the likelihood of the new fitted predictive model to the previous null model. According to the predictive model, the most important predictors are season and health. 

## Question 5c
Draw a graph representing the probability of quitting as a function of how self motivated participants were.

```{r fig.cap="Figure 6: Probability of Dropping Out and Self Motivation Scores"}

selfmod <- dropout ~ selfmot

fitselfmod <- glm(selfmod, couchto5k, family = "binomial")

couchto5k$probs = predict( fitselfmod, newdata = couchto5k, type = "response") 


couchto5k %>%
  filter(dropout==dropout) %>%
  ggplot(., aes(x=selfmot, y=probs)) + 
  geom_line() + 
  xlab("selfmot") +
  ylab("Probability of dropping out") +
  theme_bw()

```

