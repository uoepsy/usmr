---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
  pdf_document: default
params:
  examnumber: "B209120"
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(broom)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
couchto5k$missing <- NA
couchto5k$missing[couchto5k$age>100] <- "impossible age"
couchto5k$missing[couchto5k$selfmot<0] <- "impossible selfmot"
couchto5k$missing[couchto5k$week_stopped>9] <- "impossible week stopped"
mtab <- table(couchto5k$missing)


library(pander)
mtab <- table(couchto5k$missing)
mtab %>% pander(caption="Table 1: Summary of missing values. " )

couchto5k <- couchto5k%>%filter(is.na(missing))
total <- count(couchto5k)




```


```{r season}
miscoded <- sum(couchto5k$season=='autunm')
miscoded
couchto5k$season[couchto5k$season=="autunm"] <- 'autumn'
couchto5k$season <- factor(couchto5k$season)
```
`r miscoded` season of the year participants were interviewed in were initially misentered as "autunm". These were recoded as "autumn".



```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 

#continuous variable
#mode
couchto5k %>%
    count(age) %>%
    arrange(desc(n))
couchto5k %>%
    count(accountability) %>%
    arrange(desc(n))
couchto5k %>%
    count(selfmot) %>%
    arrange(desc(n))
couchto5k %>%
    count(health) %>%
    arrange(desc(n))
couchto5k %>%
    count(happiness) %>%
    arrange(desc(n))
couchto5k %>%
    count(week_stopped) %>%
    arrange(desc(n))
#mean median minimum maximum
summary(couchto5k)
#standard deviation
sd(couchto5k$age)
sd(couchto5k$accountability)
sd(couchto5k$selfmot)
sd(couchto5k$health)
sd(couchto5k$happiness)
sd(couchto5k$week_stopped)
#check whether the variable is normally distributed
shapiro.test(couchto5k$age)
shapiro.test(couchto5k$accountability)
shapiro.test(couchto5k$selfmot)
shapiro.test(couchto5k$health)
shapiro.test(couchto5k$happiness)
shapiro.test(couchto5k$week_stopped)
#density plot for age, happiness, week_stopped 
library(patchwork) ##used to arrange plots
##choice 1 density plot
ggplot(data = couchto5k, aes(x = age)) + 
  geom_density()
ggplot(data = couchto5k, aes(x = happiness)) + 
  geom_density()
ggplot(data = couchto5k, aes(x = week_stopped)) + 
  geom_density()
##choice 2 combination of plots(see interpretation example in tut w8 QB2)
age_plot <- 
  ggplot(data = couchto5k, aes(x = age)) +
  geom_density() +
  geom_boxplot(width = 1/250) +
  labs(x = "age", y = "Probability\ndensity")
happiness_plot <- 
  ggplot(data = couchto5k, aes(x = happiness)) +
  geom_density() +
  geom_boxplot(width = 1/250) +
  labs(x = "happiness", y = "Probability\ndensity")
week_stopped_plot <- 
  ggplot(data = couchto5k, aes(x = week_stopped)) +
  geom_density() +
  geom_boxplot(width = 1/250) +
  labs(x = "week_stopped", y = "Probability\ndensity")
# the "patchwork" library allows us to arrange multiple plots
age_plot / happiness_plot / week_stopped_plot


#categorical variable
##season
#frequency
table(couchto5k$season)
#percentage
table(couchto5k$season)/117*100
##city
#frequency
table(couchto5k$city)
#percentage
table(couchto5k$city)/117*100
```

# Question 1 

## Question 1a

```{r q1a}
couchto5k<-couchto5k %>%
  mutate(
    categoweek = ifelse(week_stopped<5,"before5",ifelse(week_stopped<9,"before9","completed"))
  )
table(couchto5k$categoweek)
chisq.test(table(couchto5k$categoweek), p = c(.45,.1,.45))
```

## Question 1b

```{r q1b}
#change categoweek to attrition rates
table(couchto5k$categoweek)/117*100
#plot and graph ( to display the relationship between the city, and attrition rates.)
table(couchto5k$city, couchto5k$categoweek)
plot(table(couchto5k$city, couchto5k$categoweek))
#chi-square test
chisq.test(table(couchto5k$city, couchto5k$categoweek))
```

## Question 1c

```{r q1c}
#plot
ggplot(data = couchto5k, aes(x = age, y = city)) +
  geom_boxplot()

#assumption check
##normality(p<.05,not normally distributed,here Glasgow√ Edinburgh×)
shapiro.test(couchto5k$age[couchto5k$city=="Glasgow"])
shapiro.test(couchto5k$age[couchto5k$city=="Edinburgh"])
##variance
with(couchto5k, var.test(age ~ city))

#conduct independent t-test (significantly different)
with(couchto5k, t.test(age ~ city, alternative = "two.sided"))


```

# Question 2

## Question 2a

```{r q2a}
#exploring the data
##visualise (visualise a marginal distribution see in description)
ggplot(data = couchto5k, aes(x = season, y = happiness)) +
  geom_point(alpha = 0.5) +
  labs(x = "season", 
       y = "happiness)")

#Assumption check
model2a <- lm(happiness ~ 1 + season, data = couchto5k)
par(mfrow = c(2,2)) 
plot(model2a, which=1:4)
##item21, 51, 98 are huge influential observations. these should be removed from the dataset because they are huge influential and they are obviously skewing up the model diagnostics.
couchto5k<-couchto5k[-c(21,51,98),]

#model fitting
model2a <- lm(happiness ~ 1 + season, data = couchto5k)

#Inference for regression coefficients (whether there is a linear relationship between season and happiness)+interpret the coefficient
summary(model2a)

#95%predicted values
sigma(model2a)

#95% confidence interval of coefficient 
confint(model2a, level = 0.95)

#model evaluation
##Multiple R-squared see in summary(model2a)
##Testing Model Utility: F Statistic (QA11)
anova(model2a)


```

## Question 2b

```{r q2b}

#exploring the data
##visualise (visualise a marginal distribution see in description)
####plots of the marginal relationships between the outcome variable () and each of the explanatory variables
happiness_season <- 
  ggplot(data = couchto5k, aes(x = season, y = happiness)) +
  geom_point(alpha = 0.5) +
  labs(x = "season", y = "happiness score ")
happiness_age <- 
  ggplot(data = couchto5k, aes(x = age, y = happiness)) +
  geom_point(alpha = 0.5) +
  labs(x = "age", y = "happiness score ")
happiness_season | happiness_age
##correlation 
cor.test(couchto5k$age, couchto5k$happiness, method = "pearson")

#assumption check
model2b <- lm(happiness ~ 1 + season + age, data = couchto5k)
par(mfrow = c(2,2)) 
plot(model2b, which=1:4)


#Inference for regression coefficients +interpret the coefficient
summary(model2b)


#95% confidence interval of coefficient 
confint(model2b, level = 0.95)

#model evaluation (adjusted R-squared+F-ratio)
##adjusted R-squared see in summary(model2b)
anova(model2b)

```

## Question 2c

```{r q2c}
anova(model2a, model2b)
```

# Question 3

## Question 3a

```{r q3a}

#establish new variable
couchto5k <- 
  couchto5k %>% 
  mutate(
    whether_complete = ifelse(week_stopped == "9", "yes", "no")
  )
couchto5k$whether_complete <- as.factor(couchto5k$whether_complete)

#exploring the data
##visualising
library(sjPlot)
model3a <- lm(happiness ~ 1 + season + whether_complete, data = couchto5k)
plot_model(model3a, type = "pred",  terms=c("season","whether_complete"), show.data=TRUE)#combined

#assumption check
par(mfrow = c(2,2))
plot(model3a, which=1:4)

couchto5k<-couchto5k[-c(56),]
model3a <- lm(happiness ~ 1 + season + whether_complete, data = couchto5k)

#Inference for regression coefficients +interpret the coefficient
summary(model3a)

#95%predicted values
sigma(model3a)

#95% confidence interval of coefficient 
confint(model3a, level = 0.95)

#model evaluation (adjusted R-squared+F-ratio)
##adjusted R-squared see in summary(model3a)
anova(model3a)

```

## Question 3b

```{r q3b}

#new model
model3b <- lm(happiness ~ 1 + season + whether_complete + health, data = couchto5k)

#assumption check
par(mfrow = c(2,2))
plot(model3a, which=1:4)


#coefficient and model evaluation (adjusted R-squared+F-ratio)
summary(model3b)
anova(model3b)
#95% confidence interval of coefficient 
confint(model3b, level = 0.95)

#explained variance comparision
summary(model3a)$adj.r.sq#without new variable
summary(model3b)$adj.r.sq#with new variable

#F-ratio
anova(model3a, model3b)


```

## Question 3c

```{r q3c}
#visualise
ggplot(data = couchto5k, aes(x = health, y = happiness)) + 
  geom_point() + 
  facet_wrap(~whether_complete)

#interaction in linear model
model3c <- lm(happiness ~ 1 + season + health * whether_complete, data = couchto5k)

#assumption check
par(mfrow = c(2,2))
plot(model3c, which=1:4)

#interpretation&model evaluation
summary(model3c)
anova(model3c)

#95% confidence interval of coefficient 
confint(model3c, level = 0.95)

#visualise the interaction effect
library(sjPlot)
plot_model(model3c, type="int")



```

## Question 3d
From the analysis above, we can conclude that season, health, model completion, and the interaction between health and model completion jointly influence the happiness of participants. For participants who were interviewed in the same season and did not complete the programme, as they feel more of acting healthily, their happiness level decreased. For participants who were interviewed in the same season and completed the programme, as they feel more of acting healthily, their happiness level increased. This indicated that for participants who were interviewed in the same season, feeling of acting healthily benefited the happiness of participants who completed the programme, whereas feeling of acting healthily may not benefit the happiness of participants who did not complete.

# Question 4

```{r q4}
#subset of the data
couchto5k2<-couchto5k%>% 
  filter(whether_complete == "yes")

#grouping
cdata.means <- aggregate(x=couchto5k2$happiness, by=list(couchto5k2$city,couchto5k2$season),mean)
cdata.means

#rename the variable
cdata.means<-cdata.means %>%
  mutate(city=Group.1)
cdata.means<-cdata.means %>%
  mutate(season=Group.2)
cdata.means<-cdata.means %>%
  mutate(average_happiness=x)


#plot
Plot.4<-ggplot(data=cdata.means, aes(x=season, y=average_happiness, group=city))+
  geom_point(size=2, aes(color=city))+
  ylab("Happiness")+
  xlab("Season")+
  ggtitle("average happiness ratings grouped by season and city")+
  theme_bw()+
  theme(text = element_text(size=12),
        legend.text = element_text(size=12),
        legend.direction = "horizontal",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position="top")
Plot.4


```


# Question 5

## Question 5a

```{r q5a}

#model selection
model5a0 <- glm(whether_complete ~ 1 + age + selfmot + health + accountability + season + city, data = couchto5k, family="binomial")
library (MASS)
fit_AIC=stepAIC(model5a0)


#new model
model5a1 <- glm(whether_complete ~ 1 + age + selfmot + health + season, data = couchto5k, family="binomial")

#model evaluation
anova(model5a1, test="Chisq")
library(pander)
pander(anova(model5a1, test="Chisq"))


```

## Question 5b

```{r q5b}
#Inference for regression coefficients +interpret the coefficient (see w10 tut QA6-7)
summary(model5a1)
exp(coef(model5a1))

#95%predicted values
sigma(model5a1)

#95% confidence interval of coefficient (w10 tut QC5)
confint(model5a1)
exp(confint(model5a1))




```

## Question 5c

```{r q5c}
couchto5k<-couchto5k %>%
  mutate(
    whether_complete01 = ifelse(whether_complete=="no",1,0))
couchto5k %>% ggplot(aes(x=selfmot,y=whether_complete01)) +
  ylab("p(quitting)") +
  geom_jitter(size=3,width=0,height=.2,alpha=.1) +
  geom_smooth(method="glm",method.args=list(family=binomial)) +
  scale_y_continuous(breaks=seq(0,1,by=.2))

```










