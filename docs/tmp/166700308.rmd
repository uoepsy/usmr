---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  word_document: default
  html_document: default
params:
  examnumber: B195882
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
if (!require(tidyverse)) install.packages(tidyverse)
library(tidyverse)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document.
if (!require(stats)) install.packages(stats)
library(stats)

couchto5k$age[couchto5k$age>100] <- NA
couchto5k$age[couchto5k$age<0] <- NA
couchto5k$selfmot[couchto5k$selfmot<5] <- NA
couchto5k$selfmot[couchto5k$selfmot>35] <- NA
couchto5k$week_stopped[couchto5k$week_stopped>9] <- NA
couchto5k$week_stopped[couchto5k$week_stopped<0] <- NA
couchto5k$season = gsub("autunm","autumn",couchto5k$season)

summary(couchto5k)

```

```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 
# 139 participants from Edinburgh or Glasgow aged 18-60
# 

couchto5k <- na.omit(couchto5k)

```
This is a statistics report on the results of Couch to 5k programme. 

There are 8 observational units in the database, which are age, psychometric measure of accountability, psychometric measure of self-motivation, mini-test health measure, happiness (on the 0-100 scale), season when the programme was started, city and the week when the person gave up or completed the programme.

The initial database also contains an ID graph, which is not used in the analysis. 

# Question 1 

## Question 1a
An earlier survey reported that 45% of participants left the programme before week 5, and 10% gave up before the end of the programme. The chi-square goodness of fit test is used to compare the observed proportions to the results of the earlier survey. The null hypothesis here is: the values in the current data sample are similar to those in the earlier sample. As the calculated p-value is considerably higher than conventional 0.05, we fail to reject the null hypothesis. The proportions in the current sample are in line with the assumption.
```{r q1a}

par(mfrow=c(2,2))
hist(couchto5k$age, main = "Age", xlab = "Age")
hist(couchto5k$health, main = "Health", xlab = "Health")
barplot(table(couchto5k$season), main = "Season", xlab = "Season")
pie(table(couchto5k$city), main = "City")

completed <- couchto5k$week_stopped[couchto5k$week_stopped==9]
stop_before_wk5 <- couchto5k$week_stopped[couchto5k$week_stopped<=5]
stop_after_wk5 <-couchto5k$week_stopped[couchto5k$week_stopped>5 & couchto5k$week_stopped<9]
chisq.test(x=c(length(stop_before_wk5), length(stop_after_wk5), length(completed)), p=c(0.45, 0.1, 0.45))
```

## Question 1b
Two vectors of frequencies for different cities (Edinburgh and Glasgo) were compared using a chi-squared test of independence. The null hypothesis suggests that attrition rates from the cities are approximately equal. High p-value indicates that the null should not be rejected. The patterns of attrition are indeed very close.
```{r q1b}

completed_Glasgow <- couchto5k$week_stopped[couchto5k$week_stopped==9 & couchto5k$city=="Glasgow"]
completed_Edinburgh <- couchto5k$week_stopped[couchto5k$week_stopped==9 & couchto5k$city=="Edinburgh"]
stop_before_wk5_Glasgow <- couchto5k$week_stopped[couchto5k$week_stopped<=5 & couchto5k$city=="Glasgow"]
stop_before_wk5_Edinburgh <- couchto5k$week_stopped[couchto5k$week_stopped<=5 & couchto5k$city=="Edinburgh"]
stop_after_wk5_Glasgow <- couchto5k$week_stopped[couchto5k$week_stopped>5 & couchto5k$week_stopped<9 & couchto5k$city=="Glasgow"]
stop_after_wk5_Edinburgh <- couchto5k$week_stopped[couchto5k$week_stopped>5 & couchto5k$week_stopped<9 & couchto5k$city=="Edinburgh"]

chisq.test(c(length(stop_before_wk5_Glasgow), length(stop_after_wk5_Glasgow), length(completed_Glasgow)), c(length(stop_before_wk5_Edinburgh), length(stop_after_wk5_Edinburgh), length(completed_Edinburgh)))

```

## Question 1c

Mean age of those commenced the programme in Glasgow is 33.3 years.
Mean age of those commenced the programme in Edinburgh is 41.1 years.
The results of two sample unpaired two-sided t-test with unequal variances returns 
p-value of 0.001, suggesting that there is a significant difference in ages among
those took part in the programme in different cities.

```{r q1c}

age_Glasgow <- couchto5k$age[couchto5k$city=="Glasgow"]
age_Edinburgh <- couchto5k$age[couchto5k$city=="Edinburgh"]

t.test(age_Glasgow, age_Edinburgh, alternative = "two.sided", var.equal = FALSE)

```

# Question 2

## Question 2a
Application of one way anova returns a high p-value of 0.43 that suggests that the null hypothesis of
equal means in the groups should not be rejected. There is no evidence that there is a difference in happiness
ratings in different seasons.
```{r q2a}

oneway.test(happiness ~ season, data = couchto5k, var.equal = TRUE)
# this one claims the same results
anova(lm(happiness ~ season, data = couchto5k))

```

## Question 2b
We regress happiness on age, and get a high p-value = 0.30 of the F-test for 
this model. We fail to reject the null that suggests that the age has no effect 
on happiness.

An attempt to include factors age and season together in the model also results in
a regression equation which is not statistically significant.

Adding an interaction term into the model, we get a statistically significant equation.

```{r q2b}

summary(lm(happiness ~ season, data = couchto5k))

reg1 = lm(happiness ~ age, data = couchto5k)
summary(reg1)

reg2 = lm(happiness ~ season + age, data = couchto5k)
summary(reg2)

reg3 = lm(happiness ~ season + age + age*season, data = couchto5k)
summary(reg3)

```

## Question 2c

As only one of the constructed models is signficant, we will use
it as a baseline. So, the baseline is the model with age, season and interaction term.
```{r q2c}

summary(reg3)

```

# Question 3

## Question 3a
We generate a dummy variable completed.
Having added this new variable into the equation, we saw that the coefficient
on the new variable is not significant.
```{r q3a}

couchto5k$completed = (couchto5k$week_stopped == 9)
reg4 = lm(happiness ~ season + age + age*season + completed, data = couchto5k)
summary(reg4)

```

## Question 3b
Adding health variable makes the coefficient on the variable "completed" statistically significant and positive. The respondents who have completed the course programme are
happier, ceteris paribus.
```{r q3b}
reg5 = lm(happiness ~ season + age + age*season + completed + health, data = couchto5k)
summary(reg5)
```

## Question 3c
After adding week_stopped and an interaction term health*week_stopped into the equation,
we see a substantial improvement of R-squared and highly significant coefficients on health, 
week_stopped and an interaction term health*week_stopped.

Low p-value of 1.3e-08 on the interaction term and the fact that estimate of 
the coefficient is strictly positive indicates the increased effect of the health metric
on those participants who stopped later.
```{r q3c}

reg6 = lm(happiness ~ season + age + age*season + completed + health + week_stopped + health*week_stopped, data = couchto5k)
summary(reg6)

```

## Question 3d

The most significant factors affecting the happiness are age, health and 
the interaction term between these two variables.



# Question 4

```{r q4}

new_data = data.frame(couchto5k[which(couchto5k$completed == 1), ])

ggplot(new_data, aes(fill=season, y=happiness, x=city)) + 
    geom_bar(position="dodge", stat="identity")



```


# Question 5

## Question 5a
We will use a logistic regression for predicting the probability of dropping out.
We use happiness and self motivation as predictors.
```{r q5a}

couchto5k$dropout = !(couchto5k$completed)
mylogit <- glm(dropout ~ happiness + selfmot, data = couchto5k, family = "binomial")

```

## Question 5b
The estimated equation is $ln\frac{P(dropped \; out)}{P(not \; dropped \; out)} = 4.14  + 0.00115happiness - 0.2676selfmot$

or equivalently

$P(dropped \; out) =\frac{1}{1+e^{-(4.14  + 0.00115happiness - 0.2676selfmot)}}$.

Only the coefficient on self-motivation is statistcally significant and negative.
As could be expected, people with higher levels of self-motivation tend not to drop out of the programme.

```{r q5b}

summary(mylogit)

```

## Question 5c

```{r q5c}
b0 = mylogit$coefficients[1]
b1 = mylogit$coefficients[2]
b2 = mylogit$coefficients[3]

par(mfrow=c(1,1))

curve(1/(1+exp(-(b0+b1*mean(couchto5k$happiness) + b2*x))), from=1, to=50, , xlab="selfmotivation", ylab="Probability of dropping out")

```
We see that the probability of dropping out diminishes as self motivation grows.

