---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
  word_document: default
params:
  examnumber:B174533
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(patchwork)
library(knitr)
library(psych)
library(sjPlot)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 

# clean impossible values and set as NA
summary(couchto5k)

couchto5k <- couchto5k %>% mutate(
  selfmot=ifelse(selfmot>35|selfmot<7, NA, selfmot),
  week_stopped=ifelse(week_stopped<1|week_stopped>9,NA,week_stopped)
)

# find the outliers and set as NA
outliers <- function(obs, x = 3){
  abs(obs - mean(obs, na.rm=TRUE)) > (x * sd(obs, na.rm=TRUE))
}
couchto5k$accountability[outliers(couchto5k$accountability)]<-NA
couchto5k$selfmot[outliers(couchto5k$selfmot)]<-NA
couchto5k$health[outliers(couchto5k$health)]<-NA
couchto5k$happiness[outliers(couchto5k$happiness)]<-NA
couchto5k$age[outliers(couchto5k$age)]<-NA

# exclude the NA
couchto5k <- couchto5k %>% filter(!is.na(selfmot)) %>% filter(!is.na(week_stopped)) %>% filter(!is.na(age)) 

```
Data was obtained from https://uoepsy.github.io/data/usmr_2122_data.R, a dataset containing information on 123 participants with 9 variables: pptID, season, city, age, accountability, self-motivation, health, happiness and week-stopped. Accountability and self-motivation are measured on 5-item scales, and each item is scored 1-7. The scores of multi-test health measure and happiness range from 0-100. 

All participant data was complete. However, the min self-motivation score is -99 and the max week-stopped score is 12, which are impossible because the psychometric measure of self-motivation cannot be negative, and the programme only lasts for 9 weeks. Therefore, entries smaller than 7 or larger than 35 in selfmot and entries smaller than 1 and larger than 9 in week_stopped are changed to be NA.

Then the outliers () function is written to identify the outliers which are observations more than 3 standard deviations away from the mean. And two outliers, 100 and 123, are identified in age variable. Considering the fact that the oldest person alive today in the world is 118 years old and 123 and 100 are 5.42 and 3.93 standard deviations away from the mean respectively, these two outliers are replaced with NA. Finally, the NAs are excluded from later analysis, with `r nrow(couchto5k)` participants remaining in the dataset.


```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown.
describe(couchto5k)

p1 <- couchto5k %>% ggplot(aes(x=accountability))+
  geom_density()+
  geom_boxplot(width=0.01) +
  labs(x="accountability score")
p2 <- couchto5k %>% ggplot(aes(x=selfmot))+
  geom_density()+
  geom_boxplot(width=0.02)+
  labs(x="self-motivation score")
p3 <-couchto5k %>% ggplot(aes(x=health))+
  geom_density()+
  geom_boxplot(width=0.005)+
  labs(x="health measure score")
p4 <-couchto5k %>% ggplot(aes(x=happiness))+
  geom_density()+
  geom_boxplot(width=0.001)+
  labs(x="simple happiness scale score")
p1|p2
p3|p4

```

Figure 1-4. The marginal distribution of scores on accountability, self-motivation, health and happiness.

The marginal distribution of scores on accountability (Figure 1) is unimodal with a mean of approximately `r mean(couchto5k$accountability)`. There is variation in accountability (SD = `r sd(couchto5k$accountability)`). 

The marginal distribution of scores on self-motivation (Figure 2) is unimodal with a mean of approximately `r mean(couchto5k$selfmot)`. There is variation in self-motivation (SD = `r sd(couchto5k$selfmot)`). 

The marginal distribution of scores on health is unimodal (Figure 3) with a mean of approximately `r mean(couchto5k$health)`. There is variation in health (SD = `r sd(couchto5k$health)`). 

The marginal distribution of scores on happiness (Figure 4) is unimodal with a mean of approximately `r mean(couchto5k$happiness)`. There is variation in happiness (SD = `r sd(couchto5k$happiness)`). 


# Question 1 

## Question 1a

```{r q1a}
couchto5k <- couchto5k %>% mutate(
  status = week_stopped
)
couchto5k$status[couchto5k$week_stopped<5] <-1
couchto5k$status[couchto5k$week_stopped>4 & couchto5k$week_stopped<9] <-2
couchto5k$status[couchto5k$week_stopped==9] <-3
couchto5k$status <- as.factor(couchto5k$status)

a<- chisq.test(table(couchto5k$status), p = c(0.45,0.1,0.45))

```

A new variable status is created and values of week_stopped variable are mapped in this new variable as three categories. There are `r table(couchto5k$status)[1]` participants quit before week 5, `r table(couchto5k$status)[2]` participants quit after week 5 and `r table(couchto5k$status)[3]` participants complete the programme.

Then, a chi-square goodness-of-fit test is applied since status is a categorical variable and the observed sample counts in three categories. The null hypothesis is that the proportions of participants giving up the programme before week 5, giving up after week 5 and finishing the programme are in line with 45%, 10% and 45% respectively. The result of chi-square test shows that the data in this sample is in line with data from the earlier survey (χ2= `r a$statistic`, df = `r a$parameter`, p = `r a$p.value`). 

## Question 1b

```{r q1b}
couchto5k %>% ggplot(aes(x=status))+
  geom_bar()+facet_wrap(~city)+
  labs(y="The number of participation",x="Stopped before week 5, after week 5, and completed")

status_city <-table(couchto5k$city,couchto5k$status)
b<-chisq.test(table(couchto5k$city,couchto5k$status))

```

Figure 5. The distribution of participants stopped before week 5, after week 5 and completed in Edinburgh and Glasgow.

The number of participants quitting before week 5, quitting before week 9 and completing the programme  are `r status_city[1,1]`, `r status_city[1,2]` and `r status_city[1,3]` in Edinburgh; `r status_city[2,1]`, `r status_city[2,2]` and `r status_city[2,3]` in Glasgow. The chi-square test is conducted to examine whether the patterns of attrition rates differ by city. The result shows that we cannot refuse the null hypothesis (χ2= `r b$statistic`, df =`r b$parameter`, p-value = `r b$p.value`), which means that the patterns of attrition rates does not differ by city.


## Question 1c

```{r q1c}

couchto5k %>% ggplot(aes(x=age,y=city))+
  geom_boxplot() +
  labs(x="Age of participant", y="City")
c<- shapiro.test(couchto5k$age[couchto5k$city=="Edinburgh"])
d<- shapiro.test(couchto5k$age[couchto5k$city=="Glasgow"])
couchto5k$city <- as.factor(couchto5k$city)

#with(couchto5k, var.test(age ~ city))
e<-var.test(couchto5k$age ~couchto5k$city)
f<-t.test(couchto5k$age ~couchto5k$city)

#sd(couchto5k$age[couchto5k$city=="Edinburgh"])
#sd(couchto5k$age[couchto5k$city=="Glasgow"])
```

Figure 6. The age of participants who commenced the programme in Edinburgh and Glasgow.

An independent samples t-test is conducted to assess whether the average age of participants who commenced the programme differ by city.

The assumptions are checked before conducting the t-test. First, the sample data arise from independent random samples from two populations in Edinburgh and Glasgow. Second, the Shapiro-Wilk normality test shows that ages variable is not normally distributed in Edinburgh’s samples (W = `r c$statistic`, p = `r c$p.value`) and normally distributed in Glasgow’s samples (W = `r d$statistic`, p = `r d$p.value`). Finally, F test is conducted to compare two variances between the population. And the results show that age has the equal variance in Edinburgh and Glasgow samples (F (`r e$parameter[1]`,`r e$parameter[2]`) = `r e$statistic`, p= `r e$p.value`).

T-test shows that participants who commenced the programme from Edinburgh (M = `r f$estimate[1]`, SD =`r sd(couchto5k$age[couchto5k$city=="Edinburgh"])`) are significantly older (t (77) = `r f$statistic`, p < 0.001, `r f$alternative`) than participants from Glasgow (M = `r f$estimate[2]`, SD =`r sd(couchto5k$age[couchto5k$city=="Glasgow"])`).

# Question 2

## Question 2a

```{r q2a}
couchto5k$season[couchto5k$season[]=="autunm"]<-"autumn"

q2a1<-ggplot(couchto5k, aes(x=season,y=happiness))+
  geom_boxplot()+
  labs(x="Season", y="Simple happiness scale score")
q2a2<-ggplot(couchto5k,aes(x=season,y=happiness))+
  geom_point()+
  labs(x="Season", y="Simple happiness scale score")

q2a1|q2a2
#mean(couchto5k$happiness[couchto5k$season=="autumn"])

hap_season<- lm(happiness ~ 1+ season, couchto5k)
#summary(hap_season)
#sigma(hap_season)
```

Figure 7. The simple happiness scale score of participants in four seasons

The misspelling “autunm” in some entries was firstly corrected before the data analysis. The relationship between happiness and season is plotted with a boxplot and with individual points. The graphs shows that the happiness rating seems to be higher in spring compared to other season. A simple linear model (Formula 1) is fitted to explore how season (independent variable) affects happiness rating (dependent variable).

happiness = b0+ b1 season + ϵ    (Formula 1)

The estimated average happiness rating  is `r hap_season$coefficients[1]` in autumn, `r hap_season$coefficients[1]+hap_season$coefficients[2]` in spring, `r hap_season$coefficients[1]+hap_season$coefficients[3]` in summer and `r hap_season$coefficients[1]+hap_season$coefficients[4]` in winter. The happiness rating is significant different  between spring and autumn (t (`r hap_season$df.residual`) =2.75, SE=9.775, p=0.007). Those who are interviewed in spring score on average `r hap_season$coefficients[2]` higher on happiness level compared to those who are interviewed in autumn

## Question 2b

```{r q2b}
couchto5k %>% ggplot(aes(x=age,y=happiness))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(x="Age of participants", y="Simple happiness scale score")
full_model<- lm(happiness ~ 1+ season +age +city, couchto5k)
#summary(full_model)

```

Figure 8. The ralationship between the age of participants and their simple happiness scale score

A Scatterplot is plotted to display the relationship between age and happiness rating. The correlation between them is relatively small (r = `r cor(couchto5k$age,couchto5k$happiness)`). According to the (2a), season has effects on the happiness rating, so the effects of season and other confounders are controlled in the multiple regression model (Formula 2). 

happiness =b0+ b1 season +b2 age +b3 city+ ϵ   (Formula 2)

The results show that age is not a significant predictor of happiness rating (t (`r full_model$df.residual`) =0.49, SE=0.237, p=0.625), and the city is not a significant predictor of happiness rating (t (`r full_model$df.residual`) =-1.57, SE=6.311, p=0.118). Therefore, happiness is not affected by age after the effects of season are controlled.

## Question 2c

```{r q2c}
null_model<-lm(happiness ~ 1, couchto5k)

#an incremental F-test
g<-anova(null_model,hap_season,full_model)
g
#the baseline model
baseline_m <- lm(happiness ~ 1+ season, couchto5k)
#summary(baseline_m)

```

Because researchers are interested in the psychological factors that make people continue the programme and the effects of taking the programme on health and wellbeing, the effect of season, age, and city that are not of primary interest are explored firstly with Formula 2. The results from Question 2b show that age and city are not significant predictors of happiness, so they are removed from the linear model. Season is kept in the linear model because it has a significant effect on happiness (Formula 1). The null model is also fitted. A model comparison between Formula 1, the null model and full model (Formula 2) is performed using an incremental F-test.

happiness = b0+ b1 season + ϵ                  (Formula 1)

happiness =b0+ b1 season +b2 age +b3 city+ ϵ   (Formula 2)

Results show that the additional predictor in Formula 1 provide a better fitting model, in that season explain a significant amount of variance in happiness scores (F(`r g$Df[2]`,`r g$Res.Df[2]`) =`r g$F[2]`, p=0.003). However, the additional predictors, age and city in Formula 2, do not provide a better fitting model (F(`r g$Df[3]`,`r g$Res.Df[3]`) =`r g$F[3]`, p=0.188). Therefore, Formula 1 is used as the baseline model. Also, according to R-squared coefficient, approximately `r summary(baseline_m)$r.sq *100`% of the total variability in happiness is explained by the linear association with season in Formula 1. In sum, season is an effective predictor of happiness and should be included in the baseline model. 


# Question 3

## Question 3a

```{r q3a}
couchto5k %>% ggplot(aes(x=week_stopped,y=happiness))+
  geom_point()+
  labs(x="Week of participation",y="Simple happiness scale score")+
  geom_smooth(method = "lm")
# cor(couchto5k$happiness,couchto5k$week_stopped)

hap_completion <- lm(happiness ~ 1+ season +week_stopped, couchto5k)
#summary(hap_completion)
```

Figure 9. The relationship between week of participation and simple happiness scale score

The marginal distributions of happiness and week_stopped are visualised and described in question 0. Plot of the marginal relationship between the happiness and weeks of participation is produced here and the correlation between variables is `r cor(couchto5k$happiness,couchto5k$week_stopped)`. Then multiple regression model is fit by Formula 3.

happiness = b0+ b1 season + b2 week_stopped + ϵ      (Formula 3)

There is a positive linear relationship between week of participation and the simple happiness scale score. The coefficient `r hap_completion$coefficients[5]` of week of participant says that those who have one additional week of participation tend to, on average, score `r hap_completion$coefficients[5]` higher on the simple happiness scale (t (`r hap_completion$df.residual`)=3.22, SE=1.21, p=0.002) when holding the effect of season constant. Therefore, participants’ happiness ratings affected by their completion of the programme.

## Question 3b

```{r q3b}
couchto5k %>% ggplot(aes(x=health,y=happiness))+
  geom_point()+
  labs(x="Health measure score",y="Simple happiness scale score")+
  geom_smooth(method = "lm")
#cor(couchto5k$happiness,couchto5k$health)

hap_comp_heal <- lm(happiness ~ 1+ season +week_stopped +health, couchto5k)
#summary(hap_comp_heal)
```

Figure 10. The relationship between health measure score and simple happiness scale score

The marginal distribution of health is visualised and described in question 0. Plot of the marginal relationship between the happiness and health is produced here and the correlation between variables is `r cor(couchto5k$happiness,couchto5k$health)`. Then multiple regression model is fit by Formula 4.

happiness = b0+ b1 season + b2 week_stopped + b3 health +ϵ      (Formula 4)

There is a negative linear relationship between multi-test health measure score and the simple happiness scale score for the participants in the sample. The coefficient `r hap_comp_heal$coefficients[6]` of health score says that those who have one unit increase in health tend to, on average, score `r hap_comp_heal$coefficients[6]`lower on the simple happiness scale (t (112) = -2.09, SE = 0.268, p = 0.039) when holding the effect of season and week of participation constant. Therefore, happiness is additionally affected by the health metric.


## Question 3c

```{r q3c}
couchto5k %>% 
  select(week_stopped,health,happiness)%>%
  cor%>%
  kable

interact_m <- lm(happiness ~ 1+ season +week_stopped *health, couchto5k)
#summary(interact_m)
```

To test whether the effects of good health are amplified by the feeling of acting healthily (i.e., how many weeks participants completed), we need to look at the interactions between them. The marginal distribution of health, week_stopped and happiness and the marginal relationship between these variables are showed before. The model with interaction effect is fitted below (Formula 5).

happiness = b0+ b1 season + b2 week_stopped + b3 health + b4 (week_stopped* health) + ϵ                                    (Formula 5)

Results show that one unit increase in week of participation is associated with a decrease of `r -interact_m$coefficients[5]`  in happiness (t (111) =-3.30, p=0.001) when holding the effect of season constant and one unit increase in health is associated with a decrease of `r -interact_m$coefficients[6]` in happiness (t (111) =-4.84, p<0.001) when holding the effect of season constant. And for every increase of one week participation, the change in happiness associated with one increase unit health is adjusted by `r interact_m$coefficients[7]` (t (111) =4.30, p<0.001) when holding the effect of season constant. Therefore, it is true that the happiness of participants who got further along the programme might be more affected by the health metric than that of those who stopped earlier. 


## Question 3d

Two independent variables, the week of participant and health, affects happiness of the participants. There is a positive linear relationship between week of participation and the simple happiness scale score for the participants in the sample. Participants who have one additional week of participation tend to, on average, score 3.826 (t (112)=3.45, SE=1.109, p<0.001) higher on the simple happiness scale when holding the effect of season constant.

There is a negative linear relationship between multi-test health measure score and the simple happiness scale score for the participants in the sample. Participants who have one unit increase in health tend to, on average, score 0.561 (t (112) = -2.09, SE = 0.268, p = 0.039) lower on the simple happiness scale when holding the effect of season and week of participation constant. 

There is also an interaction effect of health and week of participation on happiness. For every increase of one week participation, the change in happiness associated with one increase unit health is adjusted by 0.316 (t (111) =4.30, SE=0.073, p<0.001) when holding the effect of season constant. Therefore, the happiness of participants who got further along the programme might be more affected by the health metric than that of those who stopped earlier. 


# Question 4

```{r q4}
couchto5k2<- couchto5k %>% filter(week_stopped==9)
#describe(couchto5k2)
couchto5k2 %>% ggplot(aes(x=season,y=happiness))+
  geom_boxplot()+facet_wrap(~city)+
  labs(x = "Season participants interviewed in", 
       y = "Simple happiness scale score")

```

Figure 11. The average simple happiness scale score in four seasons for participants in Edinburgh and Glasgow

A subset of the data is created including only those participants who completed the programme using filter () function with condition “week_stopped==9”. Then, a plot of the average happiness ratings grouped by season and city is created.

# Question 5

## Question 5a

```{r q5a}
couchto5k <- couchto5k %>% 
  mutate(
  drop_out = ifelse(week_stopped==9,0,1)
)

q5a1 <- couchto5k %>% ggplot(aes(x=age,y=drop_out))+
  geom_point()+
  geom_smooth(method="lm")+
  labs(x = "Age",y = "The probability of dropping out")
q5a2 <- couchto5k %>%
  ggplot(aes(x=accountability,y=drop_out))+
  geom_point()+
  geom_smooth(method="lm")+
  labs(x = "Accountability score",y = "The probability of dropping out")
q5a3 <- couchto5k %>% ggplot(aes(x=selfmot,y=drop_out))+
  geom_point()+
  geom_smooth(method="lm")+
  labs(x = "Self-motivation score",y = "The probability of dropping out")

q5a1|q5a2|q5a3

couchto5k %>% ggplot(aes(x=drop_out))+
  geom_bar()+
  facet_wrap(~city)+
  labs(y = "Dropping out counts")
couchto5k %>% ggplot(aes(x=drop_out))+
  geom_bar()+
  facet_wrap(~season)+
  labs(y = "Dropping out counts")


m1<-glm(drop_out ~ selfmot +accountability +age +city +season,family = "binomial", data = couchto5k )
#summary(m1)

mdrop_out<-glm(drop_out ~ selfmot +season ,family = "binomial", data = couchto5k )
#summary(mdrop_out)

h<-anova(m1,mdrop_out)

```

The outcome dropping out is binary, so a new variable drop_out is created. And 1 is assigned to drop_out if week_stopped is less than 9, which means the participant dropped out. 0 is assigned to drop_out if week_stopped is equal to 9, which means the participant finished the programme. 

Then, the relationships between the dropping out and age, season, accountability, self-motivation, city are plotted separately. Whether or nor participants dropped out the programme is modelled using logistic regression, with age, season, accountability, self-motivation, city.

Results show that season and self-motivation are significant predictor for dropping out, so they are kept in the model. There is a decrease of `r -h$Deviance[2]` deviance in the later model compared to the former full model, illustrating the model does not have a better fit with more predictors. Therefore, the final model (Formula 6) that predicts the likelihood of dropping out would have season and self-motivation as predictors.

dropping out = b0 + b1 self-motivation +b2 season + ϵ      (Formula 6)

## Question 5b

```{r q5b}

```

Results show that self-motivation and season have significant effects on quitting. There is a negative linear relationship between self-motivation score and quitting out for the participants in the sample. With one unit increase in self-motivation score, the log-odds decrease by `r -mdrop_out$coefficients[2]` (z =-3.44, SE = 0.099, p < 0.001) and the probability of quitting decrease by 0.585 on average when holding the effect of season constant. There is a positive linear relationship between season participants were interviewed in and quitting outcome. Participants who were interviewed in spring tend to, on average, have an increase of `r mdrop_out$coefficients[3]` (z =3.7, SE = 0.957, p < 0.001) in the log-odds of quitting when holding the effect of self-motivation score constant. In conclusion, self-motivation and season predict the likelihood of dropping out.

## Question 5c

```{r q5c}
quit_selfmot<-glm(drop_out ~ selfmot ,family = "binomial", data = couchto5k )

couchto5k <-couchto5k %>% mutate(
  predprobs = predict(quit_selfmot,couchto5k, type="response"),
)

couchto5k %>% ggplot(aes(x=selfmot,y=predprobs))+
  geom_line()+
  labs(x="self-motivation score",y="predicted probability of quitting")
```

Figure 12. The probability of quitting with different self-motivation score.

We should first calculate the probability of quitting based on the log-odds and then plot it in a graph.








