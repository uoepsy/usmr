---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
  pdf_document: default
params:
  examnumber: "B192563"
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(patchwork)
library(psych)
library(pander)
library(broom)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Neither output nor code from this chunk will be shown in the compiled document. 
couchto5k$age[50]<-NA
couchto5k$age[55]<-NA
couchto5k$selfmot[14]<-NA
couchto5k$selfmot[119]<-NA
couchto5k["season"][couchto5k["season"] == "autunm"] <- "autumn"
couchto5k=couchto5k[-c(118),]
cor.test(couchto5k$accountability, couchto5k$week_stopped)
cor.test(couchto5k$selfmot, couchto5k$week_stopped)

```
The data set named "couchto5k" was obtained from "https://uoepsy.github.io/data/usmr_2122_data.R". It contains information on 126 participants. The data collected includes the participants' age, the city they were recruited in, the season in which they were interviewed and the week they stopped the programme. The data set also contains the participants' scores on a psychometric measure of accountability and a psychometric measure of self-motivation (both test have 5 questions, and each question is scored between 1-7 such that the lowest score can be 5 and highest can be 35), as well as the participants' measure of self-reported happiness (a score between 0-100), and a score representing a measure of their health (a score between 0-100). 
The data set collected was reviewed,and impossible values were removed. Values "156" and "113" were removed under the column "age". 2 values of "-99" had to be removed from the column "selfmot" (i.e. self-motivation ratings of the participants),and the values "autunm" was corrected to "autumn" in the "season" column. 
Data of the 1 participant was omitted due to incorrect values recorded under the  data column "week_stopped" (i.e. week of programme participant stopped in). This omission brought the data set to 125 participants. 

The first research interest of the study is the psychological factors that make people continue the programme. This means the researchers are interested in the influence of the participants' accountability and self-motivation on the duration of staying on in the programme. A Pearson's product-moment correlation was conducted to test the correlation between participants' accountability and self motivation, with the number of weeks they stayed in the programme. There was no correlation found between the participants' accountability scores and the week in which they stopped the programme (r=0.034, t(123)=0.4, p>0.05). There was a slight positive correlation found between the participants' self-motivation scores and the week in which they stopped the programme (r=0.36, t(121)=4, p<0.05). 

Figure 0(i) and Figure 0(ii) demonstrate duration of participation plotted against accountability and self-motivation respectively.
```{r descriptives}
# Code will not be shown from this chunk (because we set echo = FALSE in the very first chunk)
# the output from this code will be shown. 
ggplot(couchto5k, aes(x=accountability, week_stopped))+
  geom_point() + labs(x = 'accountability', y = 'week stopped') + ggtitle('Figure 0(i): Relationship between Accountability and Duration of participation')
ggplot(couchto5k, aes(x=selfmot, week_stopped))+
  geom_point() + labs(x = 'self-motivation', y = 'week stopped') + ggtitle('Figure 0(ii): Relationship between Self-motivation and Duration of participation')


```
The second research interest of the study is the effects of taking the programme on health and well being. This implies that the researchers are interested in exploring whether the duration of staying in the programme had an effect on the participants' health(measured through a multi-health measure) and well being (measured through the Simple Happiness Scale). Therefore a Pearson's product moment correlation was conducted to test the correlation between participants' health and happiness with and the number of weeks they stayed in the programme.
```{r}
cor.test(couchto5k$health, couchto5k$week_stopped) 
cor.test(couchto5k$happiness, couchto5k$week_stopped)
```

There was no correlation found between the participants' health and their duration of staying in the programme (r=0.04, t(122)=0.4, p>0.05). 
There was a weak positive correlation found between the participants' happiness and their duration of staying in the programme (r=0.17, t(122)=2, p>0.05). 

Figure 0(iii) and Figure 0(iv) demonstrate health and happiness plotted against duration of participation respectively.
```{r}
ggplot(couchto5k, aes(x=week_stopped, health))+
  geom_point() + labs(x = 'week stopped', y = 'health') + ggtitle('Figure 0(iii): Relationship between health and duration of participation')
ggplot(couchto5k, aes(x=week_stopped, happiness))+
  geom_point() + labs(x = 'week stopped', y = 'happiness') + ggtitle('Figure 0(iv): Relationship between happiness and duration of participation')
```

# Question 1 

## Question 1a

```{r q1a}
couchto5k<-couchto5k%>%mutate(week_stopped_level=ifelse(couchto5k$week_stopped<5, "Week 1-4", ifelse(couchto5k$week_stopped==9, "Completed", "Week 5-8")))
table1a<-table(couchto5k$week_stopped_level)
chisq.test(table(couchto5k$week_stopped_level), p = c(.45,.10,.45))
```

The earlier nation wide survey found that 45% of participants abandoned the programme before the halfway point in week 5, and a further 10% gave up before the end of the programme.To test whether the survey's findings are in line with the data in the current data frame, a chi-square goodness of fit test was conducted. A variable was created names "week_stopped_level" that assigned the categorical values of "Week 1-4', "Week 5-8" or "Completed" accordingly to when the dropped out of the programme. The chi-square goodness of fit test  showed that the current data strongly reflects the trend of the general population as presented in the nationwide survey (χ2 (2, n=125) = 171, p <.001.) 
Table 1(a) shows the number of participants who dropped before the halfway point, after the halfway point and who completed.
```{r}
table1a %>% pander(caption = "Table 1(a)")
```


## Question 1b

```{r q1b}
city_attrition<-couchto5k%>%select(city, week_stopped_level)
city_attrition<-city_attrition%>%arrange(city)
Edinburgh_attrition<-city_attrition[city_attrition$city == "Edinburgh", ]
Glasgow_attrition<-city_attrition[city_attrition$city == "Glasgow", ] 
chisq.test(city_attrition$city, city_attrition$week_stopped_level)
```

A chi-square test of independence was performed to test the independence between the city of the participants and the duration they stayed in the programme. The test showed that the city and the attrition rate of participants were slightly dependent on each other (χ2 (2, n=125) = 6, p=0.06.)

From the graphs titled "Duration of participation in Edinburgh" and "Duration of participation in Glasgow", it can be seen that the completion of the programme was higher in Edinburgh than Glasgow. 52.3 % of participants from Edinburgh completed the programme, while 33.3% of participants from Glasgow completed it. Glasgow saw a higher number of participants dropping out before 5 weeks (58.3 %) than Edinburgh (36.4 %), while Edinburgh saw a higher number of participants drop out after the halfway point (11.3%), compared to Glasgow (8.4%).

```{r}
barplot(table(Edinburgh_attrition$week_stopped_level), main = "Figure 1B(i): Duration of participation in Edinburgh")
barplot(table(Glasgow_attrition$week_stopped_level), main = "Figure 1B(ii): Duration of participation in Glasgow")
```


## Question 1c

```{r q1c}
age_city<-couchto5k%>%select(city, age)
age_city<-age_city%>%arrange(city)
Edinburgh_age<-age_city[age_city$city == "Edinburgh", ]
Edinburgh_age<- Edinburgh_age%>% slice(-c(37, 42))
Glasgow_age<-age_city[age_city$city == "Glasgow", ]
chisq.test(age_city$city, age_city$age)
```
The mean age of participants differ very slightly by city (mean age of participants from Edinburgh = 38.6, mean age of participants from Glasgow = 37.5).A chi-square test of independence was conducted to test the independence between city of the participants and average age of the participants who commenced the programme . While the test showed that there was a dependence between city and age of the participant (χ2 (42, n=125) = 37, p>0.05.) the p-value was greater than 0.05 implying that we cannot reject the null hypothesis (i.e. there is no association between city and age of the participants). 
 
# Question 2

## Question 2a
Figure 2A(i) shows that the distribution of participants' happiness scores is unimodal, and most of the incomes are between 30 and 75. This suggests that there isn't a large amount of variation in the participants' happiness scores. Figure 2A(ii) shows the no. of participants interviewed in each season. We can see that most number of participants were interviewed in Spring. 
```{r q2a}
Happiness_plot <- (ggplot(data = couchto5k, aes(x = happiness)) +
  geom_density() +
  geom_boxplot(width = 1/300) +
  labs(x = "Happiness", 
       y = "Probability density") + ggtitle("Figure 2A(i): Density plot and boxplot of participants' happiness"))
Season_plot <- (ggplot(data = couchto5k, aes(x = season)) +
  geom_bar() +
  labs(x = "Season interviewed in", 
       y = "no. of participants") + ggtitle("Figure 2A (ii): Bar plot of seasons in which the interviews were taken"))
Happiness_plot/Season_plot
```
Figure 2A(iii) shows season-wise happiness ratings.
```{r}
couchto5k %>% ggplot(aes(x = season, y = happiness, colour=season)) + geom_point()+ ggtitle("Figure 2A (iii): Season-wise Happiness ratings") 
```

```{r}
Happiness_Season <- lm(happiness ~ 1 + season, data = couchto5k)
coef(Happiness_Season)
summary(Happiness_Season)
```
A linear regression model (`Happiness_Season <- lm(happiness ~ 1 + season, data = couchto5k)`) was run to test if season the participant was interviewed in predicted their happiness scores. The model found that there is an effect of seasons on happiness outcomes. Spring results in a 7.08 increase in happiness score, Summer results in 20.53 increase in happiness score and Winter results in a 20.25 decrease in happiness score. An F-test for the overall significance of the regression was performed, wherein F(3, 121)=5.31, p<0.05, indicating strong evidence against the null hypothesis that the model is ineffective. This implies that the data provides evidence that season the interview was taken in, is an effective predictor of happiness score.


## Question 2b
Figure 2B(i) shows a boxplot of the participants' Happiness scores according to their ages. The boxplot shows that their ages are widely distributed.
```{r q2b}
ggplot(couchto5k, aes(x = age, y = happiness)) + geom_boxplot() + ggtitle("Figure 2B(i): Boxplot of Happiness score according to age")
```
A Pearson's product moment correlation test was run to check for correlation between participants' age and happiness. The test showed that a correlation does not exist (r = 0.07, t(121) = 0.9, p>0.05). However, p>0.05 implying that there is potentially evidence for the alternative hypothesis (true correlation is not equal to 0) to be true.
```{r}
Happiness_Season_Age<- lm(happiness ~ 1 + season  + age, data = couchto5k)
coef(Happiness_Season_Age)
summary(Happiness_Season_Age)
```
A linear regression model was run (`Happiness_Season_Age<- lm(happiness ~ 1 + season  + age, data = couchto5k)`), to test if age of the participant predicted their happiness scores, accounting for the effect of the season they were interviewed in. The model found that there is a an effect of seasons on happiness outcomes. The model found that the estimated increase in happiness score with one year increase in age is 0.27, accounting for the effect of the seasons the participants' were interviewed. An F-test for the overall significance of the regression was performed, wherein F(4, 118)= 4.32, p<0.05, indicating evidence against the null hypothesis that the model is ineffective. This implies that the data provides evidence that age of the participant does affect happiness.

## Question 2c
The model Happiness_Season will be used as a baseline model for Question 3. The F-test for this model demonstrated good evidence against the model being ineffective. Furthermore, seasons are predicted as a significant predictor of happiness and will need to be accounted for, while testing the relationships between happiness and other variables. The Happiness_Season model takes the form:
Happiness = 31.82 + 5.48 . Spring
Happiness = 31.82 + 17.87 . Summer
Happiness = 31.818 - 26.00 . Winter
```{r q2c}

```

# Question 3

## Question 3a
```{r}
couchto5k <- couchto5k %>% mutate(Completed= ifelse(week_stopped_level == "Completed", "Yes", "No"))
```
Figure 3A(i) shows that completion of the programme is related to a higher level of happiness scores, wherein most of the happiness scores of those who completed the programme fall roughly between 37 and 81, whereas most of the happiness scores of those who did not complete the programme fall roughly between 18 and 63. 

```{r q3a}
ggplot(couchto5k, aes(x = Completed, y = happiness)) + 
  geom_boxplot() + ggtitle("Figure 3A (i): Relationship between Happiness and Completion of the programme")
```
```{r}
Happiness_Completed<- lm(happiness ~ 1 + season + Completed, data = couchto5k)
coef(Happiness_Completed)
summary(Happiness_Completed)
```
A linear regression model was run, to test of completion of the programme predicted their happiness scores, accounting for the effect of the season they were interviewed in (`Happiness_Completed<- lm(happiness ~ 1 + season + Completed, data = couchto5k)`). The model found that there is an effect of programme completion on happiness outcomes. The model found that the estimated increase in happiness score with completion of the programme is 19.6, holding the seasons the participants were interviewed in, as constant. An F-test for the overall significance of the regression was performed, wherein F(4, 120)= 5.96, p<0.001, indicating strong evidence against the null hypothesis that the model is ineffective. This implies that programme completion strongly affects participants' happiness.

## Question 3b
```{r}
Happiness_Health_Completed<- lm(happiness ~ 1 + season + Completed + health, data = couchto5k)
coef(Happiness_Health_Completed)
summary(Happiness_Health_Completed)
```
A linear regression model was run, to test if health metrics of the participants predicted their happiness scores, accounting for the effect of the season they were interviewed in and programme completion (`Happiness_Health_Completed<- lm(happiness ~ 1 + season + Completed + health, data = couchto5k)`). The model found that there is a very negligible effect of health on happiness outcomes. 
The model predicts that there is an estimated decrease of 0.27 in happiness score due to a unit increase in health, accounting for the other variables' effects. An F-test for the overall significance of the regression was performed, wherein F(5, 119)= 4.95, p<0.001, indicating strong evidence against the null hypothesis that the model is ineffective. The model gives a t-statistic for the predictor "health" as t(119) = -0.96, p>0.05. Therefore, the model shows that health is not a significant predictor of happiness. 

## Question 3c
```{r q3c}
couchto5k <- couchto5k %>% mutate(Quit_Early= ifelse(week_stopped_level == "Week 1-4", "Yes", "No"))
```
Figure 3C(i) shows the relationship between quitting the programme early to happiness. The participants who were recorded as quitting early were those who left the programme in the first 4 weeks. The figure shows that there is a relationship between the two variables such that the happiness scores of a significant number of participants who did not quit the programme are at a slightly higher range (32 - 82) than those who did leave the programme early (25 - 62.5). 
```{r}
ggplot(couchto5k, aes(x = Quit_Early, y = happiness)) + 
  geom_boxplot() + ggtitle("Figure 3C (i): Relationship between Happiness and Quitting Early")
```
```{r}
Happiness_Health_Quitting <- lm(happiness ~ 1 + season + + health + Quit_Early, data = couchto5k)
coef(Happiness_Health_Quitting)
summary(Happiness_Health_Quitting)
```
A linear regression model was run, to test if early quitting of the programme affected happiness scores, accounting for the effect of the season they were interviewed in, and health (`Happiness_Health_Quitting <- lm(happiness ~ 1 + season + + health + Quit_Early, data = couchto5k)`). The model found that there is a slight effect of quitting the programme on happiness outcomes. 
The model predicts that quitting the programme early leads to an estimated decrease in happiness score by 17.358. An F-test for the overall significance of the regression was performed, wherein F(5, 119)= 4.12, p<0.05, indicating evidence against the null hypothesis that the model is ineffective. Therefore, the data provides evidence that quitting the programme early slightly affects happiness of the participants.

## Question 3d
Therefore, our linear regression model found a significant relationship between the season the participant was introduced in and quitting the programme, with participants' happiness score (p<0.05). The model estimated that Spring and Summer cause a 19.34 and 19.22 increase in Happiness score, while winter causes a 23.03 decrease in happiness score. The model also estimated that quitting the programme within the first four weeks can result in a 17.26 decrease in Happiness score.

# Question 4
```{r}
couchto5k_completed<-couchto5k[couchto5k$Completed == "Yes", ]
```
A subset of the data labelled "couchto5k_completed" was created, containing the data of only those participants who completed the programme, with the variables "city" and "happiness", as can be seen in Table 2.
```{r q4}
HappinessbySeasonbyCity<-couchto5k_completed%>%select(city, season, happiness)
HappinessbySeasonbyCity%>%pander(caption = "Table 2: Happiness and Season scores")

```
From this subset of data, two further subsets were created for Edinburgh and Glasgow. 
```{r}
HappinessbySeasonEdin<-HappinessbySeasonbyCity[HappinessbySeasonbyCity$city == "Edinburgh",]
HappinessbySeasonGlas<-HappinessbySeasonbyCity[HappinessbySeasonbyCity$city == "Glasgow", ]
```
The data in each these two tables were then arranged according to season, and the mean happiness rating for each season was calculated. The season-wise mean happiness ratings were then plotted for each city, as can be seen in Figure 4(i) and Figure 4(ii).
```{r}
aggregate(.~season, FUN=mean, data=HappinessbySeasonEdin[, -1])
aggregate(.~season, FUN=mean, data=HappinessbySeasonGlas[, -1])
HappinessbySeasonEdinMEAN<-aggregate(.~season, FUN=mean, data=HappinessbySeasonEdin[, -1])
HappinessbySeasonGlasMEAN<- aggregate(.~season, FUN=mean, data=HappinessbySeasonGlas[, -1])
EdinHappiness<-ggplot(data = HappinessbySeasonEdinMEAN, aes(x = season, y = happiness, group = 1)) + geom_point() + geom_line() + labs(x = "Seasons", y = "Average Happiness Ratings") + ggtitle("Figure 4(i): Mean Happiness ratings in Edinburgh") 
GlasHappiness<- ggplot(data = HappinessbySeasonGlasMEAN, aes(x = season, y = happiness, group = 1)) + geom_point() + geom_line() + labs(x = "Seasons", y = "Average Happiness Ratings") + ggtitle("Figure 4(ii): Mean Happiness ratings in Glasgow")
library(patchwork)
EdinHappiness/GlasHappiness
```

# Question 5

## Question 5a

```{r q5a}
couchto5k%>% mutate(Completed = if_else(Completed == "Yes", 1, 0))
couchto5k <- couchto5k %>% mutate(Completed_New = ifelse(Completed == "Yes", 0, 1))
lm(Completed_New ~ selfmot + accountability, data = couchto5k)
glm(Completed_New ~ selfmot + accountability, data = couchto5k, family = "binomial")
DroppingOut<- glm(Completed_New ~ selfmot + accountability, data = couchto5k, family = "binomial")
```
To build a model that predicts likelihood of dropping out, we need to determine predictors of dropping out. Therefore, we can build a linear model with the predictors self-motivation and accountability, as one of the research aims of the study was to examine the psychological factors that make people continue on the programme. The following generalized linear model named "DroppingOut" was built:
`DroppingOut<- glm(Completed_New ~ selfmot + accountability, data = couchto5k, family = "binomial")`
In the above model the dependent variable "Completed_New" was created by assigning those who completed the programme 0, and those who dropped out 1.

## Question 5b
The generalized linear model "DroppingOut" predicted that for every 1 unit increase in self-motivation rating, the odds of dropping out decrease by 0.77, and for every 1 unit increase in accountability rating, the odds of dropping out decrease by 0.99. However, the model predicts that self-motivation is a significantly strong predictor of dropping out (p<0.001), while accountability is not (p.0.05).
```{r q5b}
summary(DroppingOut)
exp(coef(DroppingOut))
```

## Question 5c

```{r q5c}
DroppingOut_Selfmot<-glm(Completed_New ~ selfmot, data = couchto5k, family = "binomial")
summary(DroppingOut_Selfmot)
exp(coef(DroppingOut_Selfmot))
```
A generalized linear model was built to estimate how self motivation affects quitting the programme, excluding accountability (since accountability was not found as a significant predictor of dropping out. The model was built as follows: `DroppingOut_Selfmot<-glm(Completed_New ~ selfmot, data = couchto5k, family = "binomial")`. 
The model found that a unit increase in self motivation increases the probability of quitting by 0.77. 

Figure 5C represents the probability of quitting as a function of self-motivation.
```{r}
selfmotdata <- tibble(selfmot = 5:35)
predict(DroppingOut_Selfmot, newdata = selfmotdata, type = "response")
selfmotdata<- selfmotdata %>% mutate(predprobs = predict(DroppingOut_Selfmot, newdata = selfmotdata, type = "response"))
ggplot(data = selfmotdata, aes(x = selfmot, y = predprobs)) +
  geom_line()+
  labs(x = "Self-motivation", y="predicted probability of dropping out") + ggtitle('Figure 5C: Probability of quitting as a function of self-motivation')
```








