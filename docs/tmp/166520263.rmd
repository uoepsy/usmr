---
title: "USMR 2021-2022 Coursework"
author: "`r params$examnumber`"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    theme: flatly
    toc: yes
    toc_float: yes
  word_document: default
  pdf_document: default
params:
  examnumber: B191355
---

<!-- We have provided a template below with headings/sub-headings for each question/sub-question. This is just a template. Feel free to add or delete code-chunks if desired.  -->
<!-- Beneath here is some code which will set everything up for you.  Anything that is needed to run your code should be explicitly set up below -->

```{r setup, include=FALSE}
# this line will mean that when you compile/knit your document, 
# the code will not show, but the output (e.g., plots) will!
knitr::opts_chunk$set(echo = FALSE)
# this line means all numeric output gets rounded to 3 dp
options(digits=3)
# load any other packages that you require here:
library(tidyverse)
library(psych)
library(knitr)
library(kableExtra)
library(sjPlot)
# This will read in your own personal data:
source("https://uoepsy.github.io/data/usmr_2122_data.R")
```

# Question 0
<!-- If you have run the R code above this point (you can do this now by pressing Ctrl-Shift-Alt-P, or running the chunk above) then your data will be in a dataframe called `couchto5k`. -->


```{r cleaning, include = FALSE}
# Take a first look at the data. 
summary(couchto5k)
# Change the impossible data we spotted into NA.
couchto5k <- couchto5k %>% mutate(
  age = ifelse(age>100, NA, age),
  selfmot = ifelse(selfmot<5, NA, selfmot),
  week_stopped = ifelse(week_stopped>9, NA, week_stopped),
  season = ifelse(season=='autunm', 'autumn', season),
  season = factor(season, levels = c('spring', 'summer', 'autumn', 'winter'))
)
# Take a look again.
summary(couchto5k)
describe(couchto5k)
```
The data set, obtained from https://uoepsy.github.io/data/usmr_2122_data.R,  contains information on 127 participants in the "Couch to 5K" program, including their age, the season they were interviewed in, the city where they were recruited, the week when they stopped the program (Week 9 indicates completion), and the scores for their accountability, self-motivation, health, and happiness.

Regarding the age, two participants were registered as over 110 years old, which is impossible, considering the nature of the program and the fact that the oldest Scottish man passed away at 107 last year. After these two values were set to NA (not available data), the average age now stands at 38.8, with a standard deviation of 11.92. The youngest participant was 18, and the oldest was 60. As for season and city, most people were interviewed in spring and recruited in Edinburgh, respectively.

Accountability and self-motivation were measured before the program started with 5 questions and each scored 1-7, meaning that scores can range from 5 to 35 (only total scores are available). The former indicator has completed data and no value out of range, while the latter has one NA and an impossible value under 5, which was removed. Both health and happiness were measured on a 0-100 scale and no data are missing or beyond possible ranges. Table \@ref(tab:couchtab) gives the descriptive statistics of the 5 numeric data.

```{r couchtab}
describe(couchto5k[2:6])[,c(2:4,8:9)] %>%
  kable(caption = "Couchto5K descriptive statistics")%>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

# Question 1 

## Question 1a
Concerning the distribution of when the participants stopped the program, we divide them into 3 groups: those who quit before completing week 5, those who quit after week 5, and those who made it till the end. According to an earlier survey, each of these three groups usually had a percentage at 45%, 10%, and 45%, respectively.
```{r stopweek}
# divide groups by stop week
couchto5k <- couchto5k %>% mutate(
  'stop_week' = case_when(
    week_stopped <= 5 ~ 'Week1-5',
    week_stopped > 5 & week_stopped <9 ~ 'Week6-8',
    week_stopped == 9 ~ 'Week9')
)
# Chi-square test
table_a1 <- prop.table(table(couchto5k$stop_week))*100 
chi_a1 <- chisq.test(table(couchto5k$stop_week), p=c(0.45, 0.1, 0.45))
```
Our data shows a pretty similar pattern with the survey (38.9%, 11.9%, and 49.2%, accordingly). By conducting a Chi-square goodness of fit test, we obtained a p-value at `r chi_a1$p.value`, which is much larger than 0.05 (default significance level in this analysis), so our data is indeed in line with the earlier survey's result.

## Question 1b
We are also interested in finding out whether the 3-group attrition rates patterns differ by city. Just by looking at Table \@ref(tab:cityattrition), it seems the tendencies are similar. 
```{r cityattrition}
# divide groups by city
edi_5k <- couchto5k[couchto5k$city == 'Edinburgh',]
gla_5k <- couchto5k[couchto5k$city == 'Glasgow',]
# make a comparison table
Edinburgh <- prop.table(table(edi_5k$stop_week))*100 
Glasgow <- prop.table(table(gla_5k$stop_week))*100
table_1b <- rbind(Edinburgh, Glasgow)
kable(table_1b, align = 'c', caption = 'Attrition Rates(%) in Edinburgh and Glasgow') %>%
  kable_styling(bootstrap_options = "striped", full_width=F)
# Chi-square test
chi_1b <- chisq.test(table_1b)
```
By conducting a Chi-square test of homogeneity, we obtained a p-value at `r chi_1b$p.value`, so there is no significant difference between the two cities' attrition rates.

## Question 1c
```{r}
test_1c <- t.test(edi_5k$age,gla_5k$age)
```
Let's now address whether the participants' average ages differ by city. The number of valid observations, the mean and the standard deviation of age of those in Edinburgh are `r length(na.omit(edi_5k$age))`, `r mean(edi_5k$age, na.rm=TRUE)`, and `r sd(edi_5k$age, na.rm=TRUE)`, while the values of Glasgow are `r length(na.omit(gla_5k$age))`, `r mean(gla_5k$age, na.rm=TRUE)`, and `r sd(gla_5k$age, na.rm=TRUE)`. A t-test of two independent means shows that the p-value stands at `r test_1c$p.value`, so there is no significant difference between the two average ages.

# Question 2

## Question 2a
The happiness ratings vary a lot among the participants. By building a linear model between happiness and season, an obvious outlier is spotted in autumn, which is proved to be highly influential by several methods, including Cook's distance.
```{r outlier, fig.align='center', out.width="70%"}
lm1 <- lm(happiness~season, couchto5k)
# check influence of outlier
plot(lm1, which =4)
# reset outlier
couchto5k$happiness[couchto5k$pptID=='ID56'] <- 25
lm1 <- lm(happiness~season, couchto5k)
```

Considering autumn only has a small number of 5 interviewees, it is better to keep all the data, so the outlier's happiness score was set to the closest normal value 25.

In our linear model now, spring serves as the reference level (intercept). According to the coefficients, the participants in spring have an average happiness score at 52.99. When the season is changed to summer, autumn, or winter, the value decreases 0.43, 40.39, or 29.99, respectively.

## Question 2b

<div align="center">
```{r q2b, message=FALSE, fig.align='center'}
lm2 <- update(lm1, ~ . +age)
tab_model(lm1, lm2, dv.labels = c("Season", "Season+Age"), show.ci = FALSE, title = "(\\#tab:q2b) Comparison of two models")
```
</div>

In order to discover whether adding the age into our model as a predictor would improve the model, an analysis of variance (ANOVA) is conducted. Since R follows the rule of Type 1 sum of squares model, a p-value of F statistic at 0.383 shows that adding age does not improve our model.

## Question 2c
The initial model that only takes seasons as the predictor will be used as our baseline model. As mentioned above, adding age does not affect our model performance, which is proved by several statistics. Besides the p-value, the adjusted R-squared value only increases minimally from 0.114 to 0.118 after the age is added. Also, the Pearson correlation coefficient between happiness and age is merely `r cor(couchto5k$age, couchto5k$happiness, use="complete.obs")`, which can be interpreted as nearly no linear relationship. The equation is:
```{r q2c}
lm_baseline <- update(lm2, ~.-age)
```
$$
\text{Happiness} = 52.99 -0.43 \text{S} -40.39 \text{A} -29.99 \text{W}  + \epsilon  \\
\begin{align}
\text{where} \\
& \text{S = Summer} \\
& \text{A = Autumn} \\
& \text{W = Winter} \\
& \epsilon \sim N(0,\sigma)\ \text{independently}
\end{align}
$$

# Question 3

## Question 3a

```{r q3a, message=FALSE}
# divide groups by completion
couchto5k <- couchto5k %>% mutate(
  completed = ifelse(week_stopped==9,'Yes','No')
)
lm3 <- update(lm_baseline, ~.+completed)
```
Now we split the data into two groups depending on whether the participant completed the program. Then, an ANOVA is performed to figure out whether completing the program or not also influences the happiness ratings building on the baseline model. It turns out that, like age, program completion does not affect happiness, with a large p-value at 0.293.

## Question 3b

```{r q3b, message=FALSE}
lm4 <- update(lm3, ~.+health)
```
We further add health ratings as a predictor, but it is also not correlated with happiness as revealed by an ANOVA. This time the p-value is smaller (0.102), but it is still not significant enough.

## Question 3c
Itâ€™s been hypothesized that the effects of good health are amplified by the feeling of acting healthily, so we would like to check whether the happiness of those who got further along the program was more affected by the health metric than that of those who stopped earlier. The model we have built by now does not show interaction between the two variables of interest. We need to add an interaction term into our model.

<div align="center">
```{r q3c, message=FALSE}
lm5 <- update(lm4, ~.+completed*health)
tab_model(lm_baseline, lm3, lm4, lm5, dv.labels = c("Season", "+Completion", "+Health", "+Completion*Health"), show.ci = FALSE, title = "(\\#tab:q3c) Comparison of four models")
```
</div>
After modifying the model, we find out that the interaction between completion and health metric is present and significant ($p=0.028$). According to the coefficients, holding other predictors constant, for those who did not complete the program, the happiness score would decrease by 0.9 for 1 increase in health score, while for those who completed it, the happiness score would, on the contrary, increase 0.39 in the same condition. 

We can change the binary variable "completed or not" into the numeric variable "how many weeks spent in the program" to further study the interaction. From the changes of slopes and direction in Figure \@ref(fig:interaction2), we can see that the longer the participants stayed in the program, the more positive the relationship between their happiness and health ratings became, which confirms the hypothesis.

```{r interaction2, warning=FALSE, message = FALSE, fig.align='center', fig.cap="Relationship between happiness and health scores based on time spent in the program", out.width="80%"}
lm6 <- lm(happiness ~ season + week_stopped * health, couchto5k)
plot_model(lm6, type = "pred", terms = c("health", "week_stopped[1,5,7,9]")) + 
  scale_y_continuous(limits = c(0, 100)) +
  theme_bw()
```


## Question 3d
Based on the observations above, we can conclude that the season, the week in which they stopped the program, and their health ratings were the main factors that influenced how happy they were. 

Participants interviewed in spring were generally happier, followed by summer, winter, and autumn. How long they spent in the program and how healthy they were had a joint impact on their happiness scores. Those who stayed devoted until later in the program got more positive effects of good health on their well-being. Other factors, such as age, are not correlated with happiness. The final model was fitted to 126 observations, and took the form: 
$$
\text{Happiness} = 155.18 -10.04 \text{S}-48.85 \text{A} -38.84 \text{W}-12.66 \text{T} -1.98 \text{H}   +0.26 \text{(T} \times \text{H)}  + \epsilon  \\
\begin{align}
\text{where} \\
& \text{S = Summer} \\
& \text{A = Autumn} \\
& \text{W = Winter} \\
& \text{T = Stop week} \\
& \text{H = Health rating} \\
& \epsilon \sim N(0,\sigma)\ \text{independently}
\end{align}
$$

# Question 4

```{r hp, fig.align='center', fig.cap="Average happiness ratings grouped by season and city", message = FALSE, out.width="80%"}
# create a subset
completed_5k <- na.omit(couchto5k[couchto5k$completed=='Yes',])
# make a plot
completed_5k%>% 
  group_by(season, city) %>% 
  summarise(mean_hp = mean(happiness)) %>% 
  ggplot(aes(x = season, y = mean_hp, fill = city, group = city)) + 
  geom_bar(position = "dodge", stat = "identity")+
  labs(y = "Average Happiness ratings", color = "City") +
  geom_text(aes(label = round(mean_hp, 2)), size = 3, hjust = 0.5, vjust=-0.5, position =  position_dodge(width = 0.9))+
  theme_bw()
```

Figure \@ref(fig:hp) demonstrates that among the participants who completed the program, those in Glasgow usually had a higher average happiness score in all the seasons.

# Question 5

## Question 5a
Finally, we would like to build a generalized linear model to predict the likelihood of dropping out (at all). We are specifically interested in the psychological factors: accountability and self-motivation, but certainly, other factors also need to be analyzed.
```{r quitglm}
couchto5k <- couchto5k %>% mutate(
  quit = ifelse(completed=='No', 1, 0)
)
glm1 <- glm(quit ~ season+age+city+accountability+selfmot, data = couchto5k, family = "binomial")
glm2 <- glm(quit ~ selfmot, data = couchto5k, family = "binomial")
anova_glm <- anova(glm1, test = "Chisq")
```
An ANOVA reveals that age, city, accountability are non-significant predictors, while season and self-motivation affect a lot whether a participant wants to stay or quit. However, both autumn and winter have samples under 15, which may lead to inaccuracy in maximum likelihood fitting. Thus, the final model only takes self-motivation ratings to predict the likelihood of quitting by:

$$
\text{logit(P(quit))}=1.18-0.08\text{Self-motivation} + \epsilon \\
$$

## Question 5b

```{r q5b}
testdata <- data.frame(selfmot=c(5:35))
testdata$prob <- predict(glm2, newdata=testdata, type="response")
```
Now we can test how the likelihood of quitting the program changes with self-motivation scored from 5 to 35. Our model predicts that the probability of dropping out ranges from 69% to 18%, falling by 1.2 to 2 percentage points for every 1 additional score in self-motivation. 

## Question 5c

```{r q5c, warning=FALSE, message = FALSE, fig.align='center', fig.cap="Relationship between probability of quitting and self-motivation", out.width="70%"}
couchto5k %>% ggplot(aes(x=selfmot,y=quit)) +
  ylab("p(quit)") +
  geom_jitter(size=2,width=0,height=.2,alpha=.1) +
  geom_smooth(method="glm", method.args=list(family="binomial"), fullrange=TRUE) +
  xlim(5, 35) + 
  scale_y_continuous(breaks=seq(0,1,by=.2)) +
  theme_bw()
```










