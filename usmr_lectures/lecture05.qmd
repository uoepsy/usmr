---
title: "Correlations"
---

```{r}
#| label: setup
#| include: false

library(tidyverse)
source('_theme/theme_quarto.R')
```

# Correlation

## Blood Alcohol and Reaction Time

:::: {.columns}

::: {.column width="50%"}
```{r}
#| label: ba
#| fig.asp: 0.6
#| echo: false

set.seed(29)
dat <- faux::rnorm_multi(n=50,
                   mu=c(0.1,650),
                   sd=c(.009,60),
                   r=.4,
                   varnames=c('BloodAlc','RT'))
dat %>% ggplot(aes(x=BloodAlc,y=RT)) +
  xlab("Blood Alcohol %/vol") + ylab("RT (ms)") +
  geom_point(size=3)
```
- data from 100 drivers
- are blood alcohol and RT (linearly) related?

:::

::: {.column width="50%"}
![](img/playmo_car.jpg)

:::

::::


::: notes
- the playmo crew have been out joyriding and were caught in a police speed trap

- the police measured 100 people's blood alcohol and their reaction times

- how would we go about telling whether two variables like this were related?
:::


## A Simplified Case

:::: r-stack

::: {#0}

```{r}
#| label: cor5
#| echo: false
#| fig.asp: 0.5
#| fig-width: 6
dat2 <- faux::rnorm_multi(n=5,
                    mu=c(5,5),
                    sd=c(2,2),
                    r=.70,
                    varnames=c('x','y'))
p<- dat2 %>% ggplot(aes(x=x,y=y)) +
  geom_point(size=5)
p
```
:::


::: {.fragment fragment-index=2}
```{r}
#| label: cor5a
#| echo: false
#| fig.asp: 0.5
#| fig-width: 6
dat2$xm <- mean(dat2$x)
dat2$ym <- mean(dat2$y)
p2 <- p +
  geom_vline(xintercept=mean(dat2$x),colour="blue",linewidth=1.5) +
  geom_segment(data=dat2,aes(xend=xm,yend=y),colour="blue",linetype="dotted",linewidth=1.5)
p2
```
:::

::: {.fragment fragment-index=3}
```{r}
#| label: cor5b
#| echo: !expr F
#| fig.asp: 0.5
#| fig-width: 6
p2 + geom_hline(yintercept=mean(dat2$y),colour="red",linewidth=1.5) +
  geom_segment(data=dat2,aes(xend=x,yend=ym),colour="red",linetype="dotted",linewidth=1.5)
```
:::

::::

- does $y$ vary linearly with $x$?

::: {.fragment fragment-index=1}

- equivalent to asking "does $y$ differ from its mean in the same way that $x$ does?"

:::

:::: notes
- here are the ways in which the values of $x$ differ from `mean(x)`
- and here are the ways in which $y$ varies from its mean
::::

##  Covariance
```{r}
#| label: covlines
#| echo: false
#| fig-asp: 0.4
#| fig-width: 10.0

library(patchwork)
dat2 <- dat2 %>% mutate(yd=y-ym, xd=x-xm)
g1 <- dat2 %>% ggplot(aes(x=1:5,y=yd,fill="r")) +
  scale_fill_manual(values=c("red")) +
  scale_x_discrete(limit=1:5,labels=round(dat2$yd,2)) +
  guides(fill=FALSE) +
  geom_bar(stat="identity") +
  xlab("") + ylab("y diff") + ylim(-4,3)
g2 <- dat2 %>% ggplot(aes(x=1:5,y=xd,fill="r")) +
  scale_fill_manual(values=c("blue")) +
  scale_x_discrete(limit=1:5,labels=round(dat2$xd,2)) +
  guides(fill=FALSE) +
  geom_bar(stat="identity") +
  xlab("") + ylab("x diff") + ylim(-4,3)
g1/g2
```

- it's likely the variables are related **if observations differ proportionately from their means**


## Covariance

**variance**

::: myblock
$$ s^2 = \frac{\sum{(x-\bar{x})^2}}{n} = \frac{\sum{(x-\bar{x})(x-\bar{x})}}{n} $$
:::



:::: {.fragment}

**covariance**

::: myblock

$$ \textrm{cov}(x,y) = \frac{\sum{\color{blue}{(x-\bar{x})}\color{red}{(y-\bar{y})}}}{n} $$
:::

::::

::: notes
- here we're using $n$, not $n-1$, because this is the whole population

- for any (x,y), $x-\bar{x}$ might be positive and $y-\bar{y}$ might be positive, so the covariance could be a negative number
:::

## Covariance

```{r}
#| label: table
#| include: false

t <- dat2 |> select(xd,yd) |> mutate(xy=xd * yd) |> round(2)
```

| $\color{blue}{x-\bar{x}}$ | $\color{red}{y-\bar{y}}$ | $\color{blue}{(x-\bar{x})}\color{red}{(y-\bar{y})}$ |
|------------:|------------:|-------------------------:|
| `r t$xd[1]` | `r t$yd[1]` |              `r t$xy[1]` |
| `r t$xd[2]` | `r t$yd[2]` |              `r t$xy[2]` |
| `r t$xd[3]` | `r t$yd[3]` |              `r t$xy[3]` |
| `r t$xd[4]` | `r t$yd[4]` |              `r t$xy[4]` |
| `r t$xd[5]` | `r t$yd[5]` |              `r t$xy[5]` |
|             |             |        **`r sum(t$xy)`** |



$$\textrm{cov}(x,y) = \frac{\sum{(x-\bar{x})(y-\bar{y})}}{n} = \frac{`r sum(t$xy)`}{5} \simeq \color{red}{`r round(sum(t$xy)/5,2)`}$$


::: notes
I've rounded the numbers at the end to make this a bit neater on the slide
:::


## The Problem With Covariance {.smaller}

:::: {.columns}

::: {.column width="50%"}

**miles**

| $x-\bar{x}$ | $y-\bar{y}$ | $(x-\bar{x})(y-\bar{y})$ |
|------------:|------------:|-------------------------:|
| `r t$xd[1]` | `r t$yd[1]` |              `r t$xy[1]` |
| `r t$xd[2]` | `r t$yd[2]` |              `r t$xy[2]` |
| `r t$xd[3]` | `r t$yd[3]` |              `r t$xy[3]` |
| `r t$xd[4]` | `r t$yd[4]` |              `r t$xy[4]` |
| `r t$xd[5]` | `r t$yd[5]` |              `r t$xy[5]` |
|             |             |        **`r sum(t$xy)`** |

$$\textrm{cov}(x,y)=\frac{`r sum(t$xy)`}{5}\simeq `r round(sum(t$xy)/5,2)`$$

:::

::: {.column width="50%"}

**kilometres**

```{r}
#| label: mkm
#| include: !expr F
tk <- dat2 %>% select(xd,yd) %>% mutate(xd=xd * 1.60934,yd=yd * 1.60934) %>% mutate(xy=xd*yd) %>% round(2)
```

| $x-\bar{x}$ | $y-\bar{y}$ | $(x-\bar{x})(y-\bar{y})$ |
|------------:|------------:|-------------------------:|
| `r tk$xd[1]` | `r tk$yd[1]` |              `r tk$xy[1]` |
| `r tk$xd[2]` | `r tk$yd[2]` |              `r tk$xy[2]` |
| `r tk$xd[3]` | `r tk$yd[3]` |              `r tk$xy[3]` |
| `r tk$xd[4]` | `r tk$yd[4]` |              `r tk$xy[4]` |
| `r tk$xd[5]` | `r tk$yd[5]` |              `r tk$xy[5]` |
|             |             |        **`r sum(tk$xy)`** |

$$ \textrm{cov}(x,y)=\frac{`r sum(tk$xy)`}{5}\simeq `r round(sum(tk$xy)/5,2)` $$

:::

::::

::: notes
- these are exactly the same 'values' so they should each be as correlated as the other

- so we need to divide covariance by something to represent the overall "scale" of the units
:::

## Correlation Coefficient ($r$)

$$r = \frac{\textrm{covariance}(x,y)}{\textrm{standard deviation}(x)\cdot\textrm{standard deviation}(y)}$$


:::: r-stack

::: {.fragment .fade-in-then-out}

$$r=\frac{\frac{\sum{(x-\bar{x})(y-\bar{y})}}{n}}{\sqrt{\frac{\sum{(x-\bar{x})^2}}{n}}\sqrt{\frac{\sum{(y-\bar{y})^2}}{n}}}$$
:::

::: {.fragment}

$$r=\frac{\frac{\sum{(x-\bar{x})(y-\bar{y})}}{\color{red}{n}}}{\sqrt{\frac{\sum{(x-\bar{x})^2}}{\color{red}{n}}}\sqrt{\frac{\sum{(y-\bar{y})^2}}{\color{red}{n}}}}$$
:::

::::

::: {.fragment}

$$r=\frac{\sum{(x-\bar{x})(y-\bar{y})}}{\sqrt{\sum{(x-\bar{x})^2}}\sqrt{\sum{(y-\bar{y})^2}}}$$

:::

::: notes
standardised covariance, ensuring that units have no effect
:::

## Correlation Coefficient

- measure of _how related_ two variables are

- $-1 \le r \le 1$ ($\pm 1$ = perfect fit; $0$ = no fit)

:::: {.columns}

::: {.column width="50%"}
![](`r knitr::fig_chunk('ba','svg')`)
$$ r=`r cor(dat$BloodAlc,dat$RT)` $$

:::

::: {.column width="50%"}

:::: r-stack

::: {.fragment .fade-out fragment-index=1}
![](img/playmo_car.jpg){width=70%}

:::

::: {.fragment fragment-index=1}

```{r}
#| label: ba2
#| fig.asp: 0.6
#| echo: false
dat3 <- dat |> mutate(Blood = max(BloodAlc)-BloodAlc+min(BloodAlc))
dat3 |> ggplot(aes(x=Blood,y=RT)) +
  xlab("Blood Alcohol %/vol") + ylab("RT (ms)") +
  geom_point(size=3)
```

$$ r=`r cor(dat3$Blood,dat$RT)` $$

:::

::::

:::

::::

::: notes
- on the left, we have the drunken drivers from our first slide, and you can see that there is a moderate positive correlation
  + the higher your blood alcohol, the slower your RT
  
- on the right, we have a negative correlation: what the drivers _think_ happens
  + the higher your blood alcohol, the _faster_ your RT
:::


## What Does the Value of _r_ Mean?

```{r}
#| label: lots
#| fig.asp: 0.5
#| echo: false
#| fig-width: 18.0
set.seed(13)
ndat <- faux::rnorm_multi(n=50,
                   mu=c(0.1,650),
                   sd=c(.009,60),
                   r=0,
                   varnames=c('BloodAlc','RT'),
                   empirical = TRUE)
p1 <- ndat |> ggplot(aes(x=BloodAlc,y=RT)) +
  xlab("Blood Alcohol %/vol") + ylab("RT (ms)") +
  geom_point(size=2) + ggtitle("r = 0") +
  theme(plot.title = element_text(size = 30, colour="red")) +
  ylim(500,850)
ndat <- faux::rnorm_multi(n=50,
                   mu=c(0.1,650),
                   sd=c(.009,60),
                   r=0.2,
                   varnames=c('BloodAlc','RT'),
                   empirical = TRUE)
p2 <- ndat |> ggplot(aes(x=BloodAlc,y=RT)) +
  xlab("Blood Alcohol %/vol") + ylab("RT (ms)") +
  geom_point(size=2) + ggtitle("r = 0.2") +
  theme(plot.title = element_text(size = 30, colour="red")) +
  ylim(500,850)
ndat <- faux::rnorm_multi(n=50,
                   mu=c(0.1,650),
                   sd=c(.009,60),
                   r=0.5,
                   varnames=c('BloodAlc','RT'),
                   empirical = TRUE)
p3 <- ndat |> ggplot(aes(x=BloodAlc,y=RT)) +
  xlab("Blood Alcohol %/vol") + ylab("RT (ms)") +
  geom_point(size=2) + ggtitle("r = 0.5") +
  theme(plot.title = element_text(size = 30, colour="red")) +
  ylim(500,850)
ndat <- faux::rnorm_multi(n=50,
                   mu=c(0.1,650),
                   sd=c(.009,60),
                   r=0.9,
                   varnames=c('BloodAlc','RT'),
                   empirical = TRUE)
p4 <- ndat |> ggplot(aes(x=BloodAlc,y=RT)) +
  xlab("Blood Alcohol %/vol") + ylab("RT (ms)") +
  geom_point(size=2) + ggtitle("r = 0.9") +
  theme(plot.title = element_text(size = 30, colour="red")) +
  ylim(500,850)
(p1 + p2) / (p3 + p4)
```

# Significance

## Significance of a Correlation

:::: {.columns}

::: {.column width="50%"}

![](`r knitr::fig_chunk('ba','svg')`)

$$ r = `r cor(dat$BloodAlc,dat$RT)` $$
:::

::: {.column width="50%"}
![](img/playmo_police.jpg)
:::

::::


::: notes
- the police have stopped our friends and measured their blood alcohol

- is their evidence sufficient to conclude that there is likely to be a relationship between blood alcohol and reaction time?

:::

## Significance of a Correlation

- we can measure a correlation using $r$

- we want to know whether that correlation is **significant**

  + i.e., whether the probability of finding it by chance is low enough


- cardinal rule in NHST:  compare everything to chance

- let's investigate...

## Random Correlations

- pick some pairs of numbers at random, return correlation

- _arbitrarily_, I've picked numbers uniformly distributed between 0 and 100

```{r}
#| label: pcor0
x <- runif(5, min=0, max=100)
y <- runif(5, min=0, max=100)
cbind(x,y)
cor(x,y)
```


## Random Correlations

- pick some pairs of numbers at random, return correlation

  - repeat 1000 times

```{r}
#| output-location: column
#| tidy.opts: { width.cutoff: 24 }

randomCor <- function(size) {
  x <- runif(size, min=0, max=100)
  y <- runif(size, min=0, max=100)
  cor(x,y) # calculate r
}

# then we can use the usual trick:
rs <- replicate(1000, randomCor(5))
hist(rs)
```

## Random Correlations

:::: {.columns}

::: {.column width="50%"}
```{r}
#| label: pcor2
#| echo: false
#| fig.asp: 0.8
t <- tibble(r=replicate(1000,randomCor(15)))
t %>% ggplot(aes(x=r)) + geom_density(size=2) +
  ggtitle("1000 correlations of 15 random pairs") +
  ylim(0,2.5) + xlim(-.8,.8) +
  geom_segment(aes(x=quantile(r,.025),xend=quantile(r,.975),y=1.5,yend=1.5),colour="red",size=1,arrow=arrow(type="open",ends="both")) +
  annotate("text",x=0,y=1.65,label="95% of observations",size=9,colour="red") +
  ylab("density")
```

:::

::: {.column width="50%"}
```{r}
#| label: pcor3
#| echo: false
#| fig.asp: 0.8
t <- tibble(r=replicate(1000,randomCor(30)))
t %>% ggplot(aes(x=r)) + geom_density(size=2) +
  ggtitle("1000 correlations of 30 random pairs") +
  ylim(0,2.5) + xlim(-.8,.8) +
  geom_segment(aes(x=quantile(r,.025),xend=quantile(r,.975),y=1.5,yend=1.5),colour="red",size=1,arrow=arrow(type="open",ends="both")) +
  annotate("text",x=0,y=1.65,label="95% of observations",size=9,colour="red") +
  ylab("density")
```
:::

::::


## Calculating Probability

:::: {.columns}

::: {.column width="50%"}

:::: r-stack

::: {#hello}

```{r}
#| echo: false
#| fig.asp: 0.8
t <- tibble(r=replicate(10000,randomCor(30)))
p <- t %>% ggplot(aes(x=r)) + geom_density(size=2) +
  ggtitle("10000 correlations of 30 random pairs") +
  ylim(0,2.5) + xlim(-.8,.8)
p
```

:::

::: {.fragment fragment-index=1}
```{r}
#| echo: false
#| fig.asp: 0.8
rt <- function(r,n) {r*sqrt((n-2)/(1-r^2))}
dtr <- function(r,n) {dt(rt(r,n),n-2)*sqrt((n-2)/(1-r^2))}
p + stat_function(fun=dtr,colour="red",args=list(n=30),linewidth=2) +
  ylab("density")
```

:::

::::

:::
::: {.column width="50%"}
- distribution of random $r$s is $t$ distribution, with $n-2$ df

::: {.fragment fragment-index=1}

:::: myblock
$$t= r\sqrt{\frac{n-2}{1-r^2}}$$
::::

- makes it "easy" to calculate probability of getting $\ge{}r$ for sample size $n$ by chance
:::

:::

::::

## Calculating Probability

:::: {.columns}

::: {.column width="50%"}

**calculate $t$**

```{r}
#| results: asis
#| echo: false
cat("```r\n")
cat("r_to_t <- function (r,n) {\n")
cat("  r * sqrt((n-2) / (1-r^2))\n")
cat("}\n\n")
cat(paste0("r_to_t(",.rround(cor(dat$BloodAlc,dat$RT),4),", 50)\n\n"))
cat("```\n")
```

```{r}
#| echo: false
(tv<-rt(cor(dat$BloodAlc,dat$RT),50))
```

:::: {.fragment fragment-index=1}

**calculate $p$**

```{r}
#| results: asis
#| echo: false
cat("```r\n")
cat(paste0("2 * pt(",.rround(tv,3),", 48, lower.tail=F)\n"))
cat("```\n")
```

```{r}
#| echo: false

2*pt(tv,48,lower.tail = F)
```
- note `2 * pt(...)` as this is a two-tailed hypothesis

::::


:::

::: {.column width="50%"}

:::: r-stack

::: {.fragment .fade-out fragment-index=2}
![](img/playmo_police.jpg){width=70%}

$$r=`r cor(dat$RT,dat$BloodAlc)`$$
:::
::: {.fragment fragment-index=2}
**or just be lazy**
```{r}
cor.test(dat$BloodAlc,dat$RT)
```

:::

::::

:::

::::
